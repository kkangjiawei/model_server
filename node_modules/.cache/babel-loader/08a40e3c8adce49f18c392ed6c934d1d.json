{"remainingRequest":"/Users/a1/Desktop/code/golang/src/vue-element-admin/node_modules/thread-loader/dist/cjs.js!/Users/a1/Desktop/code/golang/src/vue-element-admin/node_modules/babel-loader/lib/index.js!/Users/a1/Desktop/code/golang/src/vue-element-admin/src/utils/jquery.js","dependencies":[{"path":"/Users/a1/Desktop/code/golang/src/vue-element-admin/src/utils/jquery.js","mtime":1677395941797},{"path":"/Users/a1/Desktop/code/golang/src/vue-element-admin/babel.config.js","mtime":1677293736750},{"path":"/Users/a1/Desktop/code/golang/src/vue-element-admin/node_modules/cache-loader/dist/cjs.js","mtime":1677293886981},{"path":"/Users/a1/Desktop/code/golang/src/vue-element-admin/node_modules/thread-loader/dist/cjs.js","mtime":1677293886978},{"path":"/Users/a1/Desktop/code/golang/src/vue-element-admin/node_modules/babel-loader/lib/index.js","mtime":1677293894163}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:dmFyIF90eXBlb2YgPSByZXF1aXJlKCIvVXNlcnMvYTEvRGVza3RvcC9jb2RlL2dvbGFuZy9zcmMvdnVlLWVsZW1lbnQtYWRtaW4vbm9kZV9tb2R1bGVzL0B2dWUvY2xpLXBsdWdpbi1iYWJlbC9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy90eXBlb2YuanMiKS5kZWZhdWx0OwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LmdldC1wcm90b3R5cGUtb2YuanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNsaWNlLmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5mbGF0LmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS51bnNjb3BhYmxlcy5mbGF0LmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5jb25jYXQuanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC50by1zdHJpbmcuanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC50by1zdHJpbmcuanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5Lm1hcC5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuc29ydC5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuc3BsaWNlLmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5yZWdleHAuZXhlYy5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnJlcGxhY2UuanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN5bWJvbC5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3ltYm9sLmRlc2NyaXB0aW9uLmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zeW1ib2wuaXRlcmF0b3IuanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5pdGVyYXRvci5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvd2ViLmRvbS1jb2xsZWN0aW9ucy5pdGVyYXRvci5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMucmVnZXhwLmNvbnN0cnVjdG9yLmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5yZWdleHAuc3RpY2t5LmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5yZWdleHAudGVzdC5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuam9pbi5qcyIpOwpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZmlsdGVyLmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5maW5kLmpzIik7CnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcubWF0Y2guanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmZ1bmN0aW9uLm5hbWUuanMiKTsKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy50cmltLmpzIik7Ci8qIQogKiBqUXVlcnkgSmF2YVNjcmlwdCBMaWJyYXJ5IHYzLjUuMQogKiBodHRwczovL2pxdWVyeS5jb20vCiAqCiAqIEluY2x1ZGVzIFNpenpsZS5qcwogKiBodHRwczovL3NpenpsZWpzLmNvbS8KICoKICogQ29weXJpZ2h0IEpTIEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cHM6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogRGF0ZTogMjAyMC0wNS0wNFQyMjo0OVoKICovCihmdW5jdGlvbiAoZ2xvYmFsLCBmYWN0b3J5KSB7CiAgInVzZSBzdHJpY3QiOwoKICBpZiAoKHR5cGVvZiBtb2R1bGUgPT09ICJ1bmRlZmluZWQiID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mKG1vZHVsZSkpID09PSAib2JqZWN0IiAmJiBfdHlwZW9mKG1vZHVsZS5leHBvcnRzKSA9PT0gIm9iamVjdCIpIHsKICAgIC8vIEZvciBDb21tb25KUyBhbmQgQ29tbW9uSlMtbGlrZSBlbnZpcm9ubWVudHMgd2hlcmUgYSBwcm9wZXIgYHdpbmRvd2AKICAgIC8vIGlzIHByZXNlbnQsIGV4ZWN1dGUgdGhlIGZhY3RvcnkgYW5kIGdldCBqUXVlcnkuCiAgICAvLyBGb3IgZW52aXJvbm1lbnRzIHRoYXQgZG8gbm90IGhhdmUgYSBgd2luZG93YCB3aXRoIGEgYGRvY3VtZW50YAogICAgLy8gKHN1Y2ggYXMgTm9kZS5qcyksIGV4cG9zZSBhIGZhY3RvcnkgYXMgbW9kdWxlLmV4cG9ydHMuCiAgICAvLyBUaGlzIGFjY2VudHVhdGVzIHRoZSBuZWVkIGZvciB0aGUgY3JlYXRpb24gb2YgYSByZWFsIGB3aW5kb3dgLgogICAgLy8gZS5nLiB2YXIgalF1ZXJ5ID0gcmVxdWlyZSgianF1ZXJ5Iikod2luZG93KTsKICAgIC8vIFNlZSB0aWNrZXQgIzE0NTQ5IGZvciBtb3JlIGluZm8uCiAgICBtb2R1bGUuZXhwb3J0cyA9IGdsb2JhbC5kb2N1bWVudCA/IGZhY3RvcnkoZ2xvYmFsLCB0cnVlKSA6IGZ1bmN0aW9uICh3KSB7CiAgICAgIGlmICghdy5kb2N1bWVudCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigialF1ZXJ5IHJlcXVpcmVzIGEgd2luZG93IHdpdGggYSBkb2N1bWVudCIpOwogICAgICB9CiAgICAgIHJldHVybiBmYWN0b3J5KHcpOwogICAgfTsKICB9IGVsc2UgewogICAgZmFjdG9yeShnbG9iYWwpOwogIH0KCiAgLy8gUGFzcyB0aGlzIGlmIHdpbmRvdyBpcyBub3QgZGVmaW5lZCB5ZXQKfSkodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB0aGlzLCBmdW5jdGlvbiAod2luZG93LCBub0dsb2JhbCkgewogIC8vIEVkZ2UgPD0gMTIgLSAxMyssIEZpcmVmb3ggPD0xOCAtIDQ1KywgSUUgMTAgLSAxMSwgU2FmYXJpIDUuMSAtIDkrLCBpT1MgNiAtIDkuMQogIC8vIHRocm93IGV4Y2VwdGlvbnMgd2hlbiBub24tc3RyaWN0IGNvZGUgKGUuZy4sIEFTUC5ORVQgNC41KSBhY2Nlc3NlcyBzdHJpY3QgbW9kZQogIC8vIGFyZ3VtZW50cy5jYWxsZWUuY2FsbGVyICh0cmFjLTEzMzM1KS4gQnV0IGFzIG9mIGpRdWVyeSAzLjAgKDIwMTYpLCBzdHJpY3QgbW9kZSBzaG91bGQgYmUgY29tbW9uCiAgLy8gZW5vdWdoIHRoYXQgYWxsIHN1Y2ggYXR0ZW1wdHMgYXJlIGd1YXJkZWQgaW4gYSB0cnkgYmxvY2suCiAgInVzZSBzdHJpY3QiOwoKICB2YXIgYXJyID0gW107CiAgdmFyIGdldFByb3RvID0gT2JqZWN0LmdldFByb3RvdHlwZU9mOwogIHZhciBfc2xpY2UgPSBhcnIuc2xpY2U7CiAgdmFyIGZsYXQgPSBhcnIuZmxhdCA/IGZ1bmN0aW9uIChhcnJheSkgewogICAgcmV0dXJuIGFyci5mbGF0LmNhbGwoYXJyYXkpOwogIH0gOiBmdW5jdGlvbiAoYXJyYXkpIHsKICAgIHJldHVybiBhcnIuY29uY2F0LmFwcGx5KFtdLCBhcnJheSk7CiAgfTsKICB2YXIgcHVzaCA9IGFyci5wdXNoOwogIHZhciBpbmRleE9mID0gYXJyLmluZGV4T2Y7CiAgdmFyIGNsYXNzMnR5cGUgPSB7fTsKICB2YXIgdG9TdHJpbmcgPSBjbGFzczJ0eXBlLnRvU3RyaW5nOwogIHZhciBoYXNPd24gPSBjbGFzczJ0eXBlLmhhc093blByb3BlcnR5OwogIHZhciBmblRvU3RyaW5nID0gaGFzT3duLnRvU3RyaW5nOwogIHZhciBPYmplY3RGdW5jdGlvblN0cmluZyA9IGZuVG9TdHJpbmcuY2FsbChPYmplY3QpOwogIHZhciBzdXBwb3J0ID0ge307CiAgdmFyIGlzRnVuY3Rpb24gPSBmdW5jdGlvbiBpc0Z1bmN0aW9uKG9iaikgewogICAgLy8gU3VwcG9ydDogQ2hyb21lIDw9NTcsIEZpcmVmb3ggPD01MgogICAgLy8gSW4gc29tZSBicm93c2VycywgdHlwZW9mIHJldHVybnMgImZ1bmN0aW9uIiBmb3IgSFRNTCA8b2JqZWN0PiBlbGVtZW50cwogICAgLy8gKGkuZS4sIGB0eXBlb2YgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggIm9iamVjdCIgKSA9PT0gImZ1bmN0aW9uImApLgogICAgLy8gV2UgZG9uJ3Qgd2FudCB0byBjbGFzc2lmeSAqYW55KiBET00gbm9kZSBhcyBhIGZ1bmN0aW9uLgogICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG9iai5ub2RlVHlwZSAhPT0gIm51bWJlciI7CiAgfTsKICB2YXIgaXNXaW5kb3cgPSBmdW5jdGlvbiBpc1dpbmRvdyhvYmopIHsKICAgIHJldHVybiBvYmogIT0gbnVsbCAmJiBvYmogPT09IG9iai53aW5kb3c7CiAgfTsKICB2YXIgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQ7CiAgdmFyIHByZXNlcnZlZFNjcmlwdEF0dHJpYnV0ZXMgPSB7CiAgICB0eXBlOiB0cnVlLAogICAgc3JjOiB0cnVlLAogICAgbm9uY2U6IHRydWUsCiAgICBub01vZHVsZTogdHJ1ZQogIH07CiAgZnVuY3Rpb24gRE9NRXZhbChjb2RlLCBub2RlLCBkb2MpIHsKICAgIGRvYyA9IGRvYyB8fCBkb2N1bWVudDsKICAgIHZhciBpLAogICAgICB2YWwsCiAgICAgIHNjcmlwdCA9IGRvYy5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgIHNjcmlwdC50ZXh0ID0gY29kZTsKICAgIGlmIChub2RlKSB7CiAgICAgIGZvciAoaSBpbiBwcmVzZXJ2ZWRTY3JpcHRBdHRyaWJ1dGVzKSB7CiAgICAgICAgLy8gU3VwcG9ydDogRmlyZWZveCA2NCssIEVkZ2UgMTgrCiAgICAgICAgLy8gU29tZSBicm93c2VycyBkb24ndCBzdXBwb3J0IHRoZSAibm9uY2UiIHByb3BlcnR5IG9uIHNjcmlwdHMuCiAgICAgICAgLy8gT24gdGhlIG90aGVyIGhhbmQsIGp1c3QgdXNpbmcgYGdldEF0dHJpYnV0ZWAgaXMgbm90IGVub3VnaCBhcwogICAgICAgIC8vIHRoZSBgbm9uY2VgIGF0dHJpYnV0ZSBpcyByZXNldCB0byBhbiBlbXB0eSBzdHJpbmcgd2hlbmV2ZXIgaXQKICAgICAgICAvLyBiZWNvbWVzIGJyb3dzaW5nLWNvbnRleHQgY29ubmVjdGVkLgogICAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vd2hhdHdnL2h0bWwvaXNzdWVzLzIzNjkKICAgICAgICAvLyBTZWUgaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy8jbm9uY2UtYXR0cmlidXRlcwogICAgICAgIC8vIFRoZSBgbm9kZS5nZXRBdHRyaWJ1dGVgIGNoZWNrIHdhcyBhZGRlZCBmb3IgdGhlIHNha2Ugb2YKICAgICAgICAvLyBgalF1ZXJ5Lmdsb2JhbEV2YWxgIHNvIHRoYXQgaXQgY2FuIGZha2UgYSBub25jZS1jb250YWluaW5nIG5vZGUKICAgICAgICAvLyB2aWEgYW4gb2JqZWN0LgogICAgICAgIHZhbCA9IG5vZGVbaV0gfHwgbm9kZS5nZXRBdHRyaWJ1dGUgJiYgbm9kZS5nZXRBdHRyaWJ1dGUoaSk7CiAgICAgICAgaWYgKHZhbCkgewogICAgICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZShpLCB2YWwpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZG9jLmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcmlwdCk7CiAgfQogIGZ1bmN0aW9uIHRvVHlwZShvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgewogICAgICByZXR1cm4gb2JqICsgIiI7CiAgICB9CgogICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTIuMyBvbmx5IChmdW5jdGlvbmlzaCBSZWdFeHApCiAgICByZXR1cm4gX3R5cGVvZihvYmopID09PSAib2JqZWN0IiB8fCB0eXBlb2Ygb2JqID09PSAiZnVuY3Rpb24iID8gY2xhc3MydHlwZVt0b1N0cmluZy5jYWxsKG9iaildIHx8ICJvYmplY3QiIDogX3R5cGVvZihvYmopOwogIH0KICAvKiBnbG9iYWwgU3ltYm9sICovCiAgLy8gRGVmaW5pbmcgdGhpcyBnbG9iYWwgaW4gLmVzbGludHJjLmpzb24gd291bGQgY3JlYXRlIGEgZGFuZ2VyIG9mIHVzaW5nIHRoZSBnbG9iYWwKICAvLyB1bmd1YXJkZWQgaW4gYW5vdGhlciBwbGFjZSwgaXQgc2VlbXMgc2FmZXIgdG8gZGVmaW5lIGdsb2JhbCBvbmx5IGZvciB0aGlzIG1vZHVsZQoKICB2YXIgdmVyc2lvbiA9ICIzLjUuMSIsCiAgICAvLyBEZWZpbmUgYSBsb2NhbCBjb3B5IG9mIGpRdWVyeQogICAgalF1ZXJ5ID0gZnVuY3Rpb24galF1ZXJ5KHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICAgIC8vIFRoZSBqUXVlcnkgb2JqZWN0IGlzIGFjdHVhbGx5IGp1c3QgdGhlIGluaXQgY29uc3RydWN0b3IgJ2VuaGFuY2VkJwogICAgICAvLyBOZWVkIGluaXQgaWYgalF1ZXJ5IGlzIGNhbGxlZCAoanVzdCBhbGxvdyBlcnJvciB0byBiZSB0aHJvd24gaWYgbm90IGluY2x1ZGVkKQogICAgICByZXR1cm4gbmV3IGpRdWVyeS5mbi5pbml0KHNlbGVjdG9yLCBjb250ZXh0KTsKICAgIH07CiAgalF1ZXJ5LmZuID0galF1ZXJ5LnByb3RvdHlwZSA9IHsKICAgIC8vIFRoZSBjdXJyZW50IHZlcnNpb24gb2YgalF1ZXJ5IGJlaW5nIHVzZWQKICAgIGpxdWVyeTogdmVyc2lvbiwKICAgIGNvbnN0cnVjdG9yOiBqUXVlcnksCiAgICAvLyBUaGUgZGVmYXVsdCBsZW5ndGggb2YgYSBqUXVlcnkgb2JqZWN0IGlzIDAKICAgIGxlbmd0aDogMCwKICAgIHRvQXJyYXk6IGZ1bmN0aW9uIHRvQXJyYXkoKSB7CiAgICAgIHJldHVybiBfc2xpY2UuY2FsbCh0aGlzKTsKICAgIH0sCiAgICAvLyBHZXQgdGhlIE50aCBlbGVtZW50IGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0IE9SCiAgICAvLyBHZXQgdGhlIHdob2xlIG1hdGNoZWQgZWxlbWVudCBzZXQgYXMgYSBjbGVhbiBhcnJheQogICAgZ2V0OiBmdW5jdGlvbiBnZXQobnVtKSB7CiAgICAgIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIGluIGEgY2xlYW4gYXJyYXkKICAgICAgaWYgKG51bSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIF9zbGljZS5jYWxsKHRoaXMpOwogICAgICB9CgogICAgICAvLyBSZXR1cm4ganVzdCB0aGUgb25lIGVsZW1lbnQgZnJvbSB0aGUgc2V0CiAgICAgIHJldHVybiBudW0gPCAwID8gdGhpc1tudW0gKyB0aGlzLmxlbmd0aF0gOiB0aGlzW251bV07CiAgICB9LAogICAgLy8gVGFrZSBhbiBhcnJheSBvZiBlbGVtZW50cyBhbmQgcHVzaCBpdCBvbnRvIHRoZSBzdGFjawogICAgLy8gKHJldHVybmluZyB0aGUgbmV3IG1hdGNoZWQgZWxlbWVudCBzZXQpCiAgICBwdXNoU3RhY2s6IGZ1bmN0aW9uIHB1c2hTdGFjayhlbGVtcykgewogICAgICAvLyBCdWlsZCBhIG5ldyBqUXVlcnkgbWF0Y2hlZCBlbGVtZW50IHNldAogICAgICB2YXIgcmV0ID0galF1ZXJ5Lm1lcmdlKHRoaXMuY29uc3RydWN0b3IoKSwgZWxlbXMpOwoKICAgICAgLy8gQWRkIHRoZSBvbGQgb2JqZWN0IG9udG8gdGhlIHN0YWNrIChhcyBhIHJlZmVyZW5jZSkKICAgICAgcmV0LnByZXZPYmplY3QgPSB0aGlzOwoKICAgICAgLy8gUmV0dXJuIHRoZSBuZXdseS1mb3JtZWQgZWxlbWVudCBzZXQKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgICAvLyBFeGVjdXRlIGEgY2FsbGJhY2sgZm9yIGV2ZXJ5IGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgc2V0LgogICAgZWFjaDogZnVuY3Rpb24gZWFjaChjYWxsYmFjaykgewogICAgICByZXR1cm4galF1ZXJ5LmVhY2godGhpcywgY2FsbGJhY2spOwogICAgfSwKICAgIG1hcDogZnVuY3Rpb24gbWFwKGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhqUXVlcnkubWFwKHRoaXMsIGZ1bmN0aW9uIChlbGVtLCBpKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmNhbGwoZWxlbSwgaSwgZWxlbSk7CiAgICAgIH0pKTsKICAgIH0sCiAgICBzbGljZTogZnVuY3Rpb24gc2xpY2UoKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhfc2xpY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9LAogICAgZmlyc3Q6IGZ1bmN0aW9uIGZpcnN0KCkgewogICAgICByZXR1cm4gdGhpcy5lcSgwKTsKICAgIH0sCiAgICBsYXN0OiBmdW5jdGlvbiBsYXN0KCkgewogICAgICByZXR1cm4gdGhpcy5lcSgtMSk7CiAgICB9LAogICAgZXZlbjogZnVuY3Rpb24gZXZlbigpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGpRdWVyeS5ncmVwKHRoaXMsIGZ1bmN0aW9uIChfZWxlbSwgaSkgewogICAgICAgIHJldHVybiAoaSArIDEpICUgMjsKICAgICAgfSkpOwogICAgfSwKICAgIG9kZDogZnVuY3Rpb24gb2RkKCkgewogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soalF1ZXJ5LmdyZXAodGhpcywgZnVuY3Rpb24gKF9lbGVtLCBpKSB7CiAgICAgICAgcmV0dXJuIGkgJSAyOwogICAgICB9KSk7CiAgICB9LAogICAgZXE6IGZ1bmN0aW9uIGVxKGkpIHsKICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoLAogICAgICAgIGogPSAraSArIChpIDwgMCA/IGxlbiA6IDApOwogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soaiA+PSAwICYmIGogPCBsZW4gPyBbdGhpc1tqXV0gOiBbXSk7CiAgICB9LAogICAgZW5kOiBmdW5jdGlvbiBlbmQoKSB7CiAgICAgIHJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcigpOwogICAgfSwKICAgIC8vIEZvciBpbnRlcm5hbCB1c2Ugb25seS4KICAgIC8vIEJlaGF2ZXMgbGlrZSBhbiBBcnJheSdzIG1ldGhvZCwgbm90IGxpa2UgYSBqUXVlcnkgbWV0aG9kLgogICAgcHVzaDogcHVzaCwKICAgIHNvcnQ6IGFyci5zb3J0LAogICAgc3BsaWNlOiBhcnIuc3BsaWNlCiAgfTsKICBqUXVlcnkuZXh0ZW5kID0galF1ZXJ5LmZuLmV4dGVuZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBvcHRpb25zLAogICAgICBuYW1lLAogICAgICBzcmMsCiAgICAgIGNvcHksCiAgICAgIGNvcHlJc0FycmF5LAogICAgICBjbG9uZSwKICAgICAgdGFyZ2V0ID0gYXJndW1lbnRzWzBdIHx8IHt9LAogICAgICBpID0gMSwKICAgICAgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwKICAgICAgZGVlcCA9IGZhbHNlOwoKICAgIC8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KICAgIGlmICh0eXBlb2YgdGFyZ2V0ID09PSAiYm9vbGVhbiIpIHsKICAgICAgZGVlcCA9IHRhcmdldDsKCiAgICAgIC8vIFNraXAgdGhlIGJvb2xlYW4gYW5kIHRoZSB0YXJnZXQKICAgICAgdGFyZ2V0ID0gYXJndW1lbnRzW2ldIHx8IHt9OwogICAgICBpKys7CiAgICB9CgogICAgLy8gSGFuZGxlIGNhc2Ugd2hlbiB0YXJnZXQgaXMgYSBzdHJpbmcgb3Igc29tZXRoaW5nIChwb3NzaWJsZSBpbiBkZWVwIGNvcHkpCiAgICBpZiAoX3R5cGVvZih0YXJnZXQpICE9PSAib2JqZWN0IiAmJiAhaXNGdW5jdGlvbih0YXJnZXQpKSB7CiAgICAgIHRhcmdldCA9IHt9OwogICAgfQoKICAgIC8vIEV4dGVuZCBqUXVlcnkgaXRzZWxmIGlmIG9ubHkgb25lIGFyZ3VtZW50IGlzIHBhc3NlZAogICAgaWYgKGkgPT09IGxlbmd0aCkgewogICAgICB0YXJnZXQgPSB0aGlzOwogICAgICBpLS07CiAgICB9CiAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIC8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMKICAgICAgaWYgKChvcHRpb25zID0gYXJndW1lbnRzW2ldKSAhPSBudWxsKSB7CiAgICAgICAgLy8gRXh0ZW5kIHRoZSBiYXNlIG9iamVjdAogICAgICAgIGZvciAobmFtZSBpbiBvcHRpb25zKSB7CiAgICAgICAgICBjb3B5ID0gb3B0aW9uc1tuYW1lXTsKCiAgICAgICAgICAvLyBQcmV2ZW50IE9iamVjdC5wcm90b3R5cGUgcG9sbHV0aW9uCiAgICAgICAgICAvLyBQcmV2ZW50IG5ldmVyLWVuZGluZyBsb29wCiAgICAgICAgICBpZiAobmFtZSA9PT0gIl9fcHJvdG9fXyIgfHwgdGFyZ2V0ID09PSBjb3B5KSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFJlY3Vyc2UgaWYgd2UncmUgbWVyZ2luZyBwbGFpbiBvYmplY3RzIG9yIGFycmF5cwogICAgICAgICAgaWYgKGRlZXAgJiYgY29weSAmJiAoalF1ZXJ5LmlzUGxhaW5PYmplY3QoY29weSkgfHwgKGNvcHlJc0FycmF5ID0gQXJyYXkuaXNBcnJheShjb3B5KSkpKSB7CiAgICAgICAgICAgIHNyYyA9IHRhcmdldFtuYW1lXTsKCiAgICAgICAgICAgIC8vIEVuc3VyZSBwcm9wZXIgdHlwZSBmb3IgdGhlIHNvdXJjZSB2YWx1ZQogICAgICAgICAgICBpZiAoY29weUlzQXJyYXkgJiYgIUFycmF5LmlzQXJyYXkoc3JjKSkgewogICAgICAgICAgICAgIGNsb25lID0gW107CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWNvcHlJc0FycmF5ICYmICFqUXVlcnkuaXNQbGFpbk9iamVjdChzcmMpKSB7CiAgICAgICAgICAgICAgY2xvbmUgPSB7fTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjbG9uZSA9IHNyYzsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb3B5SXNBcnJheSA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gTmV2ZXIgbW92ZSBvcmlnaW5hbCBvYmplY3RzLCBjbG9uZSB0aGVtCiAgICAgICAgICAgIHRhcmdldFtuYW1lXSA9IGpRdWVyeS5leHRlbmQoZGVlcCwgY2xvbmUsIGNvcHkpOwoKICAgICAgICAgICAgLy8gRG9uJ3QgYnJpbmcgaW4gdW5kZWZpbmVkIHZhbHVlcwogICAgICAgICAgfSBlbHNlIGlmIChjb3B5ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGFyZ2V0W25hbWVdID0gY29weTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBSZXR1cm4gdGhlIG1vZGlmaWVkIG9iamVjdAogICAgcmV0dXJuIHRhcmdldDsKICB9OwogIGpRdWVyeS5leHRlbmQoewogICAgLy8gVW5pcXVlIGZvciBlYWNoIGNvcHkgb2YgalF1ZXJ5IG9uIHRoZSBwYWdlCiAgICBleHBhbmRvOiAialF1ZXJ5IiArICh2ZXJzaW9uICsgTWF0aC5yYW5kb20oKSkucmVwbGFjZSgvXEQvZywgIiIpLAogICAgLy8gQXNzdW1lIGpRdWVyeSBpcyByZWFkeSB3aXRob3V0IHRoZSByZWFkeSBtb2R1bGUKICAgIGlzUmVhZHk6IHRydWUsCiAgICBlcnJvcjogZnVuY3Rpb24gZXJyb3IobXNnKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpOwogICAgfSwKICAgIG5vb3A6IGZ1bmN0aW9uIG5vb3AoKSB7fSwKICAgIGlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uIGlzUGxhaW5PYmplY3Qob2JqKSB7CiAgICAgIHZhciBwcm90bywgQ3RvcjsKCiAgICAgIC8vIERldGVjdCBvYnZpb3VzIG5lZ2F0aXZlcwogICAgICAvLyBVc2UgdG9TdHJpbmcgaW5zdGVhZCBvZiBqUXVlcnkudHlwZSB0byBjYXRjaCBob3N0IG9iamVjdHMKICAgICAgaWYgKCFvYmogfHwgdG9TdHJpbmcuY2FsbChvYmopICE9PSAiW29iamVjdCBPYmplY3RdIikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBwcm90byA9IGdldFByb3RvKG9iaik7CgogICAgICAvLyBPYmplY3RzIHdpdGggbm8gcHJvdG90eXBlIChlLmcuLCBgT2JqZWN0LmNyZWF0ZSggbnVsbCApYCkgYXJlIHBsYWluCiAgICAgIGlmICghcHJvdG8pIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgLy8gT2JqZWN0cyB3aXRoIHByb3RvdHlwZSBhcmUgcGxhaW4gaWZmIHRoZXkgd2VyZSBjb25zdHJ1Y3RlZCBieSBhIGdsb2JhbCBPYmplY3QgZnVuY3Rpb24KICAgICAgQ3RvciA9IGhhc093bi5jYWxsKHByb3RvLCAiY29uc3RydWN0b3IiKSAmJiBwcm90by5jb25zdHJ1Y3RvcjsKICAgICAgcmV0dXJuIHR5cGVvZiBDdG9yID09PSAiZnVuY3Rpb24iICYmIGZuVG9TdHJpbmcuY2FsbChDdG9yKSA9PT0gT2JqZWN0RnVuY3Rpb25TdHJpbmc7CiAgICB9LAogICAgaXNFbXB0eU9iamVjdDogZnVuY3Rpb24gaXNFbXB0eU9iamVjdChvYmopIHsKICAgICAgdmFyIG5hbWU7CiAgICAgIGZvciAobmFtZSBpbiBvYmopIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgLy8gRXZhbHVhdGVzIGEgc2NyaXB0IGluIGEgcHJvdmlkZWQgY29udGV4dDsgZmFsbHMgYmFjayB0byB0aGUgZ2xvYmFsIG9uZQogICAgLy8gaWYgbm90IHNwZWNpZmllZC4KICAgIGdsb2JhbEV2YWw6IGZ1bmN0aW9uIGdsb2JhbEV2YWwoY29kZSwgb3B0aW9ucywgZG9jKSB7CiAgICAgIERPTUV2YWwoY29kZSwgewogICAgICAgIG5vbmNlOiBvcHRpb25zICYmIG9wdGlvbnMubm9uY2UKICAgICAgfSwgZG9jKTsKICAgIH0sCiAgICBlYWNoOiBmdW5jdGlvbiBlYWNoKG9iaiwgY2FsbGJhY2spIHsKICAgICAgdmFyIGxlbmd0aCwKICAgICAgICBpID0gMDsKICAgICAgaWYgKGlzQXJyYXlMaWtlKG9iaikpIHsKICAgICAgICBsZW5ndGggPSBvYmoubGVuZ3RoOwogICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChjYWxsYmFjay5jYWxsKG9ialtpXSwgaSwgb2JqW2ldKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvciAoaSBpbiBvYmopIHsKICAgICAgICAgIGlmIChjYWxsYmFjay5jYWxsKG9ialtpXSwgaSwgb2JqW2ldKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvYmo7CiAgICB9LAogICAgLy8gcmVzdWx0cyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQogICAgbWFrZUFycmF5OiBmdW5jdGlvbiBtYWtlQXJyYXkoYXJyLCByZXN1bHRzKSB7CiAgICAgIHZhciByZXQgPSByZXN1bHRzIHx8IFtdOwogICAgICBpZiAoYXJyICE9IG51bGwpIHsKICAgICAgICBpZiAoaXNBcnJheUxpa2UoT2JqZWN0KGFycikpKSB7CiAgICAgICAgICBqUXVlcnkubWVyZ2UocmV0LCB0eXBlb2YgYXJyID09PSAic3RyaW5nIiA/IFthcnJdIDogYXJyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcHVzaC5jYWxsKHJldCwgYXJyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgICBpbkFycmF5OiBmdW5jdGlvbiBpbkFycmF5KGVsZW0sIGFyciwgaSkgewogICAgICByZXR1cm4gYXJyID09IG51bGwgPyAtMSA6IGluZGV4T2YuY2FsbChhcnIsIGVsZW0sIGkpOwogICAgfSwKICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seSwgUGhhbnRvbUpTIDEgb25seQogICAgLy8gcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cyBvbiBhbmNpZW50IFdlYktpdAogICAgbWVyZ2U6IGZ1bmN0aW9uIG1lcmdlKGZpcnN0LCBzZWNvbmQpIHsKICAgICAgdmFyIGxlbiA9ICtzZWNvbmQubGVuZ3RoLAogICAgICAgIGogPSAwLAogICAgICAgIGkgPSBmaXJzdC5sZW5ndGg7CiAgICAgIGZvciAoOyBqIDwgbGVuOyBqKyspIHsKICAgICAgICBmaXJzdFtpKytdID0gc2Vjb25kW2pdOwogICAgICB9CiAgICAgIGZpcnN0Lmxlbmd0aCA9IGk7CiAgICAgIHJldHVybiBmaXJzdDsKICAgIH0sCiAgICBncmVwOiBmdW5jdGlvbiBncmVwKGVsZW1zLCBjYWxsYmFjaywgaW52ZXJ0KSB7CiAgICAgIHZhciBjYWxsYmFja0ludmVyc2UsCiAgICAgICAgbWF0Y2hlcyA9IFtdLAogICAgICAgIGkgPSAwLAogICAgICAgIGxlbmd0aCA9IGVsZW1zLmxlbmd0aCwKICAgICAgICBjYWxsYmFja0V4cGVjdCA9ICFpbnZlcnQ7CgogICAgICAvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgb25seSBzYXZpbmcgdGhlIGl0ZW1zCiAgICAgIC8vIHRoYXQgcGFzcyB0aGUgdmFsaWRhdG9yIGZ1bmN0aW9uCiAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBjYWxsYmFja0ludmVyc2UgPSAhY2FsbGJhY2soZWxlbXNbaV0sIGkpOwogICAgICAgIGlmIChjYWxsYmFja0ludmVyc2UgIT09IGNhbGxiYWNrRXhwZWN0KSB7CiAgICAgICAgICBtYXRjaGVzLnB1c2goZWxlbXNbaV0pOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbWF0Y2hlczsKICAgIH0sCiAgICAvLyBhcmcgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKICAgIG1hcDogZnVuY3Rpb24gbWFwKGVsZW1zLCBjYWxsYmFjaywgYXJnKSB7CiAgICAgIHZhciBsZW5ndGgsCiAgICAgICAgdmFsdWUsCiAgICAgICAgaSA9IDAsCiAgICAgICAgcmV0ID0gW107CgogICAgICAvLyBHbyB0aHJvdWdoIHRoZSBhcnJheSwgdHJhbnNsYXRpbmcgZWFjaCBvZiB0aGUgaXRlbXMgdG8gdGhlaXIgbmV3IHZhbHVlcwogICAgICBpZiAoaXNBcnJheUxpa2UoZWxlbXMpKSB7CiAgICAgICAgbGVuZ3RoID0gZWxlbXMubGVuZ3RoOwogICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbXNbaV0sIGksIGFyZyk7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICByZXQucHVzaCh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBHbyB0aHJvdWdoIGV2ZXJ5IGtleSBvbiB0aGUgb2JqZWN0LAogICAgICB9IGVsc2UgewogICAgICAgIGZvciAoaSBpbiBlbGVtcykgewogICAgICAgICAgdmFsdWUgPSBjYWxsYmFjayhlbGVtc1tpXSwgaSwgYXJnKTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldC5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIEZsYXR0ZW4gYW55IG5lc3RlZCBhcnJheXMKICAgICAgcmV0dXJuIGZsYXQocmV0KTsKICAgIH0sCiAgICAvLyBBIGdsb2JhbCBHVUlEIGNvdW50ZXIgZm9yIG9iamVjdHMKICAgIGd1aWQ6IDEsCiAgICAvLyBqUXVlcnkuc3VwcG9ydCBpcyBub3QgdXNlZCBpbiBDb3JlIGJ1dCBvdGhlciBwcm9qZWN0cyBhdHRhY2ggdGhlaXIKICAgIC8vIHByb3BlcnRpZXMgdG8gaXQgc28gaXQgbmVlZHMgdG8gZXhpc3QuCiAgICBzdXBwb3J0OiBzdXBwb3J0CiAgfSk7CiAgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIpIHsKICAgIGpRdWVyeS5mbltTeW1ib2wuaXRlcmF0b3JdID0gYXJyW1N5bWJvbC5pdGVyYXRvcl07CiAgfQoKICAvLyBQb3B1bGF0ZSB0aGUgY2xhc3MydHlwZSBtYXAKICBqUXVlcnkuZWFjaCgiQm9vbGVhbiBOdW1iZXIgU3RyaW5nIEZ1bmN0aW9uIEFycmF5IERhdGUgUmVnRXhwIE9iamVjdCBFcnJvciBTeW1ib2wiLnNwbGl0KCIgIiksIGZ1bmN0aW9uIChfaSwgbmFtZSkgewogICAgY2xhc3MydHlwZVsiW29iamVjdCAiICsgbmFtZSArICJdIl0gPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgfSk7CiAgZnVuY3Rpb24gaXNBcnJheUxpa2Uob2JqKSB7CiAgICAvLyBTdXBwb3J0OiByZWFsIGlPUyA4LjIgb25seSAobm90IHJlcHJvZHVjaWJsZSBpbiBzaW11bGF0b3IpCiAgICAvLyBgaW5gIGNoZWNrIHVzZWQgdG8gcHJldmVudCBKSVQgZXJyb3IgKGdoLTIxNDUpCiAgICAvLyBoYXNPd24gaXNuJ3QgdXNlZCBoZXJlIGR1ZSB0byBmYWxzZSBuZWdhdGl2ZXMKICAgIC8vIHJlZ2FyZGluZyBOb2RlbGlzdCBsZW5ndGggaW4gSUUKICAgIHZhciBsZW5ndGggPSAhIW9iaiAmJiAibGVuZ3RoIiBpbiBvYmogJiYgb2JqLmxlbmd0aCwKICAgICAgdHlwZSA9IHRvVHlwZShvYmopOwogICAgaWYgKGlzRnVuY3Rpb24ob2JqKSB8fCBpc1dpbmRvdyhvYmopKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0eXBlID09PSAiYXJyYXkiIHx8IGxlbmd0aCA9PT0gMCB8fCB0eXBlb2YgbGVuZ3RoID09PSAibnVtYmVyIiAmJiBsZW5ndGggPiAwICYmIGxlbmd0aCAtIDEgaW4gb2JqOwogIH0KICB2YXIgU2l6emxlID0KICAvKiEKICAqIFNpenpsZSBDU1MgU2VsZWN0b3IgRW5naW5lIHYyLjMuNQogICogaHR0cHM6Ly9zaXp6bGVqcy5jb20vCiAgKgogICogQ29weXJpZ2h0IEpTIEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAgKiBodHRwczovL2pzLmZvdW5kYXRpb24vCiAgKgogICogRGF0ZTogMjAyMC0wMy0xNAogICovCiAgZnVuY3Rpb24gKHdpbmRvdykgewogICAgdmFyIGksCiAgICAgIHN1cHBvcnQsCiAgICAgIEV4cHIsCiAgICAgIGdldFRleHQsCiAgICAgIGlzWE1MLAogICAgICB0b2tlbml6ZSwKICAgICAgY29tcGlsZSwKICAgICAgc2VsZWN0LAogICAgICBvdXRlcm1vc3RDb250ZXh0LAogICAgICBzb3J0SW5wdXQsCiAgICAgIGhhc0R1cGxpY2F0ZSwKICAgICAgLy8gTG9jYWwgZG9jdW1lbnQgdmFycwogICAgICBzZXREb2N1bWVudCwKICAgICAgZG9jdW1lbnQsCiAgICAgIGRvY0VsZW0sCiAgICAgIGRvY3VtZW50SXNIVE1MLAogICAgICByYnVnZ3lRU0EsCiAgICAgIHJidWdneU1hdGNoZXMsCiAgICAgIG1hdGNoZXMsCiAgICAgIGNvbnRhaW5zLAogICAgICAvLyBJbnN0YW5jZS1zcGVjaWZpYyBkYXRhCiAgICAgIGV4cGFuZG8gPSAic2l6emxlIiArIDEgKiBuZXcgRGF0ZSgpLAogICAgICBwcmVmZXJyZWREb2MgPSB3aW5kb3cuZG9jdW1lbnQsCiAgICAgIGRpcnJ1bnMgPSAwLAogICAgICBkb25lID0gMCwKICAgICAgY2xhc3NDYWNoZSA9IGNyZWF0ZUNhY2hlKCksCiAgICAgIHRva2VuQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLAogICAgICBjb21waWxlckNhY2hlID0gY3JlYXRlQ2FjaGUoKSwKICAgICAgbm9ubmF0aXZlU2VsZWN0b3JDYWNoZSA9IGNyZWF0ZUNhY2hlKCksCiAgICAgIHNvcnRPcmRlciA9IGZ1bmN0aW9uIHNvcnRPcmRlcihhLCBiKSB7CiAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgIGhhc0R1cGxpY2F0ZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgICB9LAogICAgICAvLyBJbnN0YW5jZSBtZXRob2RzCiAgICAgIGhhc093biA9IHt9Lmhhc093blByb3BlcnR5LAogICAgICBhcnIgPSBbXSwKICAgICAgcG9wID0gYXJyLnBvcCwKICAgICAgcHVzaE5hdGl2ZSA9IGFyci5wdXNoLAogICAgICBwdXNoID0gYXJyLnB1c2gsCiAgICAgIHNsaWNlID0gYXJyLnNsaWNlLAogICAgICAvLyBVc2UgYSBzdHJpcHBlZC1kb3duIGluZGV4T2YgYXMgaXQncyBmYXN0ZXIgdGhhbiBuYXRpdmUKICAgICAgLy8gaHR0cHM6Ly9qc3BlcmYuY29tL3Rob3ItaW5kZXhvZi12cy1mb3IvNQogICAgICBpbmRleE9mID0gZnVuY3Rpb24gaW5kZXhPZihsaXN0LCBlbGVtKSB7CiAgICAgICAgdmFyIGkgPSAwLAogICAgICAgICAgbGVuID0gbGlzdC5sZW5ndGg7CiAgICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgaWYgKGxpc3RbaV0gPT09IGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiAtMTsKICAgICAgfSwKICAgICAgYm9vbGVhbnMgPSAiY2hlY2tlZHxzZWxlY3RlZHxhc3luY3xhdXRvZm9jdXN8YXV0b3BsYXl8Y29udHJvbHN8ZGVmZXJ8ZGlzYWJsZWR8aGlkZGVufCIgKyAiaXNtYXB8bG9vcHxtdWx0aXBsZXxvcGVufHJlYWRvbmx5fHJlcXVpcmVkfHNjb3BlZCIsCiAgICAgIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbnMKCiAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtc2VsZWN0b3JzLyN3aGl0ZXNwYWNlCiAgICAgIHdoaXRlc3BhY2UgPSAiW1xceDIwXFx0XFxyXFxuXFxmXSIsCiAgICAgIC8vIGh0dHBzOi8vd3d3LnczLm9yZy9UUi9jc3Mtc3ludGF4LTMvI2lkZW50LXRva2VuLWRpYWdyYW0KICAgICAgaWRlbnRpZmllciA9ICIoPzpcXFxcW1xcZGEtZkEtRl17MSw2fSIgKyB3aGl0ZXNwYWNlICsgIj98XFxcXFteXFxyXFxuXFxmXXxbXFx3LV18W15cMC1cXHg3Zl0pKyIsCiAgICAgIC8vIEF0dHJpYnV0ZSBzZWxlY3RvcnM6IGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jYXR0cmlidXRlLXNlbGVjdG9ycwogICAgICBhdHRyaWJ1dGVzID0gIlxcWyIgKyB3aGl0ZXNwYWNlICsgIiooIiArIGlkZW50aWZpZXIgKyAiKSg/OiIgKyB3aGl0ZXNwYWNlICsKICAgICAgLy8gT3BlcmF0b3IgKGNhcHR1cmUgMikKICAgICAgIiooWypeJHwhfl0/PSkiICsgd2hpdGVzcGFjZSArCiAgICAgIC8vICJBdHRyaWJ1dGUgdmFsdWVzIG11c3QgYmUgQ1NTIGlkZW50aWZpZXJzIFtjYXB0dXJlIDVdCiAgICAgIC8vIG9yIHN0cmluZ3MgW2NhcHR1cmUgMyBvciBjYXB0dXJlIDRdIgogICAgICAiKig/OicoKD86XFxcXC58W15cXFxcJ10pKiknfFwiKCg/OlxcXFwufFteXFxcXFwiXSkqKVwifCgiICsgaWRlbnRpZmllciArICIpKXwpIiArIHdoaXRlc3BhY2UgKyAiKlxcXSIsCiAgICAgIHBzZXVkb3MgPSAiOigiICsgaWRlbnRpZmllciArICIpKD86XFwoKCIgKwogICAgICAvLyBUbyByZWR1Y2UgdGhlIG51bWJlciBvZiBzZWxlY3RvcnMgbmVlZGluZyB0b2tlbml6ZSBpbiB0aGUgcHJlRmlsdGVyLCBwcmVmZXIgYXJndW1lbnRzOgogICAgICAvLyAxLiBxdW90ZWQgKGNhcHR1cmUgMzsgY2FwdHVyZSA0IG9yIGNhcHR1cmUgNSkKICAgICAgIignKCg/OlxcXFwufFteXFxcXCddKSopJ3xcIigoPzpcXFxcLnxbXlxcXFxcIl0pKilcIil8IiArCiAgICAgIC8vIDIuIHNpbXBsZSAoY2FwdHVyZSA2KQogICAgICAiKCg/OlxcXFwufFteXFxcXCgpW1xcXV18IiArIGF0dHJpYnV0ZXMgKyAiKSopfCIgKwogICAgICAvLyAzLiBhbnl0aGluZyBlbHNlIChjYXB0dXJlIDIpCiAgICAgICIuKiIgKyAiKVxcKXwpIiwKICAgICAgLy8gTGVhZGluZyBhbmQgbm9uLWVzY2FwZWQgdHJhaWxpbmcgd2hpdGVzcGFjZSwgY2FwdHVyaW5nIHNvbWUgbm9uLXdoaXRlc3BhY2UgY2hhcmFjdGVycyBwcmVjZWRpbmcgdGhlIGxhdHRlcgogICAgICByd2hpdGVzcGFjZSA9IG5ldyBSZWdFeHAod2hpdGVzcGFjZSArICIrIiwgImciKSwKICAgICAgcnRyaW0gPSBuZXcgUmVnRXhwKCJeIiArIHdoaXRlc3BhY2UgKyAiK3woKD86XnxbXlxcXFxdKSg/OlxcXFwuKSopIiArIHdoaXRlc3BhY2UgKyAiKyQiLCAiZyIpLAogICAgICByY29tbWEgPSBuZXcgUmVnRXhwKCJeIiArIHdoaXRlc3BhY2UgKyAiKiwiICsgd2hpdGVzcGFjZSArICIqIiksCiAgICAgIHJjb21iaW5hdG9ycyA9IG5ldyBSZWdFeHAoIl4iICsgd2hpdGVzcGFjZSArICIqKFs+K35dfCIgKyB3aGl0ZXNwYWNlICsgIikiICsgd2hpdGVzcGFjZSArICIqIiksCiAgICAgIHJkZXNjZW5kID0gbmV3IFJlZ0V4cCh3aGl0ZXNwYWNlICsgInw+IiksCiAgICAgIHJwc2V1ZG8gPSBuZXcgUmVnRXhwKHBzZXVkb3MpLAogICAgICByaWRlbnRpZmllciA9IG5ldyBSZWdFeHAoIl4iICsgaWRlbnRpZmllciArICIkIiksCiAgICAgIG1hdGNoRXhwciA9IHsKICAgICAgICAiSUQiOiBuZXcgUmVnRXhwKCJeIygiICsgaWRlbnRpZmllciArICIpIiksCiAgICAgICAgIkNMQVNTIjogbmV3IFJlZ0V4cCgiXlxcLigiICsgaWRlbnRpZmllciArICIpIiksCiAgICAgICAgIlRBRyI6IG5ldyBSZWdFeHAoIl4oIiArIGlkZW50aWZpZXIgKyAifFsqXSkiKSwKICAgICAgICAiQVRUUiI6IG5ldyBSZWdFeHAoIl4iICsgYXR0cmlidXRlcyksCiAgICAgICAgIlBTRVVETyI6IG5ldyBSZWdFeHAoIl4iICsgcHNldWRvcyksCiAgICAgICAgIkNISUxEIjogbmV3IFJlZ0V4cCgiXjoob25seXxmaXJzdHxsYXN0fG50aHxudGgtbGFzdCktKGNoaWxkfG9mLXR5cGUpKD86XFwoIiArIHdoaXRlc3BhY2UgKyAiKihldmVufG9kZHwoKFsrLV18KShcXGQqKW58KSIgKyB3aGl0ZXNwYWNlICsgIiooPzooWystXXwpIiArIHdoaXRlc3BhY2UgKyAiKihcXGQrKXwpKSIgKyB3aGl0ZXNwYWNlICsgIipcXCl8KSIsICJpIiksCiAgICAgICAgImJvb2wiOiBuZXcgUmVnRXhwKCJeKD86IiArIGJvb2xlYW5zICsgIikkIiwgImkiKSwKICAgICAgICAvLyBGb3IgdXNlIGluIGxpYnJhcmllcyBpbXBsZW1lbnRpbmcgLmlzKCkKICAgICAgICAvLyBXZSB1c2UgdGhpcyBmb3IgUE9TIG1hdGNoaW5nIGluIGBzZWxlY3RgCiAgICAgICAgIm5lZWRzQ29udGV4dCI6IG5ldyBSZWdFeHAoIl4iICsgd2hpdGVzcGFjZSArICIqWz4rfl18OihldmVufG9kZHxlcXxndHxsdHxudGh8Zmlyc3R8bGFzdCkoPzpcXCgiICsgd2hpdGVzcGFjZSArICIqKCg/Oi1cXGQpP1xcZCopIiArIHdoaXRlc3BhY2UgKyAiKlxcKXwpKD89W14tXXwkKSIsICJpIikKICAgICAgfSwKICAgICAgcmh0bWwgPSAvSFRNTCQvaSwKICAgICAgcmlucHV0cyA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbikkL2ksCiAgICAgIHJoZWFkZXIgPSAvXmhcZCQvaSwKICAgICAgcm5hdGl2ZSA9IC9eW157XStce1xzKlxbbmF0aXZlIFx3LywKICAgICAgLy8gRWFzaWx5LXBhcnNlYWJsZS9yZXRyaWV2YWJsZSBJRCBvciBUQUcgb3IgQ0xBU1Mgc2VsZWN0b3JzCiAgICAgIHJxdWlja0V4cHIgPSAvXig/OiMoW1x3LV0rKXwoXHcrKXxcLihbXHctXSspKSQvLAogICAgICByc2libGluZyA9IC9bK35dLywKICAgICAgLy8gQ1NTIGVzY2FwZXMKICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI2VzY2FwZWQtY2hhcmFjdGVycwogICAgICBydW5lc2NhcGUgPSBuZXcgUmVnRXhwKCJcXFxcW1xcZGEtZkEtRl17MSw2fSIgKyB3aGl0ZXNwYWNlICsgIj98XFxcXChbXlxcclxcblxcZl0pIiwgImciKSwKICAgICAgZnVuZXNjYXBlID0gZnVuY3Rpb24gZnVuZXNjYXBlKGVzY2FwZSwgbm9uSGV4KSB7CiAgICAgICAgdmFyIGhpZ2ggPSAiMHgiICsgZXNjYXBlLnNsaWNlKDEpIC0gMHgxMDAwMDsKICAgICAgICByZXR1cm4gbm9uSGV4ID8KICAgICAgICAvLyBTdHJpcCB0aGUgYmFja3NsYXNoIHByZWZpeCBmcm9tIGEgbm9uLWhleCBlc2NhcGUgc2VxdWVuY2UKICAgICAgICBub25IZXggOgogICAgICAgIC8vIFJlcGxhY2UgYSBoZXhhZGVjaW1hbCBlc2NhcGUgc2VxdWVuY2Ugd2l0aCB0aGUgZW5jb2RlZCBVbmljb2RlIGNvZGUgcG9pbnQKICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTExKwogICAgICAgIC8vIEZvciB2YWx1ZXMgb3V0c2lkZSB0aGUgQmFzaWMgTXVsdGlsaW5ndWFsIFBsYW5lIChCTVApLCBtYW51YWxseSBjb25zdHJ1Y3QgYQogICAgICAgIC8vIHN1cnJvZ2F0ZSBwYWlyCiAgICAgICAgaGlnaCA8IDAgPyBTdHJpbmcuZnJvbUNoYXJDb2RlKGhpZ2ggKyAweDEwMDAwKSA6IFN0cmluZy5mcm9tQ2hhckNvZGUoaGlnaCA+PiAxMCB8IDB4RDgwMCwgaGlnaCAmIDB4M0ZGIHwgMHhEQzAwKTsKICAgICAgfSwKICAgICAgLy8gQ1NTIHN0cmluZy9pZGVudGlmaWVyIHNlcmlhbGl6YXRpb24KICAgICAgLy8gaHR0cHM6Ly9kcmFmdHMuY3Nzd2cub3JnL2Nzc29tLyNjb21tb24tc2VyaWFsaXppbmctaWRpb21zCiAgICAgIHJjc3Nlc2NhcGUgPSAvKFtcMC1ceDFmXHg3Zl18Xi0/XGQpfF4tJHxbXlwwLVx4MWZceDdmLVx1RkZGRlx3LV0vZywKICAgICAgZmNzc2VzY2FwZSA9IGZ1bmN0aW9uIGZjc3Nlc2NhcGUoY2gsIGFzQ29kZVBvaW50KSB7CiAgICAgICAgaWYgKGFzQ29kZVBvaW50KSB7CiAgICAgICAgICAvLyBVKzAwMDAgTlVMTCBiZWNvbWVzIFUrRkZGRCBSRVBMQUNFTUVOVCBDSEFSQUNURVIKICAgICAgICAgIGlmIChjaCA9PT0gIlwwIikgewogICAgICAgICAgICByZXR1cm4gIlx1RkZGRCI7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQ29udHJvbCBjaGFyYWN0ZXJzIGFuZCAoZGVwZW5kZW50IHVwb24gcG9zaXRpb24pIG51bWJlcnMgZ2V0IGVzY2FwZWQgYXMgY29kZSBwb2ludHMKICAgICAgICAgIHJldHVybiBjaC5zbGljZSgwLCAtMSkgKyAiXFwiICsgY2guY2hhckNvZGVBdChjaC5sZW5ndGggLSAxKS50b1N0cmluZygxNikgKyAiICI7CiAgICAgICAgfQoKICAgICAgICAvLyBPdGhlciBwb3RlbnRpYWxseS1zcGVjaWFsIEFTQ0lJIGNoYXJhY3RlcnMgZ2V0IGJhY2tzbGFzaC1lc2NhcGVkCiAgICAgICAgcmV0dXJuICJcXCIgKyBjaDsKICAgICAgfSwKICAgICAgLy8gVXNlZCBmb3IgaWZyYW1lcwogICAgICAvLyBTZWUgc2V0RG9jdW1lbnQoKQogICAgICAvLyBSZW1vdmluZyB0aGUgZnVuY3Rpb24gd3JhcHBlciBjYXVzZXMgYSAiUGVybWlzc2lvbiBEZW5pZWQiCiAgICAgIC8vIGVycm9yIGluIElFCiAgICAgIHVubG9hZEhhbmRsZXIgPSBmdW5jdGlvbiB1bmxvYWRIYW5kbGVyKCkgewogICAgICAgIHNldERvY3VtZW50KCk7CiAgICAgIH0sCiAgICAgIGluRGlzYWJsZWRGaWVsZHNldCA9IGFkZENvbWJpbmF0b3IoZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICByZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gdHJ1ZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJmaWVsZHNldCI7CiAgICAgIH0sIHsKICAgICAgICBkaXI6ICJwYXJlbnROb2RlIiwKICAgICAgICBuZXh0OiAibGVnZW5kIgogICAgICB9KTsKCiAgICAvLyBPcHRpbWl6ZSBmb3IgcHVzaC5hcHBseSggXywgTm9kZUxpc3QgKQogICAgdHJ5IHsKICAgICAgcHVzaC5hcHBseShhcnIgPSBzbGljZS5jYWxsKHByZWZlcnJlZERvYy5jaGlsZE5vZGVzKSwgcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMpOwoKICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZDw0LjAKICAgICAgLy8gRGV0ZWN0IHNpbGVudGx5IGZhaWxpbmcgcHVzaC5hcHBseQogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLWV4cHJlc3Npb25zCiAgICAgIGFycltwcmVmZXJyZWREb2MuY2hpbGROb2Rlcy5sZW5ndGhdLm5vZGVUeXBlOwogICAgfSBjYXRjaCAoZSkgewogICAgICBwdXNoID0gewogICAgICAgIGFwcGx5OiBhcnIubGVuZ3RoID8KICAgICAgICAvLyBMZXZlcmFnZSBzbGljZSBpZiBwb3NzaWJsZQogICAgICAgIGZ1bmN0aW9uICh0YXJnZXQsIGVscykgewogICAgICAgICAgcHVzaE5hdGl2ZS5hcHBseSh0YXJnZXQsIHNsaWNlLmNhbGwoZWxzKSk7CiAgICAgICAgfSA6CiAgICAgICAgLy8gU3VwcG9ydDogSUU8OQogICAgICAgIC8vIE90aGVyd2lzZSBhcHBlbmQgZGlyZWN0bHkKICAgICAgICBmdW5jdGlvbiAodGFyZ2V0LCBlbHMpIHsKICAgICAgICAgIHZhciBqID0gdGFyZ2V0Lmxlbmd0aCwKICAgICAgICAgICAgaSA9IDA7CgogICAgICAgICAgLy8gQ2FuJ3QgdHJ1c3QgTm9kZUxpc3QubGVuZ3RoCiAgICAgICAgICB3aGlsZSAodGFyZ2V0W2orK10gPSBlbHNbaSsrXSkge30KICAgICAgICAgIHRhcmdldC5sZW5ndGggPSBqIC0gMTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBTaXp6bGUoc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQpIHsKICAgICAgdmFyIG0sCiAgICAgICAgaSwKICAgICAgICBlbGVtLAogICAgICAgIG5pZCwKICAgICAgICBtYXRjaCwKICAgICAgICBncm91cHMsCiAgICAgICAgbmV3U2VsZWN0b3IsCiAgICAgICAgbmV3Q29udGV4dCA9IGNvbnRleHQgJiYgY29udGV4dC5vd25lckRvY3VtZW50LAogICAgICAgIC8vIG5vZGVUeXBlIGRlZmF1bHRzIHRvIDksIHNpbmNlIGNvbnRleHQgZGVmYXVsdHMgdG8gZG9jdW1lbnQKICAgICAgICBub2RlVHlwZSA9IGNvbnRleHQgPyBjb250ZXh0Lm5vZGVUeXBlIDogOTsKICAgICAgcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107CgogICAgICAvLyBSZXR1cm4gZWFybHkgZnJvbSBjYWxscyB3aXRoIGludmFsaWQgc2VsZWN0b3Igb3IgY29udGV4dAogICAgICBpZiAodHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIiB8fCAhc2VsZWN0b3IgfHwgbm9kZVR5cGUgIT09IDEgJiYgbm9kZVR5cGUgIT09IDkgJiYgbm9kZVR5cGUgIT09IDExKSB7CiAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgIH0KCiAgICAgIC8vIFRyeSB0byBzaG9ydGN1dCBmaW5kIG9wZXJhdGlvbnMgKGFzIG9wcG9zZWQgdG8gZmlsdGVycykgaW4gSFRNTCBkb2N1bWVudHMKICAgICAgaWYgKCFzZWVkKSB7CiAgICAgICAgc2V0RG9jdW1lbnQoY29udGV4dCk7CiAgICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CiAgICAgICAgaWYgKGRvY3VtZW50SXNIVE1MKSB7CiAgICAgICAgICAvLyBJZiB0aGUgc2VsZWN0b3IgaXMgc3VmZmljaWVudGx5IHNpbXBsZSwgdHJ5IHVzaW5nIGEgImdldCpCeSoiIERPTSBtZXRob2QKICAgICAgICAgIC8vIChleGNlcHRpbmcgRG9jdW1lbnRGcmFnbWVudCBjb250ZXh0LCB3aGVyZSB0aGUgbWV0aG9kcyBkb24ndCBleGlzdCkKICAgICAgICAgIGlmIChub2RlVHlwZSAhPT0gMTEgJiYgKG1hdGNoID0gcnF1aWNrRXhwci5leGVjKHNlbGVjdG9yKSkpIHsKICAgICAgICAgICAgLy8gSUQgc2VsZWN0b3IKICAgICAgICAgICAgaWYgKG0gPSBtYXRjaFsxXSkgewogICAgICAgICAgICAgIC8vIERvY3VtZW50IGNvbnRleHQKICAgICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChtKSkgewogICAgICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBJRSwgT3BlcmEsIFdlYmtpdAogICAgICAgICAgICAgICAgICAvLyBUT0RPOiBpZGVudGlmeSB2ZXJzaW9ucwogICAgICAgICAgICAgICAgICAvLyBnZXRFbGVtZW50QnlJZCBjYW4gbWF0Y2ggZWxlbWVudHMgYnkgbmFtZSBpbnN0ZWFkIG9mIElECiAgICAgICAgICAgICAgICAgIGlmIChlbGVtLmlkID09PSBtKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGVsZW0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBFbGVtZW50IGNvbnRleHQKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gU3VwcG9ydDogSUUsIE9wZXJhLCBXZWJraXQKICAgICAgICAgICAgICAgIC8vIFRPRE86IGlkZW50aWZ5IHZlcnNpb25zCiAgICAgICAgICAgICAgICAvLyBnZXRFbGVtZW50QnlJZCBjYW4gbWF0Y2ggZWxlbWVudHMgYnkgbmFtZSBpbnN0ZWFkIG9mIElECiAgICAgICAgICAgICAgICBpZiAobmV3Q29udGV4dCAmJiAoZWxlbSA9IG5ld0NvbnRleHQuZ2V0RWxlbWVudEJ5SWQobSkpICYmIGNvbnRhaW5zKGNvbnRleHQsIGVsZW0pICYmIGVsZW0uaWQgPT09IG0pIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGVsZW0pOwogICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIFR5cGUgc2VsZWN0b3IKICAgICAgICAgICAgfSBlbHNlIGlmIChtYXRjaFsyXSkgewogICAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZShzZWxlY3RvcikpOwogICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwoKICAgICAgICAgICAgICAvLyBDbGFzcyBzZWxlY3RvcgogICAgICAgICAgICB9IGVsc2UgaWYgKChtID0gbWF0Y2hbM10pICYmIHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUpIHsKICAgICAgICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdHMsIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShtKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBUYWtlIGFkdmFudGFnZSBvZiBxdWVyeVNlbGVjdG9yQWxsCiAgICAgICAgICBpZiAoc3VwcG9ydC5xc2EgJiYgIW5vbm5hdGl2ZVNlbGVjdG9yQ2FjaGVbc2VsZWN0b3IgKyAiICJdICYmICghcmJ1Z2d5UVNBIHx8ICFyYnVnZ3lRU0EudGVzdChzZWxlY3RvcikpICYmICgKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDggb25seQogICAgICAgICAgLy8gRXhjbHVkZSBvYmplY3QgZWxlbWVudHMKICAgICAgICAgIG5vZGVUeXBlICE9PSAxIHx8IGNvbnRleHQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm9iamVjdCIpKSB7CiAgICAgICAgICAgIG5ld1NlbGVjdG9yID0gc2VsZWN0b3I7CiAgICAgICAgICAgIG5ld0NvbnRleHQgPSBjb250ZXh0OwoKICAgICAgICAgICAgLy8gcVNBIGNvbnNpZGVycyBlbGVtZW50cyBvdXRzaWRlIGEgc2NvcGluZyByb290IHdoZW4gZXZhbHVhdGluZyBjaGlsZCBvcgogICAgICAgICAgICAvLyBkZXNjZW5kYW50IGNvbWJpbmF0b3JzLCB3aGljaCBpcyBub3Qgd2hhdCB3ZSB3YW50LgogICAgICAgICAgICAvLyBJbiBzdWNoIGNhc2VzLCB3ZSB3b3JrIGFyb3VuZCB0aGUgYmVoYXZpb3IgYnkgcHJlZml4aW5nIGV2ZXJ5IHNlbGVjdG9yIGluIHRoZQogICAgICAgICAgICAvLyBsaXN0IHdpdGggYW4gSUQgc2VsZWN0b3IgcmVmZXJlbmNpbmcgdGhlIHNjb3BlIGNvbnRleHQuCiAgICAgICAgICAgIC8vIFRoZSB0ZWNobmlxdWUgaGFzIHRvIGJlIHVzZWQgYXMgd2VsbCB3aGVuIGEgbGVhZGluZyBjb21iaW5hdG9yIGlzIHVzZWQKICAgICAgICAgICAgLy8gYXMgc3VjaCBzZWxlY3RvcnMgYXJlIG5vdCByZWNvZ25pemVkIGJ5IHF1ZXJ5U2VsZWN0b3JBbGwuCiAgICAgICAgICAgIC8vIFRoYW5rcyB0byBBbmRyZXcgRHVwb250IGZvciB0aGlzIHRlY2huaXF1ZS4KICAgICAgICAgICAgaWYgKG5vZGVUeXBlID09PSAxICYmIChyZGVzY2VuZC50ZXN0KHNlbGVjdG9yKSB8fCByY29tYmluYXRvcnMudGVzdChzZWxlY3RvcikpKSB7CiAgICAgICAgICAgICAgLy8gRXhwYW5kIGNvbnRleHQgZm9yIHNpYmxpbmcgc2VsZWN0b3JzCiAgICAgICAgICAgICAgbmV3Q29udGV4dCA9IHJzaWJsaW5nLnRlc3Qoc2VsZWN0b3IpICYmIHRlc3RDb250ZXh0KGNvbnRleHQucGFyZW50Tm9kZSkgfHwgY29udGV4dDsKCiAgICAgICAgICAgICAgLy8gV2UgY2FuIHVzZSA6c2NvcGUgaW5zdGVhZCBvZiB0aGUgSUQgaGFjayBpZiB0aGUgYnJvd3NlcgogICAgICAgICAgICAgIC8vIHN1cHBvcnRzIGl0ICYgaWYgd2UncmUgbm90IGNoYW5naW5nIHRoZSBjb250ZXh0LgogICAgICAgICAgICAgIGlmIChuZXdDb250ZXh0ICE9PSBjb250ZXh0IHx8ICFzdXBwb3J0LnNjb3BlKSB7CiAgICAgICAgICAgICAgICAvLyBDYXB0dXJlIHRoZSBjb250ZXh0IElELCBzZXR0aW5nIGl0IGZpcnN0IGlmIG5lY2Vzc2FyeQogICAgICAgICAgICAgICAgaWYgKG5pZCA9IGNvbnRleHQuZ2V0QXR0cmlidXRlKCJpZCIpKSB7CiAgICAgICAgICAgICAgICAgIG5pZCA9IG5pZC5yZXBsYWNlKHJjc3Nlc2NhcGUsIGZjc3Nlc2NhcGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5zZXRBdHRyaWJ1dGUoImlkIiwgbmlkID0gZXhwYW5kbyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBQcmVmaXggZXZlcnkgc2VsZWN0b3IgaW4gdGhlIGxpc3QKICAgICAgICAgICAgICBncm91cHMgPSB0b2tlbml6ZShzZWxlY3Rvcik7CiAgICAgICAgICAgICAgaSA9IGdyb3Vwcy5sZW5ndGg7CiAgICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgICAgZ3JvdXBzW2ldID0gKG5pZCA/ICIjIiArIG5pZCA6ICI6c2NvcGUiKSArICIgIiArIHRvU2VsZWN0b3IoZ3JvdXBzW2ldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbmV3U2VsZWN0b3IgPSBncm91cHMuam9pbigiLCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcHVzaC5hcHBseShyZXN1bHRzLCBuZXdDb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwobmV3U2VsZWN0b3IpKTsKICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgfSBjYXRjaCAocXNhRXJyb3IpIHsKICAgICAgICAgICAgICBub25uYXRpdmVTZWxlY3RvckNhY2hlKHNlbGVjdG9yLCB0cnVlKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBpZiAobmlkID09PSBleHBhbmRvKSB7CiAgICAgICAgICAgICAgICBjb250ZXh0LnJlbW92ZUF0dHJpYnV0ZSgiaWQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIEFsbCBvdGhlcnMKICAgICAgcmV0dXJuIHNlbGVjdChzZWxlY3Rvci5yZXBsYWNlKHJ0cmltLCAiJDEiKSwgY29udGV4dCwgcmVzdWx0cywgc2VlZCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGUga2V5LXZhbHVlIGNhY2hlcyBvZiBsaW1pdGVkIHNpemUKICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihzdHJpbmcsIG9iamVjdCl9IFJldHVybnMgdGhlIE9iamVjdCBkYXRhIGFmdGVyIHN0b3JpbmcgaXQgb24gaXRzZWxmIHdpdGgKICAgICAqCXByb3BlcnR5IG5hbWUgdGhlIChzcGFjZS1zdWZmaXhlZCkgc3RyaW5nIGFuZCAoaWYgdGhlIGNhY2hlIGlzIGxhcmdlciB0aGFuIEV4cHIuY2FjaGVMZW5ndGgpCiAgICAgKglkZWxldGluZyB0aGUgb2xkZXN0IGVudHJ5CiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUNhY2hlKCkgewogICAgICB2YXIga2V5cyA9IFtdOwogICAgICBmdW5jdGlvbiBjYWNoZShrZXksIHZhbHVlKSB7CiAgICAgICAgLy8gVXNlIChrZXkgKyAiICIpIHRvIGF2b2lkIGNvbGxpc2lvbiB3aXRoIG5hdGl2ZSBwcm90b3R5cGUgcHJvcGVydGllcyAoc2VlIElzc3VlICMxNTcpCiAgICAgICAgaWYgKGtleXMucHVzaChrZXkgKyAiICIpID4gRXhwci5jYWNoZUxlbmd0aCkgewogICAgICAgICAgLy8gT25seSBrZWVwIHRoZSBtb3N0IHJlY2VudCBlbnRyaWVzCiAgICAgICAgICBkZWxldGUgY2FjaGVba2V5cy5zaGlmdCgpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhY2hlW2tleSArICIgIl0gPSB2YWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gY2FjaGU7CiAgICB9CgogICAgLyoqCiAgICAgKiBNYXJrIGEgZnVuY3Rpb24gZm9yIHNwZWNpYWwgdXNlIGJ5IFNpenpsZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIG1hcmsKICAgICAqLwogICAgZnVuY3Rpb24gbWFya0Z1bmN0aW9uKGZuKSB7CiAgICAgIGZuW2V4cGFuZG9dID0gdHJ1ZTsKICAgICAgcmV0dXJuIGZuOwogICAgfQoKICAgIC8qKgogICAgICogU3VwcG9ydCB0ZXN0aW5nIHVzaW5nIGFuIGVsZW1lbnQKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFBhc3NlZCB0aGUgY3JlYXRlZCBlbGVtZW50IGFuZCByZXR1cm5zIGEgYm9vbGVhbiByZXN1bHQKICAgICAqLwogICAgZnVuY3Rpb24gYXNzZXJ0KGZuKSB7CiAgICAgIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImZpZWxkc2V0Iik7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuICEhZm4oZWwpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIC8vIFJlbW92ZSBmcm9tIGl0cyBwYXJlbnQgYnkgZGVmYXVsdAogICAgICAgIGlmIChlbC5wYXJlbnROb2RlKSB7CiAgICAgICAgICBlbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsKTsKICAgICAgICB9CgogICAgICAgIC8vIHJlbGVhc2UgbWVtb3J5IGluIElFCiAgICAgICAgZWwgPSBudWxsOwogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBBZGRzIHRoZSBzYW1lIGhhbmRsZXIgZm9yIGFsbCBvZiB0aGUgc3BlY2lmaWVkIGF0dHJzCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gYXR0cnMgUGlwZS1zZXBhcmF0ZWQgbGlzdCBvZiBhdHRyaWJ1dGVzCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyIFRoZSBtZXRob2QgdGhhdCB3aWxsIGJlIGFwcGxpZWQKICAgICAqLwogICAgZnVuY3Rpb24gYWRkSGFuZGxlKGF0dHJzLCBoYW5kbGVyKSB7CiAgICAgIHZhciBhcnIgPSBhdHRycy5zcGxpdCgifCIpLAogICAgICAgIGkgPSBhcnIubGVuZ3RoOwogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgRXhwci5hdHRySGFuZGxlW2FycltpXV0gPSBoYW5kbGVyOwogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgZG9jdW1lbnQgb3JkZXIgb2YgdHdvIHNpYmxpbmdzCiAgICAgKiBAcGFyYW0ge0VsZW1lbnR9IGEKICAgICAqIEBwYXJhbSB7RWxlbWVudH0gYgogICAgICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyBsZXNzIHRoYW4gMCBpZiBhIHByZWNlZGVzIGIsIGdyZWF0ZXIgdGhhbiAwIGlmIGEgZm9sbG93cyBiCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNpYmxpbmdDaGVjayhhLCBiKSB7CiAgICAgIHZhciBjdXIgPSBiICYmIGEsCiAgICAgICAgZGlmZiA9IGN1ciAmJiBhLm5vZGVUeXBlID09PSAxICYmIGIubm9kZVR5cGUgPT09IDEgJiYgYS5zb3VyY2VJbmRleCAtIGIuc291cmNlSW5kZXg7CgogICAgICAvLyBVc2UgSUUgc291cmNlSW5kZXggaWYgYXZhaWxhYmxlIG9uIGJvdGggbm9kZXMKICAgICAgaWYgKGRpZmYpIHsKICAgICAgICByZXR1cm4gZGlmZjsKICAgICAgfQoKICAgICAgLy8gQ2hlY2sgaWYgYiBmb2xsb3dzIGEKICAgICAgaWYgKGN1cikgewogICAgICAgIHdoaWxlIChjdXIgPSBjdXIubmV4dFNpYmxpbmcpIHsKICAgICAgICAgIGlmIChjdXIgPT09IGIpIHsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYSA/IDEgOiAtMTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgaW5wdXQgdHlwZXMKICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUlucHV0UHNldWRvKHR5cGUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgcmV0dXJuIG5hbWUgPT09ICJpbnB1dCIgJiYgZWxlbS50eXBlID09PSB0eXBlOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBidXR0b25zCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVCdXR0b25Qc2V1ZG8odHlwZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm4gKG5hbWUgPT09ICJpbnB1dCIgfHwgbmFtZSA9PT0gImJ1dHRvbiIpICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgOmVuYWJsZWQvOmRpc2FibGVkCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGRpc2FibGVkIHRydWUgZm9yIDpkaXNhYmxlZDsgZmFsc2UgZm9yIDplbmFibGVkCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZURpc2FibGVkUHNldWRvKGRpc2FibGVkKSB7CiAgICAgIC8vIEtub3duIDpkaXNhYmxlZCBmYWxzZSBwb3NpdGl2ZXM6IGZpZWxkc2V0W2Rpc2FibGVkXSA+IGxlZ2VuZDpudGgtb2YtdHlwZShuKzIpIDpjYW4tZGlzYWJsZQogICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAvLyBPbmx5IGNlcnRhaW4gZWxlbWVudHMgY2FuIG1hdGNoIDplbmFibGVkIG9yIDpkaXNhYmxlZAogICAgICAgIC8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3NjcmlwdGluZy5odG1sI3NlbGVjdG9yLWVuYWJsZWQKICAgICAgICAvLyBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9zY3JpcHRpbmcuaHRtbCNzZWxlY3Rvci1kaXNhYmxlZAogICAgICAgIGlmICgiZm9ybSIgaW4gZWxlbSkgewogICAgICAgICAgLy8gQ2hlY2sgZm9yIGluaGVyaXRlZCBkaXNhYmxlZG5lc3Mgb24gcmVsZXZhbnQgbm9uLWRpc2FibGVkIGVsZW1lbnRzOgogICAgICAgICAgLy8gKiBsaXN0ZWQgZm9ybS1hc3NvY2lhdGVkIGVsZW1lbnRzIGluIGEgZGlzYWJsZWQgZmllbGRzZXQKICAgICAgICAgIC8vICAgaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2UvZm9ybXMuaHRtbCNjYXRlZ29yeS1saXN0ZWQKICAgICAgICAgIC8vICAgaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2UvZm9ybXMuaHRtbCNjb25jZXB0LWZlLWRpc2FibGVkCiAgICAgICAgICAvLyAqIG9wdGlvbiBlbGVtZW50cyBpbiBhIGRpc2FibGVkIG9wdGdyb3VwCiAgICAgICAgICAvLyAgIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL2Zvcm1zLmh0bWwjY29uY2VwdC1vcHRpb24tZGlzYWJsZWQKICAgICAgICAgIC8vIEFsbCBzdWNoIGVsZW1lbnRzIGhhdmUgYSAiZm9ybSIgcHJvcGVydHkuCiAgICAgICAgICBpZiAoZWxlbS5wYXJlbnROb2RlICYmIGVsZW0uZGlzYWJsZWQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIE9wdGlvbiBlbGVtZW50cyBkZWZlciB0byBhIHBhcmVudCBvcHRncm91cCBpZiBwcmVzZW50CiAgICAgICAgICAgIGlmICgibGFiZWwiIGluIGVsZW0pIHsKICAgICAgICAgICAgICBpZiAoImxhYmVsIiBpbiBlbGVtLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLnBhcmVudE5vZGUuZGlzYWJsZWQgPT09IGRpc2FibGVkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gZGlzYWJsZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA2IC0gMTEKICAgICAgICAgICAgLy8gVXNlIHRoZSBpc0Rpc2FibGVkIHNob3J0Y3V0IHByb3BlcnR5IHRvIGNoZWNrIGZvciBkaXNhYmxlZCBmaWVsZHNldCBhbmNlc3RvcnMKICAgICAgICAgICAgcmV0dXJuIGVsZW0uaXNEaXNhYmxlZCA9PT0gZGlzYWJsZWQgfHwKICAgICAgICAgICAgLy8gV2hlcmUgdGhlcmUgaXMgbm8gaXNEaXNhYmxlZCwgY2hlY2sgbWFudWFsbHkKICAgICAgICAgICAgLyoganNoaW50IC1XMDE4ICovCiAgICAgICAgICAgIGVsZW0uaXNEaXNhYmxlZCAhPT0gIWRpc2FibGVkICYmIGluRGlzYWJsZWRGaWVsZHNldChlbGVtKSA9PT0gZGlzYWJsZWQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gZGlzYWJsZWQ7CgogICAgICAgICAgLy8gVHJ5IHRvIHdpbm5vdyBvdXQgZWxlbWVudHMgdGhhdCBjYW4ndCBiZSBkaXNhYmxlZCBiZWZvcmUgdHJ1c3RpbmcgdGhlIGRpc2FibGVkIHByb3BlcnR5LgogICAgICAgICAgLy8gU29tZSB2aWN0aW1zIGdldCBjYXVnaHQgaW4gb3VyIG5ldCAobGFiZWwsIGxlZ2VuZCwgbWVudSwgdHJhY2spLCBidXQgaXQgc2hvdWxkbid0CiAgICAgICAgICAvLyBldmVuIGV4aXN0IG9uIHRoZW0sIGxldCBhbG9uZSBoYXZlIGEgYm9vbGVhbiB2YWx1ZS4KICAgICAgICB9IGVsc2UgaWYgKCJsYWJlbCIgaW4gZWxlbSkgewogICAgICAgICAgcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IGRpc2FibGVkOwogICAgICAgIH0KCiAgICAgICAgLy8gUmVtYWluaW5nIGVsZW1lbnRzIGFyZSBuZWl0aGVyIDplbmFibGVkIG5vciA6ZGlzYWJsZWQKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIHBvc2l0aW9uYWxzCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZuKSB7CiAgICAgIHJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKGFyZ3VtZW50KSB7CiAgICAgICAgYXJndW1lbnQgPSArYXJndW1lbnQ7CiAgICAgICAgcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiAoc2VlZCwgbWF0Y2hlcykgewogICAgICAgICAgdmFyIGosCiAgICAgICAgICAgIG1hdGNoSW5kZXhlcyA9IGZuKFtdLCBzZWVkLmxlbmd0aCwgYXJndW1lbnQpLAogICAgICAgICAgICBpID0gbWF0Y2hJbmRleGVzLmxlbmd0aDsKCiAgICAgICAgICAvLyBNYXRjaCBlbGVtZW50cyBmb3VuZCBhdCB0aGUgc3BlY2lmaWVkIGluZGV4ZXMKICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgaWYgKHNlZWRbaiA9IG1hdGNoSW5kZXhlc1tpXV0pIHsKICAgICAgICAgICAgICBzZWVkW2pdID0gIShtYXRjaGVzW2pdID0gc2VlZFtqXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgYSBub2RlIGZvciB2YWxpZGl0eSBhcyBhIFNpenpsZSBjb250ZXh0CiAgICAgKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0PX0gY29udGV4dAogICAgICogQHJldHVybnMge0VsZW1lbnR8T2JqZWN0fEJvb2xlYW59IFRoZSBpbnB1dCBub2RlIGlmIGFjY2VwdGFibGUsIG90aGVyd2lzZSBhIGZhbHN5IHZhbHVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRlc3RDb250ZXh0KGNvbnRleHQpIHsKICAgICAgcmV0dXJuIGNvbnRleHQgJiYgdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnRleHQ7CiAgICB9CgogICAgLy8gRXhwb3NlIHN1cHBvcnQgdmFycyBmb3IgY29udmVuaWVuY2UKICAgIHN1cHBvcnQgPSBTaXp6bGUuc3VwcG9ydCA9IHt9OwoKICAgIC8qKgogICAgICogRGV0ZWN0cyBYTUwgbm9kZXMKICAgICAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3R9IGVsZW0gQW4gZWxlbWVudCBvciBhIGRvY3VtZW50CiAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gVHJ1ZSBpZmYgZWxlbSBpcyBhIG5vbi1IVE1MIFhNTCBub2RlCiAgICAgKi8KICAgIGlzWE1MID0gU2l6emxlLmlzWE1MID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgdmFyIG5hbWVzcGFjZSA9IGVsZW0ubmFtZXNwYWNlVVJJLAogICAgICAgIGRvY0VsZW0gPSAoZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0pLmRvY3VtZW50RWxlbWVudDsKCiAgICAgIC8vIFN1cHBvcnQ6IElFIDw9OAogICAgICAvLyBBc3N1bWUgSFRNTCB3aGVuIGRvY3VtZW50RWxlbWVudCBkb2Vzbid0IHlldCBleGlzdCwgc3VjaCBhcyBpbnNpZGUgbG9hZGluZyBpZnJhbWVzCiAgICAgIC8vIGh0dHBzOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC80ODMzCiAgICAgIHJldHVybiAhcmh0bWwudGVzdChuYW1lc3BhY2UgfHwgZG9jRWxlbSAmJiBkb2NFbGVtLm5vZGVOYW1lIHx8ICJIVE1MIik7CiAgICB9OwoKICAgIC8qKgogICAgICogU2V0cyBkb2N1bWVudC1yZWxhdGVkIHZhcmlhYmxlcyBvbmNlIGJhc2VkIG9uIHRoZSBjdXJyZW50IGRvY3VtZW50CiAgICAgKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0fSBbZG9jXSBBbiBlbGVtZW50IG9yIGRvY3VtZW50IG9iamVjdCB0byB1c2UgdG8gc2V0IHRoZSBkb2N1bWVudAogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgY3VycmVudCBkb2N1bWVudAogICAgICovCiAgICBzZXREb2N1bWVudCA9IFNpenpsZS5zZXREb2N1bWVudCA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgIHZhciBoYXNDb21wYXJlLAogICAgICAgIHN1YldpbmRvdywKICAgICAgICBkb2MgPSBub2RlID8gbm9kZS5vd25lckRvY3VtZW50IHx8IG5vZGUgOiBwcmVmZXJyZWREb2M7CgogICAgICAvLyBSZXR1cm4gZWFybHkgaWYgZG9jIGlzIGludmFsaWQgb3IgYWxyZWFkeSBzZWxlY3RlZAogICAgICAvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsKICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuCiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBlcWVxZXEKICAgICAgaWYgKGRvYyA9PSBkb2N1bWVudCB8fCBkb2Mubm9kZVR5cGUgIT09IDkgfHwgIWRvYy5kb2N1bWVudEVsZW1lbnQpIHsKICAgICAgICByZXR1cm4gZG9jdW1lbnQ7CiAgICAgIH0KCiAgICAgIC8vIFVwZGF0ZSBnbG9iYWwgdmFyaWFibGVzCiAgICAgIGRvY3VtZW50ID0gZG9jOwogICAgICBkb2NFbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgICBkb2N1bWVudElzSFRNTCA9ICFpc1hNTChkb2N1bWVudCk7CgogICAgICAvLyBTdXBwb3J0OiBJRSA5IC0gMTErLCBFZGdlIDEyIC0gMTgrCiAgICAgIC8vIEFjY2Vzc2luZyBpZnJhbWUgZG9jdW1lbnRzIGFmdGVyIHVubG9hZCB0aHJvd3MgInBlcm1pc3Npb24gZGVuaWVkIiBlcnJvcnMgKGpRdWVyeSAjMTM5MzYpCiAgICAgIC8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNyAtIDE4KwogICAgICAvLyBJRS9FZGdlIHNvbWV0aW1lcyB0aHJvdyBhICJQZXJtaXNzaW9uIGRlbmllZCIgZXJyb3Igd2hlbiBzdHJpY3QtY29tcGFyaW5nCiAgICAgIC8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4KICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGVxZXFlcQogICAgICBpZiAocHJlZmVycmVkRG9jICE9IGRvY3VtZW50ICYmIChzdWJXaW5kb3cgPSBkb2N1bWVudC5kZWZhdWx0VmlldykgJiYgc3ViV2luZG93LnRvcCAhPT0gc3ViV2luZG93KSB7CiAgICAgICAgLy8gU3VwcG9ydDogSUUgMTEsIEVkZ2UKICAgICAgICBpZiAoc3ViV2luZG93LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgIHN1YldpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ1bmxvYWQiLCB1bmxvYWRIYW5kbGVyLCBmYWxzZSk7CgogICAgICAgICAgLy8gU3VwcG9ydDogSUUgOSAtIDEwIG9ubHkKICAgICAgICB9IGVsc2UgaWYgKHN1YldpbmRvdy5hdHRhY2hFdmVudCkgewogICAgICAgICAgc3ViV2luZG93LmF0dGFjaEV2ZW50KCJvbnVubG9hZCIsIHVubG9hZEhhbmRsZXIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gU3VwcG9ydDogSUUgOCAtIDExKywgRWRnZSAxMiAtIDE4KywgQ2hyb21lIDw9MTYgLSAyNSBvbmx5LCBGaXJlZm94IDw9My42IC0gMzEgb25seSwKICAgICAgLy8gU2FmYXJpIDQgLSA1IG9ubHksIE9wZXJhIDw9MTEuNiAtIDEyLnggb25seQogICAgICAvLyBJRS9FZGdlICYgb2xkZXIgYnJvd3NlcnMgZG9uJ3Qgc3VwcG9ydCB0aGUgOnNjb3BlIHBzZXVkby1jbGFzcy4KICAgICAgLy8gU3VwcG9ydDogU2FmYXJpIDYuMCBvbmx5CiAgICAgIC8vIFNhZmFyaSA2LjAgc3VwcG9ydHMgOnNjb3BlIGJ1dCBpdCdzIGFuIGFsaWFzIG9mIDpyb290IHRoZXJlLgogICAgICBzdXBwb3J0LnNjb3BlID0gYXNzZXJ0KGZ1bmN0aW9uIChlbCkgewogICAgICAgIGRvY0VsZW0uYXBwZW5kQ2hpbGQoZWwpLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpKTsKICAgICAgICByZXR1cm4gdHlwZW9mIGVsLnF1ZXJ5U2VsZWN0b3JBbGwgIT09ICJ1bmRlZmluZWQiICYmICFlbC5xdWVyeVNlbGVjdG9yQWxsKCI6c2NvcGUgZmllbGRzZXQgZGl2IikubGVuZ3RoOwogICAgICB9KTsKCiAgICAgIC8qIEF0dHJpYnV0ZXMKICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoKICAgICAgLy8gU3VwcG9ydDogSUU8OAogICAgICAvLyBWZXJpZnkgdGhhdCBnZXRBdHRyaWJ1dGUgcmVhbGx5IHJldHVybnMgYXR0cmlidXRlcyBhbmQgbm90IHByb3BlcnRpZXMKICAgICAgLy8gKGV4Y2VwdGluZyBJRTggYm9vbGVhbnMpCiAgICAgIHN1cHBvcnQuYXR0cmlidXRlcyA9IGFzc2VydChmdW5jdGlvbiAoZWwpIHsKICAgICAgICBlbC5jbGFzc05hbWUgPSAiaSI7CiAgICAgICAgcmV0dXJuICFlbC5nZXRBdHRyaWJ1dGUoImNsYXNzTmFtZSIpOwogICAgICB9KTsKCiAgICAgIC8qIGdldEVsZW1lbnQocylCeSoKICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoKICAgICAgLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSByZXR1cm5zIG9ubHkgZWxlbWVudHMKICAgICAgc3VwcG9ydC5nZXRFbGVtZW50c0J5VGFnTmFtZSA9IGFzc2VydChmdW5jdGlvbiAoZWwpIHsKICAgICAgICBlbC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVDb21tZW50KCIiKSk7CiAgICAgICAgcmV0dXJuICFlbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpLmxlbmd0aDsKICAgICAgfSk7CgogICAgICAvLyBTdXBwb3J0OiBJRTw5CiAgICAgIHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9IHJuYXRpdmUudGVzdChkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKTsKCiAgICAgIC8vIFN1cHBvcnQ6IElFPDEwCiAgICAgIC8vIENoZWNrIGlmIGdldEVsZW1lbnRCeUlkIHJldHVybnMgZWxlbWVudHMgYnkgbmFtZQogICAgICAvLyBUaGUgYnJva2VuIGdldEVsZW1lbnRCeUlkIG1ldGhvZHMgZG9uJ3QgcGljayB1cCBwcm9ncmFtbWF0aWNhbGx5LXNldCBuYW1lcywKICAgICAgLy8gc28gdXNlIGEgcm91bmRhYm91dCBnZXRFbGVtZW50c0J5TmFtZSB0ZXN0CiAgICAgIHN1cHBvcnQuZ2V0QnlJZCA9IGFzc2VydChmdW5jdGlvbiAoZWwpIHsKICAgICAgICBkb2NFbGVtLmFwcGVuZENoaWxkKGVsKS5pZCA9IGV4cGFuZG87CiAgICAgICAgcmV0dXJuICFkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZSB8fCAhZG9jdW1lbnQuZ2V0RWxlbWVudHNCeU5hbWUoZXhwYW5kbykubGVuZ3RoOwogICAgICB9KTsKCiAgICAgIC8vIElEIGZpbHRlciBhbmQgZmluZAogICAgICBpZiAoc3VwcG9ydC5nZXRCeUlkKSB7CiAgICAgICAgRXhwci5maWx0ZXJbIklEIl0gPSBmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgIHZhciBhdHRySWQgPSBpZC5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoImlkIikgPT09IGF0dHJJZDsKICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBFeHByLmZpbmRbIklEIl0gPSBmdW5jdGlvbiAoaWQsIGNvbnRleHQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnRJc0hUTUwpIHsKICAgICAgICAgICAgdmFyIGVsZW0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKGlkKTsKICAgICAgICAgICAgcmV0dXJuIGVsZW0gPyBbZWxlbV0gOiBbXTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIEV4cHIuZmlsdGVyWyJJRCJdID0gZnVuY3Rpb24gKGlkKSB7CiAgICAgICAgICB2YXIgYXR0cklkID0gaWQucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSk7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSAidW5kZWZpbmVkIiAmJiBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoImlkIik7CiAgICAgICAgICAgIHJldHVybiBub2RlICYmIG5vZGUudmFsdWUgPT09IGF0dHJJZDsKICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICAgICAgLy8gU3VwcG9ydDogSUUgNiAtIDcgb25seQogICAgICAgIC8vIGdldEVsZW1lbnRCeUlkIGlzIG5vdCByZWxpYWJsZSBhcyBhIGZpbmQgc2hvcnRjdXQKICAgICAgICBFeHByLmZpbmRbIklEIl0gPSBmdW5jdGlvbiAoaWQsIGNvbnRleHQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnRJc0hUTUwpIHsKICAgICAgICAgICAgdmFyIG5vZGUsCiAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICBlbGVtcywKICAgICAgICAgICAgICBlbGVtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICAgICAgLy8gVmVyaWZ5IHRoZSBpZCBhdHRyaWJ1dGUKICAgICAgICAgICAgICBub2RlID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpOwogICAgICAgICAgICAgIGlmIChub2RlICYmIG5vZGUudmFsdWUgPT09IGlkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gW2VsZW1dOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gRmFsbCBiYWNrIG9uIGdldEVsZW1lbnRzQnlOYW1lCiAgICAgICAgICAgICAgZWxlbXMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlOYW1lKGlkKTsKICAgICAgICAgICAgICBpID0gMDsKICAgICAgICAgICAgICB3aGlsZSAoZWxlbSA9IGVsZW1zW2krK10pIHsKICAgICAgICAgICAgICAgIG5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoImlkIik7CiAgICAgICAgICAgICAgICBpZiAobm9kZSAmJiBub2RlLnZhbHVlID09PSBpZCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gW2VsZW1dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgLy8gVGFnCiAgICAgIEV4cHIuZmluZFsiVEFHIl0gPSBzdXBwb3J0LmdldEVsZW1lbnRzQnlUYWdOYW1lID8gZnVuY3Rpb24gKHRhZywgY29udGV4dCkgewogICAgICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CgogICAgICAgICAgLy8gRG9jdW1lbnRGcmFnbWVudCBub2RlcyBkb24ndCBoYXZlIGdFQlROCiAgICAgICAgfSBlbHNlIGlmIChzdXBwb3J0LnFzYSkgewogICAgICAgICAgcmV0dXJuIGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCh0YWcpOwogICAgICAgIH0KICAgICAgfSA6IGZ1bmN0aW9uICh0YWcsIGNvbnRleHQpIHsKICAgICAgICB2YXIgZWxlbSwKICAgICAgICAgIHRtcCA9IFtdLAogICAgICAgICAgaSA9IDAsCiAgICAgICAgICAvLyBCeSBoYXBweSBjb2luY2lkZW5jZSwgYSAoYnJva2VuKSBnRUJUTiBhcHBlYXJzIG9uIERvY3VtZW50RnJhZ21lbnQgbm9kZXMgdG9vCiAgICAgICAgICByZXN1bHRzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwoKICAgICAgICAvLyBGaWx0ZXIgb3V0IHBvc3NpYmxlIGNvbW1lbnRzCiAgICAgICAgaWYgKHRhZyA9PT0gIioiKSB7CiAgICAgICAgICB3aGlsZSAoZWxlbSA9IHJlc3VsdHNbaSsrXSkgewogICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgIHRtcC5wdXNoKGVsZW0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdG1wOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgfTsKCiAgICAgIC8vIENsYXNzCiAgICAgIEV4cHIuZmluZFsiQ0xBU1MiXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiBmdW5jdGlvbiAoY2xhc3NOYW1lLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgIT09ICJ1bmRlZmluZWQiICYmIGRvY3VtZW50SXNIVE1MKSB7CiAgICAgICAgICByZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTmFtZSk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgLyogUVNBL21hdGNoZXNTZWxlY3RvcgogICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgogICAgICAvLyBRU0EgYW5kIG1hdGNoZXNTZWxlY3RvciBzdXBwb3J0CgogICAgICAvLyBtYXRjaGVzU2VsZWN0b3IoOmFjdGl2ZSkgcmVwb3J0cyBmYWxzZSB3aGVuIHRydWUgKElFOS9PcGVyYSAxMS41KQogICAgICByYnVnZ3lNYXRjaGVzID0gW107CgogICAgICAvLyBxU2EoOmZvY3VzKSByZXBvcnRzIGZhbHNlIHdoZW4gdHJ1ZSAoQ2hyb21lIDIxKQogICAgICAvLyBXZSBhbGxvdyB0aGlzIGJlY2F1c2Ugb2YgYSBidWcgaW4gSUU4LzkgdGhhdCB0aHJvd3MgYW4gZXJyb3IKICAgICAgLy8gd2hlbmV2ZXIgYGRvY3VtZW50LmFjdGl2ZUVsZW1lbnRgIGlzIGFjY2Vzc2VkIG9uIGFuIGlmcmFtZQogICAgICAvLyBTbywgd2UgYWxsb3cgOmZvY3VzIHRvIHBhc3MgdGhyb3VnaCBRU0EgYWxsIHRoZSB0aW1lIHRvIGF2b2lkIHRoZSBJRSBlcnJvcgogICAgICAvLyBTZWUgaHR0cHM6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEzMzc4CiAgICAgIHJidWdneVFTQSA9IFtdOwogICAgICBpZiAoc3VwcG9ydC5xc2EgPSBybmF0aXZlLnRlc3QoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCkpIHsKICAgICAgICAvLyBCdWlsZCBRU0EgcmVnZXgKICAgICAgICAvLyBSZWdleCBzdHJhdGVneSBhZG9wdGVkIGZyb20gRGllZ28gUGVyaW5pCiAgICAgICAgYXNzZXJ0KGZ1bmN0aW9uIChlbCkgewogICAgICAgICAgdmFyIGlucHV0OwoKICAgICAgICAgIC8vIFNlbGVjdCBpcyBzZXQgdG8gZW1wdHkgc3RyaW5nIG9uIHB1cnBvc2UKICAgICAgICAgIC8vIFRoaXMgaXMgdG8gdGVzdCBJRSdzIHRyZWF0bWVudCBvZiBub3QgZXhwbGljaXRseQogICAgICAgICAgLy8gc2V0dGluZyBhIGJvb2xlYW4gY29udGVudCBhdHRyaWJ1dGUsCiAgICAgICAgICAvLyBzaW5jZSBpdHMgcHJlc2VuY2Ugc2hvdWxkIGJlIGVub3VnaAogICAgICAgICAgLy8gaHR0cHM6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEyMzU5CiAgICAgICAgICBkb2NFbGVtLmFwcGVuZENoaWxkKGVsKS5pbm5lckhUTUwgPSAiPGEgaWQ9JyIgKyBleHBhbmRvICsgIic+PC9hPiIgKyAiPHNlbGVjdCBpZD0nIiArIGV4cGFuZG8gKyAiLVxyXFwnIG1zYWxsb3djYXB0dXJlPScnPiIgKyAiPG9wdGlvbiBzZWxlY3RlZD0nJz48L29wdGlvbj48L3NlbGVjdD4iOwoKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFOCwgT3BlcmEgMTEtMTIuMTYKICAgICAgICAgIC8vIE5vdGhpbmcgc2hvdWxkIGJlIHNlbGVjdGVkIHdoZW4gZW1wdHkgc3RyaW5ncyBmb2xsb3cgXj0gb3IgJD0gb3IgKj0KICAgICAgICAgIC8vIFRoZSB0ZXN0IGF0dHJpYnV0ZSBtdXN0IGJlIHVua25vd24gaW4gT3BlcmEgYnV0ICJzYWZlIiBmb3IgV2luUlQKICAgICAgICAgIC8vIGh0dHBzOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvaWUvaGg0NjUzODguYXNweCNhdHRyaWJ1dGVfc2VjdGlvbgogICAgICAgICAgaWYgKGVsLnF1ZXJ5U2VsZWN0b3JBbGwoIlttc2FsbG93Y2FwdHVyZV49JyddIikubGVuZ3RoKSB7CiAgICAgICAgICAgIHJidWdneVFTQS5wdXNoKCJbKl4kXT0iICsgd2hpdGVzcGFjZSArICIqKD86Jyd8XCJcIikiKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBTdXBwb3J0OiBJRTgKICAgICAgICAgIC8vIEJvb2xlYW4gYXR0cmlidXRlcyBhbmQgInZhbHVlIiBhcmUgbm90IHRyZWF0ZWQgY29ycmVjdGx5CiAgICAgICAgICBpZiAoIWVsLnF1ZXJ5U2VsZWN0b3JBbGwoIltzZWxlY3RlZF0iKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goIlxcWyIgKyB3aGl0ZXNwYWNlICsgIiooPzp2YWx1ZXwiICsgYm9vbGVhbnMgKyAiKSIpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFN1cHBvcnQ6IENocm9tZTwyOSwgQW5kcm9pZDw0LjQsIFNhZmFyaTw3LjArLCBpT1M8Ny4wKywgUGhhbnRvbUpTPDEuOS44KwogICAgICAgICAgaWYgKCFlbC5xdWVyeVNlbGVjdG9yQWxsKCJbaWR+PSIgKyBleHBhbmRvICsgIi1dIikubGVuZ3RoKSB7CiAgICAgICAgICAgIHJidWdneVFTQS5wdXNoKCJ+PSIpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNSAtIDE4KwogICAgICAgICAgLy8gSUUgMTEvRWRnZSBkb24ndCBmaW5kIGVsZW1lbnRzIG9uIGEgYFtuYW1lPScnXWAgcXVlcnkgaW4gc29tZSBjYXNlcy4KICAgICAgICAgIC8vIEFkZGluZyBhIHRlbXBvcmFyeSBhdHRyaWJ1dGUgdG8gdGhlIGRvY3VtZW50IGJlZm9yZSB0aGUgc2VsZWN0aW9uIHdvcmtzCiAgICAgICAgICAvLyBhcm91bmQgdGhlIGlzc3VlLgogICAgICAgICAgLy8gSW50ZXJlc3RpbmdseSwgSUUgMTAgJiBvbGRlciBkb24ndCBzZWVtIHRvIGhhdmUgdGhlIGlzc3VlLgogICAgICAgICAgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgICAgaW5wdXQuc2V0QXR0cmlidXRlKCJuYW1lIiwgIiIpOwogICAgICAgICAgZWwuYXBwZW5kQ2hpbGQoaW5wdXQpOwogICAgICAgICAgaWYgKCFlbC5xdWVyeVNlbGVjdG9yQWxsKCJbbmFtZT0nJ10iKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goIlxcWyIgKyB3aGl0ZXNwYWNlICsgIipuYW1lIiArIHdoaXRlc3BhY2UgKyAiKj0iICsgd2hpdGVzcGFjZSArICIqKD86Jyd8XCJcIikiKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBXZWJraXQvT3BlcmEgLSA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbiBlbGVtZW50cwogICAgICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQKICAgICAgICAgIC8vIElFOCB0aHJvd3MgZXJyb3IgaGVyZSBhbmQgd2lsbCBub3Qgc2VlIGxhdGVyIHRlc3RzCiAgICAgICAgICBpZiAoIWVsLnF1ZXJ5U2VsZWN0b3JBbGwoIjpjaGVja2VkIikubGVuZ3RoKSB7CiAgICAgICAgICAgIHJidWdneVFTQS5wdXNoKCI6Y2hlY2tlZCIpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFN1cHBvcnQ6IFNhZmFyaSA4KywgaU9TIDgrCiAgICAgICAgICAvLyBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MTM2ODUxCiAgICAgICAgICAvLyBJbi1wYWdlIGBzZWxlY3RvciNpZCBzaWJsaW5nLWNvbWJpbmF0b3Igc2VsZWN0b3JgIGZhaWxzCiAgICAgICAgICBpZiAoIWVsLnF1ZXJ5U2VsZWN0b3JBbGwoImEjIiArIGV4cGFuZG8gKyAiKyoiKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goIi4jLitbK35dIik7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU3VwcG9ydDogRmlyZWZveCA8PTMuNiAtIDUgb25seQogICAgICAgICAgLy8gT2xkIEZpcmVmb3ggZG9lc24ndCB0aHJvdyBvbiBhIGJhZGx5LWVzY2FwZWQgaWRlbnRpZmllci4KICAgICAgICAgIGVsLnF1ZXJ5U2VsZWN0b3JBbGwoIlxcXGYiKTsKICAgICAgICAgIHJidWdneVFTQS5wdXNoKCJbXFxyXFxuXFxmXSIpOwogICAgICAgIH0pOwogICAgICAgIGFzc2VydChmdW5jdGlvbiAoZWwpIHsKICAgICAgICAgIGVsLmlubmVySFRNTCA9ICI8YSBocmVmPScnIGRpc2FibGVkPSdkaXNhYmxlZCc+PC9hPiIgKyAiPHNlbGVjdCBkaXNhYmxlZD0nZGlzYWJsZWQnPjxvcHRpb24vPjwvc2VsZWN0PiI7CgogICAgICAgICAgLy8gU3VwcG9ydDogV2luZG93cyA4IE5hdGl2ZSBBcHBzCiAgICAgICAgICAvLyBUaGUgdHlwZSBhbmQgbmFtZSBhdHRyaWJ1dGVzIGFyZSByZXN0cmljdGVkIGR1cmluZyAuaW5uZXJIVE1MIGFzc2lnbm1lbnQKICAgICAgICAgIHZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoInR5cGUiLCAiaGlkZGVuIik7CiAgICAgICAgICBlbC5hcHBlbmRDaGlsZChpbnB1dCkuc2V0QXR0cmlidXRlKCJuYW1lIiwgIkQiKTsKCiAgICAgICAgICAvLyBTdXBwb3J0OiBJRTgKICAgICAgICAgIC8vIEVuZm9yY2UgY2FzZS1zZW5zaXRpdml0eSBvZiBuYW1lIGF0dHJpYnV0ZQogICAgICAgICAgaWYgKGVsLnF1ZXJ5U2VsZWN0b3JBbGwoIltuYW1lPWRdIikubGVuZ3RoKSB7CiAgICAgICAgICAgIHJidWdneVFTQS5wdXNoKCJuYW1lIiArIHdoaXRlc3BhY2UgKyAiKlsqXiR8IX5dPz0iKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBGRiAzLjUgLSA6ZW5hYmxlZC86ZGlzYWJsZWQgYW5kIGhpZGRlbiBlbGVtZW50cyAoaGlkZGVuIGVsZW1lbnRzIGFyZSBzdGlsbCBlbmFibGVkKQogICAgICAgICAgLy8gSUU4IHRocm93cyBlcnJvciBoZXJlIGFuZCB3aWxsIG5vdCBzZWUgbGF0ZXIgdGVzdHMKICAgICAgICAgIGlmIChlbC5xdWVyeVNlbGVjdG9yQWxsKCI6ZW5hYmxlZCIpLmxlbmd0aCAhPT0gMikgewogICAgICAgICAgICByYnVnZ3lRU0EucHVzaCgiOmVuYWJsZWQiLCAiOmRpc2FibGVkIik7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU3VwcG9ydDogSUU5LTExKwogICAgICAgICAgLy8gSUUncyA6ZGlzYWJsZWQgc2VsZWN0b3IgZG9lcyBub3QgcGljayB1cCB0aGUgY2hpbGRyZW4gb2YgZGlzYWJsZWQgZmllbGRzZXRzCiAgICAgICAgICBkb2NFbGVtLmFwcGVuZENoaWxkKGVsKS5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICBpZiAoZWwucXVlcnlTZWxlY3RvckFsbCgiOmRpc2FibGVkIikubGVuZ3RoICE9PSAyKSB7CiAgICAgICAgICAgIHJidWdneVFTQS5wdXNoKCI6ZW5hYmxlZCIsICI6ZGlzYWJsZWQiKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBTdXBwb3J0OiBPcGVyYSAxMCAtIDExIG9ubHkKICAgICAgICAgIC8vIE9wZXJhIDEwLTExIGRvZXMgbm90IHRocm93IG9uIHBvc3QtY29tbWEgaW52YWxpZCBwc2V1ZG9zCiAgICAgICAgICBlbC5xdWVyeVNlbGVjdG9yQWxsKCIqLDp4Iik7CiAgICAgICAgICByYnVnZ3lRU0EucHVzaCgiLC4qOiIpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciA9IHJuYXRpdmUudGVzdChtYXRjaGVzID0gZG9jRWxlbS5tYXRjaGVzIHx8IGRvY0VsZW0ud2Via2l0TWF0Y2hlc1NlbGVjdG9yIHx8IGRvY0VsZW0ubW96TWF0Y2hlc1NlbGVjdG9yIHx8IGRvY0VsZW0ub01hdGNoZXNTZWxlY3RvciB8fCBkb2NFbGVtLm1zTWF0Y2hlc1NlbGVjdG9yKSkgewogICAgICAgIGFzc2VydChmdW5jdGlvbiAoZWwpIHsKICAgICAgICAgIC8vIENoZWNrIHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRvIG1hdGNoZXNTZWxlY3RvcgogICAgICAgICAgLy8gb24gYSBkaXNjb25uZWN0ZWQgbm9kZSAoSUUgOSkKICAgICAgICAgIHN1cHBvcnQuZGlzY29ubmVjdGVkTWF0Y2ggPSBtYXRjaGVzLmNhbGwoZWwsICIqIik7CgogICAgICAgICAgLy8gVGhpcyBzaG91bGQgZmFpbCB3aXRoIGFuIGV4Y2VwdGlvbgogICAgICAgICAgLy8gR2Vja28gZG9lcyBub3QgZXJyb3IsIHJldHVybnMgZmFsc2UgaW5zdGVhZAogICAgICAgICAgbWF0Y2hlcy5jYWxsKGVsLCAiW3MhPScnXTp4Iik7CiAgICAgICAgICByYnVnZ3lNYXRjaGVzLnB1c2goIiE9IiwgcHNldWRvcyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmJ1Z2d5UVNBID0gcmJ1Z2d5UVNBLmxlbmd0aCAmJiBuZXcgUmVnRXhwKHJidWdneVFTQS5qb2luKCJ8IikpOwogICAgICByYnVnZ3lNYXRjaGVzID0gcmJ1Z2d5TWF0Y2hlcy5sZW5ndGggJiYgbmV3IFJlZ0V4cChyYnVnZ3lNYXRjaGVzLmpvaW4oInwiKSk7CgogICAgICAvKiBDb250YWlucwogICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCiAgICAgIGhhc0NvbXBhcmUgPSBybmF0aXZlLnRlc3QoZG9jRWxlbS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbik7CgogICAgICAvLyBFbGVtZW50IGNvbnRhaW5zIGFub3RoZXIKICAgICAgLy8gUHVycG9zZWZ1bGx5IHNlbGYtZXhjbHVzaXZlCiAgICAgIC8vIEFzIGluLCBhbiBlbGVtZW50IGRvZXMgbm90IGNvbnRhaW4gaXRzZWxmCiAgICAgIGNvbnRhaW5zID0gaGFzQ29tcGFyZSB8fCBybmF0aXZlLnRlc3QoZG9jRWxlbS5jb250YWlucykgPyBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIHZhciBhZG93biA9IGEubm9kZVR5cGUgPT09IDkgPyBhLmRvY3VtZW50RWxlbWVudCA6IGEsCiAgICAgICAgICBidXAgPSBiICYmIGIucGFyZW50Tm9kZTsKICAgICAgICByZXR1cm4gYSA9PT0gYnVwIHx8ICEhKGJ1cCAmJiBidXAubm9kZVR5cGUgPT09IDEgJiYgKGFkb3duLmNvbnRhaW5zID8gYWRvd24uY29udGFpbnMoYnVwKSA6IGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihidXApICYgMTYpKTsKICAgICAgfSA6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgaWYgKGIpIHsKICAgICAgICAgIHdoaWxlIChiID0gYi5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgIGlmIChiID09PSBhKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9OwoKICAgICAgLyogU29ydGluZwogICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgogICAgICAvLyBEb2N1bWVudCBvcmRlciBzb3J0aW5nCiAgICAgIHNvcnRPcmRlciA9IGhhc0NvbXBhcmUgPyBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIC8vIEZsYWcgZm9yIGR1cGxpY2F0ZSByZW1vdmFsCiAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgIGhhc0R1cGxpY2F0ZSA9IHRydWU7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CgogICAgICAgIC8vIFNvcnQgb24gbWV0aG9kIGV4aXN0ZW5jZSBpZiBvbmx5IG9uZSBpbnB1dCBoYXMgY29tcGFyZURvY3VtZW50UG9zaXRpb24KICAgICAgICB2YXIgY29tcGFyZSA9ICFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIC0gIWIuY29tcGFyZURvY3VtZW50UG9zaXRpb247CiAgICAgICAgaWYgKGNvbXBhcmUpIHsKICAgICAgICAgIHJldHVybiBjb21wYXJlOwogICAgICAgIH0KCiAgICAgICAgLy8gQ2FsY3VsYXRlIHBvc2l0aW9uIGlmIGJvdGggaW5wdXRzIGJlbG9uZyB0byB0aGUgc2FtZSBkb2N1bWVudAogICAgICAgIC8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNyAtIDE4KwogICAgICAgIC8vIElFL0VkZ2Ugc29tZXRpbWVzIHRocm93IGEgIlBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIHN0cmljdC1jb21wYXJpbmcKICAgICAgICAvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuCiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGVxZXFlcQogICAgICAgIGNvbXBhcmUgPSAoYS5vd25lckRvY3VtZW50IHx8IGEpID09IChiLm93bmVyRG9jdW1lbnQgfHwgYikgPyBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGIpIDoKICAgICAgICAvLyBPdGhlcndpc2Ugd2Uga25vdyB0aGV5IGFyZSBkaXNjb25uZWN0ZWQKICAgICAgICAxOwoKICAgICAgICAvLyBEaXNjb25uZWN0ZWQgbm9kZXMKICAgICAgICBpZiAoY29tcGFyZSAmIDEgfHwgIXN1cHBvcnQuc29ydERldGFjaGVkICYmIGIuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYSkgPT09IGNvbXBhcmUpIHsKICAgICAgICAgIC8vIENob29zZSB0aGUgZmlyc3QgZWxlbWVudCB0aGF0IGlzIHJlbGF0ZWQgdG8gb3VyIHByZWZlcnJlZCBkb2N1bWVudAogICAgICAgICAgLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrCiAgICAgICAgICAvLyBJRS9FZGdlIHNvbWV0aW1lcyB0aHJvdyBhICJQZXJtaXNzaW9uIGRlbmllZCIgZXJyb3Igd2hlbiBzdHJpY3QtY29tcGFyaW5nCiAgICAgICAgICAvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuCiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZXFlcWVxCiAgICAgICAgICBpZiAoYSA9PSBkb2N1bWVudCB8fCBhLm93bmVyRG9jdW1lbnQgPT0gcHJlZmVycmVkRG9jICYmIGNvbnRhaW5zKHByZWZlcnJlZERvYywgYSkpIHsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNyAtIDE4KwogICAgICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAgICAgLy8gdHdvIGRvY3VtZW50czsgc2hhbGxvdyBjb21wYXJpc29ucyB3b3JrLgogICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGVxZXFlcQogICAgICAgICAgaWYgKGIgPT0gZG9jdW1lbnQgfHwgYi5vd25lckRvY3VtZW50ID09IHByZWZlcnJlZERvYyAmJiBjb250YWlucyhwcmVmZXJyZWREb2MsIGIpKSB7CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIE1haW50YWluIG9yaWdpbmFsIG9yZGVyCiAgICAgICAgICByZXR1cm4gc29ydElucHV0ID8gaW5kZXhPZihzb3J0SW5wdXQsIGEpIC0gaW5kZXhPZihzb3J0SW5wdXQsIGIpIDogMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbXBhcmUgJiA0ID8gLTEgOiAxOwogICAgICB9IDogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAvLyBFeGl0IGVhcmx5IGlmIHRoZSBub2RlcyBhcmUgaWRlbnRpY2FsCiAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgIGhhc0R1cGxpY2F0ZSA9IHRydWU7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgdmFyIGN1ciwKICAgICAgICAgIGkgPSAwLAogICAgICAgICAgYXVwID0gYS5wYXJlbnROb2RlLAogICAgICAgICAgYnVwID0gYi5wYXJlbnROb2RlLAogICAgICAgICAgYXAgPSBbYV0sCiAgICAgICAgICBicCA9IFtiXTsKCiAgICAgICAgLy8gUGFyZW50bGVzcyBub2RlcyBhcmUgZWl0aGVyIGRvY3VtZW50cyBvciBkaXNjb25uZWN0ZWQKICAgICAgICBpZiAoIWF1cCB8fCAhYnVwKSB7CiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsKICAgICAgICAgIC8vIElFL0VkZ2Ugc29tZXRpbWVzIHRocm93IGEgIlBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIHN0cmljdC1jb21wYXJpbmcKICAgICAgICAgIC8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4KICAgICAgICAgIC8qIGVzbGludC1kaXNhYmxlIGVxZXFlcSAqLwogICAgICAgICAgcmV0dXJuIGEgPT0gZG9jdW1lbnQgPyAtMSA6IGIgPT0gZG9jdW1lbnQgPyAxIDogLyogZXNsaW50LWVuYWJsZSBlcWVxZXEgKi8KICAgICAgICAgIGF1cCA/IC0xIDogYnVwID8gMSA6IHNvcnRJbnB1dCA/IGluZGV4T2Yoc29ydElucHV0LCBhKSAtIGluZGV4T2Yoc29ydElucHV0LCBiKSA6IDA7CgogICAgICAgICAgLy8gSWYgdGhlIG5vZGVzIGFyZSBzaWJsaW5ncywgd2UgY2FuIGRvIGEgcXVpY2sgY2hlY2sKICAgICAgICB9IGVsc2UgaWYgKGF1cCA9PT0gYnVwKSB7CiAgICAgICAgICByZXR1cm4gc2libGluZ0NoZWNrKGEsIGIpOwogICAgICAgIH0KCiAgICAgICAgLy8gT3RoZXJ3aXNlIHdlIG5lZWQgZnVsbCBsaXN0cyBvZiB0aGVpciBhbmNlc3RvcnMgZm9yIGNvbXBhcmlzb24KICAgICAgICBjdXIgPSBhOwogICAgICAgIHdoaWxlIChjdXIgPSBjdXIucGFyZW50Tm9kZSkgewogICAgICAgICAgYXAudW5zaGlmdChjdXIpOwogICAgICAgIH0KICAgICAgICBjdXIgPSBiOwogICAgICAgIHdoaWxlIChjdXIgPSBjdXIucGFyZW50Tm9kZSkgewogICAgICAgICAgYnAudW5zaGlmdChjdXIpOwogICAgICAgIH0KCiAgICAgICAgLy8gV2FsayBkb3duIHRoZSB0cmVlIGxvb2tpbmcgZm9yIGEgZGlzY3JlcGFuY3kKICAgICAgICB3aGlsZSAoYXBbaV0gPT09IGJwW2ldKSB7CiAgICAgICAgICBpKys7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpID8KICAgICAgICAvLyBEbyBhIHNpYmxpbmcgY2hlY2sgaWYgdGhlIG5vZGVzIGhhdmUgYSBjb21tb24gYW5jZXN0b3IKICAgICAgICBzaWJsaW5nQ2hlY2soYXBbaV0sIGJwW2ldKSA6CiAgICAgICAgLy8gT3RoZXJ3aXNlIG5vZGVzIGluIG91ciBkb2N1bWVudCBzb3J0IGZpcnN0CiAgICAgICAgLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrCiAgICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAgIC8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4KICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZSBlcWVxZXEgKi8KICAgICAgICBhcFtpXSA9PSBwcmVmZXJyZWREb2MgPyAtMSA6IGJwW2ldID09IHByZWZlcnJlZERvYyA/IDEgOiAvKiBlc2xpbnQtZW5hYmxlIGVxZXFlcSAqLwogICAgICAgIDA7CiAgICAgIH07CiAgICAgIHJldHVybiBkb2N1bWVudDsKICAgIH07CiAgICBTaXp6bGUubWF0Y2hlcyA9IGZ1bmN0aW9uIChleHByLCBlbGVtZW50cykgewogICAgICByZXR1cm4gU2l6emxlKGV4cHIsIG51bGwsIG51bGwsIGVsZW1lbnRzKTsKICAgIH07CiAgICBTaXp6bGUubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24gKGVsZW0sIGV4cHIpIHsKICAgICAgc2V0RG9jdW1lbnQoZWxlbSk7CiAgICAgIGlmIChzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciAmJiBkb2N1bWVudElzSFRNTCAmJiAhbm9ubmF0aXZlU2VsZWN0b3JDYWNoZVtleHByICsgIiAiXSAmJiAoIXJidWdneU1hdGNoZXMgfHwgIXJidWdneU1hdGNoZXMudGVzdChleHByKSkgJiYgKCFyYnVnZ3lRU0EgfHwgIXJidWdneVFTQS50ZXN0KGV4cHIpKSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgcmV0ID0gbWF0Y2hlcy5jYWxsKGVsZW0sIGV4cHIpOwoKICAgICAgICAgIC8vIElFIDkncyBtYXRjaGVzU2VsZWN0b3IgcmV0dXJucyBmYWxzZSBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKICAgICAgICAgIGlmIChyZXQgfHwgc3VwcG9ydC5kaXNjb25uZWN0ZWRNYXRjaCB8fAogICAgICAgICAgLy8gQXMgd2VsbCwgZGlzY29ubmVjdGVkIG5vZGVzIGFyZSBzYWlkIHRvIGJlIGluIGEgZG9jdW1lbnQKICAgICAgICAgIC8vIGZyYWdtZW50IGluIElFIDkKICAgICAgICAgIGVsZW0uZG9jdW1lbnQgJiYgZWxlbS5kb2N1bWVudC5ub2RlVHlwZSAhPT0gMTEpIHsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBub25uYXRpdmVTZWxlY3RvckNhY2hlKGV4cHIsIHRydWUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gU2l6emxlKGV4cHIsIGRvY3VtZW50LCBudWxsLCBbZWxlbV0pLmxlbmd0aCA+IDA7CiAgICB9OwogICAgU2l6emxlLmNvbnRhaW5zID0gZnVuY3Rpb24gKGNvbnRleHQsIGVsZW0pIHsKICAgICAgLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCiAgICAgIC8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNyAtIDE4KwogICAgICAvLyBJRS9FZGdlIHNvbWV0aW1lcyB0aHJvdyBhICJQZXJtaXNzaW9uIGRlbmllZCIgZXJyb3Igd2hlbiBzdHJpY3QtY29tcGFyaW5nCiAgICAgIC8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4KICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGVxZXFlcQogICAgICBpZiAoKGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0KSAhPSBkb2N1bWVudCkgewogICAgICAgIHNldERvY3VtZW50KGNvbnRleHQpOwogICAgICB9CiAgICAgIHJldHVybiBjb250YWlucyhjb250ZXh0LCBlbGVtKTsKICAgIH07CiAgICBTaXp6bGUuYXR0ciA9IGZ1bmN0aW9uIChlbGVtLCBuYW1lKSB7CiAgICAgIC8vIFNldCBkb2N1bWVudCB2YXJzIGlmIG5lZWRlZAogICAgICAvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsKICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuCiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBlcWVxZXEKICAgICAgaWYgKChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSkgIT0gZG9jdW1lbnQpIHsKICAgICAgICBzZXREb2N1bWVudChlbGVtKTsKICAgICAgfQogICAgICB2YXIgZm4gPSBFeHByLmF0dHJIYW5kbGVbbmFtZS50b0xvd2VyQ2FzZSgpXSwKICAgICAgICAvLyBEb24ndCBnZXQgZm9vbGVkIGJ5IE9iamVjdC5wcm90b3R5cGUgcHJvcGVydGllcyAoalF1ZXJ5ICMxMzgwNykKICAgICAgICB2YWwgPSBmbiAmJiBoYXNPd24uY2FsbChFeHByLmF0dHJIYW5kbGUsIG5hbWUudG9Mb3dlckNhc2UoKSkgPyBmbihlbGVtLCBuYW1lLCAhZG9jdW1lbnRJc0hUTUwpIDogdW5kZWZpbmVkOwogICAgICByZXR1cm4gdmFsICE9PSB1bmRlZmluZWQgPyB2YWwgOiBzdXBwb3J0LmF0dHJpYnV0ZXMgfHwgIWRvY3VtZW50SXNIVE1MID8gZWxlbS5nZXRBdHRyaWJ1dGUobmFtZSkgOiAodmFsID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpKSAmJiB2YWwuc3BlY2lmaWVkID8gdmFsLnZhbHVlIDogbnVsbDsKICAgIH07CiAgICBTaXp6bGUuZXNjYXBlID0gZnVuY3Rpb24gKHNlbCkgewogICAgICByZXR1cm4gKHNlbCArICIiKS5yZXBsYWNlKHJjc3Nlc2NhcGUsIGZjc3Nlc2NhcGUpOwogICAgfTsKICAgIFNpenpsZS5lcnJvciA9IGZ1bmN0aW9uIChtc2cpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJTeW50YXggZXJyb3IsIHVucmVjb2duaXplZCBleHByZXNzaW9uOiAiICsgbXNnKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBEb2N1bWVudCBzb3J0aW5nIGFuZCByZW1vdmluZyBkdXBsaWNhdGVzCiAgICAgKiBAcGFyYW0ge0FycmF5TGlrZX0gcmVzdWx0cwogICAgICovCiAgICBTaXp6bGUudW5pcXVlU29ydCA9IGZ1bmN0aW9uIChyZXN1bHRzKSB7CiAgICAgIHZhciBlbGVtLAogICAgICAgIGR1cGxpY2F0ZXMgPSBbXSwKICAgICAgICBqID0gMCwKICAgICAgICBpID0gMDsKCiAgICAgIC8vIFVubGVzcyB3ZSAqa25vdyogd2UgY2FuIGRldGVjdCBkdXBsaWNhdGVzLCBhc3N1bWUgdGhlaXIgcHJlc2VuY2UKICAgICAgaGFzRHVwbGljYXRlID0gIXN1cHBvcnQuZGV0ZWN0RHVwbGljYXRlczsKICAgICAgc29ydElucHV0ID0gIXN1cHBvcnQuc29ydFN0YWJsZSAmJiByZXN1bHRzLnNsaWNlKDApOwogICAgICByZXN1bHRzLnNvcnQoc29ydE9yZGVyKTsKICAgICAgaWYgKGhhc0R1cGxpY2F0ZSkgewogICAgICAgIHdoaWxlIChlbGVtID0gcmVzdWx0c1tpKytdKSB7CiAgICAgICAgICBpZiAoZWxlbSA9PT0gcmVzdWx0c1tpXSkgewogICAgICAgICAgICBqID0gZHVwbGljYXRlcy5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB3aGlsZSAoai0tKSB7CiAgICAgICAgICByZXN1bHRzLnNwbGljZShkdXBsaWNhdGVzW2pdLCAxKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIENsZWFyIGlucHV0IGFmdGVyIHNvcnRpbmcgdG8gcmVsZWFzZSBvYmplY3RzCiAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L3NpenpsZS9wdWxsLzIyNQogICAgICBzb3J0SW5wdXQgPSBudWxsOwogICAgICByZXR1cm4gcmVzdWx0czsKICAgIH07CgogICAgLyoqCiAgICAgKiBVdGlsaXR5IGZ1bmN0aW9uIGZvciByZXRyaWV2aW5nIHRoZSB0ZXh0IHZhbHVlIG9mIGFuIGFycmF5IG9mIERPTSBub2RlcwogICAgICogQHBhcmFtIHtBcnJheXxFbGVtZW50fSBlbGVtCiAgICAgKi8KICAgIGdldFRleHQgPSBTaXp6bGUuZ2V0VGV4dCA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHZhciBub2RlLAogICAgICAgIHJldCA9ICIiLAogICAgICAgIGkgPSAwLAogICAgICAgIG5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsKICAgICAgaWYgKCFub2RlVHlwZSkgewogICAgICAgIC8vIElmIG5vIG5vZGVUeXBlLCB0aGlzIGlzIGV4cGVjdGVkIHRvIGJlIGFuIGFycmF5CiAgICAgICAgd2hpbGUgKG5vZGUgPSBlbGVtW2krK10pIHsKICAgICAgICAgIC8vIERvIG5vdCB0cmF2ZXJzZSBjb21tZW50IG5vZGVzCiAgICAgICAgICByZXQgKz0gZ2V0VGV4dChub2RlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAobm9kZVR5cGUgPT09IDEgfHwgbm9kZVR5cGUgPT09IDkgfHwgbm9kZVR5cGUgPT09IDExKSB7CiAgICAgICAgLy8gVXNlIHRleHRDb250ZW50IGZvciBlbGVtZW50cwogICAgICAgIC8vIGlubmVyVGV4dCB1c2FnZSByZW1vdmVkIGZvciBjb25zaXN0ZW5jeSBvZiBuZXcgbGluZXMgKGpRdWVyeSAjMTExNTMpCiAgICAgICAgaWYgKHR5cGVvZiBlbGVtLnRleHRDb250ZW50ID09PSAic3RyaW5nIikgewogICAgICAgICAgcmV0dXJuIGVsZW0udGV4dENvbnRlbnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFRyYXZlcnNlIGl0cyBjaGlsZHJlbgogICAgICAgICAgZm9yIChlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZykgewogICAgICAgICAgICByZXQgKz0gZ2V0VGV4dChlbGVtKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAobm9kZVR5cGUgPT09IDMgfHwgbm9kZVR5cGUgPT09IDQpIHsKICAgICAgICByZXR1cm4gZWxlbS5ub2RlVmFsdWU7CiAgICAgIH0KCiAgICAgIC8vIERvIG5vdCBpbmNsdWRlIGNvbW1lbnQgb3IgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBub2RlcwoKICAgICAgcmV0dXJuIHJldDsKICAgIH07CiAgICBFeHByID0gU2l6emxlLnNlbGVjdG9ycyA9IHsKICAgICAgLy8gQ2FuIGJlIGFkanVzdGVkIGJ5IHRoZSB1c2VyCiAgICAgIGNhY2hlTGVuZ3RoOiA1MCwKICAgICAgY3JlYXRlUHNldWRvOiBtYXJrRnVuY3Rpb24sCiAgICAgIG1hdGNoOiBtYXRjaEV4cHIsCiAgICAgIGF0dHJIYW5kbGU6IHt9LAogICAgICBmaW5kOiB7fSwKICAgICAgcmVsYXRpdmU6IHsKICAgICAgICAiPiI6IHsKICAgICAgICAgIGRpcjogInBhcmVudE5vZGUiLAogICAgICAgICAgZmlyc3Q6IHRydWUKICAgICAgICB9LAogICAgICAgICIgIjogewogICAgICAgICAgZGlyOiAicGFyZW50Tm9kZSIKICAgICAgICB9LAogICAgICAgICIrIjogewogICAgICAgICAgZGlyOiAicHJldmlvdXNTaWJsaW5nIiwKICAgICAgICAgIGZpcnN0OiB0cnVlCiAgICAgICAgfSwKICAgICAgICAifiI6IHsKICAgICAgICAgIGRpcjogInByZXZpb3VzU2libGluZyIKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZUZpbHRlcjogewogICAgICAgICJBVFRSIjogZnVuY3Rpb24gQVRUUihtYXRjaCkgewogICAgICAgICAgbWF0Y2hbMV0gPSBtYXRjaFsxXS5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKTsKCiAgICAgICAgICAvLyBNb3ZlIHRoZSBnaXZlbiB2YWx1ZSB0byBtYXRjaFszXSB3aGV0aGVyIHF1b3RlZCBvciB1bnF1b3RlZAogICAgICAgICAgbWF0Y2hbM10gPSAobWF0Y2hbM10gfHwgbWF0Y2hbNF0gfHwgbWF0Y2hbNV0gfHwgIiIpLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpOwogICAgICAgICAgaWYgKG1hdGNoWzJdID09PSAifj0iKSB7CiAgICAgICAgICAgIG1hdGNoWzNdID0gIiAiICsgbWF0Y2hbM10gKyAiICI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2guc2xpY2UoMCwgNCk7CiAgICAgICAgfSwKICAgICAgICAiQ0hJTEQiOiBmdW5jdGlvbiBDSElMRChtYXRjaCkgewogICAgICAgICAgLyogbWF0Y2hlcyBmcm9tIG1hdGNoRXhwclsiQ0hJTEQiXQogICAgICAgICAgMSB0eXBlIChvbmx5fG50aHwuLi4pCiAgICAgICAgICAyIHdoYXQgKGNoaWxkfG9mLXR5cGUpCiAgICAgICAgICAzIGFyZ3VtZW50IChldmVufG9kZHxcZCp8XGQqbihbKy1dXGQrKT98Li4uKQogICAgICAgICAgNCB4bi1jb21wb25lbnQgb2YgeG4reSBhcmd1bWVudCAoWystXT9cZCpufCkKICAgICAgICAgIDUgc2lnbiBvZiB4bi1jb21wb25lbnQKICAgICAgICAgIDYgeCBvZiB4bi1jb21wb25lbnQKICAgICAgICAgIDcgc2lnbiBvZiB5LWNvbXBvbmVudAogICAgICAgICAgOCB5IG9mIHktY29tcG9uZW50CiAgICAgICAgICAqLwogICAgICAgICAgbWF0Y2hbMV0gPSBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgaWYgKG1hdGNoWzFdLnNsaWNlKDAsIDMpID09PSAibnRoIikgewogICAgICAgICAgICAvLyBudGgtKiByZXF1aXJlcyBhcmd1bWVudAogICAgICAgICAgICBpZiAoIW1hdGNoWzNdKSB7CiAgICAgICAgICAgICAgU2l6emxlLmVycm9yKG1hdGNoWzBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gbnVtZXJpYyB4IGFuZCB5IHBhcmFtZXRlcnMgZm9yIEV4cHIuZmlsdGVyLkNISUxECiAgICAgICAgICAgIC8vIHJlbWVtYmVyIHRoYXQgZmFsc2UvdHJ1ZSBjYXN0IHJlc3BlY3RpdmVseSB0byAwLzEKICAgICAgICAgICAgbWF0Y2hbNF0gPSArKG1hdGNoWzRdID8gbWF0Y2hbNV0gKyAobWF0Y2hbNl0gfHwgMSkgOiAyICogKG1hdGNoWzNdID09PSAiZXZlbiIgfHwgbWF0Y2hbM10gPT09ICJvZGQiKSk7CiAgICAgICAgICAgIG1hdGNoWzVdID0gKyhtYXRjaFs3XSArIG1hdGNoWzhdIHx8IG1hdGNoWzNdID09PSAib2RkIik7CgogICAgICAgICAgICAvLyBvdGhlciB0eXBlcyBwcm9oaWJpdCBhcmd1bWVudHMKICAgICAgICAgIH0gZWxzZSBpZiAobWF0Y2hbM10pIHsKICAgICAgICAgICAgU2l6emxlLmVycm9yKG1hdGNoWzBdKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICB9LAogICAgICAgICJQU0VVRE8iOiBmdW5jdGlvbiBQU0VVRE8obWF0Y2gpIHsKICAgICAgICAgIHZhciBleGNlc3MsCiAgICAgICAgICAgIHVucXVvdGVkID0gIW1hdGNoWzZdICYmIG1hdGNoWzJdOwogICAgICAgICAgaWYgKG1hdGNoRXhwclsiQ0hJTEQiXS50ZXN0KG1hdGNoWzBdKSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBBY2NlcHQgcXVvdGVkIGFyZ3VtZW50cyBhcy1pcwogICAgICAgICAgaWYgKG1hdGNoWzNdKSB7CiAgICAgICAgICAgIG1hdGNoWzJdID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNV0gfHwgIiI7CgogICAgICAgICAgICAvLyBTdHJpcCBleGNlc3MgY2hhcmFjdGVycyBmcm9tIHVucXVvdGVkIGFyZ3VtZW50cwogICAgICAgICAgfSBlbHNlIGlmICh1bnF1b3RlZCAmJiBycHNldWRvLnRlc3QodW5xdW90ZWQpICYmICgKICAgICAgICAgIC8vIEdldCBleGNlc3MgZnJvbSB0b2tlbml6ZSAocmVjdXJzaXZlbHkpCiAgICAgICAgICBleGNlc3MgPSB0b2tlbml6ZSh1bnF1b3RlZCwgdHJ1ZSkpICYmICgKICAgICAgICAgIC8vIGFkdmFuY2UgdG8gdGhlIG5leHQgY2xvc2luZyBwYXJlbnRoZXNpcwogICAgICAgICAgZXhjZXNzID0gdW5xdW90ZWQuaW5kZXhPZigiKSIsIHVucXVvdGVkLmxlbmd0aCAtIGV4Y2VzcykgLSB1bnF1b3RlZC5sZW5ndGgpKSB7CiAgICAgICAgICAgIC8vIGV4Y2VzcyBpcyBhIG5lZ2F0aXZlIGluZGV4CiAgICAgICAgICAgIG1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoMCwgZXhjZXNzKTsKICAgICAgICAgICAgbWF0Y2hbMl0gPSB1bnF1b3RlZC5zbGljZSgwLCBleGNlc3MpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFJldHVybiBvbmx5IGNhcHR1cmVzIG5lZWRlZCBieSB0aGUgcHNldWRvIGZpbHRlciBtZXRob2QgKHR5cGUgYW5kIGFyZ3VtZW50KQogICAgICAgICAgcmV0dXJuIG1hdGNoLnNsaWNlKDAsIDMpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZmlsdGVyOiB7CiAgICAgICAgIlRBRyI6IGZ1bmN0aW9uIFRBRyhub2RlTmFtZVNlbGVjdG9yKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBub2RlTmFtZVNlbGVjdG9yLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWVTZWxlY3RvciA9PT0gIioiID8gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5vZGVOYW1lOwogICAgICAgICAgfTsKICAgICAgICB9LAogICAgICAgICJDTEFTUyI6IGZ1bmN0aW9uIENMQVNTKGNsYXNzTmFtZSkgewogICAgICAgICAgdmFyIHBhdHRlcm4gPSBjbGFzc0NhY2hlW2NsYXNzTmFtZSArICIgIl07CiAgICAgICAgICByZXR1cm4gcGF0dGVybiB8fCAocGF0dGVybiA9IG5ldyBSZWdFeHAoIihefCIgKyB3aGl0ZXNwYWNlICsgIikiICsgY2xhc3NOYW1lICsgIigiICsgd2hpdGVzcGFjZSArICJ8JCkiKSkgJiYgY2xhc3NDYWNoZShjbGFzc05hbWUsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBwYXR0ZXJuLnRlc3QodHlwZW9mIGVsZW0uY2xhc3NOYW1lID09PSAic3RyaW5nIiAmJiBlbGVtLmNsYXNzTmFtZSB8fCB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgIT09ICJ1bmRlZmluZWQiICYmIGVsZW0uZ2V0QXR0cmlidXRlKCJjbGFzcyIpIHx8ICIiKTsKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgIkFUVFIiOiBmdW5jdGlvbiBBVFRSKG5hbWUsIG9wZXJhdG9yLCBjaGVjaykgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBTaXp6bGUuYXR0cihlbGVtLCBuYW1lKTsKICAgICAgICAgICAgaWYgKHJlc3VsdCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG9wZXJhdG9yID09PSAiIT0iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghb3BlcmF0b3IpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHQgKz0gIiI7CgogICAgICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZSBtYXgtbGVuICovCgogICAgICAgICAgICByZXR1cm4gb3BlcmF0b3IgPT09ICI9IiA/IHJlc3VsdCA9PT0gY2hlY2sgOiBvcGVyYXRvciA9PT0gIiE9IiA/IHJlc3VsdCAhPT0gY2hlY2sgOiBvcGVyYXRvciA9PT0gIl49IiA/IGNoZWNrICYmIHJlc3VsdC5pbmRleE9mKGNoZWNrKSA9PT0gMCA6IG9wZXJhdG9yID09PSAiKj0iID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoY2hlY2spID4gLTEgOiBvcGVyYXRvciA9PT0gIiQ9IiA/IGNoZWNrICYmIHJlc3VsdC5zbGljZSgtY2hlY2subGVuZ3RoKSA9PT0gY2hlY2sgOiBvcGVyYXRvciA9PT0gIn49IiA/ICgiICIgKyByZXN1bHQucmVwbGFjZShyd2hpdGVzcGFjZSwgIiAiKSArICIgIikuaW5kZXhPZihjaGVjaykgPiAtMSA6IG9wZXJhdG9yID09PSAifD0iID8gcmVzdWx0ID09PSBjaGVjayB8fCByZXN1bHQuc2xpY2UoMCwgY2hlY2subGVuZ3RoICsgMSkgPT09IGNoZWNrICsgIi0iIDogZmFsc2U7CiAgICAgICAgICAgIC8qIGVzbGludC1lbmFibGUgbWF4LWxlbiAqLwogICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICAiQ0hJTEQiOiBmdW5jdGlvbiBDSElMRCh0eXBlLCB3aGF0LCBfYXJndW1lbnQsIGZpcnN0LCBsYXN0KSB7CiAgICAgICAgICB2YXIgc2ltcGxlID0gdHlwZS5zbGljZSgwLCAzKSAhPT0gIm50aCIsCiAgICAgICAgICAgIGZvcndhcmQgPSB0eXBlLnNsaWNlKC00KSAhPT0gImxhc3QiLAogICAgICAgICAgICBvZlR5cGUgPSB3aGF0ID09PSAib2YtdHlwZSI7CiAgICAgICAgICByZXR1cm4gZmlyc3QgPT09IDEgJiYgbGFzdCA9PT0gMCA/CiAgICAgICAgICAvLyBTaG9ydGN1dCBmb3IgOm50aC0qKG4pCiAgICAgICAgICBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gISFlbGVtLnBhcmVudE5vZGU7CiAgICAgICAgICB9IDogZnVuY3Rpb24gKGVsZW0sIF9jb250ZXh0LCB4bWwpIHsKICAgICAgICAgICAgdmFyIGNhY2hlLAogICAgICAgICAgICAgIHVuaXF1ZUNhY2hlLAogICAgICAgICAgICAgIG91dGVyQ2FjaGUsCiAgICAgICAgICAgICAgbm9kZSwKICAgICAgICAgICAgICBub2RlSW5kZXgsCiAgICAgICAgICAgICAgc3RhcnQsCiAgICAgICAgICAgICAgZGlyID0gc2ltcGxlICE9PSBmb3J3YXJkID8gIm5leHRTaWJsaW5nIiA6ICJwcmV2aW91c1NpYmxpbmciLAogICAgICAgICAgICAgIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZSwKICAgICAgICAgICAgICBuYW1lID0gb2ZUeXBlICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgICB1c2VDYWNoZSA9ICF4bWwgJiYgIW9mVHlwZSwKICAgICAgICAgICAgICBkaWZmID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgICAgICAvLyA6KGZpcnN0fGxhc3R8b25seSktKGNoaWxkfG9mLXR5cGUpCiAgICAgICAgICAgICAgaWYgKHNpbXBsZSkgewogICAgICAgICAgICAgICAgd2hpbGUgKGRpcikgewogICAgICAgICAgICAgICAgICBub2RlID0gZWxlbTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUgPSBub2RlW2Rpcl0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAob2ZUeXBlID8gbm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lIDogbm9kZS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgLy8gUmV2ZXJzZSBkaXJlY3Rpb24gZm9yIDpvbmx5LSogKGlmIHdlIGhhdmVuJ3QgeWV0IGRvbmUgc28pCiAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gZGlyID0gdHlwZSA9PT0gIm9ubHkiICYmICFzdGFydCAmJiAibmV4dFNpYmxpbmciOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN0YXJ0ID0gW2ZvcndhcmQgPyBwYXJlbnQuZmlyc3RDaGlsZCA6IHBhcmVudC5sYXN0Q2hpbGRdOwoKICAgICAgICAgICAgICAvLyBub24teG1sIDpudGgtY2hpbGQoLi4uKSBzdG9yZXMgY2FjaGUgZGF0YSBvbiBgcGFyZW50YAogICAgICAgICAgICAgIGlmIChmb3J3YXJkICYmIHVzZUNhY2hlKSB7CiAgICAgICAgICAgICAgICAvLyBTZWVrIGBlbGVtYCBmcm9tIGEgcHJldmlvdXNseS1jYWNoZWQgaW5kZXgKCiAgICAgICAgICAgICAgICAvLyAuLi5pbiBhIGd6aXAtZnJpZW5kbHkgd2F5CiAgICAgICAgICAgICAgICBub2RlID0gcGFyZW50OwogICAgICAgICAgICAgICAgb3V0ZXJDYWNoZSA9IG5vZGVbZXhwYW5kb10gfHwgKG5vZGVbZXhwYW5kb10gPSB7fSk7CgogICAgICAgICAgICAgICAgLy8gU3VwcG9ydDogSUUgPDkgb25seQogICAgICAgICAgICAgICAgLy8gRGVmZW5kIGFnYWluc3QgY2xvbmVkIGF0dHJvcGVydGllcyAoalF1ZXJ5IGdoLTE3MDkpCiAgICAgICAgICAgICAgICB1bmlxdWVDYWNoZSA9IG91dGVyQ2FjaGVbbm9kZS51bmlxdWVJRF0gfHwgKG91dGVyQ2FjaGVbbm9kZS51bmlxdWVJRF0gPSB7fSk7CiAgICAgICAgICAgICAgICBjYWNoZSA9IHVuaXF1ZUNhY2hlW3R5cGVdIHx8IFtdOwogICAgICAgICAgICAgICAgbm9kZUluZGV4ID0gY2FjaGVbMF0gPT09IGRpcnJ1bnMgJiYgY2FjaGVbMV07CiAgICAgICAgICAgICAgICBkaWZmID0gbm9kZUluZGV4ICYmIGNhY2hlWzJdOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGVJbmRleCAmJiBwYXJlbnQuY2hpbGROb2Rlc1tub2RlSW5kZXhdOwogICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUgPSArK25vZGVJbmRleCAmJiBub2RlICYmIG5vZGVbZGlyXSB8fCAoCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBzZWVraW5nIGBlbGVtYCBmcm9tIHRoZSBzdGFydAogICAgICAgICAgICAgICAgZGlmZiA9IG5vZGVJbmRleCA9IDApIHx8IHN0YXJ0LnBvcCgpKSB7CiAgICAgICAgICAgICAgICAgIC8vIFdoZW4gZm91bmQsIGNhY2hlIGluZGV4ZXMgb24gYHBhcmVudGAgYW5kIGJyZWFrCiAgICAgICAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxICYmICsrZGlmZiAmJiBub2RlID09PSBlbGVtKSB7CiAgICAgICAgICAgICAgICAgICAgdW5pcXVlQ2FjaGVbdHlwZV0gPSBbZGlycnVucywgbm9kZUluZGV4LCBkaWZmXTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBVc2UgcHJldmlvdXNseS1jYWNoZWQgZWxlbWVudCBpbmRleCBpZiBhdmFpbGFibGUKICAgICAgICAgICAgICAgIGlmICh1c2VDYWNoZSkgewogICAgICAgICAgICAgICAgICAvLyAuLi5pbiBhIGd6aXAtZnJpZW5kbHkgd2F5CiAgICAgICAgICAgICAgICAgIG5vZGUgPSBlbGVtOwogICAgICAgICAgICAgICAgICBvdXRlckNhY2hlID0gbm9kZVtleHBhbmRvXSB8fCAobm9kZVtleHBhbmRvXSA9IHt9KTsKCiAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDw5IG9ubHkKICAgICAgICAgICAgICAgICAgLy8gRGVmZW5kIGFnYWluc3QgY2xvbmVkIGF0dHJvcGVydGllcyAoalF1ZXJ5IGdoLTE3MDkpCiAgICAgICAgICAgICAgICAgIHVuaXF1ZUNhY2hlID0gb3V0ZXJDYWNoZVtub2RlLnVuaXF1ZUlEXSB8fCAob3V0ZXJDYWNoZVtub2RlLnVuaXF1ZUlEXSA9IHt9KTsKICAgICAgICAgICAgICAgICAgY2FjaGUgPSB1bmlxdWVDYWNoZVt0eXBlXSB8fCBbXTsKICAgICAgICAgICAgICAgICAgbm9kZUluZGV4ID0gY2FjaGVbMF0gPT09IGRpcnJ1bnMgJiYgY2FjaGVbMV07CiAgICAgICAgICAgICAgICAgIGRpZmYgPSBub2RlSW5kZXg7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8geG1sIDpudGgtY2hpbGQoLi4uKQogICAgICAgICAgICAgICAgLy8gb3IgOm50aC1sYXN0LWNoaWxkKC4uLikgb3IgOm50aCgtbGFzdCk/LW9mLXR5cGUoLi4uKQogICAgICAgICAgICAgICAgaWYgKGRpZmYgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgIC8vIFVzZSB0aGUgc2FtZSBsb29wIGFzIGFib3ZlIHRvIHNlZWsgYGVsZW1gIGZyb20gdGhlIHN0YXJ0CiAgICAgICAgICAgICAgICAgIHdoaWxlIChub2RlID0gKytub2RlSW5kZXggJiYgbm9kZSAmJiBub2RlW2Rpcl0gfHwgKGRpZmYgPSBub2RlSW5kZXggPSAwKSB8fCBzdGFydC5wb3AoKSkgewogICAgICAgICAgICAgICAgICAgIGlmICgob2ZUeXBlID8gbm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lIDogbm9kZS5ub2RlVHlwZSA9PT0gMSkgJiYgKytkaWZmKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBDYWNoZSB0aGUgaW5kZXggb2YgZWFjaCBlbmNvdW50ZXJlZCBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICBpZiAodXNlQ2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3V0ZXJDYWNoZSA9IG5vZGVbZXhwYW5kb10gfHwgKG5vZGVbZXhwYW5kb10gPSB7fSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8OSBvbmx5CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlZmVuZCBhZ2FpbnN0IGNsb25lZCBhdHRyb3BlcnRpZXMgKGpRdWVyeSBnaC0xNzA5KQogICAgICAgICAgICAgICAgICAgICAgICB1bmlxdWVDYWNoZSA9IG91dGVyQ2FjaGVbbm9kZS51bmlxdWVJRF0gfHwgKG91dGVyQ2FjaGVbbm9kZS51bmlxdWVJRF0gPSB7fSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHVuaXF1ZUNhY2hlW3R5cGVdID0gW2RpcnJ1bnMsIGRpZmZdOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBJbmNvcnBvcmF0ZSB0aGUgb2Zmc2V0LCB0aGVuIGNoZWNrIGFnYWluc3QgY3ljbGUgc2l6ZQogICAgICAgICAgICAgIGRpZmYgLT0gbGFzdDsKICAgICAgICAgICAgICByZXR1cm4gZGlmZiA9PT0gZmlyc3QgfHwgZGlmZiAlIGZpcnN0ID09PSAwICYmIGRpZmYgLyBmaXJzdCA+PSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgIlBTRVVETyI6IGZ1bmN0aW9uIFBTRVVETyhwc2V1ZG8sIGFyZ3VtZW50KSB7CiAgICAgICAgICAvLyBwc2V1ZG8tY2xhc3MgbmFtZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUKICAgICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jcHNldWRvLWNsYXNzZXMKICAgICAgICAgIC8vIFByaW9yaXRpemUgYnkgY2FzZSBzZW5zaXRpdml0eSBpbiBjYXNlIGN1c3RvbSBwc2V1ZG9zIGFyZSBhZGRlZCB3aXRoIHVwcGVyY2FzZSBsZXR0ZXJzCiAgICAgICAgICAvLyBSZW1lbWJlciB0aGF0IHNldEZpbHRlcnMgaW5oZXJpdHMgZnJvbSBwc2V1ZG9zCiAgICAgICAgICB2YXIgYXJncywKICAgICAgICAgICAgZm4gPSBFeHByLnBzZXVkb3NbcHNldWRvXSB8fCBFeHByLnNldEZpbHRlcnNbcHNldWRvLnRvTG93ZXJDYXNlKCldIHx8IFNpenpsZS5lcnJvcigidW5zdXBwb3J0ZWQgcHNldWRvOiAiICsgcHNldWRvKTsKCiAgICAgICAgICAvLyBUaGUgdXNlciBtYXkgdXNlIGNyZWF0ZVBzZXVkbyB0byBpbmRpY2F0ZSB0aGF0CiAgICAgICAgICAvLyBhcmd1bWVudHMgYXJlIG5lZWRlZCB0byBjcmVhdGUgdGhlIGZpbHRlciBmdW5jdGlvbgogICAgICAgICAgLy8ganVzdCBhcyBTaXp6bGUgZG9lcwogICAgICAgICAgaWYgKGZuW2V4cGFuZG9dKSB7CiAgICAgICAgICAgIHJldHVybiBmbihhcmd1bWVudCk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQnV0IG1haW50YWluIHN1cHBvcnQgZm9yIG9sZCBzaWduYXR1cmVzCiAgICAgICAgICBpZiAoZm4ubGVuZ3RoID4gMSkgewogICAgICAgICAgICBhcmdzID0gW3BzZXVkbywgcHNldWRvLCAiIiwgYXJndW1lbnRdOwogICAgICAgICAgICByZXR1cm4gRXhwci5zZXRGaWx0ZXJzLmhhc093blByb3BlcnR5KHBzZXVkby50b0xvd2VyQ2FzZSgpKSA/IG1hcmtGdW5jdGlvbihmdW5jdGlvbiAoc2VlZCwgbWF0Y2hlcykgewogICAgICAgICAgICAgIHZhciBpZHgsCiAgICAgICAgICAgICAgICBtYXRjaGVkID0gZm4oc2VlZCwgYXJndW1lbnQpLAogICAgICAgICAgICAgICAgaSA9IG1hdGNoZWQubGVuZ3RoOwogICAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgIGlkeCA9IGluZGV4T2Yoc2VlZCwgbWF0Y2hlZFtpXSk7CiAgICAgICAgICAgICAgICBzZWVkW2lkeF0gPSAhKG1hdGNoZXNbaWR4XSA9IG1hdGNoZWRbaV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkgOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICAgIHJldHVybiBmbihlbGVtLCAwLCBhcmdzKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHBzZXVkb3M6IHsKICAgICAgICAvLyBQb3RlbnRpYWxseSBjb21wbGV4IHBzZXVkb3MKICAgICAgICAibm90IjogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICAgICAgLy8gVHJpbSB0aGUgc2VsZWN0b3IgcGFzc2VkIHRvIGNvbXBpbGUKICAgICAgICAgIC8vIHRvIGF2b2lkIHRyZWF0aW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nCiAgICAgICAgICAvLyBzcGFjZXMgYXMgY29tYmluYXRvcnMKICAgICAgICAgIHZhciBpbnB1dCA9IFtdLAogICAgICAgICAgICByZXN1bHRzID0gW10sCiAgICAgICAgICAgIG1hdGNoZXIgPSBjb21waWxlKHNlbGVjdG9yLnJlcGxhY2UocnRyaW0sICIkMSIpKTsKICAgICAgICAgIHJldHVybiBtYXRjaGVyW2V4cGFuZG9dID8gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWVkLCBtYXRjaGVzLCBfY29udGV4dCwgeG1sKSB7CiAgICAgICAgICAgIHZhciBlbGVtLAogICAgICAgICAgICAgIHVubWF0Y2hlZCA9IG1hdGNoZXIoc2VlZCwgbnVsbCwgeG1sLCBbXSksCiAgICAgICAgICAgICAgaSA9IHNlZWQubGVuZ3RoOwoKICAgICAgICAgICAgLy8gTWF0Y2ggZWxlbWVudHMgdW5tYXRjaGVkIGJ5IGBtYXRjaGVyYAogICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgaWYgKGVsZW0gPSB1bm1hdGNoZWRbaV0pIHsKICAgICAgICAgICAgICAgIHNlZWRbaV0gPSAhKG1hdGNoZXNbaV0gPSBlbGVtKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pIDogZnVuY3Rpb24gKGVsZW0sIF9jb250ZXh0LCB4bWwpIHsKICAgICAgICAgICAgaW5wdXRbMF0gPSBlbGVtOwogICAgICAgICAgICBtYXRjaGVyKGlucHV0LCBudWxsLCB4bWwsIHJlc3VsdHMpOwoKICAgICAgICAgICAgLy8gRG9uJ3Qga2VlcCB0aGUgZWxlbWVudCAoaXNzdWUgIzI5OSkKICAgICAgICAgICAgaW5wdXRbMF0gPSBudWxsOwogICAgICAgICAgICByZXR1cm4gIXJlc3VsdHMucG9wKCk7CiAgICAgICAgICB9OwogICAgICAgIH0pLAogICAgICAgICJoYXMiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuIFNpenpsZShzZWxlY3RvciwgZWxlbSkubGVuZ3RoID4gMDsKICAgICAgICAgIH07CiAgICAgICAgfSksCiAgICAgICAgImNvbnRhaW5zIjogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gKGVsZW0udGV4dENvbnRlbnQgfHwgZ2V0VGV4dChlbGVtKSkuaW5kZXhPZih0ZXh0KSA+IC0xOwogICAgICAgICAgfTsKICAgICAgICB9KSwKICAgICAgICAvLyAiV2hldGhlciBhbiBlbGVtZW50IGlzIHJlcHJlc2VudGVkIGJ5IGEgOmxhbmcoKSBzZWxlY3RvcgogICAgICAgIC8vIGlzIGJhc2VkIHNvbGVseSBvbiB0aGUgZWxlbWVudCdzIGxhbmd1YWdlIHZhbHVlCiAgICAgICAgLy8gYmVpbmcgZXF1YWwgdG8gdGhlIGlkZW50aWZpZXIgQywKICAgICAgICAvLyBvciBiZWdpbm5pbmcgd2l0aCB0aGUgaWRlbnRpZmllciBDIGltbWVkaWF0ZWx5IGZvbGxvd2VkIGJ5ICItIi4KICAgICAgICAvLyBUaGUgbWF0Y2hpbmcgb2YgQyBhZ2FpbnN0IHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUgaXMgcGVyZm9ybWVkIGNhc2UtaW5zZW5zaXRpdmVseS4KICAgICAgICAvLyBUaGUgaWRlbnRpZmllciBDIGRvZXMgbm90IGhhdmUgdG8gYmUgYSB2YWxpZCBsYW5ndWFnZSBuYW1lLiIKICAgICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2xhbmctcHNldWRvCiAgICAgICAgImxhbmciOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKGxhbmcpIHsKICAgICAgICAgIC8vIGxhbmcgdmFsdWUgbXVzdCBiZSBhIHZhbGlkIGlkZW50aWZpZXIKICAgICAgICAgIGlmICghcmlkZW50aWZpZXIudGVzdChsYW5nIHx8ICIiKSkgewogICAgICAgICAgICBTaXp6bGUuZXJyb3IoInVuc3VwcG9ydGVkIGxhbmc6ICIgKyBsYW5nKTsKICAgICAgICAgIH0KICAgICAgICAgIGxhbmcgPSBsYW5nLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgdmFyIGVsZW1MYW5nOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKGVsZW1MYW5nID0gZG9jdW1lbnRJc0hUTUwgPyBlbGVtLmxhbmcgOiBlbGVtLmdldEF0dHJpYnV0ZSgieG1sOmxhbmciKSB8fCBlbGVtLmdldEF0dHJpYnV0ZSgibGFuZyIpKSB7CiAgICAgICAgICAgICAgICBlbGVtTGFuZyA9IGVsZW1MYW5nLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZWxlbUxhbmcgPT09IGxhbmcgfHwgZWxlbUxhbmcuaW5kZXhPZihsYW5nICsgIi0iKSA9PT0gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gd2hpbGUgKChlbGVtID0gZWxlbS5wYXJlbnROb2RlKSAmJiBlbGVtLm5vZGVUeXBlID09PSAxKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfTsKICAgICAgICB9KSwKICAgICAgICAvLyBNaXNjZWxsYW5lb3VzCiAgICAgICAgInRhcmdldCI6IGZ1bmN0aW9uIHRhcmdldChlbGVtKSB7CiAgICAgICAgICB2YXIgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbiAmJiB3aW5kb3cubG9jYXRpb24uaGFzaDsKICAgICAgICAgIHJldHVybiBoYXNoICYmIGhhc2guc2xpY2UoMSkgPT09IGVsZW0uaWQ7CiAgICAgICAgfSwKICAgICAgICAicm9vdCI6IGZ1bmN0aW9uIHJvb3QoZWxlbSkgewogICAgICAgICAgcmV0dXJuIGVsZW0gPT09IGRvY0VsZW07CiAgICAgICAgfSwKICAgICAgICAiZm9jdXMiOiBmdW5jdGlvbiBmb2N1cyhlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbSA9PT0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiAoIWRvY3VtZW50Lmhhc0ZvY3VzIHx8IGRvY3VtZW50Lmhhc0ZvY3VzKCkpICYmICEhKGVsZW0udHlwZSB8fCBlbGVtLmhyZWYgfHwgfmVsZW0udGFiSW5kZXgpOwogICAgICAgIH0sCiAgICAgICAgLy8gQm9vbGVhbiBwcm9wZXJ0aWVzCiAgICAgICAgImVuYWJsZWQiOiBjcmVhdGVEaXNhYmxlZFBzZXVkbyhmYWxzZSksCiAgICAgICAgImRpc2FibGVkIjogY3JlYXRlRGlzYWJsZWRQc2V1ZG8odHJ1ZSksCiAgICAgICAgImNoZWNrZWQiOiBmdW5jdGlvbiBjaGVja2VkKGVsZW0pIHsKICAgICAgICAgIC8vIEluIENTUzMsIDpjaGVja2VkIHNob3VsZCByZXR1cm4gYm90aCBjaGVja2VkIGFuZCBzZWxlY3RlZCBlbGVtZW50cwogICAgICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvMjAxMS9SRUMtY3NzMy1zZWxlY3RvcnMtMjAxMTA5MjkvI2NoZWNrZWQKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSA9PT0gImlucHV0IiAmJiAhIWVsZW0uY2hlY2tlZCB8fCBub2RlTmFtZSA9PT0gIm9wdGlvbiIgJiYgISFlbGVtLnNlbGVjdGVkOwogICAgICAgIH0sCiAgICAgICAgInNlbGVjdGVkIjogZnVuY3Rpb24gc2VsZWN0ZWQoZWxlbSkgewogICAgICAgICAgLy8gQWNjZXNzaW5nIHRoaXMgcHJvcGVydHkgbWFrZXMgc2VsZWN0ZWQtYnktZGVmYXVsdAogICAgICAgICAgLy8gb3B0aW9ucyBpbiBTYWZhcmkgd29yayBwcm9wZXJseQogICAgICAgICAgaWYgKGVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLWV4cHJlc3Npb25zCiAgICAgICAgICAgIGVsZW0ucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW0uc2VsZWN0ZWQgPT09IHRydWU7CiAgICAgICAgfSwKICAgICAgICAvLyBDb250ZW50cwogICAgICAgICJlbXB0eSI6IGZ1bmN0aW9uIGVtcHR5KGVsZW0pIHsKICAgICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jZW1wdHktcHNldWRvCiAgICAgICAgICAvLyA6ZW1wdHkgaXMgbmVnYXRlZCBieSBlbGVtZW50ICgxKSBvciBjb250ZW50IG5vZGVzICh0ZXh0OiAzOyBjZGF0YTogNDsgZW50aXR5IHJlZjogNSksCiAgICAgICAgICAvLyAgIGJ1dCBub3QgYnkgb3RoZXJzIChjb21tZW50OiA4OyBwcm9jZXNzaW5nIGluc3RydWN0aW9uOiA3OyBldGMuKQogICAgICAgICAgLy8gbm9kZVR5cGUgPCA2IHdvcmtzIGJlY2F1c2UgYXR0cmlidXRlcyAoMikgZG8gbm90IGFwcGVhciBhcyBjaGlsZHJlbgogICAgICAgICAgZm9yIChlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZykgewogICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA8IDYpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCiAgICAgICAgInBhcmVudCI6IGZ1bmN0aW9uIHBhcmVudChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gIUV4cHIucHNldWRvc1siZW1wdHkiXShlbGVtKTsKICAgICAgICB9LAogICAgICAgIC8vIEVsZW1lbnQvaW5wdXQgdHlwZXMKICAgICAgICAiaGVhZGVyIjogZnVuY3Rpb24gaGVhZGVyKGVsZW0pIHsKICAgICAgICAgIHJldHVybiByaGVhZGVyLnRlc3QoZWxlbS5ub2RlTmFtZSk7CiAgICAgICAgfSwKICAgICAgICAiaW5wdXQiOiBmdW5jdGlvbiBpbnB1dChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gcmlucHV0cy50ZXN0KGVsZW0ubm9kZU5hbWUpOwogICAgICAgIH0sCiAgICAgICAgImJ1dHRvbiI6IGZ1bmN0aW9uIGJ1dHRvbihlbGVtKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBuYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gImJ1dHRvbiIgfHwgbmFtZSA9PT0gImJ1dHRvbiI7CiAgICAgICAgfSwKICAgICAgICAidGV4dCI6IGZ1bmN0aW9uIHRleHQoZWxlbSkgewogICAgICAgICAgdmFyIGF0dHI7CiAgICAgICAgICByZXR1cm4gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gInRleHQiICYmICgKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFPDgKICAgICAgICAgIC8vIE5ldyBIVE1MNSBhdHRyaWJ1dGUgdmFsdWVzIChlLmcuLCAic2VhcmNoIikgYXBwZWFyIHdpdGggZWxlbS50eXBlID09PSAidGV4dCIKICAgICAgICAgIChhdHRyID0gZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKSkgPT0gbnVsbCB8fCBhdHRyLnRvTG93ZXJDYXNlKCkgPT09ICJ0ZXh0Iik7CiAgICAgICAgfSwKICAgICAgICAvLyBQb3NpdGlvbi1pbi1jb2xsZWN0aW9uCiAgICAgICAgImZpcnN0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gWzBdOwogICAgICAgIH0pLAogICAgICAgICJsYXN0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAoX21hdGNoSW5kZXhlcywgbGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4gW2xlbmd0aCAtIDFdOwogICAgICAgIH0pLAogICAgICAgICJlcSI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24gKF9tYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQpIHsKICAgICAgICAgIHJldHVybiBbYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudF07CiAgICAgICAgfSksCiAgICAgICAgImV2ZW4iOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCkgewogICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgICBtYXRjaEluZGV4ZXMucHVzaChpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaEluZGV4ZXM7CiAgICAgICAgfSksCiAgICAgICAgIm9kZCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24gKG1hdGNoSW5kZXhlcywgbGVuZ3RoKSB7CiAgICAgICAgICB2YXIgaSA9IDE7CiAgICAgICAgICBmb3IgKDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICAgIG1hdGNoSW5kZXhlcy5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoSW5kZXhlczsKICAgICAgICB9KSwKICAgICAgICAibHQiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQpIHsKICAgICAgICAgIHZhciBpID0gYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudCA+IGxlbmd0aCA/IGxlbmd0aCA6IGFyZ3VtZW50OwogICAgICAgICAgZm9yICg7IC0taSA+PSAwOykgewogICAgICAgICAgICBtYXRjaEluZGV4ZXMucHVzaChpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaEluZGV4ZXM7CiAgICAgICAgfSksCiAgICAgICAgImd0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAobWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50KSB7CiAgICAgICAgICB2YXIgaSA9IGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQ7CiAgICAgICAgICBmb3IgKDsgKytpIDwgbGVuZ3RoOykgewogICAgICAgICAgICBtYXRjaEluZGV4ZXMucHVzaChpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaEluZGV4ZXM7CiAgICAgICAgfSkKICAgICAgfQogICAgfTsKICAgIEV4cHIucHNldWRvc1sibnRoIl0gPSBFeHByLnBzZXVkb3NbImVxIl07CgogICAgLy8gQWRkIGJ1dHRvbi9pbnB1dCB0eXBlIHBzZXVkb3MKICAgIGZvciAoaSBpbiB7CiAgICAgIHJhZGlvOiB0cnVlLAogICAgICBjaGVja2JveDogdHJ1ZSwKICAgICAgZmlsZTogdHJ1ZSwKICAgICAgcGFzc3dvcmQ6IHRydWUsCiAgICAgIGltYWdlOiB0cnVlCiAgICB9KSB7CiAgICAgIEV4cHIucHNldWRvc1tpXSA9IGNyZWF0ZUlucHV0UHNldWRvKGkpOwogICAgfQogICAgZm9yIChpIGluIHsKICAgICAgc3VibWl0OiB0cnVlLAogICAgICByZXNldDogdHJ1ZQogICAgfSkgewogICAgICBFeHByLnBzZXVkb3NbaV0gPSBjcmVhdGVCdXR0b25Qc2V1ZG8oaSk7CiAgICB9CgogICAgLy8gRWFzeSBBUEkgZm9yIGNyZWF0aW5nIG5ldyBzZXRGaWx0ZXJzCiAgICBmdW5jdGlvbiBzZXRGaWx0ZXJzKCkge30KICAgIHNldEZpbHRlcnMucHJvdG90eXBlID0gRXhwci5maWx0ZXJzID0gRXhwci5wc2V1ZG9zOwogICAgRXhwci5zZXRGaWx0ZXJzID0gbmV3IHNldEZpbHRlcnMoKTsKICAgIHRva2VuaXplID0gU2l6emxlLnRva2VuaXplID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBwYXJzZU9ubHkpIHsKICAgICAgdmFyIG1hdGNoZWQsCiAgICAgICAgbWF0Y2gsCiAgICAgICAgdG9rZW5zLAogICAgICAgIHR5cGUsCiAgICAgICAgc29GYXIsCiAgICAgICAgZ3JvdXBzLAogICAgICAgIHByZUZpbHRlcnMsCiAgICAgICAgY2FjaGVkID0gdG9rZW5DYWNoZVtzZWxlY3RvciArICIgIl07CiAgICAgIGlmIChjYWNoZWQpIHsKICAgICAgICByZXR1cm4gcGFyc2VPbmx5ID8gMCA6IGNhY2hlZC5zbGljZSgwKTsKICAgICAgfQogICAgICBzb0ZhciA9IHNlbGVjdG9yOwogICAgICBncm91cHMgPSBbXTsKICAgICAgcHJlRmlsdGVycyA9IEV4cHIucHJlRmlsdGVyOwogICAgICB3aGlsZSAoc29GYXIpIHsKICAgICAgICAvLyBDb21tYSBhbmQgZmlyc3QgcnVuCiAgICAgICAgaWYgKCFtYXRjaGVkIHx8IChtYXRjaCA9IHJjb21tYS5leGVjKHNvRmFyKSkpIHsKICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAvLyBEb24ndCBjb25zdW1lIHRyYWlsaW5nIGNvbW1hcyBhcyB2YWxpZAogICAgICAgICAgICBzb0ZhciA9IHNvRmFyLnNsaWNlKG1hdGNoWzBdLmxlbmd0aCkgfHwgc29GYXI7CiAgICAgICAgICB9CiAgICAgICAgICBncm91cHMucHVzaCh0b2tlbnMgPSBbXSk7CiAgICAgICAgfQogICAgICAgIG1hdGNoZWQgPSBmYWxzZTsKCiAgICAgICAgLy8gQ29tYmluYXRvcnMKICAgICAgICBpZiAobWF0Y2ggPSByY29tYmluYXRvcnMuZXhlYyhzb0ZhcikpIHsKICAgICAgICAgIG1hdGNoZWQgPSBtYXRjaC5zaGlmdCgpOwogICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICB2YWx1ZTogbWF0Y2hlZCwKICAgICAgICAgICAgLy8gQ2FzdCBkZXNjZW5kYW50IGNvbWJpbmF0b3JzIHRvIHNwYWNlCiAgICAgICAgICAgIHR5cGU6IG1hdGNoWzBdLnJlcGxhY2UocnRyaW0sICIgIikKICAgICAgICAgIH0pOwogICAgICAgICAgc29GYXIgPSBzb0Zhci5zbGljZShtYXRjaGVkLmxlbmd0aCk7CiAgICAgICAgfQoKICAgICAgICAvLyBGaWx0ZXJzCiAgICAgICAgZm9yICh0eXBlIGluIEV4cHIuZmlsdGVyKSB7CiAgICAgICAgICBpZiAoKG1hdGNoID0gbWF0Y2hFeHByW3R5cGVdLmV4ZWMoc29GYXIpKSAmJiAoIXByZUZpbHRlcnNbdHlwZV0gfHwgKG1hdGNoID0gcHJlRmlsdGVyc1t0eXBlXShtYXRjaCkpKSkgewogICAgICAgICAgICBtYXRjaGVkID0gbWF0Y2guc2hpZnQoKTsKICAgICAgICAgICAgdG9rZW5zLnB1c2goewogICAgICAgICAgICAgIHZhbHVlOiBtYXRjaGVkLAogICAgICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICAgICAgbWF0Y2hlczogbWF0Y2gKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNvRmFyID0gc29GYXIuc2xpY2UobWF0Y2hlZC5sZW5ndGgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIW1hdGNoZWQpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gUmV0dXJuIHRoZSBsZW5ndGggb2YgdGhlIGludmFsaWQgZXhjZXNzCiAgICAgIC8vIGlmIHdlJ3JlIGp1c3QgcGFyc2luZwogICAgICAvLyBPdGhlcndpc2UsIHRocm93IGFuIGVycm9yIG9yIHJldHVybiB0b2tlbnMKICAgICAgcmV0dXJuIHBhcnNlT25seSA/IHNvRmFyLmxlbmd0aCA6IHNvRmFyID8gU2l6emxlLmVycm9yKHNlbGVjdG9yKSA6CiAgICAgIC8vIENhY2hlIHRoZSB0b2tlbnMKICAgICAgdG9rZW5DYWNoZShzZWxlY3RvciwgZ3JvdXBzKS5zbGljZSgwKTsKICAgIH07CiAgICBmdW5jdGlvbiB0b1NlbGVjdG9yKHRva2VucykgewogICAgICB2YXIgaSA9IDAsCiAgICAgICAgbGVuID0gdG9rZW5zLmxlbmd0aCwKICAgICAgICBzZWxlY3RvciA9ICIiOwogICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgc2VsZWN0b3IgKz0gdG9rZW5zW2ldLnZhbHVlOwogICAgICB9CiAgICAgIHJldHVybiBzZWxlY3RvcjsKICAgIH0KICAgIGZ1bmN0aW9uIGFkZENvbWJpbmF0b3IobWF0Y2hlciwgY29tYmluYXRvciwgYmFzZSkgewogICAgICB2YXIgZGlyID0gY29tYmluYXRvci5kaXIsCiAgICAgICAgc2tpcCA9IGNvbWJpbmF0b3IubmV4dCwKICAgICAgICBrZXkgPSBza2lwIHx8IGRpciwKICAgICAgICBjaGVja05vbkVsZW1lbnRzID0gYmFzZSAmJiBrZXkgPT09ICJwYXJlbnROb2RlIiwKICAgICAgICBkb25lTmFtZSA9IGRvbmUrKzsKICAgICAgcmV0dXJuIGNvbWJpbmF0b3IuZmlyc3QgPwogICAgICAvLyBDaGVjayBhZ2FpbnN0IGNsb3Nlc3QgYW5jZXN0b3IvcHJlY2VkaW5nIGVsZW1lbnQKICAgICAgZnVuY3Rpb24gKGVsZW0sIGNvbnRleHQsIHhtbCkgewogICAgICAgIHdoaWxlIChlbGVtID0gZWxlbVtkaXJdKSB7CiAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzKSB7CiAgICAgICAgICAgIHJldHVybiBtYXRjaGVyKGVsZW0sIGNvbnRleHQsIHhtbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSA6CiAgICAgIC8vIENoZWNrIGFnYWluc3QgYWxsIGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50cwogICAgICBmdW5jdGlvbiAoZWxlbSwgY29udGV4dCwgeG1sKSB7CiAgICAgICAgdmFyIG9sZENhY2hlLAogICAgICAgICAgdW5pcXVlQ2FjaGUsCiAgICAgICAgICBvdXRlckNhY2hlLAogICAgICAgICAgbmV3Q2FjaGUgPSBbZGlycnVucywgZG9uZU5hbWVdOwoKICAgICAgICAvLyBXZSBjYW4ndCBzZXQgYXJiaXRyYXJ5IGRhdGEgb24gWE1MIG5vZGVzLCBzbyB0aGV5IGRvbid0IGJlbmVmaXQgZnJvbSBjb21iaW5hdG9yIGNhY2hpbmcKICAgICAgICBpZiAoeG1sKSB7CiAgICAgICAgICB3aGlsZSAoZWxlbSA9IGVsZW1bZGlyXSkgewogICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzKSB7CiAgICAgICAgICAgICAgaWYgKG1hdGNoZXIoZWxlbSwgY29udGV4dCwgeG1sKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdoaWxlIChlbGVtID0gZWxlbVtkaXJdKSB7CiAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMpIHsKICAgICAgICAgICAgICBvdXRlckNhY2hlID0gZWxlbVtleHBhbmRvXSB8fCAoZWxlbVtleHBhbmRvXSA9IHt9KTsKCiAgICAgICAgICAgICAgLy8gU3VwcG9ydDogSUUgPDkgb25seQogICAgICAgICAgICAgIC8vIERlZmVuZCBhZ2FpbnN0IGNsb25lZCBhdHRyb3BlcnRpZXMgKGpRdWVyeSBnaC0xNzA5KQogICAgICAgICAgICAgIHVuaXF1ZUNhY2hlID0gb3V0ZXJDYWNoZVtlbGVtLnVuaXF1ZUlEXSB8fCAob3V0ZXJDYWNoZVtlbGVtLnVuaXF1ZUlEXSA9IHt9KTsKICAgICAgICAgICAgICBpZiAoc2tpcCAmJiBza2lwID09PSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAgICAgICAgIGVsZW0gPSBlbGVtW2Rpcl0gfHwgZWxlbTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKChvbGRDYWNoZSA9IHVuaXF1ZUNhY2hlW2tleV0pICYmIG9sZENhY2hlWzBdID09PSBkaXJydW5zICYmIG9sZENhY2hlWzFdID09PSBkb25lTmFtZSkgewogICAgICAgICAgICAgICAgLy8gQXNzaWduIHRvIG5ld0NhY2hlIHNvIHJlc3VsdHMgYmFjay1wcm9wYWdhdGUgdG8gcHJldmlvdXMgZWxlbWVudHMKICAgICAgICAgICAgICAgIHJldHVybiBuZXdDYWNoZVsyXSA9IG9sZENhY2hlWzJdOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBSZXVzZSBuZXdjYWNoZSBzbyByZXN1bHRzIGJhY2stcHJvcGFnYXRlIHRvIHByZXZpb3VzIGVsZW1lbnRzCiAgICAgICAgICAgICAgICB1bmlxdWVDYWNoZVtrZXldID0gbmV3Q2FjaGU7CgogICAgICAgICAgICAgICAgLy8gQSBtYXRjaCBtZWFucyB3ZSdyZSBkb25lOyBhIGZhaWwgbWVhbnMgd2UgaGF2ZSB0byBrZWVwIGNoZWNraW5nCiAgICAgICAgICAgICAgICBpZiAobmV3Q2FjaGVbMl0gPSBtYXRjaGVyKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGVsZW1lbnRNYXRjaGVyKG1hdGNoZXJzKSB7CiAgICAgIHJldHVybiBtYXRjaGVycy5sZW5ndGggPiAxID8gZnVuY3Rpb24gKGVsZW0sIGNvbnRleHQsIHhtbCkgewogICAgICAgIHZhciBpID0gbWF0Y2hlcnMubGVuZ3RoOwogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgIGlmICghbWF0Y2hlcnNbaV0oZWxlbSwgY29udGV4dCwgeG1sKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IDogbWF0Y2hlcnNbMF07CiAgICB9CiAgICBmdW5jdGlvbiBtdWx0aXBsZUNvbnRleHRzKHNlbGVjdG9yLCBjb250ZXh0cywgcmVzdWx0cykgewogICAgICB2YXIgaSA9IDAsCiAgICAgICAgbGVuID0gY29udGV4dHMubGVuZ3RoOwogICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgU2l6emxlKHNlbGVjdG9yLCBjb250ZXh0c1tpXSwgcmVzdWx0cyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICB9CiAgICBmdW5jdGlvbiBjb25kZW5zZSh1bm1hdGNoZWQsIG1hcCwgZmlsdGVyLCBjb250ZXh0LCB4bWwpIHsKICAgICAgdmFyIGVsZW0sCiAgICAgICAgbmV3VW5tYXRjaGVkID0gW10sCiAgICAgICAgaSA9IDAsCiAgICAgICAgbGVuID0gdW5tYXRjaGVkLmxlbmd0aCwKICAgICAgICBtYXBwZWQgPSBtYXAgIT0gbnVsbDsKICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgIGlmIChlbGVtID0gdW5tYXRjaGVkW2ldKSB7CiAgICAgICAgICBpZiAoIWZpbHRlciB8fCBmaWx0ZXIoZWxlbSwgY29udGV4dCwgeG1sKSkgewogICAgICAgICAgICBuZXdVbm1hdGNoZWQucHVzaChlbGVtKTsKICAgICAgICAgICAgaWYgKG1hcHBlZCkgewogICAgICAgICAgICAgIG1hcC5wdXNoKGkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBuZXdVbm1hdGNoZWQ7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRNYXRjaGVyKHByZUZpbHRlciwgc2VsZWN0b3IsIG1hdGNoZXIsIHBvc3RGaWx0ZXIsIHBvc3RGaW5kZXIsIHBvc3RTZWxlY3RvcikgewogICAgICBpZiAocG9zdEZpbHRlciAmJiAhcG9zdEZpbHRlcltleHBhbmRvXSkgewogICAgICAgIHBvc3RGaWx0ZXIgPSBzZXRNYXRjaGVyKHBvc3RGaWx0ZXIpOwogICAgICB9CiAgICAgIGlmIChwb3N0RmluZGVyICYmICFwb3N0RmluZGVyW2V4cGFuZG9dKSB7CiAgICAgICAgcG9zdEZpbmRlciA9IHNldE1hdGNoZXIocG9zdEZpbmRlciwgcG9zdFNlbGVjdG9yKTsKICAgICAgfQogICAgICByZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWVkLCByZXN1bHRzLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICB2YXIgdGVtcCwKICAgICAgICAgIGksCiAgICAgICAgICBlbGVtLAogICAgICAgICAgcHJlTWFwID0gW10sCiAgICAgICAgICBwb3N0TWFwID0gW10sCiAgICAgICAgICBwcmVleGlzdGluZyA9IHJlc3VsdHMubGVuZ3RoLAogICAgICAgICAgLy8gR2V0IGluaXRpYWwgZWxlbWVudHMgZnJvbSBzZWVkIG9yIGNvbnRleHQKICAgICAgICAgIGVsZW1zID0gc2VlZCB8fCBtdWx0aXBsZUNvbnRleHRzKHNlbGVjdG9yIHx8ICIqIiwgY29udGV4dC5ub2RlVHlwZSA/IFtjb250ZXh0XSA6IGNvbnRleHQsIFtdKSwKICAgICAgICAgIC8vIFByZWZpbHRlciB0byBnZXQgbWF0Y2hlciBpbnB1dCwgcHJlc2VydmluZyBhIG1hcCBmb3Igc2VlZC1yZXN1bHRzIHN5bmNocm9uaXphdGlvbgogICAgICAgICAgbWF0Y2hlckluID0gcHJlRmlsdGVyICYmIChzZWVkIHx8ICFzZWxlY3RvcikgPyBjb25kZW5zZShlbGVtcywgcHJlTWFwLCBwcmVGaWx0ZXIsIGNvbnRleHQsIHhtbCkgOiBlbGVtcywKICAgICAgICAgIG1hdGNoZXJPdXQgPSBtYXRjaGVyID8KICAgICAgICAgIC8vIElmIHdlIGhhdmUgYSBwb3N0RmluZGVyLCBvciBmaWx0ZXJlZCBzZWVkLCBvciBub24tc2VlZCBwb3N0RmlsdGVyIG9yIHByZWV4aXN0aW5nIHJlc3VsdHMsCiAgICAgICAgICBwb3N0RmluZGVyIHx8IChzZWVkID8gcHJlRmlsdGVyIDogcHJlZXhpc3RpbmcgfHwgcG9zdEZpbHRlcikgPwogICAgICAgICAgLy8gLi4uaW50ZXJtZWRpYXRlIHByb2Nlc3NpbmcgaXMgbmVjZXNzYXJ5CiAgICAgICAgICBbXSA6CiAgICAgICAgICAvLyAuLi5vdGhlcndpc2UgdXNlIHJlc3VsdHMgZGlyZWN0bHkKICAgICAgICAgIHJlc3VsdHMgOiBtYXRjaGVySW47CgogICAgICAgIC8vIEZpbmQgcHJpbWFyeSBtYXRjaGVzCiAgICAgICAgaWYgKG1hdGNoZXIpIHsKICAgICAgICAgIG1hdGNoZXIobWF0Y2hlckluLCBtYXRjaGVyT3V0LCBjb250ZXh0LCB4bWwpOwogICAgICAgIH0KCiAgICAgICAgLy8gQXBwbHkgcG9zdEZpbHRlcgogICAgICAgIGlmIChwb3N0RmlsdGVyKSB7CiAgICAgICAgICB0ZW1wID0gY29uZGVuc2UobWF0Y2hlck91dCwgcG9zdE1hcCk7CiAgICAgICAgICBwb3N0RmlsdGVyKHRlbXAsIFtdLCBjb250ZXh0LCB4bWwpOwoKICAgICAgICAgIC8vIFVuLW1hdGNoIGZhaWxpbmcgZWxlbWVudHMgYnkgbW92aW5nIHRoZW0gYmFjayB0byBtYXRjaGVySW4KICAgICAgICAgIGkgPSB0ZW1wLmxlbmd0aDsKICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgaWYgKGVsZW0gPSB0ZW1wW2ldKSB7CiAgICAgICAgICAgICAgbWF0Y2hlck91dFtwb3N0TWFwW2ldXSA9ICEobWF0Y2hlckluW3Bvc3RNYXBbaV1dID0gZWxlbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHNlZWQpIHsKICAgICAgICAgIGlmIChwb3N0RmluZGVyIHx8IHByZUZpbHRlcikgewogICAgICAgICAgICBpZiAocG9zdEZpbmRlcikgewogICAgICAgICAgICAgIC8vIEdldCB0aGUgZmluYWwgbWF0Y2hlck91dCBieSBjb25kZW5zaW5nIHRoaXMgaW50ZXJtZWRpYXRlIGludG8gcG9zdEZpbmRlciBjb250ZXh0cwogICAgICAgICAgICAgIHRlbXAgPSBbXTsKICAgICAgICAgICAgICBpID0gbWF0Y2hlck91dC5sZW5ndGg7CiAgICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgICAgaWYgKGVsZW0gPSBtYXRjaGVyT3V0W2ldKSB7CiAgICAgICAgICAgICAgICAgIC8vIFJlc3RvcmUgbWF0Y2hlckluIHNpbmNlIGVsZW0gaXMgbm90IHlldCBhIGZpbmFsIG1hdGNoCiAgICAgICAgICAgICAgICAgIHRlbXAucHVzaChtYXRjaGVySW5baV0gPSBlbGVtKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcG9zdEZpbmRlcihudWxsLCBtYXRjaGVyT3V0ID0gW10sIHRlbXAsIHhtbCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1vdmUgbWF0Y2hlZCBlbGVtZW50cyBmcm9tIHNlZWQgdG8gcmVzdWx0cyB0byBrZWVwIHRoZW0gc3luY2hyb25pemVkCiAgICAgICAgICAgIGkgPSBtYXRjaGVyT3V0Lmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgIGlmICgoZWxlbSA9IG1hdGNoZXJPdXRbaV0pICYmICh0ZW1wID0gcG9zdEZpbmRlciA/IGluZGV4T2Yoc2VlZCwgZWxlbSkgOiBwcmVNYXBbaV0pID4gLTEpIHsKICAgICAgICAgICAgICAgIHNlZWRbdGVtcF0gPSAhKHJlc3VsdHNbdGVtcF0gPSBlbGVtKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBBZGQgZWxlbWVudHMgdG8gcmVzdWx0cywgdGhyb3VnaCBwb3N0RmluZGVyIGlmIGRlZmluZWQKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWF0Y2hlck91dCA9IGNvbmRlbnNlKG1hdGNoZXJPdXQgPT09IHJlc3VsdHMgPyBtYXRjaGVyT3V0LnNwbGljZShwcmVleGlzdGluZywgbWF0Y2hlck91dC5sZW5ndGgpIDogbWF0Y2hlck91dCk7CiAgICAgICAgICBpZiAocG9zdEZpbmRlcikgewogICAgICAgICAgICBwb3N0RmluZGVyKG51bGwsIHJlc3VsdHMsIG1hdGNoZXJPdXQsIHhtbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdHMsIG1hdGNoZXJPdXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBmdW5jdGlvbiBtYXRjaGVyRnJvbVRva2Vucyh0b2tlbnMpIHsKICAgICAgdmFyIGNoZWNrQ29udGV4dCwKICAgICAgICBtYXRjaGVyLAogICAgICAgIGosCiAgICAgICAgbGVuID0gdG9rZW5zLmxlbmd0aCwKICAgICAgICBsZWFkaW5nUmVsYXRpdmUgPSBFeHByLnJlbGF0aXZlW3Rva2Vuc1swXS50eXBlXSwKICAgICAgICBpbXBsaWNpdFJlbGF0aXZlID0gbGVhZGluZ1JlbGF0aXZlIHx8IEV4cHIucmVsYXRpdmVbIiAiXSwKICAgICAgICBpID0gbGVhZGluZ1JlbGF0aXZlID8gMSA6IDAsCiAgICAgICAgLy8gVGhlIGZvdW5kYXRpb25hbCBtYXRjaGVyIGVuc3VyZXMgdGhhdCBlbGVtZW50cyBhcmUgcmVhY2hhYmxlIGZyb20gdG9wLWxldmVsIGNvbnRleHQocykKICAgICAgICBtYXRjaENvbnRleHQgPSBhZGRDb21iaW5hdG9yKGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbSA9PT0gY2hlY2tDb250ZXh0OwogICAgICAgIH0sIGltcGxpY2l0UmVsYXRpdmUsIHRydWUpLAogICAgICAgIG1hdGNoQW55Q29udGV4dCA9IGFkZENvbWJpbmF0b3IoZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiBpbmRleE9mKGNoZWNrQ29udGV4dCwgZWxlbSkgPiAtMTsKICAgICAgICB9LCBpbXBsaWNpdFJlbGF0aXZlLCB0cnVlKSwKICAgICAgICBtYXRjaGVycyA9IFtmdW5jdGlvbiAoZWxlbSwgY29udGV4dCwgeG1sKSB7CiAgICAgICAgICB2YXIgcmV0ID0gIWxlYWRpbmdSZWxhdGl2ZSAmJiAoeG1sIHx8IGNvbnRleHQgIT09IG91dGVybW9zdENvbnRleHQpIHx8ICgoY2hlY2tDb250ZXh0ID0gY29udGV4dCkubm9kZVR5cGUgPyBtYXRjaENvbnRleHQoZWxlbSwgY29udGV4dCwgeG1sKSA6IG1hdGNoQW55Q29udGV4dChlbGVtLCBjb250ZXh0LCB4bWwpKTsKCiAgICAgICAgICAvLyBBdm9pZCBoYW5naW5nIG9udG8gZWxlbWVudCAoaXNzdWUgIzI5OSkKICAgICAgICAgIGNoZWNrQ29udGV4dCA9IG51bGw7CiAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH1dOwogICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgaWYgKG1hdGNoZXIgPSBFeHByLnJlbGF0aXZlW3Rva2Vuc1tpXS50eXBlXSkgewogICAgICAgICAgbWF0Y2hlcnMgPSBbYWRkQ29tYmluYXRvcihlbGVtZW50TWF0Y2hlcihtYXRjaGVycyksIG1hdGNoZXIpXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWF0Y2hlciA9IEV4cHIuZmlsdGVyW3Rva2Vuc1tpXS50eXBlXS5hcHBseShudWxsLCB0b2tlbnNbaV0ubWF0Y2hlcyk7CgogICAgICAgICAgLy8gUmV0dXJuIHNwZWNpYWwgdXBvbiBzZWVpbmcgYSBwb3NpdGlvbmFsIG1hdGNoZXIKICAgICAgICAgIGlmIChtYXRjaGVyW2V4cGFuZG9dKSB7CiAgICAgICAgICAgIC8vIEZpbmQgdGhlIG5leHQgcmVsYXRpdmUgb3BlcmF0b3IgKGlmIGFueSkgZm9yIHByb3BlciBoYW5kbGluZwogICAgICAgICAgICBqID0gKytpOwogICAgICAgICAgICBmb3IgKDsgaiA8IGxlbjsgaisrKSB7CiAgICAgICAgICAgICAgaWYgKEV4cHIucmVsYXRpdmVbdG9rZW5zW2pdLnR5cGVdKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNldE1hdGNoZXIoaSA+IDEgJiYgZWxlbWVudE1hdGNoZXIobWF0Y2hlcnMpLCBpID4gMSAmJiB0b1NlbGVjdG9yKAogICAgICAgICAgICAvLyBJZiB0aGUgcHJlY2VkaW5nIHRva2VuIHdhcyBhIGRlc2NlbmRhbnQgY29tYmluYXRvciwgaW5zZXJ0IGFuIGltcGxpY2l0IGFueS1lbGVtZW50IGAqYAogICAgICAgICAgICB0b2tlbnMuc2xpY2UoMCwgaSAtIDEpLmNvbmNhdCh7CiAgICAgICAgICAgICAgdmFsdWU6IHRva2Vuc1tpIC0gMl0udHlwZSA9PT0gIiAiID8gIioiIDogIiIKICAgICAgICAgICAgfSkpLnJlcGxhY2UocnRyaW0sICIkMSIpLCBtYXRjaGVyLCBpIDwgaiAmJiBtYXRjaGVyRnJvbVRva2Vucyh0b2tlbnMuc2xpY2UoaSwgaikpLCBqIDwgbGVuICYmIG1hdGNoZXJGcm9tVG9rZW5zKHRva2VucyA9IHRva2Vucy5zbGljZShqKSksIGogPCBsZW4gJiYgdG9TZWxlY3Rvcih0b2tlbnMpKTsKICAgICAgICAgIH0KICAgICAgICAgIG1hdGNoZXJzLnB1c2gobWF0Y2hlcik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBlbGVtZW50TWF0Y2hlcihtYXRjaGVycyk7CiAgICB9CiAgICBmdW5jdGlvbiBtYXRjaGVyRnJvbUdyb3VwTWF0Y2hlcnMoZWxlbWVudE1hdGNoZXJzLCBzZXRNYXRjaGVycykgewogICAgICB2YXIgYnlTZXQgPSBzZXRNYXRjaGVycy5sZW5ndGggPiAwLAogICAgICAgIGJ5RWxlbWVudCA9IGVsZW1lbnRNYXRjaGVycy5sZW5ndGggPiAwLAogICAgICAgIHN1cGVyTWF0Y2hlciA9IGZ1bmN0aW9uIHN1cGVyTWF0Y2hlcihzZWVkLCBjb250ZXh0LCB4bWwsIHJlc3VsdHMsIG91dGVybW9zdCkgewogICAgICAgICAgdmFyIGVsZW0sCiAgICAgICAgICAgIGosCiAgICAgICAgICAgIG1hdGNoZXIsCiAgICAgICAgICAgIG1hdGNoZWRDb3VudCA9IDAsCiAgICAgICAgICAgIGkgPSAiMCIsCiAgICAgICAgICAgIHVubWF0Y2hlZCA9IHNlZWQgJiYgW10sCiAgICAgICAgICAgIHNldE1hdGNoZWQgPSBbXSwKICAgICAgICAgICAgY29udGV4dEJhY2t1cCA9IG91dGVybW9zdENvbnRleHQsCiAgICAgICAgICAgIC8vIFdlIG11c3QgYWx3YXlzIGhhdmUgZWl0aGVyIHNlZWQgZWxlbWVudHMgb3Igb3V0ZXJtb3N0IGNvbnRleHQKICAgICAgICAgICAgZWxlbXMgPSBzZWVkIHx8IGJ5RWxlbWVudCAmJiBFeHByLmZpbmRbIlRBRyJdKCIqIiwgb3V0ZXJtb3N0KSwKICAgICAgICAgICAgLy8gVXNlIGludGVnZXIgZGlycnVucyBpZmYgdGhpcyBpcyB0aGUgb3V0ZXJtb3N0IG1hdGNoZXIKICAgICAgICAgICAgZGlycnVuc1VuaXF1ZSA9IGRpcnJ1bnMgKz0gY29udGV4dEJhY2t1cCA9PSBudWxsID8gMSA6IE1hdGgucmFuZG9tKCkgfHwgMC4xLAogICAgICAgICAgICBsZW4gPSBlbGVtcy5sZW5ndGg7CiAgICAgICAgICBpZiAob3V0ZXJtb3N0KSB7CiAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNyAtIDE4KwogICAgICAgICAgICAvLyBJRS9FZGdlIHNvbWV0aW1lcyB0aHJvdyBhICJQZXJtaXNzaW9uIGRlbmllZCIgZXJyb3Igd2hlbiBzdHJpY3QtY29tcGFyaW5nCiAgICAgICAgICAgIC8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4KICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGVxZXFlcQogICAgICAgICAgICBvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dCA9PSBkb2N1bWVudCB8fCBjb250ZXh0IHx8IG91dGVybW9zdDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBBZGQgZWxlbWVudHMgcGFzc2luZyBlbGVtZW50TWF0Y2hlcnMgZGlyZWN0bHkgdG8gcmVzdWx0cwogICAgICAgICAgLy8gU3VwcG9ydDogSUU8OSwgU2FmYXJpCiAgICAgICAgICAvLyBUb2xlcmF0ZSBOb2RlTGlzdCBwcm9wZXJ0aWVzIChJRTogImxlbmd0aCI7IFNhZmFyaTogPG51bWJlcj4pIG1hdGNoaW5nIGVsZW1lbnRzIGJ5IGlkCiAgICAgICAgICBmb3IgKDsgaSAhPT0gbGVuICYmIChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKykgewogICAgICAgICAgICBpZiAoYnlFbGVtZW50ICYmIGVsZW0pIHsKICAgICAgICAgICAgICBqID0gMDsKCiAgICAgICAgICAgICAgLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrCiAgICAgICAgICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAgICAgICAgIC8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4KICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZXFlcWVxCiAgICAgICAgICAgICAgaWYgKCFjb250ZXh0ICYmIGVsZW0ub3duZXJEb2N1bWVudCAhPSBkb2N1bWVudCkgewogICAgICAgICAgICAgICAgc2V0RG9jdW1lbnQoZWxlbSk7CiAgICAgICAgICAgICAgICB4bWwgPSAhZG9jdW1lbnRJc0hUTUw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChtYXRjaGVyID0gZWxlbWVudE1hdGNoZXJzW2orK10pIHsKICAgICAgICAgICAgICAgIGlmIChtYXRjaGVyKGVsZW0sIGNvbnRleHQgfHwgZG9jdW1lbnQsIHhtbCkpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKGVsZW0pOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG91dGVybW9zdCkgewogICAgICAgICAgICAgICAgZGlycnVucyA9IGRpcnJ1bnNVbmlxdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUcmFjayB1bm1hdGNoZWQgZWxlbWVudHMgZm9yIHNldCBmaWx0ZXJzCiAgICAgICAgICAgIGlmIChieVNldCkgewogICAgICAgICAgICAgIC8vIFRoZXkgd2lsbCBoYXZlIGdvbmUgdGhyb3VnaCBhbGwgcG9zc2libGUgbWF0Y2hlcnMKICAgICAgICAgICAgICBpZiAoZWxlbSA9ICFtYXRjaGVyICYmIGVsZW0pIHsKICAgICAgICAgICAgICAgIG1hdGNoZWRDb3VudC0tOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gTGVuZ3RoZW4gdGhlIGFycmF5IGZvciBldmVyeSBlbGVtZW50LCBtYXRjaGVkIG9yIG5vdAogICAgICAgICAgICAgIGlmIChzZWVkKSB7CiAgICAgICAgICAgICAgICB1bm1hdGNoZWQucHVzaChlbGVtKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBgaWAgaXMgbm93IHRoZSBjb3VudCBvZiBlbGVtZW50cyB2aXNpdGVkIGFib3ZlLCBhbmQgYWRkaW5nIGl0IHRvIGBtYXRjaGVkQ291bnRgCiAgICAgICAgICAvLyBtYWtlcyB0aGUgbGF0dGVyIG5vbm5lZ2F0aXZlLgogICAgICAgICAgbWF0Y2hlZENvdW50ICs9IGk7CgogICAgICAgICAgLy8gQXBwbHkgc2V0IGZpbHRlcnMgdG8gdW5tYXRjaGVkIGVsZW1lbnRzCiAgICAgICAgICAvLyBOT1RFOiBUaGlzIGNhbiBiZSBza2lwcGVkIGlmIHRoZXJlIGFyZSBubyB1bm1hdGNoZWQgZWxlbWVudHMgKGkuZS4sIGBtYXRjaGVkQ291bnRgCiAgICAgICAgICAvLyBlcXVhbHMgYGlgKSwgdW5sZXNzIHdlIGRpZG4ndCB2aXNpdCBfYW55XyBlbGVtZW50cyBpbiB0aGUgYWJvdmUgbG9vcCBiZWNhdXNlIHdlIGhhdmUKICAgICAgICAgIC8vIG5vIGVsZW1lbnQgbWF0Y2hlcnMgYW5kIG5vIHNlZWQuCiAgICAgICAgICAvLyBJbmNyZW1lbnRpbmcgYW4gaW5pdGlhbGx5LXN0cmluZyAiMCIgYGlgIGFsbG93cyBgaWAgdG8gcmVtYWluIGEgc3RyaW5nIG9ubHkgaW4gdGhhdAogICAgICAgICAgLy8gY2FzZSwgd2hpY2ggd2lsbCByZXN1bHQgaW4gYSAiMDAiIGBtYXRjaGVkQ291bnRgIHRoYXQgZGlmZmVycyBmcm9tIGBpYCBidXQgaXMgYWxzbwogICAgICAgICAgLy8gbnVtZXJpY2FsbHkgemVyby4KICAgICAgICAgIGlmIChieVNldCAmJiBpICE9PSBtYXRjaGVkQ291bnQpIHsKICAgICAgICAgICAgaiA9IDA7CiAgICAgICAgICAgIHdoaWxlIChtYXRjaGVyID0gc2V0TWF0Y2hlcnNbaisrXSkgewogICAgICAgICAgICAgIG1hdGNoZXIodW5tYXRjaGVkLCBzZXRNYXRjaGVkLCBjb250ZXh0LCB4bWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzZWVkKSB7CiAgICAgICAgICAgICAgLy8gUmVpbnRlZ3JhdGUgZWxlbWVudCBtYXRjaGVzIHRvIGVsaW1pbmF0ZSB0aGUgbmVlZCBmb3Igc29ydGluZwogICAgICAgICAgICAgIGlmIChtYXRjaGVkQ291bnQgPiAwKSB7CiAgICAgICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgICAgIGlmICghKHVubWF0Y2hlZFtpXSB8fCBzZXRNYXRjaGVkW2ldKSkgewogICAgICAgICAgICAgICAgICAgIHNldE1hdGNoZWRbaV0gPSBwb3AuY2FsbChyZXN1bHRzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gRGlzY2FyZCBpbmRleCBwbGFjZWhvbGRlciB2YWx1ZXMgdG8gZ2V0IG9ubHkgYWN0dWFsIG1hdGNoZXMKICAgICAgICAgICAgICBzZXRNYXRjaGVkID0gY29uZGVuc2Uoc2V0TWF0Y2hlZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFkZCBtYXRjaGVzIHRvIHJlc3VsdHMKICAgICAgICAgICAgcHVzaC5hcHBseShyZXN1bHRzLCBzZXRNYXRjaGVkKTsKCiAgICAgICAgICAgIC8vIFNlZWRsZXNzIHNldCBtYXRjaGVzIHN1Y2NlZWRpbmcgbXVsdGlwbGUgc3VjY2Vzc2Z1bCBtYXRjaGVycyBzdGlwdWxhdGUgc29ydGluZwogICAgICAgICAgICBpZiAob3V0ZXJtb3N0ICYmICFzZWVkICYmIHNldE1hdGNoZWQubGVuZ3RoID4gMCAmJiBtYXRjaGVkQ291bnQgKyBzZXRNYXRjaGVycy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgU2l6emxlLnVuaXF1ZVNvcnQocmVzdWx0cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBPdmVycmlkZSBtYW5pcHVsYXRpb24gb2YgZ2xvYmFscyBieSBuZXN0ZWQgbWF0Y2hlcnMKICAgICAgICAgIGlmIChvdXRlcm1vc3QpIHsKICAgICAgICAgICAgZGlycnVucyA9IGRpcnJ1bnNVbmlxdWU7CiAgICAgICAgICAgIG91dGVybW9zdENvbnRleHQgPSBjb250ZXh0QmFja3VwOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVubWF0Y2hlZDsKICAgICAgICB9OwogICAgICByZXR1cm4gYnlTZXQgPyBtYXJrRnVuY3Rpb24oc3VwZXJNYXRjaGVyKSA6IHN1cGVyTWF0Y2hlcjsKICAgIH0KICAgIGNvbXBpbGUgPSBTaXp6bGUuY29tcGlsZSA9IGZ1bmN0aW9uIChzZWxlY3RvciwgbWF0Y2ggLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8pIHsKICAgICAgdmFyIGksCiAgICAgICAgc2V0TWF0Y2hlcnMgPSBbXSwKICAgICAgICBlbGVtZW50TWF0Y2hlcnMgPSBbXSwKICAgICAgICBjYWNoZWQgPSBjb21waWxlckNhY2hlW3NlbGVjdG9yICsgIiAiXTsKICAgICAgaWYgKCFjYWNoZWQpIHsKICAgICAgICAvLyBHZW5lcmF0ZSBhIGZ1bmN0aW9uIG9mIHJlY3Vyc2l2ZSBmdW5jdGlvbnMgdGhhdCBjYW4gYmUgdXNlZCB0byBjaGVjayBlYWNoIGVsZW1lbnQKICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICBtYXRjaCA9IHRva2VuaXplKHNlbGVjdG9yKTsKICAgICAgICB9CiAgICAgICAgaSA9IG1hdGNoLmxlbmd0aDsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICBjYWNoZWQgPSBtYXRjaGVyRnJvbVRva2VucyhtYXRjaFtpXSk7CiAgICAgICAgICBpZiAoY2FjaGVkW2V4cGFuZG9dKSB7CiAgICAgICAgICAgIHNldE1hdGNoZXJzLnB1c2goY2FjaGVkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGVsZW1lbnRNYXRjaGVycy5wdXNoKGNhY2hlZCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBDYWNoZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24KICAgICAgICBjYWNoZWQgPSBjb21waWxlckNhY2hlKHNlbGVjdG9yLCBtYXRjaGVyRnJvbUdyb3VwTWF0Y2hlcnMoZWxlbWVudE1hdGNoZXJzLCBzZXRNYXRjaGVycykpOwoKICAgICAgICAvLyBTYXZlIHNlbGVjdG9yIGFuZCB0b2tlbml6YXRpb24KICAgICAgICBjYWNoZWQuc2VsZWN0b3IgPSBzZWxlY3RvcjsKICAgICAgfQogICAgICByZXR1cm4gY2FjaGVkOwogICAgfTsKCiAgICAvKioKICAgICAqIEEgbG93LWxldmVsIHNlbGVjdGlvbiBmdW5jdGlvbiB0aGF0IHdvcmtzIHdpdGggU2l6emxlJ3MgY29tcGlsZWQKICAgICAqICBzZWxlY3RvciBmdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7U3RyaW5nfEZ1bmN0aW9ufSBzZWxlY3RvciBBIHNlbGVjdG9yIG9yIGEgcHJlLWNvbXBpbGVkCiAgICAgKiAgc2VsZWN0b3IgZnVuY3Rpb24gYnVpbHQgd2l0aCBTaXp6bGUuY29tcGlsZQogICAgICogQHBhcmFtIHtFbGVtZW50fSBjb250ZXh0CiAgICAgKiBAcGFyYW0ge0FycmF5fSBbcmVzdWx0c10KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtzZWVkXSBBIHNldCBvZiBlbGVtZW50cyB0byBtYXRjaCBhZ2FpbnN0CiAgICAgKi8KICAgIHNlbGVjdCA9IFNpenpsZS5zZWxlY3QgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQpIHsKICAgICAgdmFyIGksCiAgICAgICAgdG9rZW5zLAogICAgICAgIHRva2VuLAogICAgICAgIHR5cGUsCiAgICAgICAgZmluZCwKICAgICAgICBjb21waWxlZCA9IHR5cGVvZiBzZWxlY3RvciA9PT0gImZ1bmN0aW9uIiAmJiBzZWxlY3RvciwKICAgICAgICBtYXRjaCA9ICFzZWVkICYmIHRva2VuaXplKHNlbGVjdG9yID0gY29tcGlsZWQuc2VsZWN0b3IgfHwgc2VsZWN0b3IpOwogICAgICByZXN1bHRzID0gcmVzdWx0cyB8fCBbXTsKCiAgICAgIC8vIFRyeSB0byBtaW5pbWl6ZSBvcGVyYXRpb25zIGlmIHRoZXJlIGlzIG9ubHkgb25lIHNlbGVjdG9yIGluIHRoZSBsaXN0IGFuZCBubyBzZWVkCiAgICAgIC8vICh0aGUgbGF0dGVyIG9mIHdoaWNoIGd1YXJhbnRlZXMgdXMgY29udGV4dCkKICAgICAgaWYgKG1hdGNoLmxlbmd0aCA9PT0gMSkgewogICAgICAgIC8vIFJlZHVjZSBjb250ZXh0IGlmIHRoZSBsZWFkaW5nIGNvbXBvdW5kIHNlbGVjdG9yIGlzIGFuIElECiAgICAgICAgdG9rZW5zID0gbWF0Y2hbMF0gPSBtYXRjaFswXS5zbGljZSgwKTsKICAgICAgICBpZiAodG9rZW5zLmxlbmd0aCA+IDIgJiYgKHRva2VuID0gdG9rZW5zWzBdKS50eXBlID09PSAiSUQiICYmIGNvbnRleHQubm9kZVR5cGUgPT09IDkgJiYgZG9jdW1lbnRJc0hUTUwgJiYgRXhwci5yZWxhdGl2ZVt0b2tlbnNbMV0udHlwZV0pIHsKICAgICAgICAgIGNvbnRleHQgPSAoRXhwci5maW5kWyJJRCJdKHRva2VuLm1hdGNoZXNbMF0ucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSksIGNvbnRleHQpIHx8IFtdKVswXTsKICAgICAgICAgIGlmICghY29udGV4dCkgewogICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKCiAgICAgICAgICAgIC8vIFByZWNvbXBpbGVkIG1hdGNoZXJzIHdpbGwgc3RpbGwgdmVyaWZ5IGFuY2VzdHJ5LCBzbyBzdGVwIHVwIGEgbGV2ZWwKICAgICAgICAgIH0gZWxzZSBpZiAoY29tcGlsZWQpIHsKICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHNlbGVjdG9yID0gc2VsZWN0b3Iuc2xpY2UodG9rZW5zLnNoaWZ0KCkudmFsdWUubGVuZ3RoKTsKICAgICAgICB9CgogICAgICAgIC8vIEZldGNoIGEgc2VlZCBzZXQgZm9yIHJpZ2h0LXRvLWxlZnQgbWF0Y2hpbmcKICAgICAgICBpID0gbWF0Y2hFeHByWyJuZWVkc0NvbnRleHQiXS50ZXN0KHNlbGVjdG9yKSA/IDAgOiB0b2tlbnMubGVuZ3RoOwogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgIHRva2VuID0gdG9rZW5zW2ldOwoKICAgICAgICAgIC8vIEFib3J0IGlmIHdlIGhpdCBhIGNvbWJpbmF0b3IKICAgICAgICAgIGlmIChFeHByLnJlbGF0aXZlW3R5cGUgPSB0b2tlbi50eXBlXSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmaW5kID0gRXhwci5maW5kW3R5cGVdKSB7CiAgICAgICAgICAgIC8vIFNlYXJjaCwgZXhwYW5kaW5nIGNvbnRleHQgZm9yIGxlYWRpbmcgc2libGluZyBjb21iaW5hdG9ycwogICAgICAgICAgICBpZiAoc2VlZCA9IGZpbmQodG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKSwgcnNpYmxpbmcudGVzdCh0b2tlbnNbMF0udHlwZSkgJiYgdGVzdENvbnRleHQoY29udGV4dC5wYXJlbnROb2RlKSB8fCBjb250ZXh0KSkgewogICAgICAgICAgICAgIC8vIElmIHNlZWQgaXMgZW1wdHkgb3Igbm8gdG9rZW5zIHJlbWFpbiwgd2UgY2FuIHJldHVybiBlYXJseQogICAgICAgICAgICAgIHRva2Vucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgc2VsZWN0b3IgPSBzZWVkLmxlbmd0aCAmJiB0b1NlbGVjdG9yKHRva2Vucyk7CiAgICAgICAgICAgICAgaWYgKCFzZWxlY3RvcikgewogICAgICAgICAgICAgICAgcHVzaC5hcHBseShyZXN1bHRzLCBzZWVkKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQ29tcGlsZSBhbmQgZXhlY3V0ZSBhIGZpbHRlcmluZyBmdW5jdGlvbiBpZiBvbmUgaXMgbm90IHByb3ZpZGVkCiAgICAgIC8vIFByb3ZpZGUgYG1hdGNoYCB0byBhdm9pZCByZXRva2VuaXphdGlvbiBpZiB3ZSBtb2RpZmllZCB0aGUgc2VsZWN0b3IgYWJvdmUKICAgICAgKGNvbXBpbGVkIHx8IGNvbXBpbGUoc2VsZWN0b3IsIG1hdGNoKSkoc2VlZCwgY29udGV4dCwgIWRvY3VtZW50SXNIVE1MLCByZXN1bHRzLCAhY29udGV4dCB8fCByc2libGluZy50ZXN0KHNlbGVjdG9yKSAmJiB0ZXN0Q29udGV4dChjb250ZXh0LnBhcmVudE5vZGUpIHx8IGNvbnRleHQpOwogICAgICByZXR1cm4gcmVzdWx0czsKICAgIH07CgogICAgLy8gT25lLXRpbWUgYXNzaWdubWVudHMKCiAgICAvLyBTb3J0IHN0YWJpbGl0eQogICAgc3VwcG9ydC5zb3J0U3RhYmxlID0gZXhwYW5kby5zcGxpdCgiIikuc29ydChzb3J0T3JkZXIpLmpvaW4oIiIpID09PSBleHBhbmRvOwoKICAgIC8vIFN1cHBvcnQ6IENocm9tZSAxNC0zNSsKICAgIC8vIEFsd2F5cyBhc3N1bWUgZHVwbGljYXRlcyBpZiB0aGV5IGFyZW4ndCBwYXNzZWQgdG8gdGhlIGNvbXBhcmlzb24gZnVuY3Rpb24KICAgIHN1cHBvcnQuZGV0ZWN0RHVwbGljYXRlcyA9ICEhaGFzRHVwbGljYXRlOwoKICAgIC8vIEluaXRpYWxpemUgYWdhaW5zdCB0aGUgZGVmYXVsdCBkb2N1bWVudAogICAgc2V0RG9jdW1lbnQoKTsKCiAgICAvLyBTdXBwb3J0OiBXZWJraXQ8NTM3LjMyIC0gU2FmYXJpIDYuMC4zL0Nocm9tZSAyNSAoZml4ZWQgaW4gQ2hyb21lIDI3KQogICAgLy8gRGV0YWNoZWQgbm9kZXMgY29uZm91bmRpbmdseSBmb2xsb3cgKmVhY2ggb3RoZXIqCiAgICBzdXBwb3J0LnNvcnREZXRhY2hlZCA9IGFzc2VydChmdW5jdGlvbiAoZWwpIHsKICAgICAgLy8gU2hvdWxkIHJldHVybiAxLCBidXQgcmV0dXJucyA0IChmb2xsb3dpbmcpCiAgICAgIHJldHVybiBlbC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJmaWVsZHNldCIpKSAmIDE7CiAgICB9KTsKCiAgICAvLyBTdXBwb3J0OiBJRTw4CiAgICAvLyBQcmV2ZW50IGF0dHJpYnV0ZS9wcm9wZXJ0eSAiaW50ZXJwb2xhdGlvbiIKICAgIC8vIGh0dHBzOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzY0MjklMjhWUy44NSUyOS5hc3B4CiAgICBpZiAoIWFzc2VydChmdW5jdGlvbiAoZWwpIHsKICAgICAgZWwuaW5uZXJIVE1MID0gIjxhIGhyZWY9JyMnPjwvYT4iOwogICAgICByZXR1cm4gZWwuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoImhyZWYiKSA9PT0gIiMiOwogICAgfSkpIHsKICAgICAgYWRkSGFuZGxlKCJ0eXBlfGhyZWZ8aGVpZ2h0fHdpZHRoIiwgZnVuY3Rpb24gKGVsZW0sIG5hbWUsIGlzWE1MKSB7CiAgICAgICAgaWYgKCFpc1hNTCkgewogICAgICAgICAgcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKG5hbWUsIG5hbWUudG9Mb3dlckNhc2UoKSA9PT0gInR5cGUiID8gMSA6IDIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgLy8gU3VwcG9ydDogSUU8OQogICAgLy8gVXNlIGRlZmF1bHRWYWx1ZSBpbiBwbGFjZSBvZiBnZXRBdHRyaWJ1dGUoInZhbHVlIikKICAgIGlmICghc3VwcG9ydC5hdHRyaWJ1dGVzIHx8ICFhc3NlcnQoZnVuY3Rpb24gKGVsKSB7CiAgICAgIGVsLmlubmVySFRNTCA9ICI8aW5wdXQvPiI7CiAgICAgIGVsLmZpcnN0Q2hpbGQuc2V0QXR0cmlidXRlKCJ2YWx1ZSIsICIiKTsKICAgICAgcmV0dXJuIGVsLmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpID09PSAiIjsKICAgIH0pKSB7CiAgICAgIGFkZEhhbmRsZSgidmFsdWUiLCBmdW5jdGlvbiAoZWxlbSwgX25hbWUsIGlzWE1MKSB7CiAgICAgICAgaWYgKCFpc1hNTCAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIpIHsKICAgICAgICAgIHJldHVybiBlbGVtLmRlZmF1bHRWYWx1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIC8vIFN1cHBvcnQ6IElFPDkKICAgIC8vIFVzZSBnZXRBdHRyaWJ1dGVOb2RlIHRvIGZldGNoIGJvb2xlYW5zIHdoZW4gZ2V0QXR0cmlidXRlIGxpZXMKICAgIGlmICghYXNzZXJ0KGZ1bmN0aW9uIChlbCkgewogICAgICByZXR1cm4gZWwuZ2V0QXR0cmlidXRlKCJkaXNhYmxlZCIpID09IG51bGw7CiAgICB9KSkgewogICAgICBhZGRIYW5kbGUoYm9vbGVhbnMsIGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBpc1hNTCkgewogICAgICAgIHZhciB2YWw7CiAgICAgICAgaWYgKCFpc1hNTCkgewogICAgICAgICAgcmV0dXJuIGVsZW1bbmFtZV0gPT09IHRydWUgPyBuYW1lLnRvTG93ZXJDYXNlKCkgOiAodmFsID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpKSAmJiB2YWwuc3BlY2lmaWVkID8gdmFsLnZhbHVlIDogbnVsbDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIFNpenpsZTsKICB9KHdpbmRvdyk7CiAgalF1ZXJ5LmZpbmQgPSBTaXp6bGU7CiAgalF1ZXJ5LmV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzOwoKICAvLyBEZXByZWNhdGVkCiAgalF1ZXJ5LmV4cHJbIjoiXSA9IGpRdWVyeS5leHByLnBzZXVkb3M7CiAgalF1ZXJ5LnVuaXF1ZVNvcnQgPSBqUXVlcnkudW5pcXVlID0gU2l6emxlLnVuaXF1ZVNvcnQ7CiAgalF1ZXJ5LnRleHQgPSBTaXp6bGUuZ2V0VGV4dDsKICBqUXVlcnkuaXNYTUxEb2MgPSBTaXp6bGUuaXNYTUw7CiAgalF1ZXJ5LmNvbnRhaW5zID0gU2l6emxlLmNvbnRhaW5zOwogIGpRdWVyeS5lc2NhcGVTZWxlY3RvciA9IFNpenpsZS5lc2NhcGU7CiAgdmFyIGRpciA9IGZ1bmN0aW9uIGRpcihlbGVtLCBfZGlyLCB1bnRpbCkgewogICAgdmFyIG1hdGNoZWQgPSBbXSwKICAgICAgdHJ1bmNhdGUgPSB1bnRpbCAhPT0gdW5kZWZpbmVkOwogICAgd2hpbGUgKChlbGVtID0gZWxlbVtfZGlyXSkgJiYgZWxlbS5ub2RlVHlwZSAhPT0gOSkgewogICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgIGlmICh0cnVuY2F0ZSAmJiBqUXVlcnkoZWxlbSkuaXModW50aWwpKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgbWF0Y2hlZC5wdXNoKGVsZW0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbWF0Y2hlZDsKICB9OwogIHZhciBfc2libGluZ3MgPSBmdW5jdGlvbiBzaWJsaW5ncyhuLCBlbGVtKSB7CiAgICB2YXIgbWF0Y2hlZCA9IFtdOwogICAgZm9yICg7IG47IG4gPSBuLm5leHRTaWJsaW5nKSB7CiAgICAgIGlmIChuLm5vZGVUeXBlID09PSAxICYmIG4gIT09IGVsZW0pIHsKICAgICAgICBtYXRjaGVkLnB1c2gobik7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBtYXRjaGVkOwogIH07CiAgdmFyIHJuZWVkc0NvbnRleHQgPSBqUXVlcnkuZXhwci5tYXRjaC5uZWVkc0NvbnRleHQ7CiAgZnVuY3Rpb24gbm9kZU5hbWUoZWxlbSwgbmFtZSkgewogICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgfQogIDsKICB2YXIgcnNpbmdsZVRhZyA9IC9ePChbYS16XVteXC9cMD46XHgyMFx0XHJcblxmXSopW1x4MjBcdFxyXG5cZl0qXC8/Pig/OjxcL1wxPnwpJC9pOwoKICAvLyBJbXBsZW1lbnQgdGhlIGlkZW50aWNhbCBmdW5jdGlvbmFsaXR5IGZvciBmaWx0ZXIgYW5kIG5vdAogIGZ1bmN0aW9uIHdpbm5vdyhlbGVtZW50cywgcXVhbGlmaWVyLCBub3QpIHsKICAgIGlmIChpc0Z1bmN0aW9uKHF1YWxpZmllcikpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5ncmVwKGVsZW1lbnRzLCBmdW5jdGlvbiAoZWxlbSwgaSkgewogICAgICAgIHJldHVybiAhIXF1YWxpZmllci5jYWxsKGVsZW0sIGksIGVsZW0pICE9PSBub3Q7CiAgICAgIH0pOwogICAgfQoKICAgIC8vIFNpbmdsZSBlbGVtZW50CiAgICBpZiAocXVhbGlmaWVyLm5vZGVUeXBlKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICByZXR1cm4gZWxlbSA9PT0gcXVhbGlmaWVyICE9PSBub3Q7CiAgICAgIH0pOwogICAgfQoKICAgIC8vIEFycmF5bGlrZSBvZiBlbGVtZW50cyAoalF1ZXJ5LCBhcmd1bWVudHMsIEFycmF5KQogICAgaWYgKHR5cGVvZiBxdWFsaWZpZXIgIT09ICJzdHJpbmciKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICByZXR1cm4gaW5kZXhPZi5jYWxsKHF1YWxpZmllciwgZWxlbSkgPiAtMSAhPT0gbm90OwogICAgICB9KTsKICAgIH0KCiAgICAvLyBGaWx0ZXJlZCBkaXJlY3RseSBmb3IgYm90aCBzaW1wbGUgYW5kIGNvbXBsZXggc2VsZWN0b3JzCiAgICByZXR1cm4galF1ZXJ5LmZpbHRlcihxdWFsaWZpZXIsIGVsZW1lbnRzLCBub3QpOwogIH0KICBqUXVlcnkuZmlsdGVyID0gZnVuY3Rpb24gKGV4cHIsIGVsZW1zLCBub3QpIHsKICAgIHZhciBlbGVtID0gZWxlbXNbMF07CiAgICBpZiAobm90KSB7CiAgICAgIGV4cHIgPSAiOm5vdCgiICsgZXhwciArICIpIjsKICAgIH0KICAgIGlmIChlbGVtcy5sZW5ndGggPT09IDEgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICByZXR1cm4galF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKGVsZW0sIGV4cHIpID8gW2VsZW1dIDogW107CiAgICB9CiAgICByZXR1cm4galF1ZXJ5LmZpbmQubWF0Y2hlcyhleHByLCBqUXVlcnkuZ3JlcChlbGVtcywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDE7CiAgICB9KSk7CiAgfTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGZpbmQ6IGZ1bmN0aW9uIGZpbmQoc2VsZWN0b3IpIHsKICAgICAgdmFyIGksCiAgICAgICAgcmV0LAogICAgICAgIGxlbiA9IHRoaXMubGVuZ3RoLAogICAgICAgIHNlbGYgPSB0aGlzOwogICAgICBpZiAodHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIikgewogICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhqUXVlcnkoc2VsZWN0b3IpLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKGpRdWVyeS5jb250YWlucyhzZWxmW2ldLCB0aGlzKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSkpOwogICAgICB9CiAgICAgIHJldCA9IHRoaXMucHVzaFN0YWNrKFtdKTsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgalF1ZXJ5LmZpbmQoc2VsZWN0b3IsIHNlbGZbaV0sIHJldCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlbiA+IDEgPyBqUXVlcnkudW5pcXVlU29ydChyZXQpIDogcmV0OwogICAgfSwKICAgIGZpbHRlcjogZnVuY3Rpb24gZmlsdGVyKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayh3aW5ub3codGhpcywgc2VsZWN0b3IgfHwgW10sIGZhbHNlKSk7CiAgICB9LAogICAgbm90OiBmdW5jdGlvbiBub3Qoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHdpbm5vdyh0aGlzLCBzZWxlY3RvciB8fCBbXSwgdHJ1ZSkpOwogICAgfSwKICAgIGlzOiBmdW5jdGlvbiBpcyhzZWxlY3RvcikgewogICAgICByZXR1cm4gISF3aW5ub3codGhpcywKICAgICAgLy8gSWYgdGhpcyBpcyBhIHBvc2l0aW9uYWwvcmVsYXRpdmUgc2VsZWN0b3IsIGNoZWNrIG1lbWJlcnNoaXAgaW4gdGhlIHJldHVybmVkIHNldAogICAgICAvLyBzbyAkKCJwOmZpcnN0IikuaXMoInA6bGFzdCIpIHdvbid0IHJldHVybiB0cnVlIGZvciBhIGRvYyB3aXRoIHR3byAicCIuCiAgICAgIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgJiYgcm5lZWRzQ29udGV4dC50ZXN0KHNlbGVjdG9yKSA/IGpRdWVyeShzZWxlY3RvcikgOiBzZWxlY3RvciB8fCBbXSwgZmFsc2UpLmxlbmd0aDsKICAgIH0KICB9KTsKCiAgLy8gSW5pdGlhbGl6ZSBhIGpRdWVyeSBvYmplY3QKCiAgLy8gQSBjZW50cmFsIHJlZmVyZW5jZSB0byB0aGUgcm9vdCBqUXVlcnkoZG9jdW1lbnQpCiAgdmFyIHJvb3RqUXVlcnksCiAgICAvLyBBIHNpbXBsZSB3YXkgdG8gY2hlY2sgZm9yIEhUTUwgc3RyaW5ncwogICAgLy8gUHJpb3JpdGl6ZSAjaWQgb3ZlciA8dGFnPiB0byBhdm9pZCBYU1MgdmlhIGxvY2F0aW9uLmhhc2ggKCM5NTIxKQogICAgLy8gU3RyaWN0IEhUTUwgcmVjb2duaXRpb24gKCMxMTI5MDogbXVzdCBzdGFydCB3aXRoIDwpCiAgICAvLyBTaG9ydGN1dCBzaW1wbGUgI2lkIGNhc2UgZm9yIHNwZWVkCiAgICBycXVpY2tFeHByID0gL14oPzpccyooPFtcd1xXXSs+KVtePl0qfCMoW1x3LV0rKSkkLywKICAgIGluaXQgPSBqUXVlcnkuZm4uaW5pdCA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCwgcm9vdCkgewogICAgICB2YXIgbWF0Y2gsIGVsZW07CgogICAgICAvLyBIQU5ETEU6ICQoIiIpLCAkKG51bGwpLCAkKHVuZGVmaW5lZCksICQoZmFsc2UpCiAgICAgIGlmICghc2VsZWN0b3IpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgLy8gTWV0aG9kIGluaXQoKSBhY2NlcHRzIGFuIGFsdGVybmF0ZSByb290alF1ZXJ5CiAgICAgIC8vIHNvIG1pZ3JhdGUgY2FuIHN1cHBvcnQgalF1ZXJ5LnN1YiAoZ2gtMjEwMSkKICAgICAgcm9vdCA9IHJvb3QgfHwgcm9vdGpRdWVyeTsKCiAgICAgIC8vIEhhbmRsZSBIVE1MIHN0cmluZ3MKICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIpIHsKICAgICAgICBpZiAoc2VsZWN0b3JbMF0gPT09ICI8IiAmJiBzZWxlY3RvcltzZWxlY3Rvci5sZW5ndGggLSAxXSA9PT0gIj4iICYmIHNlbGVjdG9yLmxlbmd0aCA+PSAzKSB7CiAgICAgICAgICAvLyBBc3N1bWUgdGhhdCBzdHJpbmdzIHRoYXQgc3RhcnQgYW5kIGVuZCB3aXRoIDw+IGFyZSBIVE1MIGFuZCBza2lwIHRoZSByZWdleCBjaGVjawogICAgICAgICAgbWF0Y2ggPSBbbnVsbCwgc2VsZWN0b3IsIG51bGxdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtYXRjaCA9IHJxdWlja0V4cHIuZXhlYyhzZWxlY3Rvcik7CiAgICAgICAgfQoKICAgICAgICAvLyBNYXRjaCBodG1sIG9yIG1ha2Ugc3VyZSBubyBjb250ZXh0IGlzIHNwZWNpZmllZCBmb3IgI2lkCiAgICAgICAgaWYgKG1hdGNoICYmIChtYXRjaFsxXSB8fCAhY29udGV4dCkpIHsKICAgICAgICAgIC8vIEhBTkRMRTogJChodG1sKSAtPiAkKGFycmF5KQogICAgICAgICAgaWYgKG1hdGNoWzFdKSB7CiAgICAgICAgICAgIGNvbnRleHQgPSBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ID8gY29udGV4dFswXSA6IGNvbnRleHQ7CgogICAgICAgICAgICAvLyBPcHRpb24gdG8gcnVuIHNjcmlwdHMgaXMgdHJ1ZSBmb3IgYmFjay1jb21wYXQKICAgICAgICAgICAgLy8gSW50ZW50aW9uYWxseSBsZXQgdGhlIGVycm9yIGJlIHRocm93biBpZiBwYXJzZUhUTUwgaXMgbm90IHByZXNlbnQKICAgICAgICAgICAgalF1ZXJ5Lm1lcmdlKHRoaXMsIGpRdWVyeS5wYXJzZUhUTUwobWF0Y2hbMV0sIGNvbnRleHQgJiYgY29udGV4dC5ub2RlVHlwZSA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogZG9jdW1lbnQsIHRydWUpKTsKCiAgICAgICAgICAgIC8vIEhBTkRMRTogJChodG1sLCBwcm9wcykKICAgICAgICAgICAgaWYgKHJzaW5nbGVUYWcudGVzdChtYXRjaFsxXSkgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3QoY29udGV4dCkpIHsKICAgICAgICAgICAgICBmb3IgKG1hdGNoIGluIGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIC8vIFByb3BlcnRpZXMgb2YgY29udGV4dCBhcmUgY2FsbGVkIGFzIG1ldGhvZHMgaWYgcG9zc2libGUKICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKHRoaXNbbWF0Y2hdKSkgewogICAgICAgICAgICAgICAgICB0aGlzW21hdGNoXShjb250ZXh0W21hdGNoXSk7CgogICAgICAgICAgICAgICAgICAvLyAuLi5hbmQgb3RoZXJ3aXNlIHNldCBhcyBhdHRyaWJ1dGVzCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aGlzLmF0dHIobWF0Y2gsIGNvbnRleHRbbWF0Y2hdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgICAgICAgICAvLyBIQU5ETEU6ICQoI2lkKQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG1hdGNoWzJdKTsKICAgICAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgICAgICAvLyBJbmplY3QgdGhlIGVsZW1lbnQgZGlyZWN0bHkgaW50byB0aGUgalF1ZXJ5IG9iamVjdAogICAgICAgICAgICAgIHRoaXNbMF0gPSBlbGVtOwogICAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBIQU5ETEU6ICQoZXhwciwgJCguLi4pKQogICAgICAgIH0gZWxzZSBpZiAoIWNvbnRleHQgfHwgY29udGV4dC5qcXVlcnkpIHsKICAgICAgICAgIHJldHVybiAoY29udGV4dCB8fCByb290KS5maW5kKHNlbGVjdG9yKTsKCiAgICAgICAgICAvLyBIQU5ETEU6ICQoZXhwciwgY29udGV4dCkKICAgICAgICAgIC8vICh3aGljaCBpcyBqdXN0IGVxdWl2YWxlbnQgdG86ICQoY29udGV4dCkuZmluZChleHByKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvcihjb250ZXh0KS5maW5kKHNlbGVjdG9yKTsKICAgICAgICB9CgogICAgICAgIC8vIEhBTkRMRTogJChET01FbGVtZW50KQogICAgICB9IGVsc2UgaWYgKHNlbGVjdG9yLm5vZGVUeXBlKSB7CiAgICAgICAgdGhpc1swXSA9IHNlbGVjdG9yOwogICAgICAgIHRoaXMubGVuZ3RoID0gMTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICAgICAgLy8gSEFORExFOiAkKGZ1bmN0aW9uKQogICAgICAgIC8vIFNob3J0Y3V0IGZvciBkb2N1bWVudCByZWFkeQogICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24oc2VsZWN0b3IpKSB7CiAgICAgICAgcmV0dXJuIHJvb3QucmVhZHkgIT09IHVuZGVmaW5lZCA/IHJvb3QucmVhZHkoc2VsZWN0b3IpIDoKICAgICAgICAvLyBFeGVjdXRlIGltbWVkaWF0ZWx5IGlmIHJlYWR5IGlzIG5vdCBwcmVzZW50CiAgICAgICAgc2VsZWN0b3IoalF1ZXJ5KTsKICAgICAgfQogICAgICByZXR1cm4galF1ZXJ5Lm1ha2VBcnJheShzZWxlY3RvciwgdGhpcyk7CiAgICB9OwoKICAvLyBHaXZlIHRoZSBpbml0IGZ1bmN0aW9uIHRoZSBqUXVlcnkgcHJvdG90eXBlIGZvciBsYXRlciBpbnN0YW50aWF0aW9uCiAgaW5pdC5wcm90b3R5cGUgPSBqUXVlcnkuZm47CgogIC8vIEluaXRpYWxpemUgY2VudHJhbCByZWZlcmVuY2UKICByb290alF1ZXJ5ID0galF1ZXJ5KGRvY3VtZW50KTsKICB2YXIgcnBhcmVudHNwcmV2ID0gL14oPzpwYXJlbnRzfHByZXYoPzpVbnRpbHxBbGwpKS8sCiAgICAvLyBNZXRob2RzIGd1YXJhbnRlZWQgdG8gcHJvZHVjZSBhIHVuaXF1ZSBzZXQgd2hlbiBzdGFydGluZyBmcm9tIGEgdW5pcXVlIHNldAogICAgZ3VhcmFudGVlZFVuaXF1ZSA9IHsKICAgICAgY2hpbGRyZW46IHRydWUsCiAgICAgIGNvbnRlbnRzOiB0cnVlLAogICAgICBuZXh0OiB0cnVlLAogICAgICBwcmV2OiB0cnVlCiAgICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgaGFzOiBmdW5jdGlvbiBoYXModGFyZ2V0KSB7CiAgICAgIHZhciB0YXJnZXRzID0galF1ZXJ5KHRhcmdldCwgdGhpcyksCiAgICAgICAgbCA9IHRhcmdldHMubGVuZ3RoOwogICAgICByZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBpID0gMDsKICAgICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgICAgaWYgKGpRdWVyeS5jb250YWlucyh0aGlzLCB0YXJnZXRzW2ldKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGNsb3Nlc3Q6IGZ1bmN0aW9uIGNsb3Nlc3Qoc2VsZWN0b3JzLCBjb250ZXh0KSB7CiAgICAgIHZhciBjdXIsCiAgICAgICAgaSA9IDAsCiAgICAgICAgbCA9IHRoaXMubGVuZ3RoLAogICAgICAgIG1hdGNoZWQgPSBbXSwKICAgICAgICB0YXJnZXRzID0gdHlwZW9mIHNlbGVjdG9ycyAhPT0gInN0cmluZyIgJiYgalF1ZXJ5KHNlbGVjdG9ycyk7CgogICAgICAvLyBQb3NpdGlvbmFsIHNlbGVjdG9ycyBuZXZlciBtYXRjaCwgc2luY2UgdGhlcmUncyBubyBfc2VsZWN0aW9uXyBjb250ZXh0CiAgICAgIGlmICghcm5lZWRzQ29udGV4dC50ZXN0KHNlbGVjdG9ycykpIHsKICAgICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgICAgZm9yIChjdXIgPSB0aGlzW2ldOyBjdXIgJiYgY3VyICE9PSBjb250ZXh0OyBjdXIgPSBjdXIucGFyZW50Tm9kZSkgewogICAgICAgICAgICAvLyBBbHdheXMgc2tpcCBkb2N1bWVudCBmcmFnbWVudHMKICAgICAgICAgICAgaWYgKGN1ci5ub2RlVHlwZSA8IDExICYmICh0YXJnZXRzID8gdGFyZ2V0cy5pbmRleChjdXIpID4gLTEgOgogICAgICAgICAgICAvLyBEb24ndCBwYXNzIG5vbi1lbGVtZW50cyB0byBTaXp6bGUKICAgICAgICAgICAgY3VyLm5vZGVUeXBlID09PSAxICYmIGpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvcihjdXIsIHNlbGVjdG9ycykpKSB7CiAgICAgICAgICAgICAgbWF0Y2hlZC5wdXNoKGN1cik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKG1hdGNoZWQubGVuZ3RoID4gMSA/IGpRdWVyeS51bmlxdWVTb3J0KG1hdGNoZWQpIDogbWF0Y2hlZCk7CiAgICB9LAogICAgLy8gRGV0ZXJtaW5lIHRoZSBwb3NpdGlvbiBvZiBhbiBlbGVtZW50IHdpdGhpbiB0aGUgc2V0CiAgICBpbmRleDogZnVuY3Rpb24gaW5kZXgoZWxlbSkgewogICAgICAvLyBObyBhcmd1bWVudCwgcmV0dXJuIGluZGV4IGluIHBhcmVudAogICAgICBpZiAoIWVsZW0pIHsKICAgICAgICByZXR1cm4gdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUgPyB0aGlzLmZpcnN0KCkucHJldkFsbCgpLmxlbmd0aCA6IC0xOwogICAgICB9CgogICAgICAvLyBJbmRleCBpbiBzZWxlY3RvcgogICAgICBpZiAodHlwZW9mIGVsZW0gPT09ICJzdHJpbmciKSB7CiAgICAgICAgcmV0dXJuIGluZGV4T2YuY2FsbChqUXVlcnkoZWxlbSksIHRoaXNbMF0pOwogICAgICB9CgogICAgICAvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKICAgICAgcmV0dXJuIGluZGV4T2YuY2FsbCh0aGlzLAogICAgICAvLyBJZiBpdCByZWNlaXZlcyBhIGpRdWVyeSBvYmplY3QsIHRoZSBmaXJzdCBlbGVtZW50IGlzIHVzZWQKICAgICAgZWxlbS5qcXVlcnkgPyBlbGVtWzBdIDogZWxlbSk7CiAgICB9LAogICAgYWRkOiBmdW5jdGlvbiBhZGQoc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGpRdWVyeS51bmlxdWVTb3J0KGpRdWVyeS5tZXJnZSh0aGlzLmdldCgpLCBqUXVlcnkoc2VsZWN0b3IsIGNvbnRleHQpKSkpOwogICAgfSwKICAgIGFkZEJhY2s6IGZ1bmN0aW9uIGFkZEJhY2soc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkKHNlbGVjdG9yID09IG51bGwgPyB0aGlzLnByZXZPYmplY3QgOiB0aGlzLnByZXZPYmplY3QuZmlsdGVyKHNlbGVjdG9yKSk7CiAgICB9CiAgfSk7CiAgZnVuY3Rpb24gc2libGluZyhjdXIsIGRpcikgewogICAgd2hpbGUgKChjdXIgPSBjdXJbZGlyXSkgJiYgY3VyLm5vZGVUeXBlICE9PSAxKSB7fQogICAgcmV0dXJuIGN1cjsKICB9CiAgalF1ZXJ5LmVhY2goewogICAgcGFyZW50OiBmdW5jdGlvbiBwYXJlbnQoZWxlbSkgewogICAgICB2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwogICAgICByZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gMTEgPyBwYXJlbnQgOiBudWxsOwogICAgfSwKICAgIHBhcmVudHM6IGZ1bmN0aW9uIHBhcmVudHMoZWxlbSkgewogICAgICByZXR1cm4gZGlyKGVsZW0sICJwYXJlbnROb2RlIik7CiAgICB9LAogICAgcGFyZW50c1VudGlsOiBmdW5jdGlvbiBwYXJlbnRzVW50aWwoZWxlbSwgX2ksIHVudGlsKSB7CiAgICAgIHJldHVybiBkaXIoZWxlbSwgInBhcmVudE5vZGUiLCB1bnRpbCk7CiAgICB9LAogICAgbmV4dDogZnVuY3Rpb24gbmV4dChlbGVtKSB7CiAgICAgIHJldHVybiBzaWJsaW5nKGVsZW0sICJuZXh0U2libGluZyIpOwogICAgfSwKICAgIHByZXY6IGZ1bmN0aW9uIHByZXYoZWxlbSkgewogICAgICByZXR1cm4gc2libGluZyhlbGVtLCAicHJldmlvdXNTaWJsaW5nIik7CiAgICB9LAogICAgbmV4dEFsbDogZnVuY3Rpb24gbmV4dEFsbChlbGVtKSB7CiAgICAgIHJldHVybiBkaXIoZWxlbSwgIm5leHRTaWJsaW5nIik7CiAgICB9LAogICAgcHJldkFsbDogZnVuY3Rpb24gcHJldkFsbChlbGVtKSB7CiAgICAgIHJldHVybiBkaXIoZWxlbSwgInByZXZpb3VzU2libGluZyIpOwogICAgfSwKICAgIG5leHRVbnRpbDogZnVuY3Rpb24gbmV4dFVudGlsKGVsZW0sIF9pLCB1bnRpbCkgewogICAgICByZXR1cm4gZGlyKGVsZW0sICJuZXh0U2libGluZyIsIHVudGlsKTsKICAgIH0sCiAgICBwcmV2VW50aWw6IGZ1bmN0aW9uIHByZXZVbnRpbChlbGVtLCBfaSwgdW50aWwpIHsKICAgICAgcmV0dXJuIGRpcihlbGVtLCAicHJldmlvdXNTaWJsaW5nIiwgdW50aWwpOwogICAgfSwKICAgIHNpYmxpbmdzOiBmdW5jdGlvbiBzaWJsaW5ncyhlbGVtKSB7CiAgICAgIHJldHVybiBfc2libGluZ3MoKGVsZW0ucGFyZW50Tm9kZSB8fCB7fSkuZmlyc3RDaGlsZCwgZWxlbSk7CiAgICB9LAogICAgY2hpbGRyZW46IGZ1bmN0aW9uIGNoaWxkcmVuKGVsZW0pIHsKICAgICAgcmV0dXJuIF9zaWJsaW5ncyhlbGVtLmZpcnN0Q2hpbGQpOwogICAgfSwKICAgIGNvbnRlbnRzOiBmdW5jdGlvbiBjb250ZW50cyhlbGVtKSB7CiAgICAgIGlmIChlbGVtLmNvbnRlbnREb2N1bWVudCAhPSBudWxsICYmCiAgICAgIC8vIFN1cHBvcnQ6IElFIDExKwogICAgICAvLyA8b2JqZWN0PiBlbGVtZW50cyB3aXRoIG5vIGBkYXRhYCBhdHRyaWJ1dGUgaGFzIGFuIG9iamVjdAogICAgICAvLyBgY29udGVudERvY3VtZW50YCB3aXRoIGEgYG51bGxgIHByb3RvdHlwZS4KICAgICAgZ2V0UHJvdG8oZWxlbS5jb250ZW50RG9jdW1lbnQpKSB7CiAgICAgICAgcmV0dXJuIGVsZW0uY29udGVudERvY3VtZW50OwogICAgICB9CgogICAgICAvLyBTdXBwb3J0OiBJRSA5IC0gMTEgb25seSwgaU9TIDcgb25seSwgQW5kcm9pZCBCcm93c2VyIDw9NC4zIG9ubHkKICAgICAgLy8gVHJlYXQgdGhlIHRlbXBsYXRlIGVsZW1lbnQgYXMgYSByZWd1bGFyIG9uZSBpbiBicm93c2VycyB0aGF0CiAgICAgIC8vIGRvbid0IHN1cHBvcnQgaXQuCiAgICAgIGlmIChub2RlTmFtZShlbGVtLCAidGVtcGxhdGUiKSkgewogICAgICAgIGVsZW0gPSBlbGVtLmNvbnRlbnQgfHwgZWxlbTsKICAgICAgfQogICAgICByZXR1cm4galF1ZXJ5Lm1lcmdlKFtdLCBlbGVtLmNoaWxkTm9kZXMpOwogICAgfQogIH0sIGZ1bmN0aW9uIChuYW1lLCBmbikgewogICAgalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24gKHVudGlsLCBzZWxlY3RvcikgewogICAgICB2YXIgbWF0Y2hlZCA9IGpRdWVyeS5tYXAodGhpcywgZm4sIHVudGlsKTsKICAgICAgaWYgKG5hbWUuc2xpY2UoLTUpICE9PSAiVW50aWwiKSB7CiAgICAgICAgc2VsZWN0b3IgPSB1bnRpbDsKICAgICAgfQogICAgICBpZiAoc2VsZWN0b3IgJiYgdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIikgewogICAgICAgIG1hdGNoZWQgPSBqUXVlcnkuZmlsdGVyKHNlbGVjdG9yLCBtYXRjaGVkKTsKICAgICAgfQogICAgICBpZiAodGhpcy5sZW5ndGggPiAxKSB7CiAgICAgICAgLy8gUmVtb3ZlIGR1cGxpY2F0ZXMKICAgICAgICBpZiAoIWd1YXJhbnRlZWRVbmlxdWVbbmFtZV0pIHsKICAgICAgICAgIGpRdWVyeS51bmlxdWVTb3J0KG1hdGNoZWQpOwogICAgICAgIH0KCiAgICAgICAgLy8gUmV2ZXJzZSBvcmRlciBmb3IgcGFyZW50cyogYW5kIHByZXYtZGVyaXZhdGl2ZXMKICAgICAgICBpZiAocnBhcmVudHNwcmV2LnRlc3QobmFtZSkpIHsKICAgICAgICAgIG1hdGNoZWQucmV2ZXJzZSgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2sobWF0Y2hlZCk7CiAgICB9OwogIH0pOwogIHZhciBybm90aHRtbHdoaXRlID0gL1teXHgyMFx0XHJcblxmXSsvZzsKCiAgLy8gQ29udmVydCBTdHJpbmctZm9ybWF0dGVkIG9wdGlvbnMgaW50byBPYmplY3QtZm9ybWF0dGVkIG9uZXMKICBmdW5jdGlvbiBjcmVhdGVPcHRpb25zKG9wdGlvbnMpIHsKICAgIHZhciBvYmplY3QgPSB7fTsKICAgIGpRdWVyeS5lYWNoKG9wdGlvbnMubWF0Y2gocm5vdGh0bWx3aGl0ZSkgfHwgW10sIGZ1bmN0aW9uIChfLCBmbGFnKSB7CiAgICAgIG9iamVjdFtmbGFnXSA9IHRydWU7CiAgICB9KTsKICAgIHJldHVybiBvYmplY3Q7CiAgfQoKICAvKgogICogQ3JlYXRlIGEgY2FsbGJhY2sgbGlzdCB1c2luZyB0aGUgZm9sbG93aW5nIHBhcmFtZXRlcnM6CiAgKgogICoJb3B0aW9uczogYW4gb3B0aW9uYWwgbGlzdCBvZiBzcGFjZS1zZXBhcmF0ZWQgb3B0aW9ucyB0aGF0IHdpbGwgY2hhbmdlIGhvdwogICoJCQl0aGUgY2FsbGJhY2sgbGlzdCBiZWhhdmVzIG9yIGEgbW9yZSB0cmFkaXRpb25hbCBvcHRpb24gb2JqZWN0CiAgKgogICogQnkgZGVmYXVsdCBhIGNhbGxiYWNrIGxpc3Qgd2lsbCBhY3QgbGlrZSBhbiBldmVudCBjYWxsYmFjayBsaXN0IGFuZCBjYW4gYmUKICAqICJmaXJlZCIgbXVsdGlwbGUgdGltZXMuCiAgKgogICogUG9zc2libGUgb3B0aW9uczoKICAqCiAgKglvbmNlOgkJCXdpbGwgZW5zdXJlIHRoZSBjYWxsYmFjayBsaXN0IGNhbiBvbmx5IGJlIGZpcmVkIG9uY2UgKGxpa2UgYSBEZWZlcnJlZCkKICAqCiAgKgltZW1vcnk6CQkJd2lsbCBrZWVwIHRyYWNrIG9mIHByZXZpb3VzIHZhbHVlcyBhbmQgd2lsbCBjYWxsIGFueSBjYWxsYmFjayBhZGRlZAogICoJCQkJCWFmdGVyIHRoZSBsaXN0IGhhcyBiZWVuIGZpcmVkIHJpZ2h0IGF3YXkgd2l0aCB0aGUgbGF0ZXN0ICJtZW1vcml6ZWQiCiAgKgkJCQkJdmFsdWVzIChsaWtlIGEgRGVmZXJyZWQpCiAgKgogICoJdW5pcXVlOgkJCXdpbGwgZW5zdXJlIGEgY2FsbGJhY2sgY2FuIG9ubHkgYmUgYWRkZWQgb25jZSAobm8gZHVwbGljYXRlIGluIHRoZSBsaXN0KQogICoKICAqCXN0b3BPbkZhbHNlOglpbnRlcnJ1cHQgY2FsbGluZ3Mgd2hlbiBhIGNhbGxiYWNrIHJldHVybnMgZmFsc2UKICAqCiAgKi8KICBqUXVlcnkuQ2FsbGJhY2tzID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIC8vIENvbnZlcnQgb3B0aW9ucyBmcm9tIFN0cmluZy1mb3JtYXR0ZWQgdG8gT2JqZWN0LWZvcm1hdHRlZCBpZiBuZWVkZWQKICAgIC8vICh3ZSBjaGVjayBpbiBjYWNoZSBmaXJzdCkKICAgIG9wdGlvbnMgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgPyBjcmVhdGVPcHRpb25zKG9wdGlvbnMpIDogalF1ZXJ5LmV4dGVuZCh7fSwgb3B0aW9ucyk7CiAgICB2YXIKICAgICAgLy8gRmxhZyB0byBrbm93IGlmIGxpc3QgaXMgY3VycmVudGx5IGZpcmluZwogICAgICBmaXJpbmcsCiAgICAgIC8vIExhc3QgZmlyZSB2YWx1ZSBmb3Igbm9uLWZvcmdldHRhYmxlIGxpc3RzCiAgICAgIG1lbW9yeSwKICAgICAgLy8gRmxhZyB0byBrbm93IGlmIGxpc3Qgd2FzIGFscmVhZHkgZmlyZWQKICAgICAgX2ZpcmVkLAogICAgICAvLyBGbGFnIHRvIHByZXZlbnQgZmlyaW5nCiAgICAgIF9sb2NrZWQsCiAgICAgIC8vIEFjdHVhbCBjYWxsYmFjayBsaXN0CiAgICAgIGxpc3QgPSBbXSwKICAgICAgLy8gUXVldWUgb2YgZXhlY3V0aW9uIGRhdGEgZm9yIHJlcGVhdGFibGUgbGlzdHMKICAgICAgcXVldWUgPSBbXSwKICAgICAgLy8gSW5kZXggb2YgY3VycmVudGx5IGZpcmluZyBjYWxsYmFjayAobW9kaWZpZWQgYnkgYWRkL3JlbW92ZSBhcyBuZWVkZWQpCiAgICAgIGZpcmluZ0luZGV4ID0gLTEsCiAgICAgIC8vIEZpcmUgY2FsbGJhY2tzCiAgICAgIGZpcmUgPSBmdW5jdGlvbiBmaXJlKCkgewogICAgICAgIC8vIEVuZm9yY2Ugc2luZ2xlLWZpcmluZwogICAgICAgIF9sb2NrZWQgPSBfbG9ja2VkIHx8IG9wdGlvbnMub25jZTsKCiAgICAgICAgLy8gRXhlY3V0ZSBjYWxsYmFja3MgZm9yIGFsbCBwZW5kaW5nIGV4ZWN1dGlvbnMsCiAgICAgICAgLy8gcmVzcGVjdGluZyBmaXJpbmdJbmRleCBvdmVycmlkZXMgYW5kIHJ1bnRpbWUgY2hhbmdlcwogICAgICAgIF9maXJlZCA9IGZpcmluZyA9IHRydWU7CiAgICAgICAgZm9yICg7IHF1ZXVlLmxlbmd0aDsgZmlyaW5nSW5kZXggPSAtMSkgewogICAgICAgICAgbWVtb3J5ID0gcXVldWUuc2hpZnQoKTsKICAgICAgICAgIHdoaWxlICgrK2ZpcmluZ0luZGV4IDwgbGlzdC5sZW5ndGgpIHsKICAgICAgICAgICAgLy8gUnVuIGNhbGxiYWNrIGFuZCBjaGVjayBmb3IgZWFybHkgdGVybWluYXRpb24KICAgICAgICAgICAgaWYgKGxpc3RbZmlyaW5nSW5kZXhdLmFwcGx5KG1lbW9yeVswXSwgbWVtb3J5WzFdKSA9PT0gZmFsc2UgJiYgb3B0aW9ucy5zdG9wT25GYWxzZSkgewogICAgICAgICAgICAgIC8vIEp1bXAgdG8gZW5kIGFuZCBmb3JnZXQgdGhlIGRhdGEgc28gLmFkZCBkb2Vzbid0IHJlLWZpcmUKICAgICAgICAgICAgICBmaXJpbmdJbmRleCA9IGxpc3QubGVuZ3RoOwogICAgICAgICAgICAgIG1lbW9yeSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBGb3JnZXQgdGhlIGRhdGEgaWYgd2UncmUgZG9uZSB3aXRoIGl0CiAgICAgICAgaWYgKCFvcHRpb25zLm1lbW9yeSkgewogICAgICAgICAgbWVtb3J5ID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZpcmluZyA9IGZhbHNlOwoKICAgICAgICAvLyBDbGVhbiB1cCBpZiB3ZSdyZSBkb25lIGZpcmluZyBmb3IgZ29vZAogICAgICAgIGlmIChfbG9ja2VkKSB7CiAgICAgICAgICAvLyBLZWVwIGFuIGVtcHR5IGxpc3QgaWYgd2UgaGF2ZSBkYXRhIGZvciBmdXR1cmUgYWRkIGNhbGxzCiAgICAgICAgICBpZiAobWVtb3J5KSB7CiAgICAgICAgICAgIGxpc3QgPSBbXTsKCiAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgdGhpcyBvYmplY3QgaXMgc3BlbnQKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpc3QgPSAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIC8vIEFjdHVhbCBDYWxsYmFja3Mgb2JqZWN0CiAgICAgIHNlbGYgPSB7CiAgICAgICAgLy8gQWRkIGEgY2FsbGJhY2sgb3IgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcyB0byB0aGUgbGlzdAogICAgICAgIGFkZDogZnVuY3Rpb24gYWRkKCkgewogICAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgICAgLy8gSWYgd2UgaGF2ZSBtZW1vcnkgZnJvbSBhIHBhc3QgcnVuLCB3ZSBzaG91bGQgZmlyZSBhZnRlciBhZGRpbmcKICAgICAgICAgICAgaWYgKG1lbW9yeSAmJiAhZmlyaW5nKSB7CiAgICAgICAgICAgICAgZmlyaW5nSW5kZXggPSBsaXN0Lmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgcXVldWUucHVzaChtZW1vcnkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIChmdW5jdGlvbiBhZGQoYXJncykgewogICAgICAgICAgICAgIGpRdWVyeS5lYWNoKGFyZ3MsIGZ1bmN0aW9uIChfLCBhcmcpIHsKICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGFyZykpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLnVuaXF1ZSB8fCAhc2VsZi5oYXMoYXJnKSkgewogICAgICAgICAgICAgICAgICAgIGxpc3QucHVzaChhcmcpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFyZyAmJiBhcmcubGVuZ3RoICYmIHRvVHlwZShhcmcpICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAvLyBJbnNwZWN0IHJlY3Vyc2l2ZWx5CiAgICAgICAgICAgICAgICAgIGFkZChhcmcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KShhcmd1bWVudHMpOwogICAgICAgICAgICBpZiAobWVtb3J5ICYmICFmaXJpbmcpIHsKICAgICAgICAgICAgICBmaXJlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gUmVtb3ZlIGEgY2FsbGJhY2sgZnJvbSB0aGUgbGlzdAogICAgICAgIHJlbW92ZTogZnVuY3Rpb24gcmVtb3ZlKCkgewogICAgICAgICAgalF1ZXJ5LmVhY2goYXJndW1lbnRzLCBmdW5jdGlvbiAoXywgYXJnKSB7CiAgICAgICAgICAgIHZhciBpbmRleDsKICAgICAgICAgICAgd2hpbGUgKChpbmRleCA9IGpRdWVyeS5pbkFycmF5KGFyZywgbGlzdCwgaW5kZXgpKSA+IC0xKSB7CiAgICAgICAgICAgICAgbGlzdC5zcGxpY2UoaW5kZXgsIDEpOwoKICAgICAgICAgICAgICAvLyBIYW5kbGUgZmlyaW5nIGluZGV4ZXMKICAgICAgICAgICAgICBpZiAoaW5kZXggPD0gZmlyaW5nSW5kZXgpIHsKICAgICAgICAgICAgICAgIGZpcmluZ0luZGV4LS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gQ2hlY2sgaWYgYSBnaXZlbiBjYWxsYmFjayBpcyBpbiB0aGUgbGlzdC4KICAgICAgICAvLyBJZiBubyBhcmd1bWVudCBpcyBnaXZlbiwgcmV0dXJuIHdoZXRoZXIgb3Igbm90IGxpc3QgaGFzIGNhbGxiYWNrcyBhdHRhY2hlZC4KICAgICAgICBoYXM6IGZ1bmN0aW9uIGhhcyhmbikgewogICAgICAgICAgcmV0dXJuIGZuID8galF1ZXJ5LmluQXJyYXkoZm4sIGxpc3QpID4gLTEgOiBsaXN0Lmxlbmd0aCA+IDA7CiAgICAgICAgfSwKICAgICAgICAvLyBSZW1vdmUgYWxsIGNhbGxiYWNrcyBmcm9tIHRoZSBsaXN0CiAgICAgICAgZW1wdHk6IGZ1bmN0aW9uIGVtcHR5KCkgewogICAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgICAgbGlzdCA9IFtdOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBEaXNhYmxlIC5maXJlIGFuZCAuYWRkCiAgICAgICAgLy8gQWJvcnQgYW55IGN1cnJlbnQvcGVuZGluZyBleGVjdXRpb25zCiAgICAgICAgLy8gQ2xlYXIgYWxsIGNhbGxiYWNrcyBhbmQgdmFsdWVzCiAgICAgICAgZGlzYWJsZTogZnVuY3Rpb24gZGlzYWJsZSgpIHsKICAgICAgICAgIF9sb2NrZWQgPSBxdWV1ZSA9IFtdOwogICAgICAgICAgbGlzdCA9IG1lbW9yeSA9ICIiOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICBkaXNhYmxlZDogZnVuY3Rpb24gZGlzYWJsZWQoKSB7CiAgICAgICAgICByZXR1cm4gIWxpc3Q7CiAgICAgICAgfSwKICAgICAgICAvLyBEaXNhYmxlIC5maXJlCiAgICAgICAgLy8gQWxzbyBkaXNhYmxlIC5hZGQgdW5sZXNzIHdlIGhhdmUgbWVtb3J5IChzaW5jZSBpdCB3b3VsZCBoYXZlIG5vIGVmZmVjdCkKICAgICAgICAvLyBBYm9ydCBhbnkgcGVuZGluZyBleGVjdXRpb25zCiAgICAgICAgbG9jazogZnVuY3Rpb24gbG9jaygpIHsKICAgICAgICAgIF9sb2NrZWQgPSBxdWV1ZSA9IFtdOwogICAgICAgICAgaWYgKCFtZW1vcnkgJiYgIWZpcmluZykgewogICAgICAgICAgICBsaXN0ID0gbWVtb3J5ID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIGxvY2tlZDogZnVuY3Rpb24gbG9ja2VkKCkgewogICAgICAgICAgcmV0dXJuICEhX2xvY2tlZDsKICAgICAgICB9LAogICAgICAgIC8vIENhbGwgYWxsIGNhbGxiYWNrcyB3aXRoIHRoZSBnaXZlbiBjb250ZXh0IGFuZCBhcmd1bWVudHMKICAgICAgICBmaXJlV2l0aDogZnVuY3Rpb24gZmlyZVdpdGgoY29udGV4dCwgYXJncykgewogICAgICAgICAgaWYgKCFfbG9ja2VkKSB7CiAgICAgICAgICAgIGFyZ3MgPSBhcmdzIHx8IFtdOwogICAgICAgICAgICBhcmdzID0gW2NvbnRleHQsIGFyZ3Muc2xpY2UgPyBhcmdzLnNsaWNlKCkgOiBhcmdzXTsKICAgICAgICAgICAgcXVldWUucHVzaChhcmdzKTsKICAgICAgICAgICAgaWYgKCFmaXJpbmcpIHsKICAgICAgICAgICAgICBmaXJlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gQ2FsbCBhbGwgdGhlIGNhbGxiYWNrcyB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMKICAgICAgICBmaXJlOiBmdW5jdGlvbiBmaXJlKCkgewogICAgICAgICAgc2VsZi5maXJlV2l0aCh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBUbyBrbm93IGlmIHRoZSBjYWxsYmFja3MgaGF2ZSBhbHJlYWR5IGJlZW4gY2FsbGVkIGF0IGxlYXN0IG9uY2UKICAgICAgICBmaXJlZDogZnVuY3Rpb24gZmlyZWQoKSB7CiAgICAgICAgICByZXR1cm4gISFfZmlyZWQ7CiAgICAgICAgfQogICAgICB9OwogICAgcmV0dXJuIHNlbGY7CiAgfTsKICBmdW5jdGlvbiBJZGVudGl0eSh2KSB7CiAgICByZXR1cm4gdjsKICB9CiAgZnVuY3Rpb24gVGhyb3dlcihleCkgewogICAgdGhyb3cgZXg7CiAgfQogIGZ1bmN0aW9uIGFkb3B0VmFsdWUodmFsdWUsIHJlc29sdmUsIHJlamVjdCwgbm9WYWx1ZSkgewogICAgdmFyIG1ldGhvZDsKICAgIHRyeSB7CiAgICAgIC8vIENoZWNrIGZvciBwcm9taXNlIGFzcGVjdCBmaXJzdCB0byBwcml2aWxlZ2Ugc3luY2hyb25vdXMgYmVoYXZpb3IKICAgICAgaWYgKHZhbHVlICYmIGlzRnVuY3Rpb24obWV0aG9kID0gdmFsdWUucHJvbWlzZSkpIHsKICAgICAgICBtZXRob2QuY2FsbCh2YWx1ZSkuZG9uZShyZXNvbHZlKS5mYWlsKHJlamVjdCk7CgogICAgICAgIC8vIE90aGVyIHRoZW5hYmxlcwogICAgICB9IGVsc2UgaWYgKHZhbHVlICYmIGlzRnVuY3Rpb24obWV0aG9kID0gdmFsdWUudGhlbikpIHsKICAgICAgICBtZXRob2QuY2FsbCh2YWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KTsKCiAgICAgICAgLy8gT3RoZXIgbm9uLXRoZW5hYmxlcwogICAgICB9IGVsc2UgewogICAgICAgIC8vIENvbnRyb2wgYHJlc29sdmVgIGFyZ3VtZW50cyBieSBsZXR0aW5nIEFycmF5I3NsaWNlIGNhc3QgYm9vbGVhbiBgbm9WYWx1ZWAgdG8gaW50ZWdlcjoKICAgICAgICAvLyAqIGZhbHNlOiBbIHZhbHVlIF0uc2xpY2UoIDAgKSA9PiByZXNvbHZlKCB2YWx1ZSApCiAgICAgICAgLy8gKiB0cnVlOiBbIHZhbHVlIF0uc2xpY2UoIDEgKSA9PiByZXNvbHZlKCkKICAgICAgICByZXNvbHZlLmFwcGx5KHVuZGVmaW5lZCwgW3ZhbHVlXS5zbGljZShub1ZhbHVlKSk7CiAgICAgIH0KCiAgICAgIC8vIEZvciBQcm9taXNlcy9BKywgY29udmVydCBleGNlcHRpb25zIGludG8gcmVqZWN0aW9ucwogICAgICAvLyBTaW5jZSBqUXVlcnkud2hlbiBkb2Vzbid0IHVud3JhcCB0aGVuYWJsZXMsIHdlIGNhbiBza2lwIHRoZSBleHRyYSBjaGVja3MgYXBwZWFyaW5nIGluCiAgICAgIC8vIERlZmVycmVkI3RoZW4gdG8gY29uZGl0aW9uYWxseSBzdXBwcmVzcyByZWplY3Rpb24uCiAgICB9IGNhdGNoICh2YWx1ZSkgewogICAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDQuMCBvbmx5CiAgICAgIC8vIFN0cmljdCBtb2RlIGZ1bmN0aW9ucyBpbnZva2VkIHdpdGhvdXQgLmNhbGwvLmFwcGx5IGdldCBnbG9iYWwtb2JqZWN0IGNvbnRleHQKICAgICAgcmVqZWN0LmFwcGx5KHVuZGVmaW5lZCwgW3ZhbHVlXSk7CiAgICB9CiAgfQogIGpRdWVyeS5leHRlbmQoewogICAgRGVmZXJyZWQ6IGZ1bmN0aW9uIERlZmVycmVkKGZ1bmMpIHsKICAgICAgdmFyIHR1cGxlcyA9IFsKICAgICAgICAvLyBhY3Rpb24sIGFkZCBsaXN0ZW5lciwgY2FsbGJhY2tzLAogICAgICAgIC8vIC4uLiAudGhlbiBoYW5kbGVycywgYXJndW1lbnQgaW5kZXgsIFtmaW5hbCBzdGF0ZV0KICAgICAgICBbIm5vdGlmeSIsICJwcm9ncmVzcyIsIGpRdWVyeS5DYWxsYmFja3MoIm1lbW9yeSIpLCBqUXVlcnkuQ2FsbGJhY2tzKCJtZW1vcnkiKSwgMl0sIFsicmVzb2x2ZSIsICJkb25lIiwgalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwgalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwgMCwgInJlc29sdmVkIl0sIFsicmVqZWN0IiwgImZhaWwiLCBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLCBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLCAxLCAicmVqZWN0ZWQiXV0sCiAgICAgICAgX3N0YXRlID0gInBlbmRpbmciLAogICAgICAgIF9wcm9taXNlID0gewogICAgICAgICAgc3RhdGU6IGZ1bmN0aW9uIHN0YXRlKCkgewogICAgICAgICAgICByZXR1cm4gX3N0YXRlOwogICAgICAgICAgfSwKICAgICAgICAgIGFsd2F5czogZnVuY3Rpb24gYWx3YXlzKCkgewogICAgICAgICAgICBkZWZlcnJlZC5kb25lKGFyZ3VtZW50cykuZmFpbChhcmd1bWVudHMpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0sCiAgICAgICAgICAiY2F0Y2giOiBmdW5jdGlvbiBfY2F0Y2goZm4pIHsKICAgICAgICAgICAgcmV0dXJuIF9wcm9taXNlLnRoZW4obnVsbCwgZm4pOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIEtlZXAgcGlwZSBmb3IgYmFjay1jb21wYXQKICAgICAgICAgIHBpcGU6IGZ1bmN0aW9uIHBpcGUoIC8qIGZuRG9uZSwgZm5GYWlsLCBmblByb2dyZXNzICovCiAgICAgICAgICApIHsKICAgICAgICAgICAgdmFyIGZucyA9IGFyZ3VtZW50czsKICAgICAgICAgICAgcmV0dXJuIGpRdWVyeS5EZWZlcnJlZChmdW5jdGlvbiAobmV3RGVmZXIpIHsKICAgICAgICAgICAgICBqUXVlcnkuZWFjaCh0dXBsZXMsIGZ1bmN0aW9uIChfaSwgdHVwbGUpIHsKICAgICAgICAgICAgICAgIC8vIE1hcCB0dXBsZXMgKHByb2dyZXNzLCBkb25lLCBmYWlsKSB0byBhcmd1bWVudHMgKGRvbmUsIGZhaWwsIHByb2dyZXNzKQogICAgICAgICAgICAgICAgdmFyIGZuID0gaXNGdW5jdGlvbihmbnNbdHVwbGVbNF1dKSAmJiBmbnNbdHVwbGVbNF1dOwoKICAgICAgICAgICAgICAgIC8vIGRlZmVycmVkLnByb2dyZXNzKGZ1bmN0aW9uKCkgeyBiaW5kIHRvIG5ld0RlZmVyIG9yIG5ld0RlZmVyLm5vdGlmeSB9KQogICAgICAgICAgICAgICAgLy8gZGVmZXJyZWQuZG9uZShmdW5jdGlvbigpIHsgYmluZCB0byBuZXdEZWZlciBvciBuZXdEZWZlci5yZXNvbHZlIH0pCiAgICAgICAgICAgICAgICAvLyBkZWZlcnJlZC5mYWlsKGZ1bmN0aW9uKCkgeyBiaW5kIHRvIG5ld0RlZmVyIG9yIG5ld0RlZmVyLnJlamVjdCB9KQogICAgICAgICAgICAgICAgZGVmZXJyZWRbdHVwbGVbMV1dKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIHJldHVybmVkID0gZm4gJiYgZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgaWYgKHJldHVybmVkICYmIGlzRnVuY3Rpb24ocmV0dXJuZWQucHJvbWlzZSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm5lZC5wcm9taXNlKCkucHJvZ3Jlc3MobmV3RGVmZXIubm90aWZ5KS5kb25lKG5ld0RlZmVyLnJlc29sdmUpLmZhaWwobmV3RGVmZXIucmVqZWN0KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBuZXdEZWZlclt0dXBsZVswXSArICJXaXRoIl0odGhpcywgZm4gPyBbcmV0dXJuZWRdIDogYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgZm5zID0gbnVsbDsKICAgICAgICAgICAgfSkucHJvbWlzZSgpOwogICAgICAgICAgfSwKICAgICAgICAgIHRoZW46IGZ1bmN0aW9uIHRoZW4ob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgdmFyIG1heERlcHRoID0gMDsKICAgICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZShkZXB0aCwgZGVmZXJyZWQsIGhhbmRsZXIsIHNwZWNpYWwpIHsKICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLAogICAgICAgICAgICAgICAgICBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgICAgICAgICBtaWdodFRocm93ID0gZnVuY3Rpb24gbWlnaHRUaHJvdygpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmV0dXJuZWQsIHRoZW47CgogICAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IFByb21pc2VzL0ErIHNlY3Rpb24gMi4zLjMuMy4zCiAgICAgICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9wcm9taXNlc2FwbHVzLmNvbS8jcG9pbnQtNTkKICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgZG91YmxlLXJlc29sdXRpb24gYXR0ZW1wdHMKICAgICAgICAgICAgICAgICAgICBpZiAoZGVwdGggPCBtYXhEZXB0aCkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm5lZCA9IGhhbmRsZXIuYXBwbHkodGhhdCwgYXJncyk7CgogICAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IFByb21pc2VzL0ErIHNlY3Rpb24gMi4zLjEKICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC00OAogICAgICAgICAgICAgICAgICAgIGlmIChyZXR1cm5lZCA9PT0gZGVmZXJyZWQucHJvbWlzZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJUaGVuYWJsZSBzZWxmLXJlc29sdXRpb24iKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IFByb21pc2VzL0ErIHNlY3Rpb25zIDIuMy4zLjEsIDMuNQogICAgICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTU0CiAgICAgICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9wcm9taXNlc2FwbHVzLmNvbS8jcG9pbnQtNzUKICAgICAgICAgICAgICAgICAgICAvLyBSZXRyaWV2ZSBgdGhlbmAgb25seSBvbmNlCiAgICAgICAgICAgICAgICAgICAgdGhlbiA9IHJldHVybmVkICYmICgKICAgICAgICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBQcm9taXNlcy9BKyBzZWN0aW9uIDIuMy40CiAgICAgICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9wcm9taXNlc2FwbHVzLmNvbS8jcG9pbnQtNjQKICAgICAgICAgICAgICAgICAgICAvLyBPbmx5IGNoZWNrIG9iamVjdHMgYW5kIGZ1bmN0aW9ucyBmb3IgdGhlbmFiaWxpdHkKICAgICAgICAgICAgICAgICAgICBfdHlwZW9mKHJldHVybmVkKSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHJldHVybmVkID09PSAiZnVuY3Rpb24iKSAmJiByZXR1cm5lZC50aGVuOwoKICAgICAgICAgICAgICAgICAgICAvLyBIYW5kbGUgYSByZXR1cm5lZCB0aGVuYWJsZQogICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKHRoZW4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBTcGVjaWFsIHByb2Nlc3NvcnMgKG5vdGlmeSkganVzdCB3YWl0IGZvciByZXNvbHV0aW9uCiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BlY2lhbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGVuLmNhbGwocmV0dXJuZWQsIHJlc29sdmUobWF4RGVwdGgsIGRlZmVycmVkLCBJZGVudGl0eSwgc3BlY2lhbCksIHJlc29sdmUobWF4RGVwdGgsIGRlZmVycmVkLCBUaHJvd2VyLCBzcGVjaWFsKSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWwgcHJvY2Vzc29ycyAocmVzb2x2ZSkgYWxzbyBob29rIGludG8gcHJvZ3Jlc3MKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIC4uLmFuZCBkaXNyZWdhcmQgb2xkZXIgcmVzb2x1dGlvbiB2YWx1ZXMKICAgICAgICAgICAgICAgICAgICAgICAgbWF4RGVwdGgrKzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhlbi5jYWxsKHJldHVybmVkLCByZXNvbHZlKG1heERlcHRoLCBkZWZlcnJlZCwgSWRlbnRpdHksIHNwZWNpYWwpLCByZXNvbHZlKG1heERlcHRoLCBkZWZlcnJlZCwgVGhyb3dlciwgc3BlY2lhbCksIHJlc29sdmUobWF4RGVwdGgsIGRlZmVycmVkLCBJZGVudGl0eSwgZGVmZXJyZWQubm90aWZ5V2l0aCkpOwogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIC8vIEhhbmRsZSBhbGwgb3RoZXIgcmV0dXJuZWQgdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgc3Vic3RpdHV0ZSBoYW5kbGVycyBwYXNzIG9uIGNvbnRleHQKICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBtdWx0aXBsZSB2YWx1ZXMgKG5vbi1zcGVjIGJlaGF2aW9yKQogICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXIgIT09IElkZW50aXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBbcmV0dXJuZWRdOwogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIC8vIFByb2Nlc3MgdGhlIHZhbHVlKHMpCiAgICAgICAgICAgICAgICAgICAgICAvLyBEZWZhdWx0IHByb2Nlc3MgaXMgcmVzb2x2ZQogICAgICAgICAgICAgICAgICAgICAgKHNwZWNpYWwgfHwgZGVmZXJyZWQucmVzb2x2ZVdpdGgpKHRoYXQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgLy8gT25seSBub3JtYWwgcHJvY2Vzc29ycyAocmVzb2x2ZSkgY2F0Y2ggYW5kIHJlamVjdCBleGNlcHRpb25zCiAgICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBzcGVjaWFsID8gbWlnaHRUaHJvdyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgbWlnaHRUaHJvdygpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuRGVmZXJyZWQuZXhjZXB0aW9uSG9vaykgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuRGVmZXJyZWQuZXhjZXB0aW9uSG9vayhlLCBwcm9jZXNzLnN0YWNrVHJhY2UpOwogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IFByb21pc2VzL0ErIHNlY3Rpb24gMi4zLjMuMy40LjEKICAgICAgICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTYxCiAgICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgcG9zdC1yZXNvbHV0aW9uIGV4Y2VwdGlvbnMKICAgICAgICAgICAgICAgICAgICAgIGlmIChkZXB0aCArIDEgPj0gbWF4RGVwdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT25seSBzdWJzdGl0dXRlIGhhbmRsZXJzIHBhc3Mgb24gY29udGV4dAogICAgICAgICAgICAgICAgICAgICAgICAvLyBhbmQgbXVsdGlwbGUgdmFsdWVzIChub24tc3BlYyBiZWhhdmlvcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXIgIT09IFRocm93ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBbZV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0V2l0aCh0aGF0LCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gU3VwcG9ydDogUHJvbWlzZXMvQSsgc2VjdGlvbiAyLjMuMy4zLjEKICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTU3CiAgICAgICAgICAgICAgICAvLyBSZS1yZXNvbHZlIHByb21pc2VzIGltbWVkaWF0ZWx5IHRvIGRvZGdlIGZhbHNlIHJlamVjdGlvbiBmcm9tCiAgICAgICAgICAgICAgICAvLyBzdWJzZXF1ZW50IGVycm9ycwogICAgICAgICAgICAgICAgaWYgKGRlcHRoKSB7CiAgICAgICAgICAgICAgICAgIHByb2Nlc3MoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIC8vIENhbGwgYW4gb3B0aW9uYWwgaG9vayB0byByZWNvcmQgdGhlIHN0YWNrLCBpbiBjYXNlIG9mIGV4Y2VwdGlvbgogICAgICAgICAgICAgICAgICAvLyBzaW5jZSBpdCdzIG90aGVyd2lzZSBsb3N0IHdoZW4gZXhlY3V0aW9uIGdvZXMgYXN5bmMKICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5EZWZlcnJlZC5nZXRTdGFja0hvb2spIHsKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLnN0YWNrVHJhY2UgPSBqUXVlcnkuRGVmZXJyZWQuZ2V0U3RhY2tIb29rKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQocHJvY2Vzcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4galF1ZXJ5LkRlZmVycmVkKGZ1bmN0aW9uIChuZXdEZWZlcikgewogICAgICAgICAgICAgIC8vIHByb2dyZXNzX2hhbmRsZXJzLmFkZCggLi4uICkKICAgICAgICAgICAgICB0dXBsZXNbMF1bM10uYWRkKHJlc29sdmUoMCwgbmV3RGVmZXIsIGlzRnVuY3Rpb24ob25Qcm9ncmVzcykgPyBvblByb2dyZXNzIDogSWRlbnRpdHksIG5ld0RlZmVyLm5vdGlmeVdpdGgpKTsKCiAgICAgICAgICAgICAgLy8gZnVsZmlsbGVkX2hhbmRsZXJzLmFkZCggLi4uICkKICAgICAgICAgICAgICB0dXBsZXNbMV1bM10uYWRkKHJlc29sdmUoMCwgbmV3RGVmZXIsIGlzRnVuY3Rpb24ob25GdWxmaWxsZWQpID8gb25GdWxmaWxsZWQgOiBJZGVudGl0eSkpOwoKICAgICAgICAgICAgICAvLyByZWplY3RlZF9oYW5kbGVycy5hZGQoIC4uLiApCiAgICAgICAgICAgICAgdHVwbGVzWzJdWzNdLmFkZChyZXNvbHZlKDAsIG5ld0RlZmVyLCBpc0Z1bmN0aW9uKG9uUmVqZWN0ZWQpID8gb25SZWplY3RlZCA6IFRocm93ZXIpKTsKICAgICAgICAgICAgfSkucHJvbWlzZSgpOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIEdldCBhIHByb21pc2UgZm9yIHRoaXMgZGVmZXJyZWQKICAgICAgICAgIC8vIElmIG9iaiBpcyBwcm92aWRlZCwgdGhlIHByb21pc2UgYXNwZWN0IGlzIGFkZGVkIHRvIHRoZSBvYmplY3QKICAgICAgICAgIHByb21pc2U6IGZ1bmN0aW9uIHByb21pc2Uob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBvYmogIT0gbnVsbCA/IGpRdWVyeS5leHRlbmQob2JqLCBfcHJvbWlzZSkgOiBfcHJvbWlzZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGRlZmVycmVkID0ge307CgogICAgICAvLyBBZGQgbGlzdC1zcGVjaWZpYyBtZXRob2RzCiAgICAgIGpRdWVyeS5lYWNoKHR1cGxlcywgZnVuY3Rpb24gKGksIHR1cGxlKSB7CiAgICAgICAgdmFyIGxpc3QgPSB0dXBsZVsyXSwKICAgICAgICAgIHN0YXRlU3RyaW5nID0gdHVwbGVbNV07CgogICAgICAgIC8vIHByb21pc2UucHJvZ3Jlc3MgPSBsaXN0LmFkZAogICAgICAgIC8vIHByb21pc2UuZG9uZSA9IGxpc3QuYWRkCiAgICAgICAgLy8gcHJvbWlzZS5mYWlsID0gbGlzdC5hZGQKICAgICAgICBfcHJvbWlzZVt0dXBsZVsxXV0gPSBsaXN0LmFkZDsKCiAgICAgICAgLy8gSGFuZGxlIHN0YXRlCiAgICAgICAgaWYgKHN0YXRlU3RyaW5nKSB7CiAgICAgICAgICBsaXN0LmFkZChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIC8vIHN0YXRlID0gInJlc29sdmVkIiAoaS5lLiwgZnVsZmlsbGVkKQogICAgICAgICAgICAvLyBzdGF0ZSA9ICJyZWplY3RlZCIKICAgICAgICAgICAgX3N0YXRlID0gc3RhdGVTdHJpbmc7CiAgICAgICAgICB9LAogICAgICAgICAgLy8gcmVqZWN0ZWRfY2FsbGJhY2tzLmRpc2FibGUKICAgICAgICAgIC8vIGZ1bGZpbGxlZF9jYWxsYmFja3MuZGlzYWJsZQogICAgICAgICAgdHVwbGVzWzMgLSBpXVsyXS5kaXNhYmxlLAogICAgICAgICAgLy8gcmVqZWN0ZWRfaGFuZGxlcnMuZGlzYWJsZQogICAgICAgICAgLy8gZnVsZmlsbGVkX2hhbmRsZXJzLmRpc2FibGUKICAgICAgICAgIHR1cGxlc1szIC0gaV1bM10uZGlzYWJsZSwKICAgICAgICAgIC8vIHByb2dyZXNzX2NhbGxiYWNrcy5sb2NrCiAgICAgICAgICB0dXBsZXNbMF1bMl0ubG9jaywKICAgICAgICAgIC8vIHByb2dyZXNzX2hhbmRsZXJzLmxvY2sKICAgICAgICAgIHR1cGxlc1swXVszXS5sb2NrKTsKICAgICAgICB9CgogICAgICAgIC8vIHByb2dyZXNzX2hhbmRsZXJzLmZpcmUKICAgICAgICAvLyBmdWxmaWxsZWRfaGFuZGxlcnMuZmlyZQogICAgICAgIC8vIHJlamVjdGVkX2hhbmRsZXJzLmZpcmUKICAgICAgICBsaXN0LmFkZCh0dXBsZVszXS5maXJlKTsKCiAgICAgICAgLy8gZGVmZXJyZWQubm90aWZ5ID0gZnVuY3Rpb24oKSB7IGRlZmVycmVkLm5vdGlmeVdpdGgoLi4uKSB9CiAgICAgICAgLy8gZGVmZXJyZWQucmVzb2x2ZSA9IGZ1bmN0aW9uKCkgeyBkZWZlcnJlZC5yZXNvbHZlV2l0aCguLi4pIH0KICAgICAgICAvLyBkZWZlcnJlZC5yZWplY3QgPSBmdW5jdGlvbigpIHsgZGVmZXJyZWQucmVqZWN0V2l0aCguLi4pIH0KICAgICAgICBkZWZlcnJlZFt0dXBsZVswXV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkZWZlcnJlZFt0dXBsZVswXSArICJXaXRoIl0odGhpcyA9PT0gZGVmZXJyZWQgPyB1bmRlZmluZWQgOiB0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKCiAgICAgICAgLy8gZGVmZXJyZWQubm90aWZ5V2l0aCA9IGxpc3QuZmlyZVdpdGgKICAgICAgICAvLyBkZWZlcnJlZC5yZXNvbHZlV2l0aCA9IGxpc3QuZmlyZVdpdGgKICAgICAgICAvLyBkZWZlcnJlZC5yZWplY3RXaXRoID0gbGlzdC5maXJlV2l0aAogICAgICAgIGRlZmVycmVkW3R1cGxlWzBdICsgIldpdGgiXSA9IGxpc3QuZmlyZVdpdGg7CiAgICAgIH0pOwoKICAgICAgLy8gTWFrZSB0aGUgZGVmZXJyZWQgYSBwcm9taXNlCiAgICAgIF9wcm9taXNlLnByb21pc2UoZGVmZXJyZWQpOwoKICAgICAgLy8gQ2FsbCBnaXZlbiBmdW5jIGlmIGFueQogICAgICBpZiAoZnVuYykgewogICAgICAgIGZ1bmMuY2FsbChkZWZlcnJlZCwgZGVmZXJyZWQpOwogICAgICB9CgogICAgICAvLyBBbGwgZG9uZSEKICAgICAgcmV0dXJuIGRlZmVycmVkOwogICAgfSwKICAgIC8vIERlZmVycmVkIGhlbHBlcgogICAgd2hlbjogZnVuY3Rpb24gd2hlbihzaW5nbGVWYWx1ZSkgewogICAgICB2YXIKICAgICAgICAvLyBjb3VudCBvZiB1bmNvbXBsZXRlZCBzdWJvcmRpbmF0ZXMKICAgICAgICByZW1haW5pbmcgPSBhcmd1bWVudHMubGVuZ3RoLAogICAgICAgIC8vIGNvdW50IG9mIHVucHJvY2Vzc2VkIGFyZ3VtZW50cwogICAgICAgIGkgPSByZW1haW5pbmcsCiAgICAgICAgLy8gc3Vib3JkaW5hdGUgZnVsZmlsbG1lbnQgZGF0YQogICAgICAgIHJlc29sdmVDb250ZXh0cyA9IEFycmF5KGkpLAogICAgICAgIHJlc29sdmVWYWx1ZXMgPSBfc2xpY2UuY2FsbChhcmd1bWVudHMpLAogICAgICAgIC8vIHRoZSBtYXN0ZXIgRGVmZXJyZWQKICAgICAgICBtYXN0ZXIgPSBqUXVlcnkuRGVmZXJyZWQoKSwKICAgICAgICAvLyBzdWJvcmRpbmF0ZSBjYWxsYmFjayBmYWN0b3J5CiAgICAgICAgdXBkYXRlRnVuYyA9IGZ1bmN0aW9uIHVwZGF0ZUZ1bmMoaSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXNvbHZlQ29udGV4dHNbaV0gPSB0aGlzOwogICAgICAgICAgICByZXNvbHZlVmFsdWVzW2ldID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBfc2xpY2UuY2FsbChhcmd1bWVudHMpIDogdmFsdWU7CiAgICAgICAgICAgIGlmICghIC0tcmVtYWluaW5nKSB7CiAgICAgICAgICAgICAgbWFzdGVyLnJlc29sdmVXaXRoKHJlc29sdmVDb250ZXh0cywgcmVzb2x2ZVZhbHVlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfTsKCiAgICAgIC8vIFNpbmdsZS0gYW5kIGVtcHR5IGFyZ3VtZW50cyBhcmUgYWRvcHRlZCBsaWtlIFByb21pc2UucmVzb2x2ZQogICAgICBpZiAocmVtYWluaW5nIDw9IDEpIHsKICAgICAgICBhZG9wdFZhbHVlKHNpbmdsZVZhbHVlLCBtYXN0ZXIuZG9uZSh1cGRhdGVGdW5jKGkpKS5yZXNvbHZlLCBtYXN0ZXIucmVqZWN0LCAhcmVtYWluaW5nKTsKCiAgICAgICAgLy8gVXNlIC50aGVuKCkgdG8gdW53cmFwIHNlY29uZGFyeSB0aGVuYWJsZXMgKGNmLiBnaC0zMDAwKQogICAgICAgIGlmIChtYXN0ZXIuc3RhdGUoKSA9PT0gInBlbmRpbmciIHx8IGlzRnVuY3Rpb24ocmVzb2x2ZVZhbHVlc1tpXSAmJiByZXNvbHZlVmFsdWVzW2ldLnRoZW4pKSB7CiAgICAgICAgICByZXR1cm4gbWFzdGVyLnRoZW4oKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIE11bHRpcGxlIGFyZ3VtZW50cyBhcmUgYWdncmVnYXRlZCBsaWtlIFByb21pc2UuYWxsIGFycmF5IGVsZW1lbnRzCiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICBhZG9wdFZhbHVlKHJlc29sdmVWYWx1ZXNbaV0sIHVwZGF0ZUZ1bmMoaSksIG1hc3Rlci5yZWplY3QpOwogICAgICB9CiAgICAgIHJldHVybiBtYXN0ZXIucHJvbWlzZSgpOwogICAgfQogIH0pOwoKICAvLyBUaGVzZSB1c3VhbGx5IGluZGljYXRlIGEgcHJvZ3JhbW1lciBtaXN0YWtlIGR1cmluZyBkZXZlbG9wbWVudCwKICAvLyB3YXJuIGFib3V0IHRoZW0gQVNBUCByYXRoZXIgdGhhbiBzd2FsbG93aW5nIHRoZW0gYnkgZGVmYXVsdC4KICB2YXIgcmVycm9yTmFtZXMgPSAvXihFdmFsfEludGVybmFsfFJhbmdlfFJlZmVyZW5jZXxTeW50YXh8VHlwZXxVUkkpRXJyb3IkLzsKICBqUXVlcnkuRGVmZXJyZWQuZXhjZXB0aW9uSG9vayA9IGZ1bmN0aW9uIChlcnJvciwgc3RhY2spIHsKICAgIC8vIFN1cHBvcnQ6IElFIDggLSA5IG9ubHkKICAgIC8vIENvbnNvbGUgZXhpc3RzIHdoZW4gZGV2IHRvb2xzIGFyZSBvcGVuLCB3aGljaCBjYW4gaGFwcGVuIGF0IGFueSB0aW1lCiAgICBpZiAod2luZG93LmNvbnNvbGUgJiYgd2luZG93LmNvbnNvbGUud2FybiAmJiBlcnJvciAmJiByZXJyb3JOYW1lcy50ZXN0KGVycm9yLm5hbWUpKSB7CiAgICAgIHdpbmRvdy5jb25zb2xlLndhcm4oImpRdWVyeS5EZWZlcnJlZCBleGNlcHRpb246ICIgKyBlcnJvci5tZXNzYWdlLCBlcnJvci5zdGFjaywgc3RhY2spOwogICAgfQogIH07CiAgalF1ZXJ5LnJlYWR5RXhjZXB0aW9uID0gZnVuY3Rpb24gKGVycm9yKSB7CiAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIHRocm93IGVycm9yOwogICAgfSk7CiAgfTsKCiAgLy8gVGhlIGRlZmVycmVkIHVzZWQgb24gRE9NIHJlYWR5CiAgdmFyIHJlYWR5TGlzdCA9IGpRdWVyeS5EZWZlcnJlZCgpOwogIGpRdWVyeS5mbi5yZWFkeSA9IGZ1bmN0aW9uIChmbikgewogICAgcmVhZHlMaXN0LnRoZW4oZm4pCgogICAgLy8gV3JhcCBqUXVlcnkucmVhZHlFeGNlcHRpb24gaW4gYSBmdW5jdGlvbiBzbyB0aGF0IHRoZSBsb29rdXAKICAgIC8vIGhhcHBlbnMgYXQgdGhlIHRpbWUgb2YgZXJyb3IgaGFuZGxpbmcgaW5zdGVhZCBvZiBjYWxsYmFjawogICAgLy8gcmVnaXN0cmF0aW9uLgogICAgLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICBqUXVlcnkucmVhZHlFeGNlcHRpb24oZXJyb3IpOwogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIGpRdWVyeS5leHRlbmQoewogICAgLy8gSXMgdGhlIERPTSByZWFkeSB0byBiZSB1c2VkPyBTZXQgdG8gdHJ1ZSBvbmNlIGl0IG9jY3Vycy4KICAgIGlzUmVhZHk6IGZhbHNlLAogICAgLy8gQSBjb3VudGVyIHRvIHRyYWNrIGhvdyBtYW55IGl0ZW1zIHRvIHdhaXQgZm9yIGJlZm9yZQogICAgLy8gdGhlIHJlYWR5IGV2ZW50IGZpcmVzLiBTZWUgIzY3ODEKICAgIHJlYWR5V2FpdDogMSwKICAgIC8vIEhhbmRsZSB3aGVuIHRoZSBET00gaXMgcmVhZHkKICAgIHJlYWR5OiBmdW5jdGlvbiByZWFkeSh3YWl0KSB7CiAgICAgIC8vIEFib3J0IGlmIHRoZXJlIGFyZSBwZW5kaW5nIGhvbGRzIG9yIHdlJ3JlIGFscmVhZHkgcmVhZHkKICAgICAgaWYgKHdhaXQgPT09IHRydWUgPyAtLWpRdWVyeS5yZWFkeVdhaXQgOiBqUXVlcnkuaXNSZWFkeSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gUmVtZW1iZXIgdGhhdCB0aGUgRE9NIGlzIHJlYWR5CiAgICAgIGpRdWVyeS5pc1JlYWR5ID0gdHJ1ZTsKCiAgICAgIC8vIElmIGEgbm9ybWFsIERPTSBSZWFkeSBldmVudCBmaXJlZCwgZGVjcmVtZW50LCBhbmQgd2FpdCBpZiBuZWVkIGJlCiAgICAgIGlmICh3YWl0ICE9PSB0cnVlICYmIC0talF1ZXJ5LnJlYWR5V2FpdCA+IDApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIElmIHRoZXJlIGFyZSBmdW5jdGlvbnMgYm91bmQsIHRvIGV4ZWN1dGUKICAgICAgcmVhZHlMaXN0LnJlc29sdmVXaXRoKGRvY3VtZW50LCBbalF1ZXJ5XSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LnJlYWR5LnRoZW4gPSByZWFkeUxpc3QudGhlbjsKCiAgLy8gVGhlIHJlYWR5IGV2ZW50IGhhbmRsZXIgYW5kIHNlbGYgY2xlYW51cCBtZXRob2QKICBmdW5jdGlvbiBjb21wbGV0ZWQoKSB7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgY29tcGxldGVkKTsKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJsb2FkIiwgY29tcGxldGVkKTsKICAgIGpRdWVyeS5yZWFkeSgpOwogIH0KCiAgLy8gQ2F0Y2ggY2FzZXMgd2hlcmUgJChkb2N1bWVudCkucmVhZHkoKSBpcyBjYWxsZWQKICAvLyBhZnRlciB0aGUgYnJvd3NlciBldmVudCBoYXMgYWxyZWFkeSBvY2N1cnJlZC4KICAvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMCBvbmx5CiAgLy8gT2xkZXIgSUUgc29tZXRpbWVzIHNpZ25hbHMgImludGVyYWN0aXZlIiB0b28gc29vbgogIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiIHx8IGRvY3VtZW50LnJlYWR5U3RhdGUgIT09ICJsb2FkaW5nIiAmJiAhZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmRvU2Nyb2xsKSB7CiAgICAvLyBIYW5kbGUgaXQgYXN5bmNocm9ub3VzbHkgdG8gYWxsb3cgc2NyaXB0cyB0aGUgb3Bwb3J0dW5pdHkgdG8gZGVsYXkgcmVhZHkKICAgIHdpbmRvdy5zZXRUaW1lb3V0KGpRdWVyeS5yZWFkeSk7CiAgfSBlbHNlIHsKICAgIC8vIFVzZSB0aGUgaGFuZHkgZXZlbnQgY2FsbGJhY2sKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBjb21wbGV0ZWQpOwoKICAgIC8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibG9hZCIsIGNvbXBsZXRlZCk7CiAgfQoKICAvLyBNdWx0aWZ1bmN0aW9uYWwgbWV0aG9kIHRvIGdldCBhbmQgc2V0IHZhbHVlcyBvZiBhIGNvbGxlY3Rpb24KICAvLyBUaGUgdmFsdWUvcyBjYW4gb3B0aW9uYWxseSBiZSBleGVjdXRlZCBpZiBpdCdzIGEgZnVuY3Rpb24KICB2YXIgYWNjZXNzID0gZnVuY3Rpb24gYWNjZXNzKGVsZW1zLCBmbiwga2V5LCB2YWx1ZSwgY2hhaW5hYmxlLCBlbXB0eUdldCwgcmF3KSB7CiAgICB2YXIgaSA9IDAsCiAgICAgIGxlbiA9IGVsZW1zLmxlbmd0aCwKICAgICAgYnVsayA9IGtleSA9PSBudWxsOwoKICAgIC8vIFNldHMgbWFueSB2YWx1ZXMKICAgIGlmICh0b1R5cGUoa2V5KSA9PT0gIm9iamVjdCIpIHsKICAgICAgY2hhaW5hYmxlID0gdHJ1ZTsKICAgICAgZm9yIChpIGluIGtleSkgewogICAgICAgIGFjY2VzcyhlbGVtcywgZm4sIGksIGtleVtpXSwgdHJ1ZSwgZW1wdHlHZXQsIHJhdyk7CiAgICAgIH0KCiAgICAgIC8vIFNldHMgb25lIHZhbHVlCiAgICB9IGVsc2UgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgY2hhaW5hYmxlID0gdHJ1ZTsKICAgICAgaWYgKCFpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHJhdyA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKGJ1bGspIHsKICAgICAgICAvLyBCdWxrIG9wZXJhdGlvbnMgcnVuIGFnYWluc3QgdGhlIGVudGlyZSBzZXQKICAgICAgICBpZiAocmF3KSB7CiAgICAgICAgICBmbi5jYWxsKGVsZW1zLCB2YWx1ZSk7CiAgICAgICAgICBmbiA9IG51bGw7CgogICAgICAgICAgLy8gLi4uZXhjZXB0IHdoZW4gZXhlY3V0aW5nIGZ1bmN0aW9uIHZhbHVlcwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBidWxrID0gZm47CiAgICAgICAgICBmbiA9IGZ1bmN0aW9uIGZuKGVsZW0sIF9rZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBidWxrLmNhbGwoalF1ZXJ5KGVsZW0pLCB2YWx1ZSk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZm4pIHsKICAgICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBmbihlbGVtc1tpXSwga2V5LCByYXcgPyB2YWx1ZSA6IHZhbHVlLmNhbGwoZWxlbXNbaV0sIGksIGZuKGVsZW1zW2ldLCBrZXkpKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAoY2hhaW5hYmxlKSB7CiAgICAgIHJldHVybiBlbGVtczsKICAgIH0KCiAgICAvLyBHZXRzCiAgICBpZiAoYnVsaykgewogICAgICByZXR1cm4gZm4uY2FsbChlbGVtcyk7CiAgICB9CiAgICByZXR1cm4gbGVuID8gZm4oZWxlbXNbMF0sIGtleSkgOiBlbXB0eUdldDsKICB9OwoKICAvLyBNYXRjaGVzIGRhc2hlZCBzdHJpbmcgZm9yIGNhbWVsaXppbmcKICB2YXIgcm1zUHJlZml4ID0gL14tbXMtLywKICAgIHJkYXNoQWxwaGEgPSAvLShbYS16XSkvZzsKCiAgLy8gVXNlZCBieSBjYW1lbENhc2UgYXMgY2FsbGJhY2sgdG8gcmVwbGFjZSgpCiAgZnVuY3Rpb24gZmNhbWVsQ2FzZShfYWxsLCBsZXR0ZXIpIHsKICAgIHJldHVybiBsZXR0ZXIudG9VcHBlckNhc2UoKTsKICB9CgogIC8vIENvbnZlcnQgZGFzaGVkIHRvIGNhbWVsQ2FzZTsgdXNlZCBieSB0aGUgY3NzIGFuZCBkYXRhIG1vZHVsZXMKICAvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSwgRWRnZSAxMiAtIDE1CiAgLy8gTWljcm9zb2Z0IGZvcmdvdCB0byBodW1wIHRoZWlyIHZlbmRvciBwcmVmaXggKCM5NTcyKQogIGZ1bmN0aW9uIGNhbWVsQ2FzZShzdHJpbmcpIHsKICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShybXNQcmVmaXgsICJtcy0iKS5yZXBsYWNlKHJkYXNoQWxwaGEsIGZjYW1lbENhc2UpOwogIH0KICB2YXIgYWNjZXB0RGF0YSA9IGZ1bmN0aW9uIGFjY2VwdERhdGEob3duZXIpIHsKICAgIC8vIEFjY2VwdHMgb25seToKICAgIC8vICAtIE5vZGUKICAgIC8vICAgIC0gTm9kZS5FTEVNRU5UX05PREUKICAgIC8vICAgIC0gTm9kZS5ET0NVTUVOVF9OT0RFCiAgICAvLyAgLSBPYmplY3QKICAgIC8vICAgIC0gQW55CiAgICByZXR1cm4gb3duZXIubm9kZVR5cGUgPT09IDEgfHwgb3duZXIubm9kZVR5cGUgPT09IDkgfHwgIStvd25lci5ub2RlVHlwZTsKICB9OwogIGZ1bmN0aW9uIERhdGEoKSB7CiAgICB0aGlzLmV4cGFuZG8gPSBqUXVlcnkuZXhwYW5kbyArIERhdGEudWlkKys7CiAgfQogIERhdGEudWlkID0gMTsKICBEYXRhLnByb3RvdHlwZSA9IHsKICAgIGNhY2hlOiBmdW5jdGlvbiBjYWNoZShvd25lcikgewogICAgICAvLyBDaGVjayBpZiB0aGUgb3duZXIgb2JqZWN0IGFscmVhZHkgaGFzIGEgY2FjaGUKICAgICAgdmFyIHZhbHVlID0gb3duZXJbdGhpcy5leHBhbmRvXTsKCiAgICAgIC8vIElmIG5vdCwgY3JlYXRlIG9uZQogICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgdmFsdWUgPSB7fTsKCiAgICAgICAgLy8gV2UgY2FuIGFjY2VwdCBkYXRhIGZvciBub24tZWxlbWVudCBub2RlcyBpbiBtb2Rlcm4gYnJvd3NlcnMsCiAgICAgICAgLy8gYnV0IHdlIHNob3VsZCBub3QsIHNlZSAjODMzNS4KICAgICAgICAvLyBBbHdheXMgcmV0dXJuIGFuIGVtcHR5IG9iamVjdC4KICAgICAgICBpZiAoYWNjZXB0RGF0YShvd25lcikpIHsKICAgICAgICAgIC8vIElmIGl0IGlzIGEgbm9kZSB1bmxpa2VseSB0byBiZSBzdHJpbmdpZnktZWQgb3IgbG9vcGVkIG92ZXIKICAgICAgICAgIC8vIHVzZSBwbGFpbiBhc3NpZ25tZW50CiAgICAgICAgICBpZiAob3duZXIubm9kZVR5cGUpIHsKICAgICAgICAgICAgb3duZXJbdGhpcy5leHBhbmRvXSA9IHZhbHVlOwoKICAgICAgICAgICAgLy8gT3RoZXJ3aXNlIHNlY3VyZSBpdCBpbiBhIG5vbi1lbnVtZXJhYmxlIHByb3BlcnR5CiAgICAgICAgICAgIC8vIGNvbmZpZ3VyYWJsZSBtdXN0IGJlIHRydWUgdG8gYWxsb3cgdGhlIHByb3BlcnR5IHRvIGJlCiAgICAgICAgICAgIC8vIGRlbGV0ZWQgd2hlbiBkYXRhIGlzIHJlbW92ZWQKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvd25lciwgdGhpcy5leHBhbmRvLCB7CiAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gc2V0KG93bmVyLCBkYXRhLCB2YWx1ZSkgewogICAgICB2YXIgcHJvcCwKICAgICAgICBjYWNoZSA9IHRoaXMuY2FjaGUob3duZXIpOwoKICAgICAgLy8gSGFuZGxlOiBbIG93bmVyLCBrZXksIHZhbHVlIF0gYXJncwogICAgICAvLyBBbHdheXMgdXNlIGNhbWVsQ2FzZSBrZXkgKGdoLTIyNTcpCiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIpIHsKICAgICAgICBjYWNoZVtjYW1lbENhc2UoZGF0YSldID0gdmFsdWU7CgogICAgICAgIC8vIEhhbmRsZTogWyBvd25lciwgeyBwcm9wZXJ0aWVzIH0gXSBhcmdzCiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQ29weSB0aGUgcHJvcGVydGllcyBvbmUtYnktb25lIHRvIHRoZSBjYWNoZSBvYmplY3QKICAgICAgICBmb3IgKHByb3AgaW4gZGF0YSkgewogICAgICAgICAgY2FjaGVbY2FtZWxDYXNlKHByb3ApXSA9IGRhdGFbcHJvcF07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBjYWNoZTsKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uIGdldChvd25lciwga2V5KSB7CiAgICAgIHJldHVybiBrZXkgPT09IHVuZGVmaW5lZCA/IHRoaXMuY2FjaGUob3duZXIpIDoKICAgICAgLy8gQWx3YXlzIHVzZSBjYW1lbENhc2Uga2V5IChnaC0yMjU3KQogICAgICBvd25lclt0aGlzLmV4cGFuZG9dICYmIG93bmVyW3RoaXMuZXhwYW5kb11bY2FtZWxDYXNlKGtleSldOwogICAgfSwKICAgIGFjY2VzczogZnVuY3Rpb24gYWNjZXNzKG93bmVyLCBrZXksIHZhbHVlKSB7CiAgICAgIC8vIEluIGNhc2VzIHdoZXJlIGVpdGhlcjoKICAgICAgLy8KICAgICAgLy8gICAxLiBObyBrZXkgd2FzIHNwZWNpZmllZAogICAgICAvLyAgIDIuIEEgc3RyaW5nIGtleSB3YXMgc3BlY2lmaWVkLCBidXQgbm8gdmFsdWUgcHJvdmlkZWQKICAgICAgLy8KICAgICAgLy8gVGFrZSB0aGUgInJlYWQiIHBhdGggYW5kIGFsbG93IHRoZSBnZXQgbWV0aG9kIHRvIGRldGVybWluZQogICAgICAvLyB3aGljaCB2YWx1ZSB0byByZXR1cm4sIHJlc3BlY3RpdmVseSBlaXRoZXI6CiAgICAgIC8vCiAgICAgIC8vICAgMS4gVGhlIGVudGlyZSBjYWNoZSBvYmplY3QKICAgICAgLy8gICAyLiBUaGUgZGF0YSBzdG9yZWQgYXQgdGhlIGtleQogICAgICAvLwogICAgICBpZiAoa2V5ID09PSB1bmRlZmluZWQgfHwga2V5ICYmIHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICYmIHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXQob3duZXIsIGtleSk7CiAgICAgIH0KCiAgICAgIC8vIFdoZW4gdGhlIGtleSBpcyBub3QgYSBzdHJpbmcsIG9yIGJvdGggYSBrZXkgYW5kIHZhbHVlCiAgICAgIC8vIGFyZSBzcGVjaWZpZWQsIHNldCBvciBleHRlbmQgKGV4aXN0aW5nIG9iamVjdHMpIHdpdGggZWl0aGVyOgogICAgICAvLwogICAgICAvLyAgIDEuIEFuIG9iamVjdCBvZiBwcm9wZXJ0aWVzCiAgICAgIC8vICAgMi4gQSBrZXkgYW5kIHZhbHVlCiAgICAgIC8vCiAgICAgIHRoaXMuc2V0KG93bmVyLCBrZXksIHZhbHVlKTsKCiAgICAgIC8vIFNpbmNlIHRoZSAic2V0IiBwYXRoIGNhbiBoYXZlIHR3byBwb3NzaWJsZSBlbnRyeSBwb2ludHMKICAgICAgLy8gcmV0dXJuIHRoZSBleHBlY3RlZCBkYXRhIGJhc2VkIG9uIHdoaWNoIHBhdGggd2FzIHRha2VuWypdCiAgICAgIHJldHVybiB2YWx1ZSAhPT0gdW5kZWZpbmVkID8gdmFsdWUgOiBrZXk7CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbiByZW1vdmUob3duZXIsIGtleSkgewogICAgICB2YXIgaSwKICAgICAgICBjYWNoZSA9IG93bmVyW3RoaXMuZXhwYW5kb107CiAgICAgIGlmIChjYWNoZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChrZXkgIT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIFN1cHBvcnQgYXJyYXkgb3Igc3BhY2Ugc2VwYXJhdGVkIHN0cmluZyBvZiBrZXlzCiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoa2V5KSkgewogICAgICAgICAgLy8gSWYga2V5IGlzIGFuIGFycmF5IG9mIGtleXMuLi4KICAgICAgICAgIC8vIFdlIGFsd2F5cyBzZXQgY2FtZWxDYXNlIGtleXMsIHNvIHJlbW92ZSB0aGF0LgogICAgICAgICAga2V5ID0ga2V5Lm1hcChjYW1lbENhc2UpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBrZXkgPSBjYW1lbENhc2Uoa2V5KTsKCiAgICAgICAgICAvLyBJZiBhIGtleSB3aXRoIHRoZSBzcGFjZXMgZXhpc3RzLCB1c2UgaXQuCiAgICAgICAgICAvLyBPdGhlcndpc2UsIGNyZWF0ZSBhbiBhcnJheSBieSBtYXRjaGluZyBub24td2hpdGVzcGFjZQogICAgICAgICAga2V5ID0ga2V5IGluIGNhY2hlID8gW2tleV0gOiBrZXkubWF0Y2gocm5vdGh0bWx3aGl0ZSkgfHwgW107CiAgICAgICAgfQogICAgICAgIGkgPSBrZXkubGVuZ3RoOwogICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgIGRlbGV0ZSBjYWNoZVtrZXlbaV1dOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gUmVtb3ZlIHRoZSBleHBhbmRvIGlmIHRoZXJlJ3Mgbm8gbW9yZSBkYXRhCiAgICAgIGlmIChrZXkgPT09IHVuZGVmaW5lZCB8fCBqUXVlcnkuaXNFbXB0eU9iamVjdChjYWNoZSkpIHsKICAgICAgICAvLyBTdXBwb3J0OiBDaHJvbWUgPD0zNSAtIDQ1CiAgICAgICAgLy8gV2Via2l0ICYgQmxpbmsgcGVyZm9ybWFuY2Ugc3VmZmVycyB3aGVuIGRlbGV0aW5nIHByb3BlcnRpZXMKICAgICAgICAvLyBmcm9tIERPTSBub2Rlcywgc28gc2V0IHRvIHVuZGVmaW5lZCBpbnN0ZWFkCiAgICAgICAgLy8gaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9Mzc4NjA3IChidWcgcmVzdHJpY3RlZCkKICAgICAgICBpZiAob3duZXIubm9kZVR5cGUpIHsKICAgICAgICAgIG93bmVyW3RoaXMuZXhwYW5kb10gPSB1bmRlZmluZWQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlbGV0ZSBvd25lclt0aGlzLmV4cGFuZG9dOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGhhc0RhdGE6IGZ1bmN0aW9uIGhhc0RhdGEob3duZXIpIHsKICAgICAgdmFyIGNhY2hlID0gb3duZXJbdGhpcy5leHBhbmRvXTsKICAgICAgcmV0dXJuIGNhY2hlICE9PSB1bmRlZmluZWQgJiYgIWpRdWVyeS5pc0VtcHR5T2JqZWN0KGNhY2hlKTsKICAgIH0KICB9OwogIHZhciBkYXRhUHJpdiA9IG5ldyBEYXRhKCk7CiAgdmFyIGRhdGFVc2VyID0gbmV3IERhdGEoKTsKCiAgLy8JSW1wbGVtZW50YXRpb24gU3VtbWFyeQogIC8vCiAgLy8JMS4gRW5mb3JjZSBBUEkgc3VyZmFjZSBhbmQgc2VtYW50aWMgY29tcGF0aWJpbGl0eSB3aXRoIDEuOS54IGJyYW5jaAogIC8vCTIuIEltcHJvdmUgdGhlIG1vZHVsZSdzIG1haW50YWluYWJpbGl0eSBieSByZWR1Y2luZyB0aGUgc3RvcmFnZQogIC8vCQlwYXRocyB0byBhIHNpbmdsZSBtZWNoYW5pc20uCiAgLy8JMy4gVXNlIHRoZSBzYW1lIHNpbmdsZSBtZWNoYW5pc20gdG8gc3VwcG9ydCAicHJpdmF0ZSIgYW5kICJ1c2VyIiBkYXRhLgogIC8vCTQuIF9OZXZlcl8gZXhwb3NlICJwcml2YXRlIiBkYXRhIHRvIHVzZXIgY29kZSAoVE9ETzogRHJvcCBfZGF0YSwgX3JlbW92ZURhdGEpCiAgLy8JNS4gQXZvaWQgZXhwb3NpbmcgaW1wbGVtZW50YXRpb24gZGV0YWlscyBvbiB1c2VyIG9iamVjdHMgKGVnLiBleHBhbmRvIHByb3BlcnRpZXMpCiAgLy8JNi4gUHJvdmlkZSBhIGNsZWFyIHBhdGggZm9yIGltcGxlbWVudGF0aW9uIHVwZ3JhZGUgdG8gV2Vha01hcCBpbiAyMDE0CgogIHZhciByYnJhY2UgPSAvXig/Olx7W1x3XFddKlx9fFxbW1x3XFddKlxdKSQvLAogICAgcm11bHRpRGFzaCA9IC9bQS1aXS9nOwogIGZ1bmN0aW9uIGdldERhdGEoZGF0YSkgewogICAgaWYgKGRhdGEgPT09ICJ0cnVlIikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmIChkYXRhID09PSAiZmFsc2UiKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmIChkYXRhID09PSAibnVsbCIpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLy8gT25seSBjb252ZXJ0IHRvIGEgbnVtYmVyIGlmIGl0IGRvZXNuJ3QgY2hhbmdlIHRoZSBzdHJpbmcKICAgIGlmIChkYXRhID09PSArZGF0YSArICIiKSB7CiAgICAgIHJldHVybiArZGF0YTsKICAgIH0KICAgIGlmIChyYnJhY2UudGVzdChkYXRhKSkgewogICAgICByZXR1cm4gSlNPTi5wYXJzZShkYXRhKTsKICAgIH0KICAgIHJldHVybiBkYXRhOwogIH0KICBmdW5jdGlvbiBkYXRhQXR0cihlbGVtLCBrZXksIGRhdGEpIHsKICAgIHZhciBuYW1lOwoKICAgIC8vIElmIG5vdGhpbmcgd2FzIGZvdW5kIGludGVybmFsbHksIHRyeSB0byBmZXRjaCBhbnkKICAgIC8vIGRhdGEgZnJvbSB0aGUgSFRNTDUgZGF0YS0qIGF0dHJpYnV0ZQogICAgaWYgKGRhdGEgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgIG5hbWUgPSAiZGF0YS0iICsga2V5LnJlcGxhY2Uocm11bHRpRGFzaCwgIi0kJiIpLnRvTG93ZXJDYXNlKCk7CiAgICAgIGRhdGEgPSBlbGVtLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAic3RyaW5nIikgewogICAgICAgIHRyeSB7CiAgICAgICAgICBkYXRhID0gZ2V0RGF0YShkYXRhKTsKICAgICAgICB9IGNhdGNoIChlKSB7fQoKICAgICAgICAvLyBNYWtlIHN1cmUgd2Ugc2V0IHRoZSBkYXRhIHNvIGl0IGlzbid0IGNoYW5nZWQgbGF0ZXIKICAgICAgICBkYXRhVXNlci5zZXQoZWxlbSwga2V5LCBkYXRhKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkYXRhID0gdW5kZWZpbmVkOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZGF0YTsKICB9CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICBoYXNEYXRhOiBmdW5jdGlvbiBoYXNEYXRhKGVsZW0pIHsKICAgICAgcmV0dXJuIGRhdGFVc2VyLmhhc0RhdGEoZWxlbSkgfHwgZGF0YVByaXYuaGFzRGF0YShlbGVtKTsKICAgIH0sCiAgICBkYXRhOiBmdW5jdGlvbiBkYXRhKGVsZW0sIG5hbWUsIF9kYXRhKSB7CiAgICAgIHJldHVybiBkYXRhVXNlci5hY2Nlc3MoZWxlbSwgbmFtZSwgX2RhdGEpOwogICAgfSwKICAgIHJlbW92ZURhdGE6IGZ1bmN0aW9uIHJlbW92ZURhdGEoZWxlbSwgbmFtZSkgewogICAgICBkYXRhVXNlci5yZW1vdmUoZWxlbSwgbmFtZSk7CiAgICB9LAogICAgLy8gVE9ETzogTm93IHRoYXQgYWxsIGNhbGxzIHRvIF9kYXRhIGFuZCBfcmVtb3ZlRGF0YSBoYXZlIGJlZW4gcmVwbGFjZWQKICAgIC8vIHdpdGggZGlyZWN0IGNhbGxzIHRvIGRhdGFQcml2IG1ldGhvZHMsIHRoZXNlIGNhbiBiZSBkZXByZWNhdGVkLgogICAgX2RhdGE6IGZ1bmN0aW9uIF9kYXRhKGVsZW0sIG5hbWUsIGRhdGEpIHsKICAgICAgcmV0dXJuIGRhdGFQcml2LmFjY2VzcyhlbGVtLCBuYW1lLCBkYXRhKTsKICAgIH0sCiAgICBfcmVtb3ZlRGF0YTogZnVuY3Rpb24gX3JlbW92ZURhdGEoZWxlbSwgbmFtZSkgewogICAgICBkYXRhUHJpdi5yZW1vdmUoZWxlbSwgbmFtZSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBkYXRhOiBmdW5jdGlvbiBkYXRhKGtleSwgdmFsdWUpIHsKICAgICAgdmFyIGksCiAgICAgICAgbmFtZSwKICAgICAgICBkYXRhLAogICAgICAgIGVsZW0gPSB0aGlzWzBdLAogICAgICAgIGF0dHJzID0gZWxlbSAmJiBlbGVtLmF0dHJpYnV0ZXM7CgogICAgICAvLyBHZXRzIGFsbCB2YWx1ZXMKICAgICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKHRoaXMubGVuZ3RoKSB7CiAgICAgICAgICBkYXRhID0gZGF0YVVzZXIuZ2V0KGVsZW0pOwogICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgIWRhdGFQcml2LmdldChlbGVtLCAiaGFzRGF0YUF0dHJzIikpIHsKICAgICAgICAgICAgaSA9IGF0dHJzLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDExIG9ubHkKICAgICAgICAgICAgICAvLyBUaGUgYXR0cnMgZWxlbWVudHMgY2FuIGJlIG51bGwgKCMxNDg5NCkKICAgICAgICAgICAgICBpZiAoYXR0cnNbaV0pIHsKICAgICAgICAgICAgICAgIG5hbWUgPSBhdHRyc1tpXS5uYW1lOwogICAgICAgICAgICAgICAgaWYgKG5hbWUuaW5kZXhPZigiZGF0YS0iKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICBuYW1lID0gY2FtZWxDYXNlKG5hbWUuc2xpY2UoNSkpOwogICAgICAgICAgICAgICAgICBkYXRhQXR0cihlbGVtLCBuYW1lLCBkYXRhW25hbWVdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGF0YVByaXYuc2V0KGVsZW0sICJoYXNEYXRhQXR0cnMiLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgIH0KCiAgICAgIC8vIFNldHMgbXVsdGlwbGUgdmFsdWVzCiAgICAgIGlmIChfdHlwZW9mKGtleSkgPT09ICJvYmplY3QiKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkYXRhVXNlci5zZXQodGhpcywga2V5KTsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gYWNjZXNzKHRoaXMsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHZhciBkYXRhOwoKICAgICAgICAvLyBUaGUgY2FsbGluZyBqUXVlcnkgb2JqZWN0IChlbGVtZW50IG1hdGNoZXMpIGlzIG5vdCBlbXB0eQogICAgICAgIC8vIChhbmQgdGhlcmVmb3JlIGhhcyBhbiBlbGVtZW50IGFwcGVhcnMgYXQgdGhpc1sgMCBdKSBhbmQgdGhlCiAgICAgICAgLy8gYHZhbHVlYCBwYXJhbWV0ZXIgd2FzIG5vdCB1bmRlZmluZWQuIEFuIGVtcHR5IGpRdWVyeSBvYmplY3QKICAgICAgICAvLyB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBmb3IgZWxlbSA9IHRoaXNbIDAgXSB3aGljaCB3aWxsCiAgICAgICAgLy8gdGhyb3cgYW4gZXhjZXB0aW9uIGlmIGFuIGF0dGVtcHQgdG8gcmVhZCBhIGRhdGEgY2FjaGUgaXMgbWFkZS4KICAgICAgICBpZiAoZWxlbSAmJiB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAvLyBBdHRlbXB0IHRvIGdldCBkYXRhIGZyb20gdGhlIGNhY2hlCiAgICAgICAgICAvLyBUaGUga2V5IHdpbGwgYWx3YXlzIGJlIGNhbWVsQ2FzZWQgaW4gRGF0YQogICAgICAgICAgZGF0YSA9IGRhdGFVc2VyLmdldChlbGVtLCBrZXkpOwogICAgICAgICAgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBBdHRlbXB0IHRvICJkaXNjb3ZlciIgdGhlIGRhdGEgaW4KICAgICAgICAgIC8vIEhUTUw1IGN1c3RvbSBkYXRhLSogYXR0cnMKICAgICAgICAgIGRhdGEgPSBkYXRhQXR0cihlbGVtLCBrZXkpOwogICAgICAgICAgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBXZSB0cmllZCByZWFsbHkgaGFyZCwgYnV0IHRoZSBkYXRhIGRvZXNuJ3QgZXhpc3QuCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBTZXQgdGhlIGRhdGEuLi4KICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgLy8gV2UgYWx3YXlzIHN0b3JlIHRoZSBjYW1lbENhc2VkIGtleQogICAgICAgICAgZGF0YVVzZXIuc2V0KHRoaXMsIGtleSwgdmFsdWUpOwogICAgICAgIH0pOwogICAgICB9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEsIG51bGwsIHRydWUpOwogICAgfSwKICAgIHJlbW92ZURhdGE6IGZ1bmN0aW9uIHJlbW92ZURhdGEoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGRhdGFVc2VyLnJlbW92ZSh0aGlzLCBrZXkpOwogICAgICB9KTsKICAgIH0KICB9KTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIHF1ZXVlOiBmdW5jdGlvbiBxdWV1ZShlbGVtLCB0eXBlLCBkYXRhKSB7CiAgICAgIHZhciBxdWV1ZTsKICAgICAgaWYgKGVsZW0pIHsKICAgICAgICB0eXBlID0gKHR5cGUgfHwgImZ4IikgKyAicXVldWUiOwogICAgICAgIHF1ZXVlID0gZGF0YVByaXYuZ2V0KGVsZW0sIHR5cGUpOwoKICAgICAgICAvLyBTcGVlZCB1cCBkZXF1ZXVlIGJ5IGdldHRpbmcgb3V0IHF1aWNrbHkgaWYgdGhpcyBpcyBqdXN0IGEgbG9va3VwCiAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgIGlmICghcXVldWUgfHwgQXJyYXkuaXNBcnJheShkYXRhKSkgewogICAgICAgICAgICBxdWV1ZSA9IGRhdGFQcml2LmFjY2VzcyhlbGVtLCB0eXBlLCBqUXVlcnkubWFrZUFycmF5KGRhdGEpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHF1ZXVlLnB1c2goZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBxdWV1ZSB8fCBbXTsKICAgICAgfQogICAgfSwKICAgIGRlcXVldWU6IGZ1bmN0aW9uIGRlcXVldWUoZWxlbSwgdHlwZSkgewogICAgICB0eXBlID0gdHlwZSB8fCAiZngiOwogICAgICB2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoZWxlbSwgdHlwZSksCiAgICAgICAgc3RhcnRMZW5ndGggPSBxdWV1ZS5sZW5ndGgsCiAgICAgICAgZm4gPSBxdWV1ZS5zaGlmdCgpLAogICAgICAgIGhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKGVsZW0sIHR5cGUpLAogICAgICAgIG5leHQgPSBmdW5jdGlvbiBuZXh0KCkgewogICAgICAgICAgalF1ZXJ5LmRlcXVldWUoZWxlbSwgdHlwZSk7CiAgICAgICAgfTsKCiAgICAgIC8vIElmIHRoZSBmeCBxdWV1ZSBpcyBkZXF1ZXVlZCwgYWx3YXlzIHJlbW92ZSB0aGUgcHJvZ3Jlc3Mgc2VudGluZWwKICAgICAgaWYgKGZuID09PSAiaW5wcm9ncmVzcyIpIHsKICAgICAgICBmbiA9IHF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgc3RhcnRMZW5ndGgtLTsKICAgICAgfQogICAgICBpZiAoZm4pIHsKICAgICAgICAvLyBBZGQgYSBwcm9ncmVzcyBzZW50aW5lbCB0byBwcmV2ZW50IHRoZSBmeCBxdWV1ZSBmcm9tIGJlaW5nCiAgICAgICAgLy8gYXV0b21hdGljYWxseSBkZXF1ZXVlZAogICAgICAgIGlmICh0eXBlID09PSAiZngiKSB7CiAgICAgICAgICBxdWV1ZS51bnNoaWZ0KCJpbnByb2dyZXNzIik7CiAgICAgICAgfQoKICAgICAgICAvLyBDbGVhciB1cCB0aGUgbGFzdCBxdWV1ZSBzdG9wIGZ1bmN0aW9uCiAgICAgICAgZGVsZXRlIGhvb2tzLnN0b3A7CiAgICAgICAgZm4uY2FsbChlbGVtLCBuZXh0LCBob29rcyk7CiAgICAgIH0KICAgICAgaWYgKCFzdGFydExlbmd0aCAmJiBob29rcykgewogICAgICAgIGhvb2tzLmVtcHR5LmZpcmUoKTsKICAgICAgfQogICAgfSwKICAgIC8vIE5vdCBwdWJsaWMgLSBnZW5lcmF0ZSBhIHF1ZXVlSG9va3Mgb2JqZWN0LCBvciByZXR1cm4gdGhlIGN1cnJlbnQgb25lCiAgICBfcXVldWVIb29rczogZnVuY3Rpb24gX3F1ZXVlSG9va3MoZWxlbSwgdHlwZSkgewogICAgICB2YXIga2V5ID0gdHlwZSArICJxdWV1ZUhvb2tzIjsKICAgICAgcmV0dXJuIGRhdGFQcml2LmdldChlbGVtLCBrZXkpIHx8IGRhdGFQcml2LmFjY2VzcyhlbGVtLCBrZXksIHsKICAgICAgICBlbXB0eTogalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKS5hZGQoZnVuY3Rpb24gKCkgewogICAgICAgICAgZGF0YVByaXYucmVtb3ZlKGVsZW0sIFt0eXBlICsgInF1ZXVlIiwga2V5XSk7CiAgICAgICAgfSkKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBxdWV1ZTogZnVuY3Rpb24gcXVldWUodHlwZSwgZGF0YSkgewogICAgICB2YXIgc2V0dGVyID0gMjsKICAgICAgaWYgKHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIikgewogICAgICAgIGRhdGEgPSB0eXBlOwogICAgICAgIHR5cGUgPSAiZngiOwogICAgICAgIHNldHRlci0tOwogICAgICB9CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgc2V0dGVyKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5xdWV1ZSh0aGlzWzBdLCB0eXBlKTsKICAgICAgfQogICAgICByZXR1cm4gZGF0YSA9PT0gdW5kZWZpbmVkID8gdGhpcyA6IHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHF1ZXVlID0galF1ZXJ5LnF1ZXVlKHRoaXMsIHR5cGUsIGRhdGEpOwoKICAgICAgICAvLyBFbnN1cmUgYSBob29rcyBmb3IgdGhpcyBxdWV1ZQogICAgICAgIGpRdWVyeS5fcXVldWVIb29rcyh0aGlzLCB0eXBlKTsKICAgICAgICBpZiAodHlwZSA9PT0gImZ4IiAmJiBxdWV1ZVswXSAhPT0gImlucHJvZ3Jlc3MiKSB7CiAgICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCB0eXBlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGRlcXVldWU6IGZ1bmN0aW9uIGRlcXVldWUodHlwZSkgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCB0eXBlKTsKICAgICAgfSk7CiAgICB9LAogICAgY2xlYXJRdWV1ZTogZnVuY3Rpb24gY2xlYXJRdWV1ZSh0eXBlKSB7CiAgICAgIHJldHVybiB0aGlzLnF1ZXVlKHR5cGUgfHwgImZ4IiwgW10pOwogICAgfSwKICAgIC8vIEdldCBhIHByb21pc2UgcmVzb2x2ZWQgd2hlbiBxdWV1ZXMgb2YgYSBjZXJ0YWluIHR5cGUKICAgIC8vIGFyZSBlbXB0aWVkIChmeCBpcyB0aGUgdHlwZSBieSBkZWZhdWx0KQogICAgcHJvbWlzZTogZnVuY3Rpb24gcHJvbWlzZSh0eXBlLCBvYmopIHsKICAgICAgdmFyIHRtcCwKICAgICAgICBjb3VudCA9IDEsCiAgICAgICAgZGVmZXIgPSBqUXVlcnkuRGVmZXJyZWQoKSwKICAgICAgICBlbGVtZW50cyA9IHRoaXMsCiAgICAgICAgaSA9IHRoaXMubGVuZ3RoLAogICAgICAgIHJlc29sdmUgPSBmdW5jdGlvbiByZXNvbHZlKCkgewogICAgICAgICAgaWYgKCEgLS1jb3VudCkgewogICAgICAgICAgICBkZWZlci5yZXNvbHZlV2l0aChlbGVtZW50cywgW2VsZW1lbnRzXSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgaWYgKHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIikgewogICAgICAgIG9iaiA9IHR5cGU7CiAgICAgICAgdHlwZSA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICB0eXBlID0gdHlwZSB8fCAiZngiOwogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgdG1wID0gZGF0YVByaXYuZ2V0KGVsZW1lbnRzW2ldLCB0eXBlICsgInF1ZXVlSG9va3MiKTsKICAgICAgICBpZiAodG1wICYmIHRtcC5lbXB0eSkgewogICAgICAgICAgY291bnQrKzsKICAgICAgICAgIHRtcC5lbXB0eS5hZGQocmVzb2x2ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJlc29sdmUoKTsKICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2Uob2JqKTsKICAgIH0KICB9KTsKICB2YXIgcG51bSA9IC9bKy1dPyg/OlxkKlwufClcZCsoPzpbZUVdWystXT9cZCt8KS8uc291cmNlOwogIHZhciByY3NzTnVtID0gbmV3IFJlZ0V4cCgiXig/OihbKy1dKT18KSgiICsgcG51bSArICIpKFthLXolXSopJCIsICJpIik7CiAgdmFyIGNzc0V4cGFuZCA9IFsiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0Il07CiAgdmFyIGRvY3VtZW50RWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICB2YXIgaXNBdHRhY2hlZCA9IGZ1bmN0aW9uIGlzQXR0YWNoZWQoZWxlbSkgewogICAgICByZXR1cm4galF1ZXJ5LmNvbnRhaW5zKGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSk7CiAgICB9LAogICAgY29tcG9zZWQgPSB7CiAgICAgIGNvbXBvc2VkOiB0cnVlCiAgICB9OwoKICAvLyBTdXBwb3J0OiBJRSA5IC0gMTErLCBFZGdlIDEyIC0gMTgrLCBpT1MgMTAuMCAtIDEwLjIgb25seQogIC8vIENoZWNrIGF0dGFjaG1lbnQgYWNyb3NzIHNoYWRvdyBET00gYm91bmRhcmllcyB3aGVuIHBvc3NpYmxlIChnaC0zNTA0KQogIC8vIFN1cHBvcnQ6IGlPUyAxMC4wLTEwLjIgb25seQogIC8vIEVhcmx5IGlPUyAxMCB2ZXJzaW9ucyBzdXBwb3J0IGBhdHRhY2hTaGFkb3dgIGJ1dCBub3QgYGdldFJvb3ROb2RlYCwKICAvLyBsZWFkaW5nIHRvIGVycm9ycy4gV2UgbmVlZCB0byBjaGVjayBmb3IgYGdldFJvb3ROb2RlYC4KICBpZiAoZG9jdW1lbnRFbGVtZW50LmdldFJvb3ROb2RlKSB7CiAgICBpc0F0dGFjaGVkID0gZnVuY3Rpb24gaXNBdHRhY2hlZChlbGVtKSB7CiAgICAgIHJldHVybiBqUXVlcnkuY29udGFpbnMoZWxlbS5vd25lckRvY3VtZW50LCBlbGVtKSB8fCBlbGVtLmdldFJvb3ROb2RlKGNvbXBvc2VkKSA9PT0gZWxlbS5vd25lckRvY3VtZW50OwogICAgfTsKICB9CiAgdmFyIGlzSGlkZGVuV2l0aGluVHJlZSA9IGZ1bmN0aW9uIGlzSGlkZGVuV2l0aGluVHJlZShlbGVtLCBlbCkgewogICAgLy8gaXNIaWRkZW5XaXRoaW5UcmVlIG1pZ2h0IGJlIGNhbGxlZCBmcm9tIGpRdWVyeSNmaWx0ZXIgZnVuY3Rpb247CiAgICAvLyBpbiB0aGF0IGNhc2UsIGVsZW1lbnQgd2lsbCBiZSBzZWNvbmQgYXJndW1lbnQKICAgIGVsZW0gPSBlbCB8fCBlbGVtOwoKICAgIC8vIElubGluZSBzdHlsZSB0cnVtcHMgYWxsCiAgICByZXR1cm4gZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAibm9uZSIgfHwgZWxlbS5zdHlsZS5kaXNwbGF5ID09PSAiIiAmJgogICAgLy8gT3RoZXJ3aXNlLCBjaGVjayBjb21wdXRlZCBzdHlsZQogICAgLy8gU3VwcG9ydDogRmlyZWZveCA8PTQzIC0gNDUKICAgIC8vIERpc2Nvbm5lY3RlZCBlbGVtZW50cyBjYW4gaGF2ZSBjb21wdXRlZCBkaXNwbGF5OiBub25lLCBzbyBmaXJzdCBjb25maXJtIHRoYXQgZWxlbSBpcwogICAgLy8gaW4gdGhlIGRvY3VtZW50LgogICAgaXNBdHRhY2hlZChlbGVtKSAmJiBqUXVlcnkuY3NzKGVsZW0sICJkaXNwbGF5IikgPT09ICJub25lIjsKICB9OwogIGZ1bmN0aW9uIGFkanVzdENTUyhlbGVtLCBwcm9wLCB2YWx1ZVBhcnRzLCB0d2VlbikgewogICAgdmFyIGFkanVzdGVkLAogICAgICBzY2FsZSwKICAgICAgbWF4SXRlcmF0aW9ucyA9IDIwLAogICAgICBjdXJyZW50VmFsdWUgPSB0d2VlbiA/IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdHdlZW4uY3VyKCk7CiAgICAgIH0gOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5jc3MoZWxlbSwgcHJvcCwgIiIpOwogICAgICB9LAogICAgICBpbml0aWFsID0gY3VycmVudFZhbHVlKCksCiAgICAgIHVuaXQgPSB2YWx1ZVBhcnRzICYmIHZhbHVlUGFydHNbM10gfHwgKGpRdWVyeS5jc3NOdW1iZXJbcHJvcF0gPyAiIiA6ICJweCIpLAogICAgICAvLyBTdGFydGluZyB2YWx1ZSBjb21wdXRhdGlvbiBpcyByZXF1aXJlZCBmb3IgcG90ZW50aWFsIHVuaXQgbWlzbWF0Y2hlcwogICAgICBpbml0aWFsSW5Vbml0ID0gZWxlbS5ub2RlVHlwZSAmJiAoalF1ZXJ5LmNzc051bWJlcltwcm9wXSB8fCB1bml0ICE9PSAicHgiICYmICtpbml0aWFsKSAmJiByY3NzTnVtLmV4ZWMoalF1ZXJ5LmNzcyhlbGVtLCBwcm9wKSk7CiAgICBpZiAoaW5pdGlhbEluVW5pdCAmJiBpbml0aWFsSW5Vbml0WzNdICE9PSB1bml0KSB7CiAgICAgIC8vIFN1cHBvcnQ6IEZpcmVmb3ggPD01NAogICAgICAvLyBIYWx2ZSB0aGUgaXRlcmF0aW9uIHRhcmdldCB2YWx1ZSB0byBwcmV2ZW50IGludGVyZmVyZW5jZSBmcm9tIENTUyB1cHBlciBib3VuZHMgKGdoLTIxNDQpCiAgICAgIGluaXRpYWwgPSBpbml0aWFsIC8gMjsKCiAgICAgIC8vIFRydXN0IHVuaXRzIHJlcG9ydGVkIGJ5IGpRdWVyeS5jc3MKICAgICAgdW5pdCA9IHVuaXQgfHwgaW5pdGlhbEluVW5pdFszXTsKCiAgICAgIC8vIEl0ZXJhdGl2ZWx5IGFwcHJveGltYXRlIGZyb20gYSBub256ZXJvIHN0YXJ0aW5nIHBvaW50CiAgICAgIGluaXRpYWxJblVuaXQgPSAraW5pdGlhbCB8fCAxOwogICAgICB3aGlsZSAobWF4SXRlcmF0aW9ucy0tKSB7CiAgICAgICAgLy8gRXZhbHVhdGUgYW5kIHVwZGF0ZSBvdXIgYmVzdCBndWVzcyAoZG91YmxpbmcgZ3Vlc3NlcyB0aGF0IHplcm8gb3V0KS4KICAgICAgICAvLyBGaW5pc2ggaWYgdGhlIHNjYWxlIGVxdWFscyBvciBjcm9zc2VzIDEgKG1ha2luZyB0aGUgb2xkKm5ldyBwcm9kdWN0IG5vbi1wb3NpdGl2ZSkuCiAgICAgICAgalF1ZXJ5LnN0eWxlKGVsZW0sIHByb3AsIGluaXRpYWxJblVuaXQgKyB1bml0KTsKICAgICAgICBpZiAoKDEgLSBzY2FsZSkgKiAoMSAtIChzY2FsZSA9IGN1cnJlbnRWYWx1ZSgpIC8gaW5pdGlhbCB8fCAwLjUpKSA8PSAwKSB7CiAgICAgICAgICBtYXhJdGVyYXRpb25zID0gMDsKICAgICAgICB9CiAgICAgICAgaW5pdGlhbEluVW5pdCA9IGluaXRpYWxJblVuaXQgLyBzY2FsZTsKICAgICAgfQogICAgICBpbml0aWFsSW5Vbml0ID0gaW5pdGlhbEluVW5pdCAqIDI7CiAgICAgIGpRdWVyeS5zdHlsZShlbGVtLCBwcm9wLCBpbml0aWFsSW5Vbml0ICsgdW5pdCk7CgogICAgICAvLyBNYWtlIHN1cmUgd2UgdXBkYXRlIHRoZSB0d2VlbiBwcm9wZXJ0aWVzIGxhdGVyIG9uCiAgICAgIHZhbHVlUGFydHMgPSB2YWx1ZVBhcnRzIHx8IFtdOwogICAgfQogICAgaWYgKHZhbHVlUGFydHMpIHsKICAgICAgaW5pdGlhbEluVW5pdCA9ICtpbml0aWFsSW5Vbml0IHx8ICtpbml0aWFsIHx8IDA7CgogICAgICAvLyBBcHBseSByZWxhdGl2ZSBvZmZzZXQgKCs9Ly09KSBpZiBzcGVjaWZpZWQKICAgICAgYWRqdXN0ZWQgPSB2YWx1ZVBhcnRzWzFdID8gaW5pdGlhbEluVW5pdCArICh2YWx1ZVBhcnRzWzFdICsgMSkgKiB2YWx1ZVBhcnRzWzJdIDogK3ZhbHVlUGFydHNbMl07CiAgICAgIGlmICh0d2VlbikgewogICAgICAgIHR3ZWVuLnVuaXQgPSB1bml0OwogICAgICAgIHR3ZWVuLnN0YXJ0ID0gaW5pdGlhbEluVW5pdDsKICAgICAgICB0d2Vlbi5lbmQgPSBhZGp1c3RlZDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGFkanVzdGVkOwogIH0KICB2YXIgZGVmYXVsdERpc3BsYXlNYXAgPSB7fTsKICBmdW5jdGlvbiBnZXREZWZhdWx0RGlzcGxheShlbGVtKSB7CiAgICB2YXIgdGVtcCwKICAgICAgZG9jID0gZWxlbS5vd25lckRvY3VtZW50LAogICAgICBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWUsCiAgICAgIGRpc3BsYXkgPSBkZWZhdWx0RGlzcGxheU1hcFtub2RlTmFtZV07CiAgICBpZiAoZGlzcGxheSkgewogICAgICByZXR1cm4gZGlzcGxheTsKICAgIH0KICAgIHRlbXAgPSBkb2MuYm9keS5hcHBlbmRDaGlsZChkb2MuY3JlYXRlRWxlbWVudChub2RlTmFtZSkpOwogICAgZGlzcGxheSA9IGpRdWVyeS5jc3ModGVtcCwgImRpc3BsYXkiKTsKICAgIHRlbXAucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0ZW1wKTsKICAgIGlmIChkaXNwbGF5ID09PSAibm9uZSIpIHsKICAgICAgZGlzcGxheSA9ICJibG9jayI7CiAgICB9CiAgICBkZWZhdWx0RGlzcGxheU1hcFtub2RlTmFtZV0gPSBkaXNwbGF5OwogICAgcmV0dXJuIGRpc3BsYXk7CiAgfQogIGZ1bmN0aW9uIHNob3dIaWRlKGVsZW1lbnRzLCBzaG93KSB7CiAgICB2YXIgZGlzcGxheSwKICAgICAgZWxlbSwKICAgICAgdmFsdWVzID0gW10sCiAgICAgIGluZGV4ID0gMCwKICAgICAgbGVuZ3RoID0gZWxlbWVudHMubGVuZ3RoOwoKICAgIC8vIERldGVybWluZSBuZXcgZGlzcGxheSB2YWx1ZSBmb3IgZWxlbWVudHMgdGhhdCBuZWVkIHRvIGNoYW5nZQogICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIGVsZW0gPSBlbGVtZW50c1tpbmRleF07CiAgICAgIGlmICghZWxlbS5zdHlsZSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGRpc3BsYXkgPSBlbGVtLnN0eWxlLmRpc3BsYXk7CiAgICAgIGlmIChzaG93KSB7CiAgICAgICAgLy8gU2luY2Ugd2UgZm9yY2UgdmlzaWJpbGl0eSB1cG9uIGNhc2NhZGUtaGlkZGVuIGVsZW1lbnRzLCBhbiBpbW1lZGlhdGUgKGFuZCBzbG93KQogICAgICAgIC8vIGNoZWNrIGlzIHJlcXVpcmVkIGluIHRoaXMgZmlyc3QgbG9vcCB1bmxlc3Mgd2UgaGF2ZSBhIG5vbmVtcHR5IGRpc3BsYXkgdmFsdWUgKGVpdGhlcgogICAgICAgIC8vIGlubGluZSBvciBhYm91dC10by1iZS1yZXN0b3JlZCkKICAgICAgICBpZiAoZGlzcGxheSA9PT0gIm5vbmUiKSB7CiAgICAgICAgICB2YWx1ZXNbaW5kZXhdID0gZGF0YVByaXYuZ2V0KGVsZW0sICJkaXNwbGF5IikgfHwgbnVsbDsKICAgICAgICAgIGlmICghdmFsdWVzW2luZGV4XSkgewogICAgICAgICAgICBlbGVtLnN0eWxlLmRpc3BsYXkgPSAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIiIgJiYgaXNIaWRkZW5XaXRoaW5UcmVlKGVsZW0pKSB7CiAgICAgICAgICB2YWx1ZXNbaW5kZXhdID0gZ2V0RGVmYXVsdERpc3BsYXkoZWxlbSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChkaXNwbGF5ICE9PSAibm9uZSIpIHsKICAgICAgICAgIHZhbHVlc1tpbmRleF0gPSAibm9uZSI7CgogICAgICAgICAgLy8gUmVtZW1iZXIgd2hhdCB3ZSdyZSBvdmVyd3JpdGluZwogICAgICAgICAgZGF0YVByaXYuc2V0KGVsZW0sICJkaXNwbGF5IiwgZGlzcGxheSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gU2V0IHRoZSBkaXNwbGF5IG9mIHRoZSBlbGVtZW50cyBpbiBhIHNlY29uZCBsb29wIHRvIGF2b2lkIGNvbnN0YW50IHJlZmxvdwogICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIGlmICh2YWx1ZXNbaW5kZXhdICE9IG51bGwpIHsKICAgICAgICBlbGVtZW50c1tpbmRleF0uc3R5bGUuZGlzcGxheSA9IHZhbHVlc1tpbmRleF07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBlbGVtZW50czsKICB9CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBzaG93OiBmdW5jdGlvbiBzaG93KCkgewogICAgICByZXR1cm4gc2hvd0hpZGUodGhpcywgdHJ1ZSk7CiAgICB9LAogICAgaGlkZTogZnVuY3Rpb24gaGlkZSgpIHsKICAgICAgcmV0dXJuIHNob3dIaWRlKHRoaXMpOwogICAgfSwKICAgIHRvZ2dsZTogZnVuY3Rpb24gdG9nZ2xlKHN0YXRlKSB7CiAgICAgIGlmICh0eXBlb2Ygc3RhdGUgPT09ICJib29sZWFuIikgewogICAgICAgIHJldHVybiBzdGF0ZSA/IHRoaXMuc2hvdygpIDogdGhpcy5oaWRlKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGlzSGlkZGVuV2l0aGluVHJlZSh0aGlzKSkgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLnNob3coKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLmhpZGUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0pOwogIHZhciByY2hlY2thYmxlVHlwZSA9IC9eKD86Y2hlY2tib3h8cmFkaW8pJC9pOwogIHZhciBydGFnTmFtZSA9IC88KFthLXpdW15cL1wwPlx4MjBcdFxyXG5cZl0qKS9pOwogIHZhciByc2NyaXB0VHlwZSA9IC9eJHxebW9kdWxlJHxcLyg/OmphdmF8ZWNtYSlzY3JpcHQvaTsKICAoZnVuY3Rpb24gKCkgewogICAgdmFyIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICBkaXYgPSBmcmFnbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSksCiAgICAgIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKCiAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDQuMCAtIDQuMyBvbmx5CiAgICAvLyBDaGVjayBzdGF0ZSBsb3N0IGlmIHRoZSBuYW1lIGlzIHNldCAoIzExMjE3KQogICAgLy8gU3VwcG9ydDogV2luZG93cyBXZWIgQXBwcyAoV1dBKQogICAgLy8gYG5hbWVgIGFuZCBgdHlwZWAgbXVzdCB1c2UgLnNldEF0dHJpYnV0ZSBmb3IgV1dBICgjMTQ5MDEpCiAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoInR5cGUiLCAicmFkaW8iKTsKICAgIGlucHV0LnNldEF0dHJpYnV0ZSgiY2hlY2tlZCIsICJjaGVja2VkIik7CiAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoIm5hbWUiLCAidCIpOwogICAgZGl2LmFwcGVuZENoaWxkKGlucHV0KTsKCiAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4xIG9ubHkKICAgIC8vIE9sZGVyIFdlYktpdCBkb2Vzbid0IGNsb25lIGNoZWNrZWQgc3RhdGUgY29ycmVjdGx5IGluIGZyYWdtZW50cwogICAgc3VwcG9ydC5jaGVja0Nsb25lID0gZGl2LmNsb25lTm9kZSh0cnVlKS5jbG9uZU5vZGUodHJ1ZSkubGFzdENoaWxkLmNoZWNrZWQ7CgogICAgLy8gU3VwcG9ydDogSUUgPD0xMSBvbmx5CiAgICAvLyBNYWtlIHN1cmUgdGV4dGFyZWEgKGFuZCBjaGVja2JveCkgZGVmYXVsdFZhbHVlIGlzIHByb3Blcmx5IGNsb25lZAogICAgZGl2LmlubmVySFRNTCA9ICI8dGV4dGFyZWE+eDwvdGV4dGFyZWE+IjsKICAgIHN1cHBvcnQubm9DbG9uZUNoZWNrZWQgPSAhIWRpdi5jbG9uZU5vZGUodHJ1ZSkubGFzdENoaWxkLmRlZmF1bHRWYWx1ZTsKCiAgICAvLyBTdXBwb3J0OiBJRSA8PTkgb25seQogICAgLy8gSUUgPD05IHJlcGxhY2VzIDxvcHRpb24+IHRhZ3Mgd2l0aCB0aGVpciBjb250ZW50cyB3aGVuIGluc2VydGVkIG91dHNpZGUgb2YKICAgIC8vIHRoZSBzZWxlY3QgZWxlbWVudC4KICAgIGRpdi5pbm5lckhUTUwgPSAiPG9wdGlvbj48L29wdGlvbj4iOwogICAgc3VwcG9ydC5vcHRpb24gPSAhIWRpdi5sYXN0Q2hpbGQ7CiAgfSkoKTsKCiAgLy8gV2UgaGF2ZSB0byBjbG9zZSB0aGVzZSB0YWdzIHRvIHN1cHBvcnQgWEhUTUwgKCMxMzIwMCkKICB2YXIgd3JhcE1hcCA9IHsKICAgIC8vIFhIVE1MIHBhcnNlcnMgZG8gbm90IG1hZ2ljYWxseSBpbnNlcnQgZWxlbWVudHMgaW4gdGhlCiAgICAvLyBzYW1lIHdheSB0aGF0IHRhZyBzb3VwIHBhcnNlcnMgZG8uIFNvIHdlIGNhbm5vdCBzaG9ydGVuCiAgICAvLyB0aGlzIGJ5IG9taXR0aW5nIDx0Ym9keT4gb3Igb3RoZXIgcmVxdWlyZWQgZWxlbWVudHMuCiAgICB0aGVhZDogWzEsICI8dGFibGU+IiwgIjwvdGFibGU+Il0sCiAgICBjb2w6IFsyLCAiPHRhYmxlPjxjb2xncm91cD4iLCAiPC9jb2xncm91cD48L3RhYmxlPiJdLAogICAgdHI6IFsyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiJdLAogICAgdGQ6IFszLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiJdLAogICAgX2RlZmF1bHQ6IFswLCAiIiwgIiJdCiAgfTsKICB3cmFwTWFwLnRib2R5ID0gd3JhcE1hcC50Zm9vdCA9IHdyYXBNYXAuY29sZ3JvdXAgPSB3cmFwTWFwLmNhcHRpb24gPSB3cmFwTWFwLnRoZWFkOwogIHdyYXBNYXAudGggPSB3cmFwTWFwLnRkOwoKICAvLyBTdXBwb3J0OiBJRSA8PTkgb25seQogIGlmICghc3VwcG9ydC5vcHRpb24pIHsKICAgIHdyYXBNYXAub3B0Z3JvdXAgPSB3cmFwTWFwLm9wdGlvbiA9IFsxLCAiPHNlbGVjdCBtdWx0aXBsZT0nbXVsdGlwbGUnPiIsICI8L3NlbGVjdD4iXTsKICB9CiAgZnVuY3Rpb24gZ2V0QWxsKGNvbnRleHQsIHRhZykgewogICAgLy8gU3VwcG9ydDogSUUgPD05IC0gMTEgb25seQogICAgLy8gVXNlIHR5cGVvZiB0byBhdm9pZCB6ZXJvLWFyZ3VtZW50IG1ldGhvZCBpbnZvY2F0aW9uIG9uIGhvc3Qgb2JqZWN0cyAoIzE1MTUxKQogICAgdmFyIHJldDsKICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgcmV0ID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcgfHwgIioiKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgcmV0ID0gY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKHRhZyB8fCAiKiIpOwogICAgfSBlbHNlIHsKICAgICAgcmV0ID0gW107CiAgICB9CiAgICBpZiAodGFnID09PSB1bmRlZmluZWQgfHwgdGFnICYmIG5vZGVOYW1lKGNvbnRleHQsIHRhZykpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5tZXJnZShbY29udGV4dF0sIHJldCk7CiAgICB9CiAgICByZXR1cm4gcmV0OwogIH0KCiAgLy8gTWFyayBzY3JpcHRzIGFzIGhhdmluZyBhbHJlYWR5IGJlZW4gZXZhbHVhdGVkCiAgZnVuY3Rpb24gc2V0R2xvYmFsRXZhbChlbGVtcywgcmVmRWxlbWVudHMpIHsKICAgIHZhciBpID0gMCwKICAgICAgbCA9IGVsZW1zLmxlbmd0aDsKICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGRhdGFQcml2LnNldChlbGVtc1tpXSwgImdsb2JhbEV2YWwiLCAhcmVmRWxlbWVudHMgfHwgZGF0YVByaXYuZ2V0KHJlZkVsZW1lbnRzW2ldLCAiZ2xvYmFsRXZhbCIpKTsKICAgIH0KICB9CiAgdmFyIHJodG1sID0gLzx8JiM/XHcrOy87CiAgZnVuY3Rpb24gYnVpbGRGcmFnbWVudChlbGVtcywgY29udGV4dCwgc2NyaXB0cywgc2VsZWN0aW9uLCBpZ25vcmVkKSB7CiAgICB2YXIgZWxlbSwKICAgICAgdG1wLAogICAgICB0YWcsCiAgICAgIHdyYXAsCiAgICAgIGF0dGFjaGVkLAogICAgICBqLAogICAgICBmcmFnbWVudCA9IGNvbnRleHQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICBub2RlcyA9IFtdLAogICAgICBpID0gMCwKICAgICAgbCA9IGVsZW1zLmxlbmd0aDsKICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGVsZW0gPSBlbGVtc1tpXTsKICAgICAgaWYgKGVsZW0gfHwgZWxlbSA9PT0gMCkgewogICAgICAgIC8vIEFkZCBub2RlcyBkaXJlY3RseQogICAgICAgIGlmICh0b1R5cGUoZWxlbSkgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wIG9ubHksIFBoYW50b21KUyAxIG9ubHkKICAgICAgICAgIC8vIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3Mgb24gYW5jaWVudCBXZWJLaXQKICAgICAgICAgIGpRdWVyeS5tZXJnZShub2RlcywgZWxlbS5ub2RlVHlwZSA/IFtlbGVtXSA6IGVsZW0pOwoKICAgICAgICAgIC8vIENvbnZlcnQgbm9uLWh0bWwgaW50byBhIHRleHQgbm9kZQogICAgICAgIH0gZWxzZSBpZiAoIXJodG1sLnRlc3QoZWxlbSkpIHsKICAgICAgICAgIG5vZGVzLnB1c2goY29udGV4dC5jcmVhdGVUZXh0Tm9kZShlbGVtKSk7CgogICAgICAgICAgLy8gQ29udmVydCBodG1sIGludG8gRE9NIG5vZGVzCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRtcCA9IHRtcCB8fCBmcmFnbWVudC5hcHBlbmRDaGlsZChjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImRpdiIpKTsKCiAgICAgICAgICAvLyBEZXNlcmlhbGl6ZSBhIHN0YW5kYXJkIHJlcHJlc2VudGF0aW9uCiAgICAgICAgICB0YWcgPSAocnRhZ05hbWUuZXhlYyhlbGVtKSB8fCBbIiIsICIiXSlbMV0udG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHdyYXAgPSB3cmFwTWFwW3RhZ10gfHwgd3JhcE1hcC5fZGVmYXVsdDsKICAgICAgICAgIHRtcC5pbm5lckhUTUwgPSB3cmFwWzFdICsgalF1ZXJ5Lmh0bWxQcmVmaWx0ZXIoZWxlbSkgKyB3cmFwWzJdOwoKICAgICAgICAgIC8vIERlc2NlbmQgdGhyb3VnaCB3cmFwcGVycyB0byB0aGUgcmlnaHQgY29udGVudAogICAgICAgICAgaiA9IHdyYXBbMF07CiAgICAgICAgICB3aGlsZSAoai0tKSB7CiAgICAgICAgICAgIHRtcCA9IHRtcC5sYXN0Q2hpbGQ7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMCBvbmx5LCBQaGFudG9tSlMgMSBvbmx5CiAgICAgICAgICAvLyBwdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzIG9uIGFuY2llbnQgV2ViS2l0CiAgICAgICAgICBqUXVlcnkubWVyZ2Uobm9kZXMsIHRtcC5jaGlsZE5vZGVzKTsKCiAgICAgICAgICAvLyBSZW1lbWJlciB0aGUgdG9wLWxldmVsIGNvbnRhaW5lcgogICAgICAgICAgdG1wID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKCiAgICAgICAgICAvLyBFbnN1cmUgdGhlIGNyZWF0ZWQgbm9kZXMgYXJlIG9ycGhhbmVkICgjMTIzOTIpCiAgICAgICAgICB0bXAudGV4dENvbnRlbnQgPSAiIjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBSZW1vdmUgd3JhcHBlciBmcm9tIGZyYWdtZW50CiAgICBmcmFnbWVudC50ZXh0Q29udGVudCA9ICIiOwogICAgaSA9IDA7CiAgICB3aGlsZSAoZWxlbSA9IG5vZGVzW2krK10pIHsKICAgICAgLy8gU2tpcCBlbGVtZW50cyBhbHJlYWR5IGluIHRoZSBjb250ZXh0IGNvbGxlY3Rpb24gKHRyYWMtNDA4NykKICAgICAgaWYgKHNlbGVjdGlvbiAmJiBqUXVlcnkuaW5BcnJheShlbGVtLCBzZWxlY3Rpb24pID4gLTEpIHsKICAgICAgICBpZiAoaWdub3JlZCkgewogICAgICAgICAgaWdub3JlZC5wdXNoKGVsZW0pOwogICAgICAgIH0KICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBhdHRhY2hlZCA9IGlzQXR0YWNoZWQoZWxlbSk7CgogICAgICAvLyBBcHBlbmQgdG8gZnJhZ21lbnQKICAgICAgdG1wID0gZ2V0QWxsKGZyYWdtZW50LmFwcGVuZENoaWxkKGVsZW0pLCAic2NyaXB0Iik7CgogICAgICAvLyBQcmVzZXJ2ZSBzY3JpcHQgZXZhbHVhdGlvbiBoaXN0b3J5CiAgICAgIGlmIChhdHRhY2hlZCkgewogICAgICAgIHNldEdsb2JhbEV2YWwodG1wKTsKICAgICAgfQoKICAgICAgLy8gQ2FwdHVyZSBleGVjdXRhYmxlcwogICAgICBpZiAoc2NyaXB0cykgewogICAgICAgIGogPSAwOwogICAgICAgIHdoaWxlIChlbGVtID0gdG1wW2orK10pIHsKICAgICAgICAgIGlmIChyc2NyaXB0VHlwZS50ZXN0KGVsZW0udHlwZSB8fCAiIikpIHsKICAgICAgICAgICAgc2NyaXB0cy5wdXNoKGVsZW0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGZyYWdtZW50OwogIH0KICB2YXIgcmtleUV2ZW50ID0gL15rZXkvLAogICAgcm1vdXNlRXZlbnQgPSAvXig/Om1vdXNlfHBvaW50ZXJ8Y29udGV4dG1lbnV8ZHJhZ3xkcm9wKXxjbGljay8sCiAgICBydHlwZW5hbWVzcGFjZSA9IC9eKFteLl0qKSg/OlwuKC4rKXwpLzsKICBmdW5jdGlvbiByZXR1cm5UcnVlKCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGZ1bmN0aW9uIHJldHVybkZhbHNlKCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgLy8gU3VwcG9ydDogSUUgPD05IC0gMTErCiAgLy8gZm9jdXMoKSBhbmQgYmx1cigpIGFyZSBhc3luY2hyb25vdXMsIGV4Y2VwdCB3aGVuIHRoZXkgYXJlIG5vLW9wLgogIC8vIFNvIGV4cGVjdCBmb2N1cyB0byBiZSBzeW5jaHJvbm91cyB3aGVuIHRoZSBlbGVtZW50IGlzIGFscmVhZHkgYWN0aXZlLAogIC8vIGFuZCBibHVyIHRvIGJlIHN5bmNocm9ub3VzIHdoZW4gdGhlIGVsZW1lbnQgaXMgbm90IGFscmVhZHkgYWN0aXZlLgogIC8vIChmb2N1cyBhbmQgYmx1ciBhcmUgYWx3YXlzIHN5bmNocm9ub3VzIGluIG90aGVyIHN1cHBvcnRlZCBicm93c2VycywKICAvLyB0aGlzIGp1c3QgZGVmaW5lcyB3aGVuIHdlIGNhbiBjb3VudCBvbiBpdCkuCiAgZnVuY3Rpb24gZXhwZWN0U3luYyhlbGVtLCB0eXBlKSB7CiAgICByZXR1cm4gZWxlbSA9PT0gc2FmZUFjdGl2ZUVsZW1lbnQoKSA9PT0gKHR5cGUgPT09ICJmb2N1cyIpOwogIH0KCiAgLy8gU3VwcG9ydDogSUUgPD05IG9ubHkKICAvLyBBY2Nlc3NpbmcgZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBjYW4gdGhyb3cgdW5leHBlY3RlZGx5CiAgLy8gaHR0cHM6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEzMzkzCiAgZnVuY3Rpb24gc2FmZUFjdGl2ZUVsZW1lbnQoKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKICAgIH0gY2F0Y2ggKGVycikge30KICB9CiAgZnVuY3Rpb24gX29uKGVsZW0sIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIG9uZSkgewogICAgdmFyIG9yaWdGbiwgdHlwZTsKCiAgICAvLyBUeXBlcyBjYW4gYmUgYSBtYXAgb2YgdHlwZXMvaGFuZGxlcnMKICAgIGlmIChfdHlwZW9mKHR5cGVzKSA9PT0gIm9iamVjdCIpIHsKICAgICAgLy8gKCB0eXBlcy1PYmplY3QsIHNlbGVjdG9yLCBkYXRhICkKICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIpIHsKICAgICAgICAvLyAoIHR5cGVzLU9iamVjdCwgZGF0YSApCiAgICAgICAgZGF0YSA9IGRhdGEgfHwgc2VsZWN0b3I7CiAgICAgICAgc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgZm9yICh0eXBlIGluIHR5cGVzKSB7CiAgICAgICAgX29uKGVsZW0sIHR5cGUsIHNlbGVjdG9yLCBkYXRhLCB0eXBlc1t0eXBlXSwgb25lKTsKICAgICAgfQogICAgICByZXR1cm4gZWxlbTsKICAgIH0KICAgIGlmIChkYXRhID09IG51bGwgJiYgZm4gPT0gbnVsbCkgewogICAgICAvLyAoIHR5cGVzLCBmbiApCiAgICAgIGZuID0gc2VsZWN0b3I7CiAgICAgIGRhdGEgPSBzZWxlY3RvciA9IHVuZGVmaW5lZDsKICAgIH0gZWxzZSBpZiAoZm4gPT0gbnVsbCkgewogICAgICBpZiAodHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIikgewogICAgICAgIC8vICggdHlwZXMsIHNlbGVjdG9yLCBmbiApCiAgICAgICAgZm4gPSBkYXRhOwogICAgICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gKCB0eXBlcywgZGF0YSwgZm4gKQogICAgICAgIGZuID0gZGF0YTsKICAgICAgICBkYXRhID0gc2VsZWN0b3I7CiAgICAgICAgc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH0KICAgIGlmIChmbiA9PT0gZmFsc2UpIHsKICAgICAgZm4gPSByZXR1cm5GYWxzZTsKICAgIH0gZWxzZSBpZiAoIWZuKSB7CiAgICAgIHJldHVybiBlbGVtOwogICAgfQogICAgaWYgKG9uZSA9PT0gMSkgewogICAgICBvcmlnRm4gPSBmbjsKICAgICAgZm4gPSBmdW5jdGlvbiBmbihldmVudCkgewogICAgICAgIC8vIENhbiB1c2UgYW4gZW1wdHkgc2V0LCBzaW5jZSBldmVudCBjb250YWlucyB0aGUgaW5mbwogICAgICAgIGpRdWVyeSgpLm9mZihldmVudCk7CiAgICAgICAgcmV0dXJuIG9yaWdGbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwoKICAgICAgLy8gVXNlIHNhbWUgZ3VpZCBzbyBjYWxsZXIgY2FuIHJlbW92ZSB1c2luZyBvcmlnRm4KICAgICAgZm4uZ3VpZCA9IG9yaWdGbi5ndWlkIHx8IChvcmlnRm4uZ3VpZCA9IGpRdWVyeS5ndWlkKyspOwogICAgfQogICAgcmV0dXJuIGVsZW0uZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIGpRdWVyeS5ldmVudC5hZGQodGhpcywgdHlwZXMsIGZuLCBkYXRhLCBzZWxlY3Rvcik7CiAgICB9KTsKICB9CgogIC8qCiAgKiBIZWxwZXIgZnVuY3Rpb25zIGZvciBtYW5hZ2luZyBldmVudHMgLS0gbm90IHBhcnQgb2YgdGhlIHB1YmxpYyBpbnRlcmZhY2UuCiAgKiBQcm9wcyB0byBEZWFuIEVkd2FyZHMnIGFkZEV2ZW50IGxpYnJhcnkgZm9yIG1hbnkgb2YgdGhlIGlkZWFzLgogICovCiAgalF1ZXJ5LmV2ZW50ID0gewogICAgZ2xvYmFsOiB7fSwKICAgIGFkZDogZnVuY3Rpb24gYWRkKGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBkYXRhLCBzZWxlY3RvcikgewogICAgICB2YXIgaGFuZGxlT2JqSW4sCiAgICAgICAgZXZlbnRIYW5kbGUsCiAgICAgICAgdG1wLAogICAgICAgIGV2ZW50cywKICAgICAgICB0LAogICAgICAgIGhhbmRsZU9iaiwKICAgICAgICBzcGVjaWFsLAogICAgICAgIGhhbmRsZXJzLAogICAgICAgIHR5cGUsCiAgICAgICAgbmFtZXNwYWNlcywKICAgICAgICBvcmlnVHlwZSwKICAgICAgICBlbGVtRGF0YSA9IGRhdGFQcml2LmdldChlbGVtKTsKCiAgICAgIC8vIE9ubHkgYXR0YWNoIGV2ZW50cyB0byBvYmplY3RzIHRoYXQgYWNjZXB0IGRhdGEKICAgICAgaWYgKCFhY2NlcHREYXRhKGVsZW0pKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYW4gb2JqZWN0IG9mIGN1c3RvbSBkYXRhIGluIGxpZXUgb2YgdGhlIGhhbmRsZXIKICAgICAgaWYgKGhhbmRsZXIuaGFuZGxlcikgewogICAgICAgIGhhbmRsZU9iakluID0gaGFuZGxlcjsKICAgICAgICBoYW5kbGVyID0gaGFuZGxlT2JqSW4uaGFuZGxlcjsKICAgICAgICBzZWxlY3RvciA9IGhhbmRsZU9iakluLnNlbGVjdG9yOwogICAgICB9CgogICAgICAvLyBFbnN1cmUgdGhhdCBpbnZhbGlkIHNlbGVjdG9ycyB0aHJvdyBleGNlcHRpb25zIGF0IGF0dGFjaCB0aW1lCiAgICAgIC8vIEV2YWx1YXRlIGFnYWluc3QgZG9jdW1lbnRFbGVtZW50IGluIGNhc2UgZWxlbSBpcyBhIG5vbi1lbGVtZW50IG5vZGUgKGUuZy4sIGRvY3VtZW50KQogICAgICBpZiAoc2VsZWN0b3IpIHsKICAgICAgICBqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoZG9jdW1lbnRFbGVtZW50LCBzZWxlY3Rvcik7CiAgICAgIH0KCiAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBoYW5kbGVyIGhhcyBhIHVuaXF1ZSBJRCwgdXNlZCB0byBmaW5kL3JlbW92ZSBpdCBsYXRlcgogICAgICBpZiAoIWhhbmRsZXIuZ3VpZCkgewogICAgICAgIGhhbmRsZXIuZ3VpZCA9IGpRdWVyeS5ndWlkKys7CiAgICAgIH0KCiAgICAgIC8vIEluaXQgdGhlIGVsZW1lbnQncyBldmVudCBzdHJ1Y3R1cmUgYW5kIG1haW4gaGFuZGxlciwgaWYgdGhpcyBpcyB0aGUgZmlyc3QKICAgICAgaWYgKCEoZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzKSkgewogICAgICAgIGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIH0KICAgICAgaWYgKCEoZXZlbnRIYW5kbGUgPSBlbGVtRGF0YS5oYW5kbGUpKSB7CiAgICAgICAgZXZlbnRIYW5kbGUgPSBlbGVtRGF0YS5oYW5kbGUgPSBmdW5jdGlvbiAoZSkgewogICAgICAgICAgLy8gRGlzY2FyZCB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoKSBhbmQKICAgICAgICAgIC8vIHdoZW4gYW4gZXZlbnQgaXMgY2FsbGVkIGFmdGVyIGEgcGFnZSBoYXMgdW5sb2FkZWQKICAgICAgICAgIHJldHVybiB0eXBlb2YgalF1ZXJ5ICE9PSAidW5kZWZpbmVkIiAmJiBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkICE9PSBlLnR5cGUgPyBqUXVlcnkuZXZlbnQuZGlzcGF0Y2guYXBwbHkoZWxlbSwgYXJndW1lbnRzKSA6IHVuZGVmaW5lZDsKICAgICAgICB9OwogICAgICB9CgogICAgICAvLyBIYW5kbGUgbXVsdGlwbGUgZXZlbnRzIHNlcGFyYXRlZCBieSBhIHNwYWNlCiAgICAgIHR5cGVzID0gKHR5cGVzIHx8ICIiKS5tYXRjaChybm90aHRtbHdoaXRlKSB8fCBbIiJdOwogICAgICB0ID0gdHlwZXMubGVuZ3RoOwogICAgICB3aGlsZSAodC0tKSB7CiAgICAgICAgdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyh0eXBlc1t0XSkgfHwgW107CiAgICAgICAgdHlwZSA9IG9yaWdUeXBlID0gdG1wWzFdOwogICAgICAgIG5hbWVzcGFjZXMgPSAodG1wWzJdIHx8ICIiKS5zcGxpdCgiLiIpLnNvcnQoKTsKCiAgICAgICAgLy8gVGhlcmUgKm11c3QqIGJlIGEgdHlwZSwgbm8gYXR0YWNoaW5nIG5hbWVzcGFjZS1vbmx5IGhhbmRsZXJzCiAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIC8vIElmIGV2ZW50IGNoYW5nZXMgaXRzIHR5cGUsIHVzZSB0aGUgc3BlY2lhbCBldmVudCBoYW5kbGVycyBmb3IgdGhlIGNoYW5nZWQgdHlwZQogICAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCB7fTsKCiAgICAgICAgLy8gSWYgc2VsZWN0b3IgZGVmaW5lZCwgZGV0ZXJtaW5lIHNwZWNpYWwgZXZlbnQgYXBpIHR5cGUsIG90aGVyd2lzZSBnaXZlbiB0eXBlCiAgICAgICAgdHlwZSA9IChzZWxlY3RvciA/IHNwZWNpYWwuZGVsZWdhdGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSkgfHwgdHlwZTsKCiAgICAgICAgLy8gVXBkYXRlIHNwZWNpYWwgYmFzZWQgb24gbmV3bHkgcmVzZXQgdHlwZQogICAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCB7fTsKCiAgICAgICAgLy8gaGFuZGxlT2JqIGlzIHBhc3NlZCB0byBhbGwgZXZlbnQgaGFuZGxlcnMKICAgICAgICBoYW5kbGVPYmogPSBqUXVlcnkuZXh0ZW5kKHsKICAgICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgICBvcmlnVHlwZTogb3JpZ1R5cGUsCiAgICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgaGFuZGxlcjogaGFuZGxlciwKICAgICAgICAgIGd1aWQ6IGhhbmRsZXIuZ3VpZCwKICAgICAgICAgIHNlbGVjdG9yOiBzZWxlY3RvciwKICAgICAgICAgIG5lZWRzQ29udGV4dDogc2VsZWN0b3IgJiYgalF1ZXJ5LmV4cHIubWF0Y2gubmVlZHNDb250ZXh0LnRlc3Qoc2VsZWN0b3IpLAogICAgICAgICAgbmFtZXNwYWNlOiBuYW1lc3BhY2VzLmpvaW4oIi4iKQogICAgICAgIH0sIGhhbmRsZU9iakluKTsKCiAgICAgICAgLy8gSW5pdCB0aGUgZXZlbnQgaGFuZGxlciBxdWV1ZSBpZiB3ZSdyZSB0aGUgZmlyc3QKICAgICAgICBpZiAoIShoYW5kbGVycyA9IGV2ZW50c1t0eXBlXSkpIHsKICAgICAgICAgIGhhbmRsZXJzID0gZXZlbnRzW3R5cGVdID0gW107CiAgICAgICAgICBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50ID0gMDsKCiAgICAgICAgICAvLyBPbmx5IHVzZSBhZGRFdmVudExpc3RlbmVyIGlmIHRoZSBzcGVjaWFsIGV2ZW50cyBoYW5kbGVyIHJldHVybnMgZmFsc2UKICAgICAgICAgIGlmICghc3BlY2lhbC5zZXR1cCB8fCBzcGVjaWFsLnNldHVwLmNhbGwoZWxlbSwgZGF0YSwgbmFtZXNwYWNlcywgZXZlbnRIYW5kbGUpID09PSBmYWxzZSkgewogICAgICAgICAgICBpZiAoZWxlbS5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgICAgZWxlbS5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGV2ZW50SGFuZGxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoc3BlY2lhbC5hZGQpIHsKICAgICAgICAgIHNwZWNpYWwuYWRkLmNhbGwoZWxlbSwgaGFuZGxlT2JqKTsKICAgICAgICAgIGlmICghaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCkgewogICAgICAgICAgICBoYW5kbGVPYmouaGFuZGxlci5ndWlkID0gaGFuZGxlci5ndWlkOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQWRkIHRvIHRoZSBlbGVtZW50J3MgaGFuZGxlciBsaXN0LCBkZWxlZ2F0ZXMgaW4gZnJvbnQKICAgICAgICBpZiAoc2VsZWN0b3IpIHsKICAgICAgICAgIGhhbmRsZXJzLnNwbGljZShoYW5kbGVycy5kZWxlZ2F0ZUNvdW50KyssIDAsIGhhbmRsZU9iaik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGhhbmRsZXJzLnB1c2goaGFuZGxlT2JqKTsKICAgICAgICB9CgogICAgICAgIC8vIEtlZXAgdHJhY2sgb2Ygd2hpY2ggZXZlbnRzIGhhdmUgZXZlciBiZWVuIHVzZWQsIGZvciBldmVudCBvcHRpbWl6YXRpb24KICAgICAgICBqUXVlcnkuZXZlbnQuZ2xvYmFsW3R5cGVdID0gdHJ1ZTsKICAgICAgfQogICAgfSwKICAgIC8vIERldGFjaCBhbiBldmVudCBvciBzZXQgb2YgZXZlbnRzIGZyb20gYW4gZWxlbWVudAogICAgcmVtb3ZlOiBmdW5jdGlvbiByZW1vdmUoZWxlbSwgdHlwZXMsIGhhbmRsZXIsIHNlbGVjdG9yLCBtYXBwZWRUeXBlcykgewogICAgICB2YXIgaiwKICAgICAgICBvcmlnQ291bnQsCiAgICAgICAgdG1wLAogICAgICAgIGV2ZW50cywKICAgICAgICB0LAogICAgICAgIGhhbmRsZU9iaiwKICAgICAgICBzcGVjaWFsLAogICAgICAgIGhhbmRsZXJzLAogICAgICAgIHR5cGUsCiAgICAgICAgbmFtZXNwYWNlcywKICAgICAgICBvcmlnVHlwZSwKICAgICAgICBlbGVtRGF0YSA9IGRhdGFQcml2Lmhhc0RhdGEoZWxlbSkgJiYgZGF0YVByaXYuZ2V0KGVsZW0pOwogICAgICBpZiAoIWVsZW1EYXRhIHx8ICEoZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gT25jZSBmb3IgZWFjaCB0eXBlLm5hbWVzcGFjZSBpbiB0eXBlczsgdHlwZSBtYXkgYmUgb21pdHRlZAogICAgICB0eXBlcyA9ICh0eXBlcyB8fCAiIikubWF0Y2gocm5vdGh0bWx3aGl0ZSkgfHwgWyIiXTsKICAgICAgdCA9IHR5cGVzLmxlbmd0aDsKICAgICAgd2hpbGUgKHQtLSkgewogICAgICAgIHRtcCA9IHJ0eXBlbmFtZXNwYWNlLmV4ZWModHlwZXNbdF0pIHx8IFtdOwogICAgICAgIHR5cGUgPSBvcmlnVHlwZSA9IHRtcFsxXTsKICAgICAgICBuYW1lc3BhY2VzID0gKHRtcFsyXSB8fCAiIikuc3BsaXQoIi4iKS5zb3J0KCk7CgogICAgICAgIC8vIFVuYmluZCBhbGwgZXZlbnRzIChvbiB0aGlzIG5hbWVzcGFjZSwgaWYgcHJvdmlkZWQpIGZvciB0aGUgZWxlbWVudAogICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgZm9yICh0eXBlIGluIGV2ZW50cykgewogICAgICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKGVsZW0sIHR5cGUgKyB0eXBlc1t0XSwgaGFuZGxlciwgc2VsZWN0b3IsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCB7fTsKICAgICAgICB0eXBlID0gKHNlbGVjdG9yID8gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgOiBzcGVjaWFsLmJpbmRUeXBlKSB8fCB0eXBlOwogICAgICAgIGhhbmRsZXJzID0gZXZlbnRzW3R5cGVdIHx8IFtdOwogICAgICAgIHRtcCA9IHRtcFsyXSAmJiBuZXcgUmVnRXhwKCIoXnxcXC4pIiArIG5hbWVzcGFjZXMuam9pbigiXFwuKD86LipcXC58KSIpICsgIihcXC58JCkiKTsKCiAgICAgICAgLy8gUmVtb3ZlIG1hdGNoaW5nIGV2ZW50cwogICAgICAgIG9yaWdDb3VudCA9IGogPSBoYW5kbGVycy5sZW5ndGg7CiAgICAgICAgd2hpbGUgKGotLSkgewogICAgICAgICAgaGFuZGxlT2JqID0gaGFuZGxlcnNbal07CiAgICAgICAgICBpZiAoKG1hcHBlZFR5cGVzIHx8IG9yaWdUeXBlID09PSBoYW5kbGVPYmoub3JpZ1R5cGUpICYmICghaGFuZGxlciB8fCBoYW5kbGVyLmd1aWQgPT09IGhhbmRsZU9iai5ndWlkKSAmJiAoIXRtcCB8fCB0bXAudGVzdChoYW5kbGVPYmoubmFtZXNwYWNlKSkgJiYgKCFzZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gaGFuZGxlT2JqLnNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSAiKioiICYmIGhhbmRsZU9iai5zZWxlY3RvcikpIHsKICAgICAgICAgICAgaGFuZGxlcnMuc3BsaWNlKGosIDEpOwogICAgICAgICAgICBpZiAoaGFuZGxlT2JqLnNlbGVjdG9yKSB7CiAgICAgICAgICAgICAgaGFuZGxlcnMuZGVsZWdhdGVDb3VudC0tOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzcGVjaWFsLnJlbW92ZSkgewogICAgICAgICAgICAgIHNwZWNpYWwucmVtb3ZlLmNhbGwoZWxlbSwgaGFuZGxlT2JqKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gUmVtb3ZlIGdlbmVyaWMgZXZlbnQgaGFuZGxlciBpZiB3ZSByZW1vdmVkIHNvbWV0aGluZyBhbmQgbm8gbW9yZSBoYW5kbGVycyBleGlzdAogICAgICAgIC8vIChhdm9pZHMgcG90ZW50aWFsIGZvciBlbmRsZXNzIHJlY3Vyc2lvbiBkdXJpbmcgcmVtb3ZhbCBvZiBzcGVjaWFsIGV2ZW50IGhhbmRsZXJzKQogICAgICAgIGlmIChvcmlnQ291bnQgJiYgIWhhbmRsZXJzLmxlbmd0aCkgewogICAgICAgICAgaWYgKCFzcGVjaWFsLnRlYXJkb3duIHx8IHNwZWNpYWwudGVhcmRvd24uY2FsbChlbGVtLCBuYW1lc3BhY2VzLCBlbGVtRGF0YS5oYW5kbGUpID09PSBmYWxzZSkgewogICAgICAgICAgICBqUXVlcnkucmVtb3ZlRXZlbnQoZWxlbSwgdHlwZSwgZWxlbURhdGEuaGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGRlbGV0ZSBldmVudHNbdHlwZV07CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBSZW1vdmUgZGF0YSBhbmQgdGhlIGV4cGFuZG8gaWYgaXQncyBubyBsb25nZXIgdXNlZAogICAgICBpZiAoalF1ZXJ5LmlzRW1wdHlPYmplY3QoZXZlbnRzKSkgewogICAgICAgIGRhdGFQcml2LnJlbW92ZShlbGVtLCAiaGFuZGxlIGV2ZW50cyIpOwogICAgICB9CiAgICB9LAogICAgZGlzcGF0Y2g6IGZ1bmN0aW9uIGRpc3BhdGNoKG5hdGl2ZUV2ZW50KSB7CiAgICAgIHZhciBpLAogICAgICAgIGosCiAgICAgICAgcmV0LAogICAgICAgIG1hdGNoZWQsCiAgICAgICAgaGFuZGxlT2JqLAogICAgICAgIGhhbmRsZXJRdWV1ZSwKICAgICAgICBhcmdzID0gbmV3IEFycmF5KGFyZ3VtZW50cy5sZW5ndGgpLAogICAgICAgIC8vIE1ha2UgYSB3cml0YWJsZSBqUXVlcnkuRXZlbnQgZnJvbSB0aGUgbmF0aXZlIGV2ZW50IG9iamVjdAogICAgICAgIGV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeChuYXRpdmVFdmVudCksCiAgICAgICAgaGFuZGxlcnMgPSAoZGF0YVByaXYuZ2V0KHRoaXMsICJldmVudHMiKSB8fCBPYmplY3QuY3JlYXRlKG51bGwpKVtldmVudC50eXBlXSB8fCBbXSwKICAgICAgICBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbZXZlbnQudHlwZV0gfHwge307CgogICAgICAvLyBVc2UgdGhlIGZpeC1lZCBqUXVlcnkuRXZlbnQgcmF0aGVyIHRoYW4gdGhlIChyZWFkLW9ubHkpIG5hdGl2ZSBldmVudAogICAgICBhcmdzWzBdID0gZXZlbnQ7CiAgICAgIGZvciAoaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBhcmdzW2ldID0gYXJndW1lbnRzW2ldOwogICAgICB9CiAgICAgIGV2ZW50LmRlbGVnYXRlVGFyZ2V0ID0gdGhpczsKCiAgICAgIC8vIENhbGwgdGhlIHByZURpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZSwgYW5kIGxldCBpdCBiYWlsIGlmIGRlc2lyZWQKICAgICAgaWYgKHNwZWNpYWwucHJlRGlzcGF0Y2ggJiYgc3BlY2lhbC5wcmVEaXNwYXRjaC5jYWxsKHRoaXMsIGV2ZW50KSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIERldGVybWluZSBoYW5kbGVycwogICAgICBoYW5kbGVyUXVldWUgPSBqUXVlcnkuZXZlbnQuaGFuZGxlcnMuY2FsbCh0aGlzLCBldmVudCwgaGFuZGxlcnMpOwoKICAgICAgLy8gUnVuIGRlbGVnYXRlcyBmaXJzdDsgdGhleSBtYXkgd2FudCB0byBzdG9wIHByb3BhZ2F0aW9uIGJlbmVhdGggdXMKICAgICAgaSA9IDA7CiAgICAgIHdoaWxlICgobWF0Y2hlZCA9IGhhbmRsZXJRdWV1ZVtpKytdKSAmJiAhZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBtYXRjaGVkLmVsZW07CiAgICAgICAgaiA9IDA7CiAgICAgICAgd2hpbGUgKChoYW5kbGVPYmogPSBtYXRjaGVkLmhhbmRsZXJzW2orK10pICYmICFldmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgICAvLyBJZiB0aGUgZXZlbnQgaXMgbmFtZXNwYWNlZCwgdGhlbiBlYWNoIGhhbmRsZXIgaXMgb25seSBpbnZva2VkIGlmIGl0IGlzCiAgICAgICAgICAvLyBzcGVjaWFsbHkgdW5pdmVyc2FsIG9yIGl0cyBuYW1lc3BhY2VzIGFyZSBhIHN1cGVyc2V0IG9mIHRoZSBldmVudCdzLgogICAgICAgICAgaWYgKCFldmVudC5ybmFtZXNwYWNlIHx8IGhhbmRsZU9iai5uYW1lc3BhY2UgPT09IGZhbHNlIHx8IGV2ZW50LnJuYW1lc3BhY2UudGVzdChoYW5kbGVPYmoubmFtZXNwYWNlKSkgewogICAgICAgICAgICBldmVudC5oYW5kbGVPYmogPSBoYW5kbGVPYmo7CiAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBoYW5kbGVPYmouZGF0YTsKICAgICAgICAgICAgcmV0ID0gKChqUXVlcnkuZXZlbnQuc3BlY2lhbFtoYW5kbGVPYmoub3JpZ1R5cGVdIHx8IHt9KS5oYW5kbGUgfHwgaGFuZGxlT2JqLmhhbmRsZXIpLmFwcGx5KG1hdGNoZWQuZWxlbSwgYXJncyk7CiAgICAgICAgICAgIGlmIChyZXQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIGlmICgoZXZlbnQucmVzdWx0ID0gcmV0KSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIENhbGwgdGhlIHBvc3REaXNwYXRjaCBob29rIGZvciB0aGUgbWFwcGVkIHR5cGUKICAgICAgaWYgKHNwZWNpYWwucG9zdERpc3BhdGNoKSB7CiAgICAgICAgc3BlY2lhbC5wb3N0RGlzcGF0Y2guY2FsbCh0aGlzLCBldmVudCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50LnJlc3VsdDsKICAgIH0sCiAgICBoYW5kbGVyczogZnVuY3Rpb24gaGFuZGxlcnMoZXZlbnQsIF9oYW5kbGVycykgewogICAgICB2YXIgaSwKICAgICAgICBoYW5kbGVPYmosCiAgICAgICAgc2VsLAogICAgICAgIG1hdGNoZWRIYW5kbGVycywKICAgICAgICBtYXRjaGVkU2VsZWN0b3JzLAogICAgICAgIGhhbmRsZXJRdWV1ZSA9IFtdLAogICAgICAgIGRlbGVnYXRlQ291bnQgPSBfaGFuZGxlcnMuZGVsZWdhdGVDb3VudCwKICAgICAgICBjdXIgPSBldmVudC50YXJnZXQ7CgogICAgICAvLyBGaW5kIGRlbGVnYXRlIGhhbmRsZXJzCiAgICAgIGlmIChkZWxlZ2F0ZUNvdW50ICYmCiAgICAgIC8vIFN1cHBvcnQ6IElFIDw9OQogICAgICAvLyBCbGFjay1ob2xlIFNWRyA8dXNlPiBpbnN0YW5jZSB0cmVlcyAodHJhYy0xMzE4MCkKICAgICAgY3VyLm5vZGVUeXBlICYmCiAgICAgIC8vIFN1cHBvcnQ6IEZpcmVmb3ggPD00MgogICAgICAvLyBTdXBwcmVzcyBzcGVjLXZpb2xhdGluZyBjbGlja3MgaW5kaWNhdGluZyBhIG5vbi1wcmltYXJ5IHBvaW50ZXIgYnV0dG9uICh0cmFjLTM4NjEpCiAgICAgIC8vIGh0dHBzOi8vd3d3LnczLm9yZy9UUi9ET00tTGV2ZWwtMy1FdmVudHMvI2V2ZW50LXR5cGUtY2xpY2sKICAgICAgLy8gU3VwcG9ydDogSUUgMTEgb25seQogICAgICAvLyAuLi5idXQgbm90IGFycm93IGtleSAiY2xpY2tzIiBvZiByYWRpbyBpbnB1dHMsIHdoaWNoIGNhbiBoYXZlIGBidXR0b25gIC0xIChnaC0yMzQzKQogICAgICAhKGV2ZW50LnR5cGUgPT09ICJjbGljayIgJiYgZXZlbnQuYnV0dG9uID49IDEpKSB7CiAgICAgICAgZm9yICg7IGN1ciAhPT0gdGhpczsgY3VyID0gY3VyLnBhcmVudE5vZGUgfHwgdGhpcykgewogICAgICAgICAgLy8gRG9uJ3QgY2hlY2sgbm9uLWVsZW1lbnRzICgjMTMyMDgpCiAgICAgICAgICAvLyBEb24ndCBwcm9jZXNzIGNsaWNrcyBvbiBkaXNhYmxlZCBlbGVtZW50cyAoIzY5MTEsICM4MTY1LCAjMTEzODIsICMxMTc2NCkKICAgICAgICAgIGlmIChjdXIubm9kZVR5cGUgPT09IDEgJiYgIShldmVudC50eXBlID09PSAiY2xpY2siICYmIGN1ci5kaXNhYmxlZCA9PT0gdHJ1ZSkpIHsKICAgICAgICAgICAgbWF0Y2hlZEhhbmRsZXJzID0gW107CiAgICAgICAgICAgIG1hdGNoZWRTZWxlY3RvcnMgPSB7fTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGRlbGVnYXRlQ291bnQ7IGkrKykgewogICAgICAgICAgICAgIGhhbmRsZU9iaiA9IF9oYW5kbGVyc1tpXTsKCiAgICAgICAgICAgICAgLy8gRG9uJ3QgY29uZmxpY3Qgd2l0aCBPYmplY3QucHJvdG90eXBlIHByb3BlcnRpZXMgKCMxMzIwMykKICAgICAgICAgICAgICBzZWwgPSBoYW5kbGVPYmouc2VsZWN0b3IgKyAiICI7CiAgICAgICAgICAgICAgaWYgKG1hdGNoZWRTZWxlY3RvcnNbc2VsXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBtYXRjaGVkU2VsZWN0b3JzW3NlbF0gPSBoYW5kbGVPYmoubmVlZHNDb250ZXh0ID8galF1ZXJ5KHNlbCwgdGhpcykuaW5kZXgoY3VyKSA+IC0xIDogalF1ZXJ5LmZpbmQoc2VsLCB0aGlzLCBudWxsLCBbY3VyXSkubGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobWF0Y2hlZFNlbGVjdG9yc1tzZWxdKSB7CiAgICAgICAgICAgICAgICBtYXRjaGVkSGFuZGxlcnMucHVzaChoYW5kbGVPYmopOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobWF0Y2hlZEhhbmRsZXJzLmxlbmd0aCkgewogICAgICAgICAgICAgIGhhbmRsZXJRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGVsZW06IGN1ciwKICAgICAgICAgICAgICAgIGhhbmRsZXJzOiBtYXRjaGVkSGFuZGxlcnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQWRkIHRoZSByZW1haW5pbmcgKGRpcmVjdGx5LWJvdW5kKSBoYW5kbGVycwogICAgICBjdXIgPSB0aGlzOwogICAgICBpZiAoZGVsZWdhdGVDb3VudCA8IF9oYW5kbGVycy5sZW5ndGgpIHsKICAgICAgICBoYW5kbGVyUXVldWUucHVzaCh7CiAgICAgICAgICBlbGVtOiBjdXIsCiAgICAgICAgICBoYW5kbGVyczogX2hhbmRsZXJzLnNsaWNlKGRlbGVnYXRlQ291bnQpCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGhhbmRsZXJRdWV1ZTsKICAgIH0sCiAgICBhZGRQcm9wOiBmdW5jdGlvbiBhZGRQcm9wKG5hbWUsIGhvb2spIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGpRdWVyeS5FdmVudC5wcm90b3R5cGUsIG5hbWUsIHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGlzRnVuY3Rpb24oaG9vaykgPyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy5vcmlnaW5hbEV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBob29rKHRoaXMub3JpZ2luYWxFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfSA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzLm9yaWdpbmFsRXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMub3JpZ2luYWxFdmVudFtuYW1lXTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHZhbHVlKSB7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgbmFtZSwgewogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICB2YWx1ZTogdmFsdWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgZml4OiBmdW5jdGlvbiBmaXgob3JpZ2luYWxFdmVudCkgewogICAgICByZXR1cm4gb3JpZ2luYWxFdmVudFtqUXVlcnkuZXhwYW5kb10gPyBvcmlnaW5hbEV2ZW50IDogbmV3IGpRdWVyeS5FdmVudChvcmlnaW5hbEV2ZW50KTsKICAgIH0sCiAgICBzcGVjaWFsOiB7CiAgICAgIGxvYWQ6IHsKICAgICAgICAvLyBQcmV2ZW50IHRyaWdnZXJlZCBpbWFnZS5sb2FkIGV2ZW50cyBmcm9tIGJ1YmJsaW5nIHRvIHdpbmRvdy5sb2FkCiAgICAgICAgbm9CdWJibGU6IHRydWUKICAgICAgfSwKICAgICAgY2xpY2s6IHsKICAgICAgICAvLyBVdGlsaXplIG5hdGl2ZSBldmVudCB0byBlbnN1cmUgY29ycmVjdCBzdGF0ZSBmb3IgY2hlY2thYmxlIGlucHV0cwogICAgICAgIHNldHVwOiBmdW5jdGlvbiBzZXR1cChkYXRhKSB7CiAgICAgICAgICAvLyBGb3IgbXV0dWFsIGNvbXByZXNzaWJpbGl0eSB3aXRoIF9kZWZhdWx0LCByZXBsYWNlIGB0aGlzYCBhY2Nlc3Mgd2l0aCBhIGxvY2FsIHZhci4KICAgICAgICAgIC8vIGB8fCBkYXRhYCBpcyBkZWFkIGNvZGUgbWVhbnQgb25seSB0byBwcmVzZXJ2ZSB0aGUgdmFyaWFibGUgdGhyb3VnaCBtaW5pZmljYXRpb24uCiAgICAgICAgICB2YXIgZWwgPSB0aGlzIHx8IGRhdGE7CgogICAgICAgICAgLy8gQ2xhaW0gdGhlIGZpcnN0IGhhbmRsZXIKICAgICAgICAgIGlmIChyY2hlY2thYmxlVHlwZS50ZXN0KGVsLnR5cGUpICYmIGVsLmNsaWNrICYmIG5vZGVOYW1lKGVsLCAiaW5wdXQiKSkgewogICAgICAgICAgICAvLyBkYXRhUHJpdi5zZXQoIGVsLCAiY2xpY2siLCAuLi4gKQogICAgICAgICAgICBsZXZlcmFnZU5hdGl2ZShlbCwgImNsaWNrIiwgcmV0dXJuVHJ1ZSk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gUmV0dXJuIGZhbHNlIHRvIGFsbG93IG5vcm1hbCBwcm9jZXNzaW5nIGluIHRoZSBjYWxsZXIKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAogICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uIHRyaWdnZXIoZGF0YSkgewogICAgICAgICAgLy8gRm9yIG11dHVhbCBjb21wcmVzc2liaWxpdHkgd2l0aCBfZGVmYXVsdCwgcmVwbGFjZSBgdGhpc2AgYWNjZXNzIHdpdGggYSBsb2NhbCB2YXIuCiAgICAgICAgICAvLyBgfHwgZGF0YWAgaXMgZGVhZCBjb2RlIG1lYW50IG9ubHkgdG8gcHJlc2VydmUgdGhlIHZhcmlhYmxlIHRocm91Z2ggbWluaWZpY2F0aW9uLgogICAgICAgICAgdmFyIGVsID0gdGhpcyB8fCBkYXRhOwoKICAgICAgICAgIC8vIEZvcmNlIHNldHVwIGJlZm9yZSB0cmlnZ2VyaW5nIGEgY2xpY2sKICAgICAgICAgIGlmIChyY2hlY2thYmxlVHlwZS50ZXN0KGVsLnR5cGUpICYmIGVsLmNsaWNrICYmIG5vZGVOYW1lKGVsLCAiaW5wdXQiKSkgewogICAgICAgICAgICBsZXZlcmFnZU5hdGl2ZShlbCwgImNsaWNrIik7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gUmV0dXJuIG5vbi1mYWxzZSB0byBhbGxvdyBub3JtYWwgZXZlbnQtcGF0aCBwcm9wYWdhdGlvbgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKICAgICAgICAvLyBGb3IgY3Jvc3MtYnJvd3NlciBjb25zaXN0ZW5jeSwgc3VwcHJlc3MgbmF0aXZlIC5jbGljaygpIG9uIGxpbmtzCiAgICAgICAgLy8gQWxzbyBwcmV2ZW50IGl0IGlmIHdlJ3JlIGN1cnJlbnRseSBpbnNpZGUgYSBsZXZlcmFnZWQgbmF0aXZlLWV2ZW50IHN0YWNrCiAgICAgICAgX2RlZmF1bHQ6IGZ1bmN0aW9uIF9kZWZhdWx0KGV2ZW50KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwogICAgICAgICAgcmV0dXJuIHJjaGVja2FibGVUeXBlLnRlc3QodGFyZ2V0LnR5cGUpICYmIHRhcmdldC5jbGljayAmJiBub2RlTmFtZSh0YXJnZXQsICJpbnB1dCIpICYmIGRhdGFQcml2LmdldCh0YXJnZXQsICJjbGljayIpIHx8IG5vZGVOYW1lKHRhcmdldCwgImEiKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGJlZm9yZXVubG9hZDogewogICAgICAgIHBvc3REaXNwYXRjaDogZnVuY3Rpb24gcG9zdERpc3BhdGNoKGV2ZW50KSB7CiAgICAgICAgICAvLyBTdXBwb3J0OiBGaXJlZm94IDIwKwogICAgICAgICAgLy8gRmlyZWZveCBkb2Vzbid0IGFsZXJ0IGlmIHRoZSByZXR1cm5WYWx1ZSBmaWVsZCBpcyBub3Qgc2V0LgogICAgICAgICAgaWYgKGV2ZW50LnJlc3VsdCAhPT0gdW5kZWZpbmVkICYmIGV2ZW50Lm9yaWdpbmFsRXZlbnQpIHsKICAgICAgICAgICAgZXZlbnQub3JpZ2luYWxFdmVudC5yZXR1cm5WYWx1ZSA9IGV2ZW50LnJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyBFbnN1cmUgdGhlIHByZXNlbmNlIG9mIGFuIGV2ZW50IGxpc3RlbmVyIHRoYXQgaGFuZGxlcyBtYW51YWxseS10cmlnZ2VyZWQKICAvLyBzeW50aGV0aWMgZXZlbnRzIGJ5IGludGVycnVwdGluZyBwcm9ncmVzcyB1bnRpbCByZWludm9rZWQgaW4gcmVzcG9uc2UgdG8KICAvLyAqbmF0aXZlKiBldmVudHMgdGhhdCBpdCBmaXJlcyBkaXJlY3RseSwgZW5zdXJpbmcgdGhhdCBzdGF0ZSBjaGFuZ2VzIGhhdmUKICAvLyBhbHJlYWR5IG9jY3VycmVkIGJlZm9yZSBvdGhlciBsaXN0ZW5lcnMgYXJlIGludm9rZWQuCiAgZnVuY3Rpb24gbGV2ZXJhZ2VOYXRpdmUoZWwsIHR5cGUsIGV4cGVjdFN5bmMpIHsKICAgIC8vIE1pc3NpbmcgZXhwZWN0U3luYyBpbmRpY2F0ZXMgYSB0cmlnZ2VyIGNhbGwsIHdoaWNoIG11c3QgZm9yY2Ugc2V0dXAgdGhyb3VnaCBqUXVlcnkuZXZlbnQuYWRkCiAgICBpZiAoIWV4cGVjdFN5bmMpIHsKICAgICAgaWYgKGRhdGFQcml2LmdldChlbCwgdHlwZSkgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGpRdWVyeS5ldmVudC5hZGQoZWwsIHR5cGUsIHJldHVyblRydWUpOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBSZWdpc3RlciB0aGUgY29udHJvbGxlciBhcyBhIHNwZWNpYWwgdW5pdmVyc2FsIGhhbmRsZXIgZm9yIGFsbCBldmVudCBuYW1lc3BhY2VzCiAgICBkYXRhUHJpdi5zZXQoZWwsIHR5cGUsIGZhbHNlKTsKICAgIGpRdWVyeS5ldmVudC5hZGQoZWwsIHR5cGUsIHsKICAgICAgbmFtZXNwYWNlOiBmYWxzZSwKICAgICAgaGFuZGxlcjogZnVuY3Rpb24gaGFuZGxlcihldmVudCkgewogICAgICAgIHZhciBub3RBc3luYywKICAgICAgICAgIHJlc3VsdCwKICAgICAgICAgIHNhdmVkID0gZGF0YVByaXYuZ2V0KHRoaXMsIHR5cGUpOwogICAgICAgIGlmIChldmVudC5pc1RyaWdnZXIgJiAxICYmIHRoaXNbdHlwZV0pIHsKICAgICAgICAgIC8vIEludGVycnVwdCBwcm9jZXNzaW5nIG9mIHRoZSBvdXRlciBzeW50aGV0aWMgLnRyaWdnZXIoKWVkIGV2ZW50CiAgICAgICAgICAvLyBTYXZlZCBkYXRhIHNob3VsZCBiZSBmYWxzZSBpbiBzdWNoIGNhc2VzLCBidXQgbWlnaHQgYmUgYSBsZWZ0b3ZlciBjYXB0dXJlIG9iamVjdAogICAgICAgICAgLy8gZnJvbSBhbiBhc3luYyBuYXRpdmUgaGFuZGxlciAoZ2gtNDM1MCkKICAgICAgICAgIGlmICghc2F2ZWQubGVuZ3RoKSB7CiAgICAgICAgICAgIC8vIFN0b3JlIGFyZ3VtZW50cyBmb3IgdXNlIHdoZW4gaGFuZGxpbmcgdGhlIGlubmVyIG5hdGl2ZSBldmVudAogICAgICAgICAgICAvLyBUaGVyZSB3aWxsIGFsd2F5cyBiZSBhdCBsZWFzdCBvbmUgYXJndW1lbnQgKGFuIGV2ZW50IG9iamVjdCksIHNvIHRoaXMgYXJyYXkKICAgICAgICAgICAgLy8gd2lsbCBub3QgYmUgY29uZnVzZWQgd2l0aCBhIGxlZnRvdmVyIGNhcHR1cmUgb2JqZWN0LgogICAgICAgICAgICBzYXZlZCA9IF9zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGRhdGFQcml2LnNldCh0aGlzLCB0eXBlLCBzYXZlZCk7CgogICAgICAgICAgICAvLyBUcmlnZ2VyIHRoZSBuYXRpdmUgZXZlbnQgYW5kIGNhcHR1cmUgaXRzIHJlc3VsdAogICAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSsKICAgICAgICAgICAgLy8gZm9jdXMoKSBhbmQgYmx1cigpIGFyZSBhc3luY2hyb25vdXMKICAgICAgICAgICAgbm90QXN5bmMgPSBleHBlY3RTeW5jKHRoaXMsIHR5cGUpOwogICAgICAgICAgICB0aGlzW3R5cGVdKCk7CiAgICAgICAgICAgIHJlc3VsdCA9IGRhdGFQcml2LmdldCh0aGlzLCB0eXBlKTsKICAgICAgICAgICAgaWYgKHNhdmVkICE9PSByZXN1bHQgfHwgbm90QXN5bmMpIHsKICAgICAgICAgICAgICBkYXRhUHJpdi5zZXQodGhpcywgdHlwZSwgZmFsc2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3VsdCA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzYXZlZCAhPT0gcmVzdWx0KSB7CiAgICAgICAgICAgICAgLy8gQ2FuY2VsIHRoZSBvdXRlciBzeW50aGV0aWMgZXZlbnQKICAgICAgICAgICAgICBldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElmIHRoaXMgaXMgYW4gaW5uZXIgc3ludGhldGljIGV2ZW50IGZvciBhbiBldmVudCB3aXRoIGEgYnViYmxpbmcgc3Vycm9nYXRlCiAgICAgICAgICAgIC8vIChmb2N1cyBvciBibHVyKSwgYXNzdW1lIHRoYXQgdGhlIHN1cnJvZ2F0ZSBhbHJlYWR5IHByb3BhZ2F0ZWQgZnJvbSB0cmlnZ2VyaW5nIHRoZQogICAgICAgICAgICAvLyBuYXRpdmUgZXZlbnQgYW5kIHByZXZlbnQgdGhhdCBmcm9tIGhhcHBlbmluZyBhZ2FpbiBoZXJlLgogICAgICAgICAgICAvLyBUaGlzIHRlY2huaWNhbGx5IGdldHMgdGhlIG9yZGVyaW5nIHdyb25nIHcuci50LiB0byBgLnRyaWdnZXIoKWAgKGluIHdoaWNoIHRoZQogICAgICAgICAgICAvLyBidWJibGluZyBzdXJyb2dhdGUgcHJvcGFnYXRlcyAqYWZ0ZXIqIHRoZSBub24tYnViYmxpbmcgYmFzZSksIGJ1dCB0aGF0IHNlZW1zCiAgICAgICAgICAgIC8vIGxlc3MgYmFkIHRoYW4gZHVwbGljYXRpb24uCiAgICAgICAgICB9IGVsc2UgaWYgKChqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCB7fSkuZGVsZWdhdGVUeXBlKSB7CiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIElmIHRoaXMgaXMgYSBuYXRpdmUgZXZlbnQgdHJpZ2dlcmVkIGFib3ZlLCBldmVyeXRoaW5nIGlzIG5vdyBpbiBvcmRlcgogICAgICAgICAgLy8gRmlyZSBhbiBpbm5lciBzeW50aGV0aWMgZXZlbnQgd2l0aCB0aGUgb3JpZ2luYWwgYXJndW1lbnRzCiAgICAgICAgfSBlbHNlIGlmIChzYXZlZC5sZW5ndGgpIHsKICAgICAgICAgIC8vIC4uLmFuZCBjYXB0dXJlIHRoZSByZXN1bHQKICAgICAgICAgIGRhdGFQcml2LnNldCh0aGlzLCB0eXBlLCB7CiAgICAgICAgICAgIHZhbHVlOiBqUXVlcnkuZXZlbnQudHJpZ2dlcigKICAgICAgICAgICAgLy8gU3VwcG9ydDogSUUgPD05IC0gMTErCiAgICAgICAgICAgIC8vIEV4dGVuZCB3aXRoIHRoZSBwcm90b3R5cGUgdG8gcmVzZXQgdGhlIGFib3ZlIHN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpCiAgICAgICAgICAgIGpRdWVyeS5leHRlbmQoc2F2ZWRbMF0sIGpRdWVyeS5FdmVudC5wcm90b3R5cGUpLCBzYXZlZC5zbGljZSgxKSwgdGhpcykKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIEFib3J0IGhhbmRsaW5nIG9mIHRoZSBuYXRpdmUgZXZlbnQKICAgICAgICAgIGV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQogIGpRdWVyeS5yZW1vdmVFdmVudCA9IGZ1bmN0aW9uIChlbGVtLCB0eXBlLCBoYW5kbGUpIHsKICAgIC8vIFRoaXMgImlmIiBpcyBuZWVkZWQgZm9yIHBsYWluIG9iamVjdHMKICAgIGlmIChlbGVtLnJlbW92ZUV2ZW50TGlzdGVuZXIpIHsKICAgICAgZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGhhbmRsZSk7CiAgICB9CiAgfTsKICBqUXVlcnkuRXZlbnQgPSBmdW5jdGlvbiAoc3JjLCBwcm9wcykgewogICAgLy8gQWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IHRoZSAnbmV3JyBrZXl3b3JkCiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgalF1ZXJ5LkV2ZW50KSkgewogICAgICByZXR1cm4gbmV3IGpRdWVyeS5FdmVudChzcmMsIHByb3BzKTsKICAgIH0KCiAgICAvLyBFdmVudCBvYmplY3QKICAgIGlmIChzcmMgJiYgc3JjLnR5cGUpIHsKICAgICAgdGhpcy5vcmlnaW5hbEV2ZW50ID0gc3JjOwogICAgICB0aGlzLnR5cGUgPSBzcmMudHlwZTsKCiAgICAgIC8vIEV2ZW50cyBidWJibGluZyB1cCB0aGUgZG9jdW1lbnQgbWF5IGhhdmUgYmVlbiBtYXJrZWQgYXMgcHJldmVudGVkCiAgICAgIC8vIGJ5IGEgaGFuZGxlciBsb3dlciBkb3duIHRoZSB0cmVlOyByZWZsZWN0IHRoZSBjb3JyZWN0IHZhbHVlLgogICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IHNyYy5kZWZhdWx0UHJldmVudGVkIHx8IHNyYy5kZWZhdWx0UHJldmVudGVkID09PSB1bmRlZmluZWQgJiYKICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTIuMyBvbmx5CiAgICAgIHNyYy5yZXR1cm5WYWx1ZSA9PT0gZmFsc2UgPyByZXR1cm5UcnVlIDogcmV0dXJuRmFsc2U7CgogICAgICAvLyBDcmVhdGUgdGFyZ2V0IHByb3BlcnRpZXMKICAgICAgLy8gU3VwcG9ydDogU2FmYXJpIDw9NiAtIDcgb25seQogICAgICAvLyBUYXJnZXQgc2hvdWxkIG5vdCBiZSBhIHRleHQgbm9kZSAoIzUwNCwgIzEzMTQzKQogICAgICB0aGlzLnRhcmdldCA9IHNyYy50YXJnZXQgJiYgc3JjLnRhcmdldC5ub2RlVHlwZSA9PT0gMyA/IHNyYy50YXJnZXQucGFyZW50Tm9kZSA6IHNyYy50YXJnZXQ7CiAgICAgIHRoaXMuY3VycmVudFRhcmdldCA9IHNyYy5jdXJyZW50VGFyZ2V0OwogICAgICB0aGlzLnJlbGF0ZWRUYXJnZXQgPSBzcmMucmVsYXRlZFRhcmdldDsKCiAgICAgIC8vIEV2ZW50IHR5cGUKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMudHlwZSA9IHNyYzsKICAgIH0KCiAgICAvLyBQdXQgZXhwbGljaXRseSBwcm92aWRlZCBwcm9wZXJ0aWVzIG9udG8gdGhlIGV2ZW50IG9iamVjdAogICAgaWYgKHByb3BzKSB7CiAgICAgIGpRdWVyeS5leHRlbmQodGhpcywgcHJvcHMpOwogICAgfQoKICAgIC8vIENyZWF0ZSBhIHRpbWVzdGFtcCBpZiBpbmNvbWluZyBldmVudCBkb2Vzbid0IGhhdmUgb25lCiAgICB0aGlzLnRpbWVTdGFtcCA9IHNyYyAmJiBzcmMudGltZVN0YW1wIHx8IERhdGUubm93KCk7CgogICAgLy8gTWFyayBpdCBhcyBmaXhlZAogICAgdGhpc1tqUXVlcnkuZXhwYW5kb10gPSB0cnVlOwogIH07CgogIC8vIGpRdWVyeS5FdmVudCBpcyBiYXNlZCBvbiBET00zIEV2ZW50cyBhcyBzcGVjaWZpZWQgYnkgdGhlIEVDTUFTY3JpcHQgTGFuZ3VhZ2UgQmluZGluZwogIC8vIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDAzL1dELURPTS1MZXZlbC0zLUV2ZW50cy0yMDAzMDMzMS9lY21hLXNjcmlwdC1iaW5kaW5nLmh0bWwKICBqUXVlcnkuRXZlbnQucHJvdG90eXBlID0gewogICAgY29uc3RydWN0b3I6IGpRdWVyeS5FdmVudCwKICAgIGlzRGVmYXVsdFByZXZlbnRlZDogcmV0dXJuRmFsc2UsCiAgICBpc1Byb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCiAgICBpc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCiAgICBpc1NpbXVsYXRlZDogZmFsc2UsCiAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gcHJldmVudERlZmF1bHQoKSB7CiAgICAgIHZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50OwogICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IHJldHVyblRydWU7CiAgICAgIGlmIChlICYmICF0aGlzLmlzU2ltdWxhdGVkKSB7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CiAgICB9LAogICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbiBzdG9wUHJvcGFnYXRpb24oKSB7CiAgICAgIHZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50OwogICAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gcmV0dXJuVHJ1ZTsKICAgICAgaWYgKGUgJiYgIXRoaXMuaXNTaW11bGF0ZWQpIHsKICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICB9CiAgICB9LAogICAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiBmdW5jdGlvbiBzdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKSB7CiAgICAgIHZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50OwogICAgICB0aGlzLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkID0gcmV0dXJuVHJ1ZTsKICAgICAgaWYgKGUgJiYgIXRoaXMuaXNTaW11bGF0ZWQpIHsKICAgICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwogICAgICB9CiAgICAgIHRoaXMuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICB9CiAgfTsKCiAgLy8gSW5jbHVkZXMgYWxsIGNvbW1vbiBldmVudCBwcm9wcyBpbmNsdWRpbmcgS2V5RXZlbnQgYW5kIE1vdXNlRXZlbnQgc3BlY2lmaWMgcHJvcHMKICBqUXVlcnkuZWFjaCh7CiAgICBhbHRLZXk6IHRydWUsCiAgICBidWJibGVzOiB0cnVlLAogICAgY2FuY2VsYWJsZTogdHJ1ZSwKICAgIGNoYW5nZWRUb3VjaGVzOiB0cnVlLAogICAgY3RybEtleTogdHJ1ZSwKICAgIGRldGFpbDogdHJ1ZSwKICAgIGV2ZW50UGhhc2U6IHRydWUsCiAgICBtZXRhS2V5OiB0cnVlLAogICAgcGFnZVg6IHRydWUsCiAgICBwYWdlWTogdHJ1ZSwKICAgIHNoaWZ0S2V5OiB0cnVlLAogICAgdmlldzogdHJ1ZSwKICAgICJjaGFyIjogdHJ1ZSwKICAgIGNvZGU6IHRydWUsCiAgICBjaGFyQ29kZTogdHJ1ZSwKICAgIGtleTogdHJ1ZSwKICAgIGtleUNvZGU6IHRydWUsCiAgICBidXR0b246IHRydWUsCiAgICBidXR0b25zOiB0cnVlLAogICAgY2xpZW50WDogdHJ1ZSwKICAgIGNsaWVudFk6IHRydWUsCiAgICBvZmZzZXRYOiB0cnVlLAogICAgb2Zmc2V0WTogdHJ1ZSwKICAgIHBvaW50ZXJJZDogdHJ1ZSwKICAgIHBvaW50ZXJUeXBlOiB0cnVlLAogICAgc2NyZWVuWDogdHJ1ZSwKICAgIHNjcmVlblk6IHRydWUsCiAgICB0YXJnZXRUb3VjaGVzOiB0cnVlLAogICAgdG9FbGVtZW50OiB0cnVlLAogICAgdG91Y2hlczogdHJ1ZSwKICAgIHdoaWNoOiBmdW5jdGlvbiB3aGljaChldmVudCkgewogICAgICB2YXIgYnV0dG9uID0gZXZlbnQuYnV0dG9uOwoKICAgICAgLy8gQWRkIHdoaWNoIGZvciBrZXkgZXZlbnRzCiAgICAgIGlmIChldmVudC53aGljaCA9PSBudWxsICYmIHJrZXlFdmVudC50ZXN0KGV2ZW50LnR5cGUpKSB7CiAgICAgICAgcmV0dXJuIGV2ZW50LmNoYXJDb2RlICE9IG51bGwgPyBldmVudC5jaGFyQ29kZSA6IGV2ZW50LmtleUNvZGU7CiAgICAgIH0KCiAgICAgIC8vIEFkZCB3aGljaCBmb3IgY2xpY2s6IDEgPT09IGxlZnQ7IDIgPT09IG1pZGRsZTsgMyA9PT0gcmlnaHQKICAgICAgaWYgKCFldmVudC53aGljaCAmJiBidXR0b24gIT09IHVuZGVmaW5lZCAmJiBybW91c2VFdmVudC50ZXN0KGV2ZW50LnR5cGUpKSB7CiAgICAgICAgaWYgKGJ1dHRvbiAmIDEpIHsKICAgICAgICAgIHJldHVybiAxOwogICAgICAgIH0KICAgICAgICBpZiAoYnV0dG9uICYgMikgewogICAgICAgICAgcmV0dXJuIDM7CiAgICAgICAgfQogICAgICAgIGlmIChidXR0b24gJiA0KSB7CiAgICAgICAgICByZXR1cm4gMjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50LndoaWNoOwogICAgfQogIH0sIGpRdWVyeS5ldmVudC5hZGRQcm9wKTsKICBqUXVlcnkuZWFjaCh7CiAgICBmb2N1czogImZvY3VzaW4iLAogICAgYmx1cjogImZvY3Vzb3V0IgogIH0sIGZ1bmN0aW9uICh0eXBlLCBkZWxlZ2F0ZVR5cGUpIHsKICAgIGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdID0gewogICAgICAvLyBVdGlsaXplIG5hdGl2ZSBldmVudCBpZiBwb3NzaWJsZSBzbyBibHVyL2ZvY3VzIHNlcXVlbmNlIGlzIGNvcnJlY3QKICAgICAgc2V0dXA6IGZ1bmN0aW9uIHNldHVwKCkgewogICAgICAgIC8vIENsYWltIHRoZSBmaXJzdCBoYW5kbGVyCiAgICAgICAgLy8gZGF0YVByaXYuc2V0KCB0aGlzLCAiZm9jdXMiLCAuLi4gKQogICAgICAgIC8vIGRhdGFQcml2LnNldCggdGhpcywgImJsdXIiLCAuLi4gKQogICAgICAgIGxldmVyYWdlTmF0aXZlKHRoaXMsIHR5cGUsIGV4cGVjdFN5bmMpOwoKICAgICAgICAvLyBSZXR1cm4gZmFsc2UgdG8gYWxsb3cgbm9ybWFsIHByb2Nlc3NpbmcgaW4gdGhlIGNhbGxlcgogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgdHJpZ2dlcjogZnVuY3Rpb24gdHJpZ2dlcigpIHsKICAgICAgICAvLyBGb3JjZSBzZXR1cCBiZWZvcmUgdHJpZ2dlcgogICAgICAgIGxldmVyYWdlTmF0aXZlKHRoaXMsIHR5cGUpOwoKICAgICAgICAvLyBSZXR1cm4gbm9uLWZhbHNlIHRvIGFsbG93IG5vcm1hbCBldmVudC1wYXRoIHByb3BhZ2F0aW9uCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0sCiAgICAgIGRlbGVnYXRlVHlwZTogZGVsZWdhdGVUeXBlCiAgICB9OwogIH0pOwoKICAvLyBDcmVhdGUgbW91c2VlbnRlci9sZWF2ZSBldmVudHMgdXNpbmcgbW91c2VvdmVyL291dCBhbmQgZXZlbnQtdGltZSBjaGVja3MKICAvLyBzbyB0aGF0IGV2ZW50IGRlbGVnYXRpb24gd29ya3MgaW4galF1ZXJ5LgogIC8vIERvIHRoZSBzYW1lIGZvciBwb2ludGVyZW50ZXIvcG9pbnRlcmxlYXZlIGFuZCBwb2ludGVyb3Zlci9wb2ludGVyb3V0CiAgLy8KICAvLyBTdXBwb3J0OiBTYWZhcmkgNyBvbmx5CiAgLy8gU2FmYXJpIHNlbmRzIG1vdXNlZW50ZXIgdG9vIG9mdGVuOyBzZWU6CiAgLy8gaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NDcwMjU4CiAgLy8gZm9yIHRoZSBkZXNjcmlwdGlvbiBvZiB0aGUgYnVnIChpdCBleGlzdGVkIGluIG9sZGVyIENocm9tZSB2ZXJzaW9ucyBhcyB3ZWxsKS4KICBqUXVlcnkuZWFjaCh7CiAgICBtb3VzZWVudGVyOiAibW91c2VvdmVyIiwKICAgIG1vdXNlbGVhdmU6ICJtb3VzZW91dCIsCiAgICBwb2ludGVyZW50ZXI6ICJwb2ludGVyb3ZlciIsCiAgICBwb2ludGVybGVhdmU6ICJwb2ludGVyb3V0IgogIH0sIGZ1bmN0aW9uIChvcmlnLCBmaXgpIHsKICAgIGpRdWVyeS5ldmVudC5zcGVjaWFsW29yaWddID0gewogICAgICBkZWxlZ2F0ZVR5cGU6IGZpeCwKICAgICAgYmluZFR5cGU6IGZpeCwKICAgICAgaGFuZGxlOiBmdW5jdGlvbiBoYW5kbGUoZXZlbnQpIHsKICAgICAgICB2YXIgcmV0LAogICAgICAgICAgdGFyZ2V0ID0gdGhpcywKICAgICAgICAgIHJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0LAogICAgICAgICAgaGFuZGxlT2JqID0gZXZlbnQuaGFuZGxlT2JqOwoKICAgICAgICAvLyBGb3IgbW91c2VlbnRlci9sZWF2ZSBjYWxsIHRoZSBoYW5kbGVyIGlmIHJlbGF0ZWQgaXMgb3V0c2lkZSB0aGUgdGFyZ2V0LgogICAgICAgIC8vIE5COiBObyByZWxhdGVkVGFyZ2V0IGlmIHRoZSBtb3VzZSBsZWZ0L2VudGVyZWQgdGhlIGJyb3dzZXIgd2luZG93CiAgICAgICAgaWYgKCFyZWxhdGVkIHx8IHJlbGF0ZWQgIT09IHRhcmdldCAmJiAhalF1ZXJ5LmNvbnRhaW5zKHRhcmdldCwgcmVsYXRlZCkpIHsKICAgICAgICAgIGV2ZW50LnR5cGUgPSBoYW5kbGVPYmoub3JpZ1R5cGU7CiAgICAgICAgICByZXQgPSBoYW5kbGVPYmouaGFuZGxlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgZXZlbnQudHlwZSA9IGZpeDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJldDsKICAgICAgfQogICAgfTsKICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIG9uOiBmdW5jdGlvbiBvbih0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuKSB7CiAgICAgIHJldHVybiBfb24odGhpcywgdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbik7CiAgICB9LAogICAgb25lOiBmdW5jdGlvbiBvbmUodHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbikgewogICAgICByZXR1cm4gX29uKHRoaXMsIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIDEpOwogICAgfSwKICAgIG9mZjogZnVuY3Rpb24gb2ZmKHR5cGVzLCBzZWxlY3RvciwgZm4pIHsKICAgICAgdmFyIGhhbmRsZU9iaiwgdHlwZTsKICAgICAgaWYgKHR5cGVzICYmIHR5cGVzLnByZXZlbnREZWZhdWx0ICYmIHR5cGVzLmhhbmRsZU9iaikgewogICAgICAgIC8vICggZXZlbnQgKSAgZGlzcGF0Y2hlZCBqUXVlcnkuRXZlbnQKICAgICAgICBoYW5kbGVPYmogPSB0eXBlcy5oYW5kbGVPYmo7CiAgICAgICAgalF1ZXJ5KHR5cGVzLmRlbGVnYXRlVGFyZ2V0KS5vZmYoaGFuZGxlT2JqLm5hbWVzcGFjZSA/IGhhbmRsZU9iai5vcmlnVHlwZSArICIuIiArIGhhbmRsZU9iai5uYW1lc3BhY2UgOiBoYW5kbGVPYmoub3JpZ1R5cGUsIGhhbmRsZU9iai5zZWxlY3RvciwgaGFuZGxlT2JqLmhhbmRsZXIpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIGlmIChfdHlwZW9mKHR5cGVzKSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAvLyAoIHR5cGVzLW9iamVjdCBbLCBzZWxlY3Rvcl0gKQogICAgICAgIGZvciAodHlwZSBpbiB0eXBlcykgewogICAgICAgICAgdGhpcy5vZmYodHlwZSwgc2VsZWN0b3IsIHR5cGVzW3R5cGVdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgaWYgKHNlbGVjdG9yID09PSBmYWxzZSB8fCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAvLyAoIHR5cGVzIFssIGZuXSApCiAgICAgICAgZm4gPSBzZWxlY3RvcjsKICAgICAgICBzZWxlY3RvciA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICBpZiAoZm4gPT09IGZhbHNlKSB7CiAgICAgICAgZm4gPSByZXR1cm5GYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKHRoaXMsIHR5cGVzLCBmbiwgc2VsZWN0b3IpOwogICAgICB9KTsKICAgIH0KICB9KTsKICB2YXIKICAgIC8vIFN1cHBvcnQ6IElFIDw9MTAgLSAxMSwgRWRnZSAxMiAtIDEzIG9ubHkKICAgIC8vIEluIElFL0VkZ2UgdXNpbmcgcmVnZXggZ3JvdXBzIGhlcmUgY2F1c2VzIHNldmVyZSBzbG93ZG93bnMuCiAgICAvLyBTZWUgaHR0cHM6Ly9jb25uZWN0Lm1pY3Jvc29mdC5jb20vSUUvZmVlZGJhY2svZGV0YWlscy8xNzM2NTEyLwogICAgcm5vSW5uZXJodG1sID0gLzxzY3JpcHR8PHN0eWxlfDxsaW5rL2ksCiAgICAvLyBjaGVja2VkPSJjaGVja2VkIiBvciBjaGVja2VkCiAgICByY2hlY2tlZCA9IC9jaGVja2VkXHMqKD86W149XXw9XHMqLmNoZWNrZWQuKS9pLAogICAgcmNsZWFuU2NyaXB0ID0gL15ccyo8ISg/OlxbQ0RBVEFcW3wtLSl8KD86XF1cXXwtLSk+XHMqJC9nOwoKICAvLyBQcmVmZXIgYSB0Ym9keSBvdmVyIGl0cyBwYXJlbnQgdGFibGUgZm9yIGNvbnRhaW5pbmcgbmV3IHJvd3MKICBmdW5jdGlvbiBtYW5pcHVsYXRpb25UYXJnZXQoZWxlbSwgY29udGVudCkgewogICAgaWYgKG5vZGVOYW1lKGVsZW0sICJ0YWJsZSIpICYmIG5vZGVOYW1lKGNvbnRlbnQubm9kZVR5cGUgIT09IDExID8gY29udGVudCA6IGNvbnRlbnQuZmlyc3RDaGlsZCwgInRyIikpIHsKICAgICAgcmV0dXJuIGpRdWVyeShlbGVtKS5jaGlsZHJlbigidGJvZHkiKVswXSB8fCBlbGVtOwogICAgfQogICAgcmV0dXJuIGVsZW07CiAgfQoKICAvLyBSZXBsYWNlL3Jlc3RvcmUgdGhlIHR5cGUgYXR0cmlidXRlIG9mIHNjcmlwdCBlbGVtZW50cyBmb3Igc2FmZSBET00gbWFuaXB1bGF0aW9uCiAgZnVuY3Rpb24gZGlzYWJsZVNjcmlwdChlbGVtKSB7CiAgICBlbGVtLnR5cGUgPSAoZWxlbS5nZXRBdHRyaWJ1dGUoInR5cGUiKSAhPT0gbnVsbCkgKyAiLyIgKyBlbGVtLnR5cGU7CiAgICByZXR1cm4gZWxlbTsKICB9CiAgZnVuY3Rpb24gcmVzdG9yZVNjcmlwdChlbGVtKSB7CiAgICBpZiAoKGVsZW0udHlwZSB8fCAiIikuc2xpY2UoMCwgNSkgPT09ICJ0cnVlLyIpIHsKICAgICAgZWxlbS50eXBlID0gZWxlbS50eXBlLnNsaWNlKDUpOwogICAgfSBlbHNlIHsKICAgICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUoInR5cGUiKTsKICAgIH0KICAgIHJldHVybiBlbGVtOwogIH0KICBmdW5jdGlvbiBjbG9uZUNvcHlFdmVudChzcmMsIGRlc3QpIHsKICAgIHZhciBpLCBsLCB0eXBlLCBwZGF0YU9sZCwgdWRhdGFPbGQsIHVkYXRhQ3VyLCBldmVudHM7CiAgICBpZiAoZGVzdC5ub2RlVHlwZSAhPT0gMSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gMS4gQ29weSBwcml2YXRlIGRhdGE6IGV2ZW50cywgaGFuZGxlcnMsIGV0Yy4KICAgIGlmIChkYXRhUHJpdi5oYXNEYXRhKHNyYykpIHsKICAgICAgcGRhdGFPbGQgPSBkYXRhUHJpdi5nZXQoc3JjKTsKICAgICAgZXZlbnRzID0gcGRhdGFPbGQuZXZlbnRzOwogICAgICBpZiAoZXZlbnRzKSB7CiAgICAgICAgZGF0YVByaXYucmVtb3ZlKGRlc3QsICJoYW5kbGUgZXZlbnRzIik7CiAgICAgICAgZm9yICh0eXBlIGluIGV2ZW50cykgewogICAgICAgICAgZm9yIChpID0gMCwgbCA9IGV2ZW50c1t0eXBlXS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZChkZXN0LCB0eXBlLCBldmVudHNbdHlwZV1baV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIDIuIENvcHkgdXNlciBkYXRhCiAgICBpZiAoZGF0YVVzZXIuaGFzRGF0YShzcmMpKSB7CiAgICAgIHVkYXRhT2xkID0gZGF0YVVzZXIuYWNjZXNzKHNyYyk7CiAgICAgIHVkYXRhQ3VyID0galF1ZXJ5LmV4dGVuZCh7fSwgdWRhdGFPbGQpOwogICAgICBkYXRhVXNlci5zZXQoZGVzdCwgdWRhdGFDdXIpOwogICAgfQogIH0KCiAgLy8gRml4IElFIGJ1Z3MsIHNlZSBzdXBwb3J0IHRlc3RzCiAgZnVuY3Rpb24gZml4SW5wdXQoc3JjLCBkZXN0KSB7CiAgICB2YXIgbm9kZU5hbWUgPSBkZXN0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgogICAgLy8gRmFpbHMgdG8gcGVyc2lzdCB0aGUgY2hlY2tlZCBzdGF0ZSBvZiBhIGNsb25lZCBjaGVja2JveCBvciByYWRpbyBidXR0b24uCiAgICBpZiAobm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgcmNoZWNrYWJsZVR5cGUudGVzdChzcmMudHlwZSkpIHsKICAgICAgZGVzdC5jaGVja2VkID0gc3JjLmNoZWNrZWQ7CgogICAgICAvLyBGYWlscyB0byByZXR1cm4gdGhlIHNlbGVjdGVkIG9wdGlvbiB0byB0aGUgZGVmYXVsdCBzZWxlY3RlZCBzdGF0ZSB3aGVuIGNsb25pbmcgb3B0aW9ucwogICAgfSBlbHNlIGlmIChub2RlTmFtZSA9PT0gImlucHV0IiB8fCBub2RlTmFtZSA9PT0gInRleHRhcmVhIikgewogICAgICBkZXN0LmRlZmF1bHRWYWx1ZSA9IHNyYy5kZWZhdWx0VmFsdWU7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGRvbU1hbmlwKGNvbGxlY3Rpb24sIGFyZ3MsIGNhbGxiYWNrLCBpZ25vcmVkKSB7CiAgICAvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCiAgICBhcmdzID0gZmxhdChhcmdzKTsKICAgIHZhciBmcmFnbWVudCwKICAgICAgZmlyc3QsCiAgICAgIHNjcmlwdHMsCiAgICAgIGhhc1NjcmlwdHMsCiAgICAgIG5vZGUsCiAgICAgIGRvYywKICAgICAgaSA9IDAsCiAgICAgIGwgPSBjb2xsZWN0aW9uLmxlbmd0aCwKICAgICAgaU5vQ2xvbmUgPSBsIC0gMSwKICAgICAgdmFsdWUgPSBhcmdzWzBdLAogICAgICB2YWx1ZUlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uKHZhbHVlKTsKCiAgICAvLyBXZSBjYW4ndCBjbG9uZU5vZGUgZnJhZ21lbnRzIHRoYXQgY29udGFpbiBjaGVja2VkLCBpbiBXZWJLaXQKICAgIGlmICh2YWx1ZUlzRnVuY3Rpb24gfHwgbCA+IDEgJiYgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiAhc3VwcG9ydC5jaGVja0Nsb25lICYmIHJjaGVja2VkLnRlc3QodmFsdWUpKSB7CiAgICAgIHJldHVybiBjb2xsZWN0aW9uLmVhY2goZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgdmFyIHNlbGYgPSBjb2xsZWN0aW9uLmVxKGluZGV4KTsKICAgICAgICBpZiAodmFsdWVJc0Z1bmN0aW9uKSB7CiAgICAgICAgICBhcmdzWzBdID0gdmFsdWUuY2FsbCh0aGlzLCBpbmRleCwgc2VsZi5odG1sKCkpOwogICAgICAgIH0KICAgICAgICBkb21NYW5pcChzZWxmLCBhcmdzLCBjYWxsYmFjaywgaWdub3JlZCk7CiAgICAgIH0pOwogICAgfQogICAgaWYgKGwpIHsKICAgICAgZnJhZ21lbnQgPSBidWlsZEZyYWdtZW50KGFyZ3MsIGNvbGxlY3Rpb25bMF0ub3duZXJEb2N1bWVudCwgZmFsc2UsIGNvbGxlY3Rpb24sIGlnbm9yZWQpOwogICAgICBmaXJzdCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7CiAgICAgIGlmIChmcmFnbWVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIGZyYWdtZW50ID0gZmlyc3Q7CiAgICAgIH0KCiAgICAgIC8vIFJlcXVpcmUgZWl0aGVyIG5ldyBjb250ZW50IG9yIGFuIGludGVyZXN0IGluIGlnbm9yZWQgZWxlbWVudHMgdG8gaW52b2tlIHRoZSBjYWxsYmFjawogICAgICBpZiAoZmlyc3QgfHwgaWdub3JlZCkgewogICAgICAgIHNjcmlwdHMgPSBqUXVlcnkubWFwKGdldEFsbChmcmFnbWVudCwgInNjcmlwdCIpLCBkaXNhYmxlU2NyaXB0KTsKICAgICAgICBoYXNTY3JpcHRzID0gc2NyaXB0cy5sZW5ndGg7CgogICAgICAgIC8vIFVzZSB0aGUgb3JpZ2luYWwgZnJhZ21lbnQgZm9yIHRoZSBsYXN0IGl0ZW0KICAgICAgICAvLyBpbnN0ZWFkIG9mIHRoZSBmaXJzdCBiZWNhdXNlIGl0IGNhbiBlbmQgdXAKICAgICAgICAvLyBiZWluZyBlbXB0aWVkIGluY29ycmVjdGx5IGluIGNlcnRhaW4gc2l0dWF0aW9ucyAoIzgwNzApLgogICAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBub2RlID0gZnJhZ21lbnQ7CiAgICAgICAgICBpZiAoaSAhPT0gaU5vQ2xvbmUpIHsKICAgICAgICAgICAgbm9kZSA9IGpRdWVyeS5jbG9uZShub2RlLCB0cnVlLCB0cnVlKTsKCiAgICAgICAgICAgIC8vIEtlZXAgcmVmZXJlbmNlcyB0byBjbG9uZWQgc2NyaXB0cyBmb3IgbGF0ZXIgcmVzdG9yYXRpb24KICAgICAgICAgICAgaWYgKGhhc1NjcmlwdHMpIHsKICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wIG9ubHksIFBoYW50b21KUyAxIG9ubHkKICAgICAgICAgICAgICAvLyBwdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzIG9uIGFuY2llbnQgV2ViS2l0CiAgICAgICAgICAgICAgalF1ZXJ5Lm1lcmdlKHNjcmlwdHMsIGdldEFsbChub2RlLCAic2NyaXB0IikpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjay5jYWxsKGNvbGxlY3Rpb25baV0sIG5vZGUsIGkpOwogICAgICAgIH0KICAgICAgICBpZiAoaGFzU2NyaXB0cykgewogICAgICAgICAgZG9jID0gc2NyaXB0c1tzY3JpcHRzLmxlbmd0aCAtIDFdLm93bmVyRG9jdW1lbnQ7CgogICAgICAgICAgLy8gUmVlbmFibGUgc2NyaXB0cwogICAgICAgICAgalF1ZXJ5Lm1hcChzY3JpcHRzLCByZXN0b3JlU2NyaXB0KTsKCiAgICAgICAgICAvLyBFdmFsdWF0ZSBleGVjdXRhYmxlIHNjcmlwdHMgb24gZmlyc3QgZG9jdW1lbnQgaW5zZXJ0aW9uCiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaGFzU2NyaXB0czsgaSsrKSB7CiAgICAgICAgICAgIG5vZGUgPSBzY3JpcHRzW2ldOwogICAgICAgICAgICBpZiAocnNjcmlwdFR5cGUudGVzdChub2RlLnR5cGUgfHwgIiIpICYmICFkYXRhUHJpdi5hY2Nlc3Mobm9kZSwgImdsb2JhbEV2YWwiKSAmJiBqUXVlcnkuY29udGFpbnMoZG9jLCBub2RlKSkgewogICAgICAgICAgICAgIGlmIChub2RlLnNyYyAmJiAobm9kZS50eXBlIHx8ICIiKS50b0xvd2VyQ2FzZSgpICE9PSAibW9kdWxlIikgewogICAgICAgICAgICAgICAgLy8gT3B0aW9uYWwgQUpBWCBkZXBlbmRlbmN5LCBidXQgd29uJ3QgcnVuIHNjcmlwdHMgaWYgbm90IHByZXNlbnQKICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuX2V2YWxVcmwgJiYgIW5vZGUubm9Nb2R1bGUpIHsKICAgICAgICAgICAgICAgICAgalF1ZXJ5Ll9ldmFsVXJsKG5vZGUuc3JjLCB7CiAgICAgICAgICAgICAgICAgICAgbm9uY2U6IG5vZGUubm9uY2UgfHwgbm9kZS5nZXRBdHRyaWJ1dGUoIm5vbmNlIikKICAgICAgICAgICAgICAgICAgfSwgZG9jKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgRE9NRXZhbChub2RlLnRleHRDb250ZW50LnJlcGxhY2UocmNsZWFuU2NyaXB0LCAiIiksIG5vZGUsIGRvYyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gY29sbGVjdGlvbjsKICB9CiAgZnVuY3Rpb24gX3JlbW92ZShlbGVtLCBzZWxlY3Rvciwga2VlcERhdGEpIHsKICAgIHZhciBub2RlLAogICAgICBub2RlcyA9IHNlbGVjdG9yID8galF1ZXJ5LmZpbHRlcihzZWxlY3RvciwgZWxlbSkgOiBlbGVtLAogICAgICBpID0gMDsKICAgIGZvciAoOyAobm9kZSA9IG5vZGVzW2ldKSAhPSBudWxsOyBpKyspIHsKICAgICAgaWYgKCFrZWVwRGF0YSAmJiBub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgalF1ZXJ5LmNsZWFuRGF0YShnZXRBbGwobm9kZSkpOwogICAgICB9CiAgICAgIGlmIChub2RlLnBhcmVudE5vZGUpIHsKICAgICAgICBpZiAoa2VlcERhdGEgJiYgaXNBdHRhY2hlZChub2RlKSkgewogICAgICAgICAgc2V0R2xvYmFsRXZhbChnZXRBbGwobm9kZSwgInNjcmlwdCIpKTsKICAgICAgICB9CiAgICAgICAgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZWxlbTsKICB9CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICBodG1sUHJlZmlsdGVyOiBmdW5jdGlvbiBodG1sUHJlZmlsdGVyKGh0bWwpIHsKICAgICAgcmV0dXJuIGh0bWw7CiAgICB9LAogICAgY2xvbmU6IGZ1bmN0aW9uIGNsb25lKGVsZW0sIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzKSB7CiAgICAgIHZhciBpLAogICAgICAgIGwsCiAgICAgICAgc3JjRWxlbWVudHMsCiAgICAgICAgZGVzdEVsZW1lbnRzLAogICAgICAgIGNsb25lID0gZWxlbS5jbG9uZU5vZGUodHJ1ZSksCiAgICAgICAgaW5QYWdlID0gaXNBdHRhY2hlZChlbGVtKTsKCiAgICAgIC8vIEZpeCBJRSBjbG9uaW5nIGlzc3VlcwogICAgICBpZiAoIXN1cHBvcnQubm9DbG9uZUNoZWNrZWQgJiYgKGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgZWxlbS5ub2RlVHlwZSA9PT0gMTEpICYmICFqUXVlcnkuaXNYTUxEb2MoZWxlbSkpIHsKICAgICAgICAvLyBXZSBlc2NoZXcgU2l6emxlIGhlcmUgZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnM6IGh0dHBzOi8vanNwZXJmLmNvbS9nZXRhbGwtdnMtc2l6emxlLzIKICAgICAgICBkZXN0RWxlbWVudHMgPSBnZXRBbGwoY2xvbmUpOwogICAgICAgIHNyY0VsZW1lbnRzID0gZ2V0QWxsKGVsZW0pOwogICAgICAgIGZvciAoaSA9IDAsIGwgPSBzcmNFbGVtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIGZpeElucHV0KHNyY0VsZW1lbnRzW2ldLCBkZXN0RWxlbWVudHNbaV0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQ29weSB0aGUgZXZlbnRzIGZyb20gdGhlIG9yaWdpbmFsIHRvIHRoZSBjbG9uZQogICAgICBpZiAoZGF0YUFuZEV2ZW50cykgewogICAgICAgIGlmIChkZWVwRGF0YUFuZEV2ZW50cykgewogICAgICAgICAgc3JjRWxlbWVudHMgPSBzcmNFbGVtZW50cyB8fCBnZXRBbGwoZWxlbSk7CiAgICAgICAgICBkZXN0RWxlbWVudHMgPSBkZXN0RWxlbWVudHMgfHwgZ2V0QWxsKGNsb25lKTsKICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBzcmNFbGVtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgY2xvbmVDb3B5RXZlbnQoc3JjRWxlbWVudHNbaV0sIGRlc3RFbGVtZW50c1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNsb25lQ29weUV2ZW50KGVsZW0sIGNsb25lKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFByZXNlcnZlIHNjcmlwdCBldmFsdWF0aW9uIGhpc3RvcnkKICAgICAgZGVzdEVsZW1lbnRzID0gZ2V0QWxsKGNsb25lLCAic2NyaXB0Iik7CiAgICAgIGlmIChkZXN0RWxlbWVudHMubGVuZ3RoID4gMCkgewogICAgICAgIHNldEdsb2JhbEV2YWwoZGVzdEVsZW1lbnRzLCAhaW5QYWdlICYmIGdldEFsbChlbGVtLCAic2NyaXB0IikpOwogICAgICB9CgogICAgICAvLyBSZXR1cm4gdGhlIGNsb25lZCBzZXQKICAgICAgcmV0dXJuIGNsb25lOwogICAgfSwKICAgIGNsZWFuRGF0YTogZnVuY3Rpb24gY2xlYW5EYXRhKGVsZW1zKSB7CiAgICAgIHZhciBkYXRhLAogICAgICAgIGVsZW0sCiAgICAgICAgdHlwZSwKICAgICAgICBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWwsCiAgICAgICAgaSA9IDA7CiAgICAgIGZvciAoOyAoZWxlbSA9IGVsZW1zW2ldKSAhPT0gdW5kZWZpbmVkOyBpKyspIHsKICAgICAgICBpZiAoYWNjZXB0RGF0YShlbGVtKSkgewogICAgICAgICAgaWYgKGRhdGEgPSBlbGVtW2RhdGFQcml2LmV4cGFuZG9dKSB7CiAgICAgICAgICAgIGlmIChkYXRhLmV2ZW50cykgewogICAgICAgICAgICAgIGZvciAodHlwZSBpbiBkYXRhLmV2ZW50cykgewogICAgICAgICAgICAgICAgaWYgKHNwZWNpYWxbdHlwZV0pIHsKICAgICAgICAgICAgICAgICAgalF1ZXJ5LmV2ZW50LnJlbW92ZShlbGVtLCB0eXBlKTsKCiAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBzaG9ydGN1dCB0byBhdm9pZCBqUXVlcnkuZXZlbnQucmVtb3ZlJ3Mgb3ZlcmhlYWQKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGpRdWVyeS5yZW1vdmVFdmVudChlbGVtLCB0eXBlLCBkYXRhLmhhbmRsZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTdXBwb3J0OiBDaHJvbWUgPD0zNSAtIDQ1KwogICAgICAgICAgICAvLyBBc3NpZ24gdW5kZWZpbmVkIGluc3RlYWQgb2YgdXNpbmcgZGVsZXRlLCBzZWUgRGF0YSNyZW1vdmUKICAgICAgICAgICAgZWxlbVtkYXRhUHJpdi5leHBhbmRvXSA9IHVuZGVmaW5lZDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlbGVtW2RhdGFVc2VyLmV4cGFuZG9dKSB7CiAgICAgICAgICAgIC8vIFN1cHBvcnQ6IENocm9tZSA8PTM1IC0gNDUrCiAgICAgICAgICAgIC8vIEFzc2lnbiB1bmRlZmluZWQgaW5zdGVhZCBvZiB1c2luZyBkZWxldGUsIHNlZSBEYXRhI3JlbW92ZQogICAgICAgICAgICBlbGVtW2RhdGFVc2VyLmV4cGFuZG9dID0gdW5kZWZpbmVkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgZGV0YWNoOiBmdW5jdGlvbiBkZXRhY2goc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIF9yZW1vdmUodGhpcywgc2VsZWN0b3IsIHRydWUpOwogICAgfSwKICAgIHJlbW92ZTogZnVuY3Rpb24gcmVtb3ZlKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiBfcmVtb3ZlKHRoaXMsIHNlbGVjdG9yKTsKICAgIH0sCiAgICB0ZXh0OiBmdW5jdGlvbiB0ZXh0KHZhbHVlKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPyBqUXVlcnkudGV4dCh0aGlzKSA6IHRoaXMuZW1wdHkoKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgICAgdGhpcy50ZXh0Q29udGVudCA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCk7CiAgICB9LAogICAgYXBwZW5kOiBmdW5jdGlvbiBhcHBlbmQoKSB7CiAgICAgIHJldHVybiBkb21NYW5pcCh0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSkgewogICAgICAgICAgdmFyIHRhcmdldCA9IG1hbmlwdWxhdGlvblRhcmdldCh0aGlzLCBlbGVtKTsKICAgICAgICAgIHRhcmdldC5hcHBlbmRDaGlsZChlbGVtKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIHByZXBlbmQ6IGZ1bmN0aW9uIHByZXBlbmQoKSB7CiAgICAgIHJldHVybiBkb21NYW5pcCh0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSkgewogICAgICAgICAgdmFyIHRhcmdldCA9IG1hbmlwdWxhdGlvblRhcmdldCh0aGlzLCBlbGVtKTsKICAgICAgICAgIHRhcmdldC5pbnNlcnRCZWZvcmUoZWxlbSwgdGFyZ2V0LmZpcnN0Q2hpbGQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgYmVmb3JlOiBmdW5jdGlvbiBiZWZvcmUoKSB7CiAgICAgIHJldHVybiBkb21NYW5pcCh0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSkgewogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZShlbGVtLCB0aGlzKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGFmdGVyOiBmdW5jdGlvbiBhZnRlcigpIHsKICAgICAgcmV0dXJuIGRvbU1hbmlwKHRoaXMsIGFyZ3VtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICBpZiAodGhpcy5wYXJlbnROb2RlKSB7CiAgICAgICAgICB0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGVsZW0sIHRoaXMubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgZW1wdHk6IGZ1bmN0aW9uIGVtcHR5KCkgewogICAgICB2YXIgZWxlbSwKICAgICAgICBpID0gMDsKICAgICAgZm9yICg7IChlbGVtID0gdGhpc1tpXSkgIT0gbnVsbDsgaSsrKSB7CiAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgIC8vIFByZXZlbnQgbWVtb3J5IGxlYWtzCiAgICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKGdldEFsbChlbGVtLCBmYWxzZSkpOwoKICAgICAgICAgIC8vIFJlbW92ZSBhbnkgcmVtYWluaW5nIG5vZGVzCiAgICAgICAgICBlbGVtLnRleHRDb250ZW50ID0gIiI7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGNsb25lOiBmdW5jdGlvbiBjbG9uZShkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cykgewogICAgICBkYXRhQW5kRXZlbnRzID0gZGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZmFsc2UgOiBkYXRhQW5kRXZlbnRzOwogICAgICBkZWVwRGF0YUFuZEV2ZW50cyA9IGRlZXBEYXRhQW5kRXZlbnRzID09IG51bGwgPyBkYXRhQW5kRXZlbnRzIDogZGVlcERhdGFBbmRFdmVudHM7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5jbG9uZSh0aGlzLCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyk7CiAgICAgIH0pOwogICAgfSwKICAgIGh0bWw6IGZ1bmN0aW9uIGh0bWwodmFsdWUpIHsKICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB2YXIgZWxlbSA9IHRoaXNbMF0gfHwge30sCiAgICAgICAgICBpID0gMCwKICAgICAgICAgIGwgPSB0aGlzLmxlbmd0aDsKICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gZWxlbS5pbm5lckhUTUw7CiAgICAgICAgfQoKICAgICAgICAvLyBTZWUgaWYgd2UgY2FuIHRha2UgYSBzaG9ydGN1dCBhbmQganVzdCB1c2UgaW5uZXJIVE1MCiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgIXJub0lubmVyaHRtbC50ZXN0KHZhbHVlKSAmJiAhd3JhcE1hcFsocnRhZ05hbWUuZXhlYyh2YWx1ZSkgfHwgWyIiLCAiIl0pWzFdLnRvTG93ZXJDYXNlKCldKSB7CiAgICAgICAgICB2YWx1ZSA9IGpRdWVyeS5odG1sUHJlZmlsdGVyKHZhbHVlKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgZWxlbSA9IHRoaXNbaV0gfHwge307CgogICAgICAgICAgICAgIC8vIFJlbW92ZSBlbGVtZW50IG5vZGVzIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrcwogICAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKGdldEFsbChlbGVtLCBmYWxzZSkpOwogICAgICAgICAgICAgICAgZWxlbS5pbm5lckhUTUwgPSB2YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbSA9IDA7CgogICAgICAgICAgICAvLyBJZiB1c2luZyBpbm5lckhUTUwgdGhyb3dzIGFuIGV4Y2VwdGlvbiwgdXNlIHRoZSBmYWxsYmFjayBtZXRob2QKICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgfQogICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICB0aGlzLmVtcHR5KCkuYXBwZW5kKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoKTsKICAgIH0sCiAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24gcmVwbGFjZVdpdGgoKSB7CiAgICAgIHZhciBpZ25vcmVkID0gW107CgogICAgICAvLyBNYWtlIHRoZSBjaGFuZ2VzLCByZXBsYWNpbmcgZWFjaCBub24taWdub3JlZCBjb250ZXh0IGVsZW1lbnQgd2l0aCB0aGUgbmV3IGNvbnRlbnQKICAgICAgcmV0dXJuIGRvbU1hbmlwKHRoaXMsIGFyZ3VtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy5wYXJlbnROb2RlOwogICAgICAgIGlmIChqUXVlcnkuaW5BcnJheSh0aGlzLCBpZ25vcmVkKSA8IDApIHsKICAgICAgICAgIGpRdWVyeS5jbGVhbkRhdGEoZ2V0QWxsKHRoaXMpKTsKICAgICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgICAgcGFyZW50LnJlcGxhY2VDaGlsZChlbGVtLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEZvcmNlIGNhbGxiYWNrIGludm9jYXRpb24KICAgICAgfSwgaWdub3JlZCk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmVhY2goewogICAgYXBwZW5kVG86ICJhcHBlbmQiLAogICAgcHJlcGVuZFRvOiAicHJlcGVuZCIsCiAgICBpbnNlcnRCZWZvcmU6ICJiZWZvcmUiLAogICAgaW5zZXJ0QWZ0ZXI6ICJhZnRlciIsCiAgICByZXBsYWNlQWxsOiAicmVwbGFjZVdpdGgiCiAgfSwgZnVuY3Rpb24gKG5hbWUsIG9yaWdpbmFsKSB7CiAgICBqUXVlcnkuZm5bbmFtZV0gPSBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgdmFyIGVsZW1zLAogICAgICAgIHJldCA9IFtdLAogICAgICAgIGluc2VydCA9IGpRdWVyeShzZWxlY3RvciksCiAgICAgICAgbGFzdCA9IGluc2VydC5sZW5ndGggLSAxLAogICAgICAgIGkgPSAwOwogICAgICBmb3IgKDsgaSA8PSBsYXN0OyBpKyspIHsKICAgICAgICBlbGVtcyA9IGkgPT09IGxhc3QgPyB0aGlzIDogdGhpcy5jbG9uZSh0cnVlKTsKICAgICAgICBqUXVlcnkoaW5zZXJ0W2ldKVtvcmlnaW5hbF0oZWxlbXMpOwoKICAgICAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wIG9ubHksIFBoYW50b21KUyAxIG9ubHkKICAgICAgICAvLyAuZ2V0KCkgYmVjYXVzZSBwdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzIG9uIGFuY2llbnQgV2ViS2l0CiAgICAgICAgcHVzaC5hcHBseShyZXQsIGVsZW1zLmdldCgpKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2socmV0KTsKICAgIH07CiAgfSk7CiAgdmFyIHJudW1ub25weCA9IG5ldyBSZWdFeHAoIl4oIiArIHBudW0gKyAiKSg/IXB4KVthLXolXSskIiwgImkiKTsKICB2YXIgZ2V0U3R5bGVzID0gZnVuY3Rpb24gZ2V0U3R5bGVzKGVsZW0pIHsKICAgIC8vIFN1cHBvcnQ6IElFIDw9MTEgb25seSwgRmlyZWZveCA8PTMwICgjMTUwOTgsICMxNDE1MCkKICAgIC8vIElFIHRocm93cyBvbiBlbGVtZW50cyBjcmVhdGVkIGluIHBvcHVwcwogICAgLy8gRkYgbWVhbndoaWxlIHRocm93cyBvbiBmcmFtZSBlbGVtZW50cyB0aHJvdWdoICJkZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlIgogICAgdmFyIHZpZXcgPSBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXc7CiAgICBpZiAoIXZpZXcgfHwgIXZpZXcub3BlbmVyKSB7CiAgICAgIHZpZXcgPSB3aW5kb3c7CiAgICB9CiAgICByZXR1cm4gdmlldy5nZXRDb21wdXRlZFN0eWxlKGVsZW0pOwogIH07CiAgdmFyIHN3YXAgPSBmdW5jdGlvbiBzd2FwKGVsZW0sIG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgICB2YXIgcmV0LAogICAgICBuYW1lLAogICAgICBvbGQgPSB7fTsKCiAgICAvLyBSZW1lbWJlciB0aGUgb2xkIHZhbHVlcywgYW5kIGluc2VydCB0aGUgbmV3IG9uZXMKICAgIGZvciAobmFtZSBpbiBvcHRpb25zKSB7CiAgICAgIG9sZFtuYW1lXSA9IGVsZW0uc3R5bGVbbmFtZV07CiAgICAgIGVsZW0uc3R5bGVbbmFtZV0gPSBvcHRpb25zW25hbWVdOwogICAgfQogICAgcmV0ID0gY2FsbGJhY2suY2FsbChlbGVtKTsKCiAgICAvLyBSZXZlcnQgdGhlIG9sZCB2YWx1ZXMKICAgIGZvciAobmFtZSBpbiBvcHRpb25zKSB7CiAgICAgIGVsZW0uc3R5bGVbbmFtZV0gPSBvbGRbbmFtZV07CiAgICB9CiAgICByZXR1cm4gcmV0OwogIH07CiAgdmFyIHJib3hTdHlsZSA9IG5ldyBSZWdFeHAoY3NzRXhwYW5kLmpvaW4oInwiKSwgImkiKTsKICAoZnVuY3Rpb24gKCkgewogICAgLy8gRXhlY3V0aW5nIGJvdGggcGl4ZWxQb3NpdGlvbiAmIGJveFNpemluZ1JlbGlhYmxlIHRlc3RzIHJlcXVpcmUgb25seSBvbmUgbGF5b3V0CiAgICAvLyBzbyB0aGV5J3JlIGV4ZWN1dGVkIGF0IHRoZSBzYW1lIHRpbWUgdG8gc2F2ZSB0aGUgc2Vjb25kIGNvbXB1dGF0aW9uLgogICAgZnVuY3Rpb24gY29tcHV0ZVN0eWxlVGVzdHMoKSB7CiAgICAgIC8vIFRoaXMgaXMgYSBzaW5nbGV0b24sIHdlIG5lZWQgdG8gZXhlY3V0ZSBpdCBvbmx5IG9uY2UKICAgICAgaWYgKCFkaXYpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSAicG9zaXRpb246YWJzb2x1dGU7bGVmdDotMTExMTFweDt3aWR0aDo2MHB4OyIgKyAibWFyZ2luLXRvcDoxcHg7cGFkZGluZzowO2JvcmRlcjowIjsKICAgICAgZGl2LnN0eWxlLmNzc1RleHQgPSAicG9zaXRpb246cmVsYXRpdmU7ZGlzcGxheTpibG9jaztib3gtc2l6aW5nOmJvcmRlci1ib3g7b3ZlcmZsb3c6c2Nyb2xsOyIgKyAibWFyZ2luOmF1dG87Ym9yZGVyOjFweDtwYWRkaW5nOjFweDsiICsgIndpZHRoOjYwJTt0b3A6MSUiOwogICAgICBkb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoY29udGFpbmVyKS5hcHBlbmRDaGlsZChkaXYpOwogICAgICB2YXIgZGl2U3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShkaXYpOwogICAgICBwaXhlbFBvc2l0aW9uVmFsID0gZGl2U3R5bGUudG9wICE9PSAiMSUiOwoKICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCA0LjAgLSA0LjMgb25seSwgRmlyZWZveCA8PTMgLSA0NAogICAgICByZWxpYWJsZU1hcmdpbkxlZnRWYWwgPSByb3VuZFBpeGVsTWVhc3VyZXMoZGl2U3R5bGUubWFyZ2luTGVmdCkgPT09IDEyOwoKICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCA0LjAgLSA0LjMgb25seSwgU2FmYXJpIDw9OS4xIC0gMTAuMSwgaU9TIDw9Ny4wIC0gOS4zCiAgICAgIC8vIFNvbWUgc3R5bGVzIGNvbWUgYmFjayB3aXRoIHBlcmNlbnRhZ2UgdmFsdWVzLCBldmVuIHRob3VnaCB0aGV5IHNob3VsZG4ndAogICAgICBkaXYuc3R5bGUucmlnaHQgPSAiNjAlIjsKICAgICAgcGl4ZWxCb3hTdHlsZXNWYWwgPSByb3VuZFBpeGVsTWVhc3VyZXMoZGl2U3R5bGUucmlnaHQpID09PSAzNjsKCiAgICAgIC8vIFN1cHBvcnQ6IElFIDkgLSAxMSBvbmx5CiAgICAgIC8vIERldGVjdCBtaXNyZXBvcnRpbmcgb2YgY29udGVudCBkaW1lbnNpb25zIGZvciBib3gtc2l6aW5nOmJvcmRlci1ib3ggZWxlbWVudHMKICAgICAgYm94U2l6aW5nUmVsaWFibGVWYWwgPSByb3VuZFBpeGVsTWVhc3VyZXMoZGl2U3R5bGUud2lkdGgpID09PSAzNjsKCiAgICAgIC8vIFN1cHBvcnQ6IElFIDkgb25seQogICAgICAvLyBEZXRlY3Qgb3ZlcmZsb3c6c2Nyb2xsIHNjcmV3aW5lc3MgKGdoLTM2OTkpCiAgICAgIC8vIFN1cHBvcnQ6IENocm9tZSA8PTY0CiAgICAgIC8vIERvbid0IGdldCB0cmlja2VkIHdoZW4gem9vbSBhZmZlY3RzIG9mZnNldFdpZHRoIChnaC00MDI5KQogICAgICBkaXYuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogICAgICBzY3JvbGxib3hTaXplVmFsID0gcm91bmRQaXhlbE1lYXN1cmVzKGRpdi5vZmZzZXRXaWR0aCAvIDMpID09PSAxMjsKICAgICAgZG9jdW1lbnRFbGVtZW50LnJlbW92ZUNoaWxkKGNvbnRhaW5lcik7CgogICAgICAvLyBOdWxsaWZ5IHRoZSBkaXYgc28gaXQgd291bGRuJ3QgYmUgc3RvcmVkIGluIHRoZSBtZW1vcnkgYW5kCiAgICAgIC8vIGl0IHdpbGwgYWxzbyBiZSBhIHNpZ24gdGhhdCBjaGVja3MgYWxyZWFkeSBwZXJmb3JtZWQKICAgICAgZGl2ID0gbnVsbDsKICAgIH0KICAgIGZ1bmN0aW9uIHJvdW5kUGl4ZWxNZWFzdXJlcyhtZWFzdXJlKSB7CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKHBhcnNlRmxvYXQobWVhc3VyZSkpOwogICAgfQogICAgdmFyIHBpeGVsUG9zaXRpb25WYWwsCiAgICAgIGJveFNpemluZ1JlbGlhYmxlVmFsLAogICAgICBzY3JvbGxib3hTaXplVmFsLAogICAgICBwaXhlbEJveFN0eWxlc1ZhbCwKICAgICAgcmVsaWFibGVUckRpbWVuc2lvbnNWYWwsCiAgICAgIHJlbGlhYmxlTWFyZ2luTGVmdFZhbCwKICAgICAgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksCiAgICAgIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoKICAgIC8vIEZpbmlzaCBlYXJseSBpbiBsaW1pdGVkIChub24tYnJvd3NlcikgZW52aXJvbm1lbnRzCiAgICBpZiAoIWRpdi5zdHlsZSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gU3VwcG9ydDogSUUgPD05IC0gMTEgb25seQogICAgLy8gU3R5bGUgb2YgY2xvbmVkIGVsZW1lbnQgYWZmZWN0cyBzb3VyY2UgZWxlbWVudCBjbG9uZWQgKCM4OTA4KQogICAgZGl2LnN0eWxlLmJhY2tncm91bmRDbGlwID0gImNvbnRlbnQtYm94IjsKICAgIGRpdi5jbG9uZU5vZGUodHJ1ZSkuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAiIjsKICAgIHN1cHBvcnQuY2xlYXJDbG9uZVN0eWxlID0gZGl2LnN0eWxlLmJhY2tncm91bmRDbGlwID09PSAiY29udGVudC1ib3giOwogICAgalF1ZXJ5LmV4dGVuZChzdXBwb3J0LCB7CiAgICAgIGJveFNpemluZ1JlbGlhYmxlOiBmdW5jdGlvbiBib3hTaXppbmdSZWxpYWJsZSgpIHsKICAgICAgICBjb21wdXRlU3R5bGVUZXN0cygpOwogICAgICAgIHJldHVybiBib3hTaXppbmdSZWxpYWJsZVZhbDsKICAgICAgfSwKICAgICAgcGl4ZWxCb3hTdHlsZXM6IGZ1bmN0aW9uIHBpeGVsQm94U3R5bGVzKCkgewogICAgICAgIGNvbXB1dGVTdHlsZVRlc3RzKCk7CiAgICAgICAgcmV0dXJuIHBpeGVsQm94U3R5bGVzVmFsOwogICAgICB9LAogICAgICBwaXhlbFBvc2l0aW9uOiBmdW5jdGlvbiBwaXhlbFBvc2l0aW9uKCkgewogICAgICAgIGNvbXB1dGVTdHlsZVRlc3RzKCk7CiAgICAgICAgcmV0dXJuIHBpeGVsUG9zaXRpb25WYWw7CiAgICAgIH0sCiAgICAgIHJlbGlhYmxlTWFyZ2luTGVmdDogZnVuY3Rpb24gcmVsaWFibGVNYXJnaW5MZWZ0KCkgewogICAgICAgIGNvbXB1dGVTdHlsZVRlc3RzKCk7CiAgICAgICAgcmV0dXJuIHJlbGlhYmxlTWFyZ2luTGVmdFZhbDsKICAgICAgfSwKICAgICAgc2Nyb2xsYm94U2l6ZTogZnVuY3Rpb24gc2Nyb2xsYm94U2l6ZSgpIHsKICAgICAgICBjb21wdXRlU3R5bGVUZXN0cygpOwogICAgICAgIHJldHVybiBzY3JvbGxib3hTaXplVmFsOwogICAgICB9LAogICAgICAvLyBTdXBwb3J0OiBJRSA5IC0gMTErLCBFZGdlIDE1IC0gMTgrCiAgICAgIC8vIElFL0VkZ2UgbWlzcmVwb3J0IGBnZXRDb21wdXRlZFN0eWxlYCBvZiB0YWJsZSByb3dzIHdpdGggd2lkdGgvaGVpZ2h0CiAgICAgIC8vIHNldCBpbiBDU1Mgd2hpbGUgYG9mZnNldCpgIHByb3BlcnRpZXMgcmVwb3J0IGNvcnJlY3QgdmFsdWVzLgogICAgICAvLyBCZWhhdmlvciBpbiBJRSA5IGlzIG1vcmUgc3VidGxlIHRoYW4gaW4gbmV3ZXIgdmVyc2lvbnMgJiBpdCBwYXNzZXMKICAgICAgLy8gc29tZSB2ZXJzaW9ucyBvZiB0aGlzIHRlc3Q7IG1ha2Ugc3VyZSBub3QgdG8gbWFrZSBpdCBwYXNzIHRoZXJlIQogICAgICByZWxpYWJsZVRyRGltZW5zaW9uczogZnVuY3Rpb24gcmVsaWFibGVUckRpbWVuc2lvbnMoKSB7CiAgICAgICAgdmFyIHRhYmxlLCB0ciwgdHJDaGlsZCwgdHJTdHlsZTsKICAgICAgICBpZiAocmVsaWFibGVUckRpbWVuc2lvbnNWYWwgPT0gbnVsbCkgewogICAgICAgICAgdGFibGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0YWJsZSIpOwogICAgICAgICAgdHIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ciIpOwogICAgICAgICAgdHJDaGlsZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgdGFibGUuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTtsZWZ0Oi0xMTExMXB4IjsKICAgICAgICAgIHRyLnN0eWxlLmhlaWdodCA9ICIxcHgiOwogICAgICAgICAgdHJDaGlsZC5zdHlsZS5oZWlnaHQgPSAiOXB4IjsKICAgICAgICAgIGRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZCh0YWJsZSkuYXBwZW5kQ2hpbGQodHIpLmFwcGVuZENoaWxkKHRyQ2hpbGQpOwogICAgICAgICAgdHJTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKHRyKTsKICAgICAgICAgIHJlbGlhYmxlVHJEaW1lbnNpb25zVmFsID0gcGFyc2VJbnQodHJTdHlsZS5oZWlnaHQpID4gMzsKICAgICAgICAgIGRvY3VtZW50RWxlbWVudC5yZW1vdmVDaGlsZCh0YWJsZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZWxpYWJsZVRyRGltZW5zaW9uc1ZhbDsKICAgICAgfQogICAgfSk7CiAgfSkoKTsKICBmdW5jdGlvbiBjdXJDU1MoZWxlbSwgbmFtZSwgY29tcHV0ZWQpIHsKICAgIHZhciB3aWR0aCwKICAgICAgbWluV2lkdGgsCiAgICAgIG1heFdpZHRoLAogICAgICByZXQsCiAgICAgIC8vIFN1cHBvcnQ6IEZpcmVmb3ggNTErCiAgICAgIC8vIFJldHJpZXZpbmcgc3R5bGUgYmVmb3JlIGNvbXB1dGVkIHNvbWVob3cKICAgICAgLy8gZml4ZXMgYW4gaXNzdWUgd2l0aCBnZXR0aW5nIHdyb25nIHZhbHVlcwogICAgICAvLyBvbiBkZXRhY2hlZCBlbGVtZW50cwogICAgICBzdHlsZSA9IGVsZW0uc3R5bGU7CiAgICBjb21wdXRlZCA9IGNvbXB1dGVkIHx8IGdldFN0eWxlcyhlbGVtKTsKCiAgICAvLyBnZXRQcm9wZXJ0eVZhbHVlIGlzIG5lZWRlZCBmb3I6CiAgICAvLyAgIC5jc3MoJ2ZpbHRlcicpIChJRSA5IG9ubHksICMxMjUzNykKICAgIC8vICAgLmNzcygnLS1jdXN0b21Qcm9wZXJ0eSkgKCMzMTQ0KQogICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgIHJldCA9IGNvbXB1dGVkLmdldFByb3BlcnR5VmFsdWUobmFtZSkgfHwgY29tcHV0ZWRbbmFtZV07CiAgICAgIGlmIChyZXQgPT09ICIiICYmICFpc0F0dGFjaGVkKGVsZW0pKSB7CiAgICAgICAgcmV0ID0galF1ZXJ5LnN0eWxlKGVsZW0sIG5hbWUpOwogICAgICB9CgogICAgICAvLyBBIHRyaWJ1dGUgdG8gdGhlICJhd2Vzb21lIGhhY2sgYnkgRGVhbiBFZHdhcmRzIgogICAgICAvLyBBbmRyb2lkIEJyb3dzZXIgcmV0dXJucyBwZXJjZW50YWdlIGZvciBzb21lIHZhbHVlcywKICAgICAgLy8gYnV0IHdpZHRoIHNlZW1zIHRvIGJlIHJlbGlhYmx5IHBpeGVscy4KICAgICAgLy8gVGhpcyBpcyBhZ2FpbnN0IHRoZSBDU1NPTSBkcmFmdCBzcGVjOgogICAgICAvLyBodHRwczovL2RyYWZ0cy5jc3N3Zy5vcmcvY3Nzb20vI3Jlc29sdmVkLXZhbHVlcwogICAgICBpZiAoIXN1cHBvcnQucGl4ZWxCb3hTdHlsZXMoKSAmJiBybnVtbm9ucHgudGVzdChyZXQpICYmIHJib3hTdHlsZS50ZXN0KG5hbWUpKSB7CiAgICAgICAgLy8gUmVtZW1iZXIgdGhlIG9yaWdpbmFsIHZhbHVlcwogICAgICAgIHdpZHRoID0gc3R5bGUud2lkdGg7CiAgICAgICAgbWluV2lkdGggPSBzdHlsZS5taW5XaWR0aDsKICAgICAgICBtYXhXaWR0aCA9IHN0eWxlLm1heFdpZHRoOwoKICAgICAgICAvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CiAgICAgICAgc3R5bGUubWluV2lkdGggPSBzdHlsZS5tYXhXaWR0aCA9IHN0eWxlLndpZHRoID0gcmV0OwogICAgICAgIHJldCA9IGNvbXB1dGVkLndpZHRoOwoKICAgICAgICAvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCiAgICAgICAgc3R5bGUud2lkdGggPSB3aWR0aDsKICAgICAgICBzdHlsZS5taW5XaWR0aCA9IG1pbldpZHRoOwogICAgICAgIHN0eWxlLm1heFdpZHRoID0gbWF4V2lkdGg7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXQgIT09IHVuZGVmaW5lZCA/CiAgICAvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSBvbmx5CiAgICAvLyBJRSByZXR1cm5zIHpJbmRleCB2YWx1ZSBhcyBhbiBpbnRlZ2VyLgogICAgcmV0ICsgIiIgOiByZXQ7CiAgfQogIGZ1bmN0aW9uIGFkZEdldEhvb2tJZihjb25kaXRpb25GbiwgaG9va0ZuKSB7CiAgICAvLyBEZWZpbmUgdGhlIGhvb2ssIHdlJ2xsIGNoZWNrIG9uIHRoZSBmaXJzdCBydW4gaWYgaXQncyByZWFsbHkgbmVlZGVkLgogICAgcmV0dXJuIHsKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgaWYgKGNvbmRpdGlvbkZuKCkpIHsKICAgICAgICAgIC8vIEhvb2sgbm90IG5lZWRlZCAob3IgaXQncyBub3QgcG9zc2libGUgdG8gdXNlIGl0IGR1ZQogICAgICAgICAgLy8gdG8gbWlzc2luZyBkZXBlbmRlbmN5KSwgcmVtb3ZlIGl0LgogICAgICAgICAgZGVsZXRlIHRoaXMuZ2V0OwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gSG9vayBuZWVkZWQ7IHJlZGVmaW5lIGl0IHNvIHRoYXQgdGhlIHN1cHBvcnQgdGVzdCBpcyBub3QgZXhlY3V0ZWQgYWdhaW4uCiAgICAgICAgcmV0dXJuICh0aGlzLmdldCA9IGhvb2tGbikuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9CiAgdmFyIGNzc1ByZWZpeGVzID0gWyJXZWJraXQiLCAiTW96IiwgIm1zIl0sCiAgICBlbXB0eVN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iikuc3R5bGUsCiAgICB2ZW5kb3JQcm9wcyA9IHt9OwoKICAvLyBSZXR1cm4gYSB2ZW5kb3ItcHJlZml4ZWQgcHJvcGVydHkgb3IgdW5kZWZpbmVkCiAgZnVuY3Rpb24gdmVuZG9yUHJvcE5hbWUobmFtZSkgewogICAgLy8gQ2hlY2sgZm9yIHZlbmRvciBwcmVmaXhlZCBuYW1lcwogICAgdmFyIGNhcE5hbWUgPSBuYW1lWzBdLnRvVXBwZXJDYXNlKCkgKyBuYW1lLnNsaWNlKDEpLAogICAgICBpID0gY3NzUHJlZml4ZXMubGVuZ3RoOwogICAgd2hpbGUgKGktLSkgewogICAgICBuYW1lID0gY3NzUHJlZml4ZXNbaV0gKyBjYXBOYW1lOwogICAgICBpZiAobmFtZSBpbiBlbXB0eVN0eWxlKSB7CiAgICAgICAgcmV0dXJuIG5hbWU7CiAgICAgIH0KICAgIH0KICB9CgogIC8vIFJldHVybiBhIHBvdGVudGlhbGx5LW1hcHBlZCBqUXVlcnkuY3NzUHJvcHMgb3IgdmVuZG9yIHByZWZpeGVkIHByb3BlcnR5CiAgZnVuY3Rpb24gZmluYWxQcm9wTmFtZShuYW1lKSB7CiAgICB2YXIgZmluYWwgPSBqUXVlcnkuY3NzUHJvcHNbbmFtZV0gfHwgdmVuZG9yUHJvcHNbbmFtZV07CiAgICBpZiAoZmluYWwpIHsKICAgICAgcmV0dXJuIGZpbmFsOwogICAgfQogICAgaWYgKG5hbWUgaW4gZW1wdHlTdHlsZSkgewogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICAgIHJldHVybiB2ZW5kb3JQcm9wc1tuYW1lXSA9IHZlbmRvclByb3BOYW1lKG5hbWUpIHx8IG5hbWU7CiAgfQogIHZhcgogICAgLy8gU3dhcHBhYmxlIGlmIGRpc3BsYXkgaXMgbm9uZSBvciBzdGFydHMgd2l0aCB0YWJsZQogICAgLy8gZXhjZXB0ICJ0YWJsZSIsICJ0YWJsZS1jZWxsIiwgb3IgInRhYmxlLWNhcHRpb24iCiAgICAvLyBTZWUgaGVyZSBmb3IgZGlzcGxheSB2YWx1ZXM6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvQ1NTL2Rpc3BsYXkKICAgIHJkaXNwbGF5c3dhcCA9IC9eKG5vbmV8dGFibGUoPyEtY1tlYV0pLispLywKICAgIHJjdXN0b21Qcm9wID0gL14tLS8sCiAgICBjc3NTaG93ID0gewogICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgdmlzaWJpbGl0eTogImhpZGRlbiIsCiAgICAgIGRpc3BsYXk6ICJibG9jayIKICAgIH0sCiAgICBjc3NOb3JtYWxUcmFuc2Zvcm0gPSB7CiAgICAgIGxldHRlclNwYWNpbmc6ICIwIiwKICAgICAgZm9udFdlaWdodDogIjQwMCIKICAgIH07CiAgZnVuY3Rpb24gc2V0UG9zaXRpdmVOdW1iZXIoX2VsZW0sIHZhbHVlLCBzdWJ0cmFjdCkgewogICAgLy8gQW55IHJlbGF0aXZlICgrLy0pIHZhbHVlcyBoYXZlIGFscmVhZHkgYmVlbgogICAgLy8gbm9ybWFsaXplZCBhdCB0aGlzIHBvaW50CiAgICB2YXIgbWF0Y2hlcyA9IHJjc3NOdW0uZXhlYyh2YWx1ZSk7CiAgICByZXR1cm4gbWF0Y2hlcyA/CiAgICAvLyBHdWFyZCBhZ2FpbnN0IHVuZGVmaW5lZCAic3VidHJhY3QiLCBlLmcuLCB3aGVuIHVzZWQgYXMgaW4gY3NzSG9va3MKICAgIE1hdGgubWF4KDAsIG1hdGNoZXNbMl0gLSAoc3VidHJhY3QgfHwgMCkpICsgKG1hdGNoZXNbM10gfHwgInB4IikgOiB2YWx1ZTsKICB9CiAgZnVuY3Rpb24gYm94TW9kZWxBZGp1c3RtZW50KGVsZW0sIGRpbWVuc2lvbiwgYm94LCBpc0JvcmRlckJveCwgc3R5bGVzLCBjb21wdXRlZFZhbCkgewogICAgdmFyIGkgPSBkaW1lbnNpb24gPT09ICJ3aWR0aCIgPyAxIDogMCwKICAgICAgZXh0cmEgPSAwLAogICAgICBkZWx0YSA9IDA7CgogICAgLy8gQWRqdXN0bWVudCBtYXkgbm90IGJlIG5lY2Vzc2FyeQogICAgaWYgKGJveCA9PT0gKGlzQm9yZGVyQm94ID8gImJvcmRlciIgOiAiY29udGVudCIpKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgZm9yICg7IGkgPCA0OyBpICs9IDIpIHsKICAgICAgLy8gQm90aCBib3ggbW9kZWxzIGV4Y2x1ZGUgbWFyZ2luCiAgICAgIGlmIChib3ggPT09ICJtYXJnaW4iKSB7CiAgICAgICAgZGVsdGEgKz0galF1ZXJ5LmNzcyhlbGVtLCBib3ggKyBjc3NFeHBhbmRbaV0sIHRydWUsIHN0eWxlcyk7CiAgICAgIH0KCiAgICAgIC8vIElmIHdlIGdldCBoZXJlIHdpdGggYSBjb250ZW50LWJveCwgd2UncmUgc2Vla2luZyAicGFkZGluZyIgb3IgImJvcmRlciIgb3IgIm1hcmdpbiIKICAgICAgaWYgKCFpc0JvcmRlckJveCkgewogICAgICAgIC8vIEFkZCBwYWRkaW5nCiAgICAgICAgZGVsdGEgKz0galF1ZXJ5LmNzcyhlbGVtLCAicGFkZGluZyIgKyBjc3NFeHBhbmRbaV0sIHRydWUsIHN0eWxlcyk7CgogICAgICAgIC8vIEZvciAiYm9yZGVyIiBvciAibWFyZ2luIiwgYWRkIGJvcmRlcgogICAgICAgIGlmIChib3ggIT09ICJwYWRkaW5nIikgewogICAgICAgICAgZGVsdGEgKz0galF1ZXJ5LmNzcyhlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFtpXSArICJXaWR0aCIsIHRydWUsIHN0eWxlcyk7CgogICAgICAgICAgLy8gQnV0IHN0aWxsIGtlZXAgdHJhY2sgb2YgaXQgb3RoZXJ3aXNlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGV4dHJhICs9IGpRdWVyeS5jc3MoZWxlbSwgImJvcmRlciIgKyBjc3NFeHBhbmRbaV0gKyAiV2lkdGgiLCB0cnVlLCBzdHlsZXMpOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgd2UgZ2V0IGhlcmUgd2l0aCBhIGJvcmRlci1ib3ggKGNvbnRlbnQgKyBwYWRkaW5nICsgYm9yZGVyKSwgd2UncmUgc2Vla2luZyAiY29udGVudCIgb3IKICAgICAgICAvLyAicGFkZGluZyIgb3IgIm1hcmdpbiIKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBGb3IgImNvbnRlbnQiLCBzdWJ0cmFjdCBwYWRkaW5nCiAgICAgICAgaWYgKGJveCA9PT0gImNvbnRlbnQiKSB7CiAgICAgICAgICBkZWx0YSAtPSBqUXVlcnkuY3NzKGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFtpXSwgdHJ1ZSwgc3R5bGVzKTsKICAgICAgICB9CgogICAgICAgIC8vIEZvciAiY29udGVudCIgb3IgInBhZGRpbmciLCBzdWJ0cmFjdCBib3JkZXIKICAgICAgICBpZiAoYm94ICE9PSAibWFyZ2luIikgewogICAgICAgICAgZGVsdGEgLT0galF1ZXJ5LmNzcyhlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFtpXSArICJXaWR0aCIsIHRydWUsIHN0eWxlcyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gQWNjb3VudCBmb3IgcG9zaXRpdmUgY29udGVudC1ib3ggc2Nyb2xsIGd1dHRlciB3aGVuIHJlcXVlc3RlZCBieSBwcm92aWRpbmcgY29tcHV0ZWRWYWwKICAgIGlmICghaXNCb3JkZXJCb3ggJiYgY29tcHV0ZWRWYWwgPj0gMCkgewogICAgICAvLyBvZmZzZXRXaWR0aC9vZmZzZXRIZWlnaHQgaXMgYSByb3VuZGVkIHN1bSBvZiBjb250ZW50LCBwYWRkaW5nLCBzY3JvbGwgZ3V0dGVyLCBhbmQgYm9yZGVyCiAgICAgIC8vIEFzc3VtaW5nIGludGVnZXIgc2Nyb2xsIGd1dHRlciwgc3VidHJhY3QgdGhlIHJlc3QgYW5kIHJvdW5kIGRvd24KICAgICAgZGVsdGEgKz0gTWF0aC5tYXgoMCwgTWF0aC5jZWlsKGVsZW1bIm9mZnNldCIgKyBkaW1lbnNpb25bMF0udG9VcHBlckNhc2UoKSArIGRpbWVuc2lvbi5zbGljZSgxKV0gLSBjb21wdXRlZFZhbCAtIGRlbHRhIC0gZXh0cmEgLSAwLjUKCiAgICAgIC8vIElmIG9mZnNldFdpZHRoL29mZnNldEhlaWdodCBpcyB1bmtub3duLCB0aGVuIHdlIGNhbid0IGRldGVybWluZSBjb250ZW50LWJveCBzY3JvbGwgZ3V0dGVyCiAgICAgIC8vIFVzZSBhbiBleHBsaWNpdCB6ZXJvIHRvIGF2b2lkIE5hTiAoZ2gtMzk2NCkKICAgICAgKSkgfHwgMDsKICAgIH0KICAgIHJldHVybiBkZWx0YTsKICB9CiAgZnVuY3Rpb24gZ2V0V2lkdGhPckhlaWdodChlbGVtLCBkaW1lbnNpb24sIGV4dHJhKSB7CiAgICAvLyBTdGFydCB3aXRoIGNvbXB1dGVkIHN0eWxlCiAgICB2YXIgc3R5bGVzID0gZ2V0U3R5bGVzKGVsZW0pLAogICAgICAvLyBUbyBhdm9pZCBmb3JjaW5nIGEgcmVmbG93LCBvbmx5IGZldGNoIGJveFNpemluZyBpZiB3ZSBuZWVkIGl0IChnaC00MzIyKS4KICAgICAgLy8gRmFrZSBjb250ZW50LWJveCB1bnRpbCB3ZSBrbm93IGl0J3MgbmVlZGVkIHRvIGtub3cgdGhlIHRydWUgdmFsdWUuCiAgICAgIGJveFNpemluZ05lZWRlZCA9ICFzdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlKCkgfHwgZXh0cmEsCiAgICAgIGlzQm9yZGVyQm94ID0gYm94U2l6aW5nTmVlZGVkICYmIGpRdWVyeS5jc3MoZWxlbSwgImJveFNpemluZyIsIGZhbHNlLCBzdHlsZXMpID09PSAiYm9yZGVyLWJveCIsCiAgICAgIHZhbHVlSXNCb3JkZXJCb3ggPSBpc0JvcmRlckJveCwKICAgICAgdmFsID0gY3VyQ1NTKGVsZW0sIGRpbWVuc2lvbiwgc3R5bGVzKSwKICAgICAgb2Zmc2V0UHJvcCA9ICJvZmZzZXQiICsgZGltZW5zaW9uWzBdLnRvVXBwZXJDYXNlKCkgKyBkaW1lbnNpb24uc2xpY2UoMSk7CgogICAgLy8gU3VwcG9ydDogRmlyZWZveCA8PTU0CiAgICAvLyBSZXR1cm4gYSBjb25mb3VuZGluZyBub24tcGl4ZWwgdmFsdWUgb3IgZmVpZ24gaWdub3JhbmNlLCBhcyBhcHByb3ByaWF0ZS4KICAgIGlmIChybnVtbm9ucHgudGVzdCh2YWwpKSB7CiAgICAgIGlmICghZXh0cmEpIHsKICAgICAgICByZXR1cm4gdmFsOwogICAgICB9CiAgICAgIHZhbCA9ICJhdXRvIjsKICAgIH0KCiAgICAvLyBTdXBwb3J0OiBJRSA5IC0gMTEgb25seQogICAgLy8gVXNlIG9mZnNldFdpZHRoL29mZnNldEhlaWdodCBmb3Igd2hlbiBib3ggc2l6aW5nIGlzIHVucmVsaWFibGUuCiAgICAvLyBJbiB0aG9zZSBjYXNlcywgdGhlIGNvbXB1dGVkIHZhbHVlIGNhbiBiZSB0cnVzdGVkIHRvIGJlIGJvcmRlci1ib3guCiAgICBpZiAoKCFzdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlKCkgJiYgaXNCb3JkZXJCb3ggfHwKICAgIC8vIFN1cHBvcnQ6IElFIDEwIC0gMTErLCBFZGdlIDE1IC0gMTgrCiAgICAvLyBJRS9FZGdlIG1pc3JlcG9ydCBgZ2V0Q29tcHV0ZWRTdHlsZWAgb2YgdGFibGUgcm93cyB3aXRoIHdpZHRoL2hlaWdodAogICAgLy8gc2V0IGluIENTUyB3aGlsZSBgb2Zmc2V0KmAgcHJvcGVydGllcyByZXBvcnQgY29ycmVjdCB2YWx1ZXMuCiAgICAvLyBJbnRlcmVzdGluZ2x5LCBpbiBzb21lIGNhc2VzIElFIDkgZG9lc24ndCBzdWZmZXIgZnJvbSB0aGlzIGlzc3VlLgogICAgIXN1cHBvcnQucmVsaWFibGVUckRpbWVuc2lvbnMoKSAmJiBub2RlTmFtZShlbGVtLCAidHIiKSB8fAogICAgLy8gRmFsbCBiYWNrIHRvIG9mZnNldFdpZHRoL29mZnNldEhlaWdodCB3aGVuIHZhbHVlIGlzICJhdXRvIgogICAgLy8gVGhpcyBoYXBwZW5zIGZvciBpbmxpbmUgZWxlbWVudHMgd2l0aCBubyBleHBsaWNpdCBzZXR0aW5nIChnaC0zNTcxKQogICAgdmFsID09PSAiYXV0byIgfHwKICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjEgLSA0LjMgb25seQogICAgLy8gQWxzbyB1c2Ugb2Zmc2V0V2lkdGgvb2Zmc2V0SGVpZ2h0IGZvciBtaXNyZXBvcnRlZCBpbmxpbmUgZGltZW5zaW9ucyAoZ2gtMzYwMikKICAgICFwYXJzZUZsb2F0KHZhbCkgJiYgalF1ZXJ5LmNzcyhlbGVtLCAiZGlzcGxheSIsIGZhbHNlLCBzdHlsZXMpID09PSAiaW5saW5lIikgJiYKICAgIC8vIE1ha2Ugc3VyZSB0aGUgZWxlbWVudCBpcyB2aXNpYmxlICYgY29ubmVjdGVkCiAgICBlbGVtLmdldENsaWVudFJlY3RzKCkubGVuZ3RoKSB7CiAgICAgIGlzQm9yZGVyQm94ID0galF1ZXJ5LmNzcyhlbGVtLCAiYm94U2l6aW5nIiwgZmFsc2UsIHN0eWxlcykgPT09ICJib3JkZXItYm94IjsKCiAgICAgIC8vIFdoZXJlIGF2YWlsYWJsZSwgb2Zmc2V0V2lkdGgvb2Zmc2V0SGVpZ2h0IGFwcHJveGltYXRlIGJvcmRlciBib3ggZGltZW5zaW9ucy4KICAgICAgLy8gV2hlcmUgbm90IGF2YWlsYWJsZSAoZS5nLiwgU1ZHKSwgYXNzdW1lIHVucmVsaWFibGUgYm94LXNpemluZyBhbmQgaW50ZXJwcmV0IHRoZQogICAgICAvLyByZXRyaWV2ZWQgdmFsdWUgYXMgYSBjb250ZW50IGJveCBkaW1lbnNpb24uCiAgICAgIHZhbHVlSXNCb3JkZXJCb3ggPSBvZmZzZXRQcm9wIGluIGVsZW07CiAgICAgIGlmICh2YWx1ZUlzQm9yZGVyQm94KSB7CiAgICAgICAgdmFsID0gZWxlbVtvZmZzZXRQcm9wXTsKICAgICAgfQogICAgfQoKICAgIC8vIE5vcm1hbGl6ZSAiIiBhbmQgYXV0bwogICAgdmFsID0gcGFyc2VGbG9hdCh2YWwpIHx8IDA7CgogICAgLy8gQWRqdXN0IGZvciB0aGUgZWxlbWVudCdzIGJveCBtb2RlbAogICAgcmV0dXJuIHZhbCArIGJveE1vZGVsQWRqdXN0bWVudChlbGVtLCBkaW1lbnNpb24sIGV4dHJhIHx8IChpc0JvcmRlckJveCA/ICJib3JkZXIiIDogImNvbnRlbnQiKSwgdmFsdWVJc0JvcmRlckJveCwgc3R5bGVzLAogICAgLy8gUHJvdmlkZSB0aGUgY3VycmVudCBjb21wdXRlZCBzaXplIHRvIHJlcXVlc3Qgc2Nyb2xsIGd1dHRlciBjYWxjdWxhdGlvbiAoZ2gtMzU4OSkKICAgIHZhbCkgKyAicHgiOwogIH0KICBqUXVlcnkuZXh0ZW5kKHsKICAgIC8vIEFkZCBpbiBzdHlsZSBwcm9wZXJ0eSBob29rcyBmb3Igb3ZlcnJpZGluZyB0aGUgZGVmYXVsdAogICAgLy8gYmVoYXZpb3Igb2YgZ2V0dGluZyBhbmQgc2V0dGluZyBhIHN0eWxlIHByb3BlcnR5CiAgICBjc3NIb29rczogewogICAgICBvcGFjaXR5OiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoZWxlbSwgY29tcHV0ZWQpIHsKICAgICAgICAgIGlmIChjb21wdXRlZCkgewogICAgICAgICAgICAvLyBXZSBzaG91bGQgYWx3YXlzIGdldCBhIG51bWJlciBiYWNrIGZyb20gb3BhY2l0eQogICAgICAgICAgICB2YXIgcmV0ID0gY3VyQ1NTKGVsZW0sICJvcGFjaXR5Iik7CiAgICAgICAgICAgIHJldHVybiByZXQgPT09ICIiID8gIjEiIDogcmV0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIC8vIERvbid0IGF1dG9tYXRpY2FsbHkgYWRkICJweCIgdG8gdGhlc2UgcG9zc2libHktdW5pdGxlc3MgcHJvcGVydGllcwogICAgY3NzTnVtYmVyOiB7CiAgICAgICJhbmltYXRpb25JdGVyYXRpb25Db3VudCI6IHRydWUsCiAgICAgICJjb2x1bW5Db3VudCI6IHRydWUsCiAgICAgICJmaWxsT3BhY2l0eSI6IHRydWUsCiAgICAgICJmbGV4R3JvdyI6IHRydWUsCiAgICAgICJmbGV4U2hyaW5rIjogdHJ1ZSwKICAgICAgImZvbnRXZWlnaHQiOiB0cnVlLAogICAgICAiZ3JpZEFyZWEiOiB0cnVlLAogICAgICAiZ3JpZENvbHVtbiI6IHRydWUsCiAgICAgICJncmlkQ29sdW1uRW5kIjogdHJ1ZSwKICAgICAgImdyaWRDb2x1bW5TdGFydCI6IHRydWUsCiAgICAgICJncmlkUm93IjogdHJ1ZSwKICAgICAgImdyaWRSb3dFbmQiOiB0cnVlLAogICAgICAiZ3JpZFJvd1N0YXJ0IjogdHJ1ZSwKICAgICAgImxpbmVIZWlnaHQiOiB0cnVlLAogICAgICAib3BhY2l0eSI6IHRydWUsCiAgICAgICJvcmRlciI6IHRydWUsCiAgICAgICJvcnBoYW5zIjogdHJ1ZSwKICAgICAgIndpZG93cyI6IHRydWUsCiAgICAgICJ6SW5kZXgiOiB0cnVlLAogICAgICAiem9vbSI6IHRydWUKICAgIH0sCiAgICAvLyBBZGQgaW4gcHJvcGVydGllcyB3aG9zZSBuYW1lcyB5b3Ugd2lzaCB0byBmaXggYmVmb3JlCiAgICAvLyBzZXR0aW5nIG9yIGdldHRpbmcgdGhlIHZhbHVlCiAgICBjc3NQcm9wczoge30sCiAgICAvLyBHZXQgYW5kIHNldCB0aGUgc3R5bGUgcHJvcGVydHkgb24gYSBET00gTm9kZQogICAgc3R5bGU6IGZ1bmN0aW9uIHN0eWxlKGVsZW0sIG5hbWUsIHZhbHVlLCBleHRyYSkgewogICAgICAvLyBEb24ndCBzZXQgc3R5bGVzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKICAgICAgaWYgKCFlbGVtIHx8IGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCB8fCAhZWxlbS5zdHlsZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgd2UncmUgd29ya2luZyB3aXRoIHRoZSByaWdodCBuYW1lCiAgICAgIHZhciByZXQsCiAgICAgICAgdHlwZSwKICAgICAgICBob29rcywKICAgICAgICBvcmlnTmFtZSA9IGNhbWVsQ2FzZShuYW1lKSwKICAgICAgICBpc0N1c3RvbVByb3AgPSByY3VzdG9tUHJvcC50ZXN0KG5hbWUpLAogICAgICAgIHN0eWxlID0gZWxlbS5zdHlsZTsKCiAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZS4gV2UgZG9uJ3QKICAgICAgLy8gd2FudCB0byBxdWVyeSB0aGUgdmFsdWUgaWYgaXQgaXMgYSBDU1MgY3VzdG9tIHByb3BlcnR5CiAgICAgIC8vIHNpbmNlIHRoZXkgYXJlIHVzZXItZGVmaW5lZC4KICAgICAgaWYgKCFpc0N1c3RvbVByb3ApIHsKICAgICAgICBuYW1lID0gZmluYWxQcm9wTmFtZShvcmlnTmFtZSk7CiAgICAgIH0KCiAgICAgIC8vIEdldHMgaG9vayBmb3IgdGhlIHByZWZpeGVkIHZlcnNpb24sIHRoZW4gdW5wcmVmaXhlZCB2ZXJzaW9uCiAgICAgIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzW25hbWVdIHx8IGpRdWVyeS5jc3NIb29rc1tvcmlnTmFtZV07CgogICAgICAvLyBDaGVjayBpZiB3ZSdyZSBzZXR0aW5nIGEgdmFsdWUKICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0eXBlID0gX3R5cGVvZih2YWx1ZSk7CgogICAgICAgIC8vIENvbnZlcnQgIis9IiBvciAiLT0iIHRvIHJlbGF0aXZlIG51bWJlcnMgKCM3MzQ1KQogICAgICAgIGlmICh0eXBlID09PSAic3RyaW5nIiAmJiAocmV0ID0gcmNzc051bS5leGVjKHZhbHVlKSkgJiYgcmV0WzFdKSB7CiAgICAgICAgICB2YWx1ZSA9IGFkanVzdENTUyhlbGVtLCBuYW1lLCByZXQpOwoKICAgICAgICAgIC8vIEZpeGVzIGJ1ZyAjOTIzNwogICAgICAgICAgdHlwZSA9ICJudW1iZXIiOwogICAgICAgIH0KCiAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgbnVsbCBhbmQgTmFOIHZhbHVlcyBhcmVuJ3Qgc2V0ICgjNzExNikKICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCB8fCB2YWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIElmIGEgbnVtYmVyIHdhcyBwYXNzZWQgaW4sIGFkZCB0aGUgdW5pdCAoZXhjZXB0IGZvciBjZXJ0YWluIENTUyBwcm9wZXJ0aWVzKQogICAgICAgIC8vIFRoZSBpc0N1c3RvbVByb3AgY2hlY2sgY2FuIGJlIHJlbW92ZWQgaW4galF1ZXJ5IDQuMCB3aGVuIHdlIG9ubHkgYXV0by1hcHBlbmQKICAgICAgICAvLyAicHgiIHRvIGEgZmV3IGhhcmRjb2RlZCB2YWx1ZXMuCiAgICAgICAgaWYgKHR5cGUgPT09ICJudW1iZXIiICYmICFpc0N1c3RvbVByb3ApIHsKICAgICAgICAgIHZhbHVlICs9IHJldCAmJiByZXRbM10gfHwgKGpRdWVyeS5jc3NOdW1iZXJbb3JpZ05hbWVdID8gIiIgOiAicHgiKTsKICAgICAgICB9CgogICAgICAgIC8vIGJhY2tncm91bmQtKiBwcm9wcyBhZmZlY3Qgb3JpZ2luYWwgY2xvbmUncyB2YWx1ZXMKICAgICAgICBpZiAoIXN1cHBvcnQuY2xlYXJDbG9uZVN0eWxlICYmIHZhbHVlID09PSAiIiAmJiBuYW1lLmluZGV4T2YoImJhY2tncm91bmQiKSA9PT0gMCkgewogICAgICAgICAgc3R5bGVbbmFtZV0gPSAiaW5oZXJpdCI7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkLCB1c2UgdGhhdCB2YWx1ZSwgb3RoZXJ3aXNlIGp1c3Qgc2V0IHRoZSBzcGVjaWZpZWQgdmFsdWUKICAgICAgICBpZiAoIWhvb2tzIHx8ICEoInNldCIgaW4gaG9va3MpIHx8ICh2YWx1ZSA9IGhvb2tzLnNldChlbGVtLCB2YWx1ZSwgZXh0cmEpKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBpZiAoaXNDdXN0b21Qcm9wKSB7CiAgICAgICAgICAgIHN0eWxlLnNldFByb3BlcnR5KG5hbWUsIHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0eWxlW25hbWVdID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBub24tY29tcHV0ZWQgdmFsdWUgZnJvbSB0aGVyZQogICAgICAgIGlmIChob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KGVsZW0sIGZhbHNlLCBleHRyYSkpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfQoKICAgICAgICAvLyBPdGhlcndpc2UganVzdCBnZXQgdGhlIHZhbHVlIGZyb20gdGhlIHN0eWxlIG9iamVjdAogICAgICAgIHJldHVybiBzdHlsZVtuYW1lXTsKICAgICAgfQogICAgfSwKICAgIGNzczogZnVuY3Rpb24gY3NzKGVsZW0sIG5hbWUsIGV4dHJhLCBzdHlsZXMpIHsKICAgICAgdmFyIHZhbCwKICAgICAgICBudW0sCiAgICAgICAgaG9va3MsCiAgICAgICAgb3JpZ05hbWUgPSBjYW1lbENhc2UobmFtZSksCiAgICAgICAgaXNDdXN0b21Qcm9wID0gcmN1c3RvbVByb3AudGVzdChuYW1lKTsKCiAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZS4gV2UgZG9uJ3QKICAgICAgLy8gd2FudCB0byBtb2RpZnkgdGhlIHZhbHVlIGlmIGl0IGlzIGEgQ1NTIGN1c3RvbSBwcm9wZXJ0eQogICAgICAvLyBzaW5jZSB0aGV5IGFyZSB1c2VyLWRlZmluZWQuCiAgICAgIGlmICghaXNDdXN0b21Qcm9wKSB7CiAgICAgICAgbmFtZSA9IGZpbmFsUHJvcE5hbWUob3JpZ05hbWUpOwogICAgICB9CgogICAgICAvLyBUcnkgcHJlZml4ZWQgbmFtZSBmb2xsb3dlZCBieSB0aGUgdW5wcmVmaXhlZCBuYW1lCiAgICAgIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzW25hbWVdIHx8IGpRdWVyeS5jc3NIb29rc1tvcmlnTmFtZV07CgogICAgICAvLyBJZiBhIGhvb2sgd2FzIHByb3ZpZGVkIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZnJvbSB0aGVyZQogICAgICBpZiAoaG9va3MgJiYgImdldCIgaW4gaG9va3MpIHsKICAgICAgICB2YWwgPSBob29rcy5nZXQoZWxlbSwgdHJ1ZSwgZXh0cmEpOwogICAgICB9CgogICAgICAvLyBPdGhlcndpc2UsIGlmIGEgd2F5IHRvIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZXhpc3RzLCB1c2UgdGhhdAogICAgICBpZiAodmFsID09PSB1bmRlZmluZWQpIHsKICAgICAgICB2YWwgPSBjdXJDU1MoZWxlbSwgbmFtZSwgc3R5bGVzKTsKICAgICAgfQoKICAgICAgLy8gQ29udmVydCAibm9ybWFsIiB0byBjb21wdXRlZCB2YWx1ZQogICAgICBpZiAodmFsID09PSAibm9ybWFsIiAmJiBuYW1lIGluIGNzc05vcm1hbFRyYW5zZm9ybSkgewogICAgICAgIHZhbCA9IGNzc05vcm1hbFRyYW5zZm9ybVtuYW1lXTsKICAgICAgfQoKICAgICAgLy8gTWFrZSBudW1lcmljIGlmIGZvcmNlZCBvciBhIHF1YWxpZmllciB3YXMgcHJvdmlkZWQgYW5kIHZhbCBsb29rcyBudW1lcmljCiAgICAgIGlmIChleHRyYSA9PT0gIiIgfHwgZXh0cmEpIHsKICAgICAgICBudW0gPSBwYXJzZUZsb2F0KHZhbCk7CiAgICAgICAgcmV0dXJuIGV4dHJhID09PSB0cnVlIHx8IGlzRmluaXRlKG51bSkgPyBudW0gfHwgMCA6IHZhbDsKICAgICAgfQogICAgICByZXR1cm4gdmFsOwogICAgfQogIH0pOwogIGpRdWVyeS5lYWNoKFsiaGVpZ2h0IiwgIndpZHRoIl0sIGZ1bmN0aW9uIChfaSwgZGltZW5zaW9uKSB7CiAgICBqUXVlcnkuY3NzSG9va3NbZGltZW5zaW9uXSA9IHsKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoZWxlbSwgY29tcHV0ZWQsIGV4dHJhKSB7CiAgICAgICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgICAgICAvLyBDZXJ0YWluIGVsZW1lbnRzIGNhbiBoYXZlIGRpbWVuc2lvbiBpbmZvIGlmIHdlIGludmlzaWJseSBzaG93IHRoZW0KICAgICAgICAgIC8vIGJ1dCBpdCBtdXN0IGhhdmUgYSBjdXJyZW50IGRpc3BsYXkgc3R5bGUgdGhhdCB3b3VsZCBiZW5lZml0CiAgICAgICAgICByZXR1cm4gcmRpc3BsYXlzd2FwLnRlc3QoalF1ZXJ5LmNzcyhlbGVtLCAiZGlzcGxheSIpKSAmJiAoCiAgICAgICAgICAvLyBTdXBwb3J0OiBTYWZhcmkgOCsKICAgICAgICAgIC8vIFRhYmxlIGNvbHVtbnMgaW4gU2FmYXJpIGhhdmUgbm9uLXplcm8gb2Zmc2V0V2lkdGggJiB6ZXJvCiAgICAgICAgICAvLyBnZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aCB1bmxlc3MgZGlzcGxheSBpcyBjaGFuZ2VkLgogICAgICAgICAgLy8gU3VwcG9ydDogSUUgPD0xMSBvbmx5CiAgICAgICAgICAvLyBSdW5uaW5nIGdldEJvdW5kaW5nQ2xpZW50UmVjdCBvbiBhIGRpc2Nvbm5lY3RlZCBub2RlCiAgICAgICAgICAvLyBpbiBJRSB0aHJvd3MgYW4gZXJyb3IuCiAgICAgICAgICAhZWxlbS5nZXRDbGllbnRSZWN0cygpLmxlbmd0aCB8fCAhZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aCkgPyBzd2FwKGVsZW0sIGNzc1Nob3csIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIGdldFdpZHRoT3JIZWlnaHQoZWxlbSwgZGltZW5zaW9uLCBleHRyYSk7CiAgICAgICAgICB9KSA6IGdldFdpZHRoT3JIZWlnaHQoZWxlbSwgZGltZW5zaW9uLCBleHRyYSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldChlbGVtLCB2YWx1ZSwgZXh0cmEpIHsKICAgICAgICB2YXIgbWF0Y2hlcywKICAgICAgICAgIHN0eWxlcyA9IGdldFN0eWxlcyhlbGVtKSwKICAgICAgICAgIC8vIE9ubHkgcmVhZCBzdHlsZXMucG9zaXRpb24gaWYgdGhlIHRlc3QgaGFzIGEgY2hhbmNlIHRvIGZhaWwKICAgICAgICAgIC8vIHRvIGF2b2lkIGZvcmNpbmcgYSByZWZsb3cuCiAgICAgICAgICBzY3JvbGxib3hTaXplQnVnZ3kgPSAhc3VwcG9ydC5zY3JvbGxib3hTaXplKCkgJiYgc3R5bGVzLnBvc2l0aW9uID09PSAiYWJzb2x1dGUiLAogICAgICAgICAgLy8gVG8gYXZvaWQgZm9yY2luZyBhIHJlZmxvdywgb25seSBmZXRjaCBib3hTaXppbmcgaWYgd2UgbmVlZCBpdCAoZ2gtMzk5MSkKICAgICAgICAgIGJveFNpemluZ05lZWRlZCA9IHNjcm9sbGJveFNpemVCdWdneSB8fCBleHRyYSwKICAgICAgICAgIGlzQm9yZGVyQm94ID0gYm94U2l6aW5nTmVlZGVkICYmIGpRdWVyeS5jc3MoZWxlbSwgImJveFNpemluZyIsIGZhbHNlLCBzdHlsZXMpID09PSAiYm9yZGVyLWJveCIsCiAgICAgICAgICBzdWJ0cmFjdCA9IGV4dHJhID8gYm94TW9kZWxBZGp1c3RtZW50KGVsZW0sIGRpbWVuc2lvbiwgZXh0cmEsIGlzQm9yZGVyQm94LCBzdHlsZXMpIDogMDsKCiAgICAgICAgLy8gQWNjb3VudCBmb3IgdW5yZWxpYWJsZSBib3JkZXItYm94IGRpbWVuc2lvbnMgYnkgY29tcGFyaW5nIG9mZnNldCogdG8gY29tcHV0ZWQgYW5kCiAgICAgICAgLy8gZmFraW5nIGEgY29udGVudC1ib3ggdG8gZ2V0IGJvcmRlciBhbmQgcGFkZGluZyAoZ2gtMzY5OSkKICAgICAgICBpZiAoaXNCb3JkZXJCb3ggJiYgc2Nyb2xsYm94U2l6ZUJ1Z2d5KSB7CiAgICAgICAgICBzdWJ0cmFjdCAtPSBNYXRoLmNlaWwoZWxlbVsib2Zmc2V0IiArIGRpbWVuc2lvblswXS50b1VwcGVyQ2FzZSgpICsgZGltZW5zaW9uLnNsaWNlKDEpXSAtIHBhcnNlRmxvYXQoc3R5bGVzW2RpbWVuc2lvbl0pIC0gYm94TW9kZWxBZGp1c3RtZW50KGVsZW0sIGRpbWVuc2lvbiwgImJvcmRlciIsIGZhbHNlLCBzdHlsZXMpIC0gMC41KTsKICAgICAgICB9CgogICAgICAgIC8vIENvbnZlcnQgdG8gcGl4ZWxzIGlmIHZhbHVlIGFkanVzdG1lbnQgaXMgbmVlZGVkCiAgICAgICAgaWYgKHN1YnRyYWN0ICYmIChtYXRjaGVzID0gcmNzc051bS5leGVjKHZhbHVlKSkgJiYgKG1hdGNoZXNbM10gfHwgInB4IikgIT09ICJweCIpIHsKICAgICAgICAgIGVsZW0uc3R5bGVbZGltZW5zaW9uXSA9IHZhbHVlOwogICAgICAgICAgdmFsdWUgPSBqUXVlcnkuY3NzKGVsZW0sIGRpbWVuc2lvbik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZXRQb3NpdGl2ZU51bWJlcihlbGVtLCB2YWx1ZSwgc3VidHJhY3QpOwogICAgICB9CiAgICB9OwogIH0pOwogIGpRdWVyeS5jc3NIb29rcy5tYXJnaW5MZWZ0ID0gYWRkR2V0SG9va0lmKHN1cHBvcnQucmVsaWFibGVNYXJnaW5MZWZ0LCBmdW5jdGlvbiAoZWxlbSwgY29tcHV0ZWQpIHsKICAgIGlmIChjb21wdXRlZCkgewogICAgICByZXR1cm4gKHBhcnNlRmxvYXQoY3VyQ1NTKGVsZW0sICJtYXJnaW5MZWZ0IikpIHx8IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdCAtIHN3YXAoZWxlbSwgewogICAgICAgIG1hcmdpbkxlZnQ6IDAKICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQ7CiAgICAgIH0pKSArICJweCI7CiAgICB9CiAgfSk7CgogIC8vIFRoZXNlIGhvb2tzIGFyZSB1c2VkIGJ5IGFuaW1hdGUgdG8gZXhwYW5kIHByb3BlcnRpZXMKICBqUXVlcnkuZWFjaCh7CiAgICBtYXJnaW46ICIiLAogICAgcGFkZGluZzogIiIsCiAgICBib3JkZXI6ICJXaWR0aCIKICB9LCBmdW5jdGlvbiAocHJlZml4LCBzdWZmaXgpIHsKICAgIGpRdWVyeS5jc3NIb29rc1twcmVmaXggKyBzdWZmaXhdID0gewogICAgICBleHBhbmQ6IGZ1bmN0aW9uIGV4cGFuZCh2YWx1ZSkgewogICAgICAgIHZhciBpID0gMCwKICAgICAgICAgIGV4cGFuZGVkID0ge30sCiAgICAgICAgICAvLyBBc3N1bWVzIGEgc2luZ2xlIG51bWJlciBpZiBub3QgYSBzdHJpbmcKICAgICAgICAgIHBhcnRzID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlLnNwbGl0KCIgIikgOiBbdmFsdWVdOwogICAgICAgIGZvciAoOyBpIDwgNDsgaSsrKSB7CiAgICAgICAgICBleHBhbmRlZFtwcmVmaXggKyBjc3NFeHBhbmRbaV0gKyBzdWZmaXhdID0gcGFydHNbaV0gfHwgcGFydHNbaSAtIDJdIHx8IHBhcnRzWzBdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhwYW5kZWQ7CiAgICAgIH0KICAgIH07CiAgICBpZiAocHJlZml4ICE9PSAibWFyZ2luIikgewogICAgICBqUXVlcnkuY3NzSG9va3NbcHJlZml4ICsgc3VmZml4XS5zZXQgPSBzZXRQb3NpdGl2ZU51bWJlcjsKICAgIH0KICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGNzczogZnVuY3Rpb24gY3NzKG5hbWUsIHZhbHVlKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgZnVuY3Rpb24gKGVsZW0sIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgdmFyIHN0eWxlcywKICAgICAgICAgIGxlbiwKICAgICAgICAgIG1hcCA9IHt9LAogICAgICAgICAgaSA9IDA7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobmFtZSkpIHsKICAgICAgICAgIHN0eWxlcyA9IGdldFN0eWxlcyhlbGVtKTsKICAgICAgICAgIGxlbiA9IG5hbWUubGVuZ3RoOwogICAgICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBtYXBbbmFtZVtpXV0gPSBqUXVlcnkuY3NzKGVsZW0sIG5hbWVbaV0sIGZhbHNlLCBzdHlsZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPyBqUXVlcnkuc3R5bGUoZWxlbSwgbmFtZSwgdmFsdWUpIDogalF1ZXJ5LmNzcyhlbGVtLCBuYW1lKTsKICAgICAgfSwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxKTsKICAgIH0KICB9KTsKICBmdW5jdGlvbiBUd2VlbihlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZykgewogICAgcmV0dXJuIG5ldyBUd2Vlbi5wcm90b3R5cGUuaW5pdChlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZyk7CiAgfQogIGpRdWVyeS5Ud2VlbiA9IFR3ZWVuOwogIFR3ZWVuLnByb3RvdHlwZSA9IHsKICAgIGNvbnN0cnVjdG9yOiBUd2VlbiwKICAgIGluaXQ6IGZ1bmN0aW9uIGluaXQoZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcsIHVuaXQpIHsKICAgICAgdGhpcy5lbGVtID0gZWxlbTsKICAgICAgdGhpcy5wcm9wID0gcHJvcDsKICAgICAgdGhpcy5lYXNpbmcgPSBlYXNpbmcgfHwgalF1ZXJ5LmVhc2luZy5fZGVmYXVsdDsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgICAgdGhpcy5zdGFydCA9IHRoaXMubm93ID0gdGhpcy5jdXIoKTsKICAgICAgdGhpcy5lbmQgPSBlbmQ7CiAgICAgIHRoaXMudW5pdCA9IHVuaXQgfHwgKGpRdWVyeS5jc3NOdW1iZXJbcHJvcF0gPyAiIiA6ICJweCIpOwogICAgfSwKICAgIGN1cjogZnVuY3Rpb24gY3VyKCkgewogICAgICB2YXIgaG9va3MgPSBUd2Vlbi5wcm9wSG9va3NbdGhpcy5wcm9wXTsKICAgICAgcmV0dXJuIGhvb2tzICYmIGhvb2tzLmdldCA/IGhvb2tzLmdldCh0aGlzKSA6IFR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5nZXQodGhpcyk7CiAgICB9LAogICAgcnVuOiBmdW5jdGlvbiBydW4ocGVyY2VudCkgewogICAgICB2YXIgZWFzZWQsCiAgICAgICAgaG9va3MgPSBUd2Vlbi5wcm9wSG9va3NbdGhpcy5wcm9wXTsKICAgICAgaWYgKHRoaXMub3B0aW9ucy5kdXJhdGlvbikgewogICAgICAgIHRoaXMucG9zID0gZWFzZWQgPSBqUXVlcnkuZWFzaW5nW3RoaXMuZWFzaW5nXShwZXJjZW50LCB0aGlzLm9wdGlvbnMuZHVyYXRpb24gKiBwZXJjZW50LCAwLCAxLCB0aGlzLm9wdGlvbnMuZHVyYXRpb24pOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucG9zID0gZWFzZWQgPSBwZXJjZW50OwogICAgICB9CiAgICAgIHRoaXMubm93ID0gKHRoaXMuZW5kIC0gdGhpcy5zdGFydCkgKiBlYXNlZCArIHRoaXMuc3RhcnQ7CiAgICAgIGlmICh0aGlzLm9wdGlvbnMuc3RlcCkgewogICAgICAgIHRoaXMub3B0aW9ucy5zdGVwLmNhbGwodGhpcy5lbGVtLCB0aGlzLm5vdywgdGhpcyk7CiAgICAgIH0KICAgICAgaWYgKGhvb2tzICYmIGhvb2tzLnNldCkgewogICAgICAgIGhvb2tzLnNldCh0aGlzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuc2V0KHRoaXMpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH07CiAgVHdlZW4ucHJvdG90eXBlLmluaXQucHJvdG90eXBlID0gVHdlZW4ucHJvdG90eXBlOwogIFR3ZWVuLnByb3BIb29rcyA9IHsKICAgIF9kZWZhdWx0OiB7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KHR3ZWVuKSB7CiAgICAgICAgdmFyIHJlc3VsdDsKCiAgICAgICAgLy8gVXNlIGEgcHJvcGVydHkgb24gdGhlIGVsZW1lbnQgZGlyZWN0bHkgd2hlbiBpdCBpcyBub3QgYSBET00gZWxlbWVudCwKICAgICAgICAvLyBvciB3aGVuIHRoZXJlIGlzIG5vIG1hdGNoaW5nIHN0eWxlIHByb3BlcnR5IHRoYXQgZXhpc3RzLgogICAgICAgIGlmICh0d2Vlbi5lbGVtLm5vZGVUeXBlICE9PSAxIHx8IHR3ZWVuLmVsZW1bdHdlZW4ucHJvcF0gIT0gbnVsbCAmJiB0d2Vlbi5lbGVtLnN0eWxlW3R3ZWVuLnByb3BdID09IG51bGwpIHsKICAgICAgICAgIHJldHVybiB0d2Vlbi5lbGVtW3R3ZWVuLnByb3BdOwogICAgICAgIH0KCiAgICAgICAgLy8gUGFzc2luZyBhbiBlbXB0eSBzdHJpbmcgYXMgYSAzcmQgcGFyYW1ldGVyIHRvIC5jc3Mgd2lsbCBhdXRvbWF0aWNhbGx5CiAgICAgICAgLy8gYXR0ZW1wdCBhIHBhcnNlRmxvYXQgYW5kIGZhbGxiYWNrIHRvIGEgc3RyaW5nIGlmIHRoZSBwYXJzZSBmYWlscy4KICAgICAgICAvLyBTaW1wbGUgdmFsdWVzIHN1Y2ggYXMgIjEwcHgiIGFyZSBwYXJzZWQgdG8gRmxvYXQ7CiAgICAgICAgLy8gY29tcGxleCB2YWx1ZXMgc3VjaCBhcyAicm90YXRlKDFyYWQpIiBhcmUgcmV0dXJuZWQgYXMtaXMuCiAgICAgICAgcmVzdWx0ID0galF1ZXJ5LmNzcyh0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCAiIik7CgogICAgICAgIC8vIEVtcHR5IHN0cmluZ3MsIG51bGwsIHVuZGVmaW5lZCBhbmQgImF1dG8iIGFyZSBjb252ZXJ0ZWQgdG8gMC4KICAgICAgICByZXR1cm4gIXJlc3VsdCB8fCByZXN1bHQgPT09ICJhdXRvIiA/IDAgOiByZXN1bHQ7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KHR3ZWVuKSB7CiAgICAgICAgLy8gVXNlIHN0ZXAgaG9vayBmb3IgYmFjayBjb21wYXQuCiAgICAgICAgLy8gVXNlIGNzc0hvb2sgaWYgaXRzIHRoZXJlLgogICAgICAgIC8vIFVzZSAuc3R5bGUgaWYgYXZhaWxhYmxlIGFuZCB1c2UgcGxhaW4gcHJvcGVydGllcyB3aGVyZSBhdmFpbGFibGUuCiAgICAgICAgaWYgKGpRdWVyeS5meC5zdGVwW3R3ZWVuLnByb3BdKSB7CiAgICAgICAgICBqUXVlcnkuZnguc3RlcFt0d2Vlbi5wcm9wXSh0d2Vlbik7CiAgICAgICAgfSBlbHNlIGlmICh0d2Vlbi5lbGVtLm5vZGVUeXBlID09PSAxICYmIChqUXVlcnkuY3NzSG9va3NbdHdlZW4ucHJvcF0gfHwgdHdlZW4uZWxlbS5zdHlsZVtmaW5hbFByb3BOYW1lKHR3ZWVuLnByb3ApXSAhPSBudWxsKSkgewogICAgICAgICAgalF1ZXJ5LnN0eWxlKHR3ZWVuLmVsZW0sIHR3ZWVuLnByb3AsIHR3ZWVuLm5vdyArIHR3ZWVuLnVuaXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0d2Vlbi5lbGVtW3R3ZWVuLnByb3BdID0gdHdlZW4ubm93OwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CgogIC8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5CiAgLy8gUGFuaWMgYmFzZWQgYXBwcm9hY2ggdG8gc2V0dGluZyB0aGluZ3Mgb24gZGlzY29ubmVjdGVkIG5vZGVzCiAgVHdlZW4ucHJvcEhvb2tzLnNjcm9sbFRvcCA9IFR3ZWVuLnByb3BIb29rcy5zY3JvbGxMZWZ0ID0gewogICAgc2V0OiBmdW5jdGlvbiBzZXQodHdlZW4pIHsKICAgICAgaWYgKHR3ZWVuLmVsZW0ubm9kZVR5cGUgJiYgdHdlZW4uZWxlbS5wYXJlbnROb2RlKSB7CiAgICAgICAgdHdlZW4uZWxlbVt0d2Vlbi5wcm9wXSA9IHR3ZWVuLm5vdzsKICAgICAgfQogICAgfQogIH07CiAgalF1ZXJ5LmVhc2luZyA9IHsKICAgIGxpbmVhcjogZnVuY3Rpb24gbGluZWFyKHApIHsKICAgICAgcmV0dXJuIHA7CiAgICB9LAogICAgc3dpbmc6IGZ1bmN0aW9uIHN3aW5nKHApIHsKICAgICAgcmV0dXJuIDAuNSAtIE1hdGguY29zKHAgKiBNYXRoLlBJKSAvIDI7CiAgICB9LAogICAgX2RlZmF1bHQ6ICJzd2luZyIKICB9OwogIGpRdWVyeS5meCA9IFR3ZWVuLnByb3RvdHlwZS5pbml0OwoKICAvLyBCYWNrIGNvbXBhdCA8MS44IGV4dGVuc2lvbiBwb2ludAogIGpRdWVyeS5meC5zdGVwID0ge307CiAgdmFyIGZ4Tm93LAogICAgaW5Qcm9ncmVzcywKICAgIHJmeHR5cGVzID0gL14oPzp0b2dnbGV8c2hvd3xoaWRlKSQvLAogICAgcnJ1biA9IC9xdWV1ZUhvb2tzJC87CiAgZnVuY3Rpb24gc2NoZWR1bGUoKSB7CiAgICBpZiAoaW5Qcm9ncmVzcykgewogICAgICBpZiAoZG9jdW1lbnQuaGlkZGVuID09PSBmYWxzZSAmJiB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKSB7CiAgICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZShzY2hlZHVsZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoc2NoZWR1bGUsIGpRdWVyeS5meC5pbnRlcnZhbCk7CiAgICAgIH0KICAgICAgalF1ZXJ5LmZ4LnRpY2soKTsKICAgIH0KICB9CgogIC8vIEFuaW1hdGlvbnMgY3JlYXRlZCBzeW5jaHJvbm91c2x5IHdpbGwgcnVuIHN5bmNocm9ub3VzbHkKICBmdW5jdGlvbiBjcmVhdGVGeE5vdygpIHsKICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgZnhOb3cgPSB1bmRlZmluZWQ7CiAgICB9KTsKICAgIHJldHVybiBmeE5vdyA9IERhdGUubm93KCk7CiAgfQoKICAvLyBHZW5lcmF0ZSBwYXJhbWV0ZXJzIHRvIGNyZWF0ZSBhIHN0YW5kYXJkIGFuaW1hdGlvbgogIGZ1bmN0aW9uIGdlbkZ4KHR5cGUsIGluY2x1ZGVXaWR0aCkgewogICAgdmFyIHdoaWNoLAogICAgICBpID0gMCwKICAgICAgYXR0cnMgPSB7CiAgICAgICAgaGVpZ2h0OiB0eXBlCiAgICAgIH07CgogICAgLy8gSWYgd2UgaW5jbHVkZSB3aWR0aCwgc3RlcCB2YWx1ZSBpcyAxIHRvIGRvIGFsbCBjc3NFeHBhbmQgdmFsdWVzLAogICAgLy8gb3RoZXJ3aXNlIHN0ZXAgdmFsdWUgaXMgMiB0byBza2lwIG92ZXIgTGVmdCBhbmQgUmlnaHQKICAgIGluY2x1ZGVXaWR0aCA9IGluY2x1ZGVXaWR0aCA/IDEgOiAwOwogICAgZm9yICg7IGkgPCA0OyBpICs9IDIgLSBpbmNsdWRlV2lkdGgpIHsKICAgICAgd2hpY2ggPSBjc3NFeHBhbmRbaV07CiAgICAgIGF0dHJzWyJtYXJnaW4iICsgd2hpY2hdID0gYXR0cnNbInBhZGRpbmciICsgd2hpY2hdID0gdHlwZTsKICAgIH0KICAgIGlmIChpbmNsdWRlV2lkdGgpIHsKICAgICAgYXR0cnMub3BhY2l0eSA9IGF0dHJzLndpZHRoID0gdHlwZTsKICAgIH0KICAgIHJldHVybiBhdHRyczsKICB9CiAgZnVuY3Rpb24gY3JlYXRlVHdlZW4odmFsdWUsIHByb3AsIGFuaW1hdGlvbikgewogICAgdmFyIHR3ZWVuLAogICAgICBjb2xsZWN0aW9uID0gKEFuaW1hdGlvbi50d2VlbmVyc1twcm9wXSB8fCBbXSkuY29uY2F0KEFuaW1hdGlvbi50d2VlbmVyc1siKiJdKSwKICAgICAgaW5kZXggPSAwLAogICAgICBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICBpZiAodHdlZW4gPSBjb2xsZWN0aW9uW2luZGV4XS5jYWxsKGFuaW1hdGlvbiwgcHJvcCwgdmFsdWUpKSB7CiAgICAgICAgLy8gV2UncmUgZG9uZSB3aXRoIHRoaXMgcHJvcGVydHkKICAgICAgICByZXR1cm4gdHdlZW47CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZGVmYXVsdFByZWZpbHRlcihlbGVtLCBwcm9wcywgb3B0cykgewogICAgdmFyIHByb3AsCiAgICAgIHZhbHVlLAogICAgICB0b2dnbGUsCiAgICAgIGhvb2tzLAogICAgICBvbGRmaXJlLAogICAgICBwcm9wVHdlZW4sCiAgICAgIHJlc3RvcmVEaXNwbGF5LAogICAgICBkaXNwbGF5LAogICAgICBpc0JveCA9ICJ3aWR0aCIgaW4gcHJvcHMgfHwgImhlaWdodCIgaW4gcHJvcHMsCiAgICAgIGFuaW0gPSB0aGlzLAogICAgICBvcmlnID0ge30sCiAgICAgIHN0eWxlID0gZWxlbS5zdHlsZSwKICAgICAgaGlkZGVuID0gZWxlbS5ub2RlVHlwZSAmJiBpc0hpZGRlbldpdGhpblRyZWUoZWxlbSksCiAgICAgIGRhdGFTaG93ID0gZGF0YVByaXYuZ2V0KGVsZW0sICJmeHNob3ciKTsKCiAgICAvLyBRdWV1ZS1za2lwcGluZyBhbmltYXRpb25zIGhpamFjayB0aGUgZnggaG9va3MKICAgIGlmICghb3B0cy5xdWV1ZSkgewogICAgICBob29rcyA9IGpRdWVyeS5fcXVldWVIb29rcyhlbGVtLCAiZngiKTsKICAgICAgaWYgKGhvb2tzLnVucXVldWVkID09IG51bGwpIHsKICAgICAgICBob29rcy51bnF1ZXVlZCA9IDA7CiAgICAgICAgb2xkZmlyZSA9IGhvb2tzLmVtcHR5LmZpcmU7CiAgICAgICAgaG9va3MuZW1wdHkuZmlyZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICghaG9va3MudW5xdWV1ZWQpIHsKICAgICAgICAgICAgb2xkZmlyZSgpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgICAgaG9va3MudW5xdWV1ZWQrKzsKICAgICAgYW5pbS5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgIC8vIEVuc3VyZSB0aGUgY29tcGxldGUgaGFuZGxlciBpcyBjYWxsZWQgYmVmb3JlIHRoaXMgY29tcGxldGVzCiAgICAgICAgYW5pbS5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgICAgaG9va3MudW5xdWV1ZWQtLTsKICAgICAgICAgIGlmICghalF1ZXJ5LnF1ZXVlKGVsZW0sICJmeCIpLmxlbmd0aCkgewogICAgICAgICAgICBob29rcy5lbXB0eS5maXJlKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8vIERldGVjdCBzaG93L2hpZGUgYW5pbWF0aW9ucwogICAgZm9yIChwcm9wIGluIHByb3BzKSB7CiAgICAgIHZhbHVlID0gcHJvcHNbcHJvcF07CiAgICAgIGlmIChyZnh0eXBlcy50ZXN0KHZhbHVlKSkgewogICAgICAgIGRlbGV0ZSBwcm9wc1twcm9wXTsKICAgICAgICB0b2dnbGUgPSB0b2dnbGUgfHwgdmFsdWUgPT09ICJ0b2dnbGUiOwogICAgICAgIGlmICh2YWx1ZSA9PT0gKGhpZGRlbiA/ICJoaWRlIiA6ICJzaG93IikpIHsKICAgICAgICAgIC8vIFByZXRlbmQgdG8gYmUgaGlkZGVuIGlmIHRoaXMgaXMgYSAic2hvdyIgYW5kCiAgICAgICAgICAvLyB0aGVyZSBpcyBzdGlsbCBkYXRhIGZyb20gYSBzdG9wcGVkIHNob3cvaGlkZQogICAgICAgICAgaWYgKHZhbHVlID09PSAic2hvdyIgJiYgZGF0YVNob3cgJiYgZGF0YVNob3dbcHJvcF0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBoaWRkZW4gPSB0cnVlOwoKICAgICAgICAgICAgLy8gSWdub3JlIGFsbCBvdGhlciBuby1vcCBzaG93L2hpZGUgZGF0YQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIG9yaWdbcHJvcF0gPSBkYXRhU2hvdyAmJiBkYXRhU2hvd1twcm9wXSB8fCBqUXVlcnkuc3R5bGUoZWxlbSwgcHJvcCk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBCYWlsIG91dCBpZiB0aGlzIGlzIGEgbm8tb3AgbGlrZSAuaGlkZSgpLmhpZGUoKQogICAgcHJvcFR3ZWVuID0gIWpRdWVyeS5pc0VtcHR5T2JqZWN0KHByb3BzKTsKICAgIGlmICghcHJvcFR3ZWVuICYmIGpRdWVyeS5pc0VtcHR5T2JqZWN0KG9yaWcpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBSZXN0cmljdCAib3ZlcmZsb3ciIGFuZCAiZGlzcGxheSIgc3R5bGVzIGR1cmluZyBib3ggYW5pbWF0aW9ucwogICAgaWYgKGlzQm94ICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgLy8gU3VwcG9ydDogSUUgPD05IC0gMTEsIEVkZ2UgMTIgLSAxNQogICAgICAvLyBSZWNvcmQgYWxsIDMgb3ZlcmZsb3cgYXR0cmlidXRlcyBiZWNhdXNlIElFIGRvZXMgbm90IGluZmVyIHRoZSBzaG9ydGhhbmQKICAgICAgLy8gZnJvbSBpZGVudGljYWxseS12YWx1ZWQgb3ZlcmZsb3dYIGFuZCBvdmVyZmxvd1kgYW5kIEVkZ2UganVzdCBtaXJyb3JzCiAgICAgIC8vIHRoZSBvdmVyZmxvd1ggdmFsdWUgdGhlcmUuCiAgICAgIG9wdHMub3ZlcmZsb3cgPSBbc3R5bGUub3ZlcmZsb3csIHN0eWxlLm92ZXJmbG93WCwgc3R5bGUub3ZlcmZsb3dZXTsKCiAgICAgIC8vIElkZW50aWZ5IGEgZGlzcGxheSB0eXBlLCBwcmVmZXJyaW5nIG9sZCBzaG93L2hpZGUgZGF0YSBvdmVyIHRoZSBDU1MgY2FzY2FkZQogICAgICByZXN0b3JlRGlzcGxheSA9IGRhdGFTaG93ICYmIGRhdGFTaG93LmRpc3BsYXk7CiAgICAgIGlmIChyZXN0b3JlRGlzcGxheSA9PSBudWxsKSB7CiAgICAgICAgcmVzdG9yZURpc3BsYXkgPSBkYXRhUHJpdi5nZXQoZWxlbSwgImRpc3BsYXkiKTsKICAgICAgfQogICAgICBkaXNwbGF5ID0galF1ZXJ5LmNzcyhlbGVtLCAiZGlzcGxheSIpOwogICAgICBpZiAoZGlzcGxheSA9PT0gIm5vbmUiKSB7CiAgICAgICAgaWYgKHJlc3RvcmVEaXNwbGF5KSB7CiAgICAgICAgICBkaXNwbGF5ID0gcmVzdG9yZURpc3BsYXk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIEdldCBub25lbXB0eSB2YWx1ZShzKSBieSB0ZW1wb3JhcmlseSBmb3JjaW5nIHZpc2liaWxpdHkKICAgICAgICAgIHNob3dIaWRlKFtlbGVtXSwgdHJ1ZSk7CiAgICAgICAgICByZXN0b3JlRGlzcGxheSA9IGVsZW0uc3R5bGUuZGlzcGxheSB8fCByZXN0b3JlRGlzcGxheTsKICAgICAgICAgIGRpc3BsYXkgPSBqUXVlcnkuY3NzKGVsZW0sICJkaXNwbGF5Iik7CiAgICAgICAgICBzaG93SGlkZShbZWxlbV0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQW5pbWF0ZSBpbmxpbmUgZWxlbWVudHMgYXMgaW5saW5lLWJsb2NrCiAgICAgIGlmIChkaXNwbGF5ID09PSAiaW5saW5lIiB8fCBkaXNwbGF5ID09PSAiaW5saW5lLWJsb2NrIiAmJiByZXN0b3JlRGlzcGxheSAhPSBudWxsKSB7CiAgICAgICAgaWYgKGpRdWVyeS5jc3MoZWxlbSwgImZsb2F0IikgPT09ICJub25lIikgewogICAgICAgICAgLy8gUmVzdG9yZSB0aGUgb3JpZ2luYWwgZGlzcGxheSB2YWx1ZSBhdCB0aGUgZW5kIG9mIHB1cmUgc2hvdy9oaWRlIGFuaW1hdGlvbnMKICAgICAgICAgIGlmICghcHJvcFR3ZWVuKSB7CiAgICAgICAgICAgIGFuaW0uZG9uZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgc3R5bGUuZGlzcGxheSA9IHJlc3RvcmVEaXNwbGF5OwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKHJlc3RvcmVEaXNwbGF5ID09IG51bGwpIHsKICAgICAgICAgICAgICBkaXNwbGF5ID0gc3R5bGUuZGlzcGxheTsKICAgICAgICAgICAgICByZXN0b3JlRGlzcGxheSA9IGRpc3BsYXkgPT09ICJub25lIiA/ICIiIDogZGlzcGxheTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3R5bGUuZGlzcGxheSA9ICJpbmxpbmUtYmxvY2siOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKG9wdHMub3ZlcmZsb3cpIHsKICAgICAgc3R5bGUub3ZlcmZsb3cgPSAiaGlkZGVuIjsKICAgICAgYW5pbS5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgIHN0eWxlLm92ZXJmbG93ID0gb3B0cy5vdmVyZmxvd1swXTsKICAgICAgICBzdHlsZS5vdmVyZmxvd1ggPSBvcHRzLm92ZXJmbG93WzFdOwogICAgICAgIHN0eWxlLm92ZXJmbG93WSA9IG9wdHMub3ZlcmZsb3dbMl07CiAgICAgIH0pOwogICAgfQoKICAgIC8vIEltcGxlbWVudCBzaG93L2hpZGUgYW5pbWF0aW9ucwogICAgcHJvcFR3ZWVuID0gZmFsc2U7CiAgICBmb3IgKHByb3AgaW4gb3JpZykgewogICAgICAvLyBHZW5lcmFsIHNob3cvaGlkZSBzZXR1cCBmb3IgdGhpcyBlbGVtZW50IGFuaW1hdGlvbgogICAgICBpZiAoIXByb3BUd2VlbikgewogICAgICAgIGlmIChkYXRhU2hvdykgewogICAgICAgICAgaWYgKCJoaWRkZW4iIGluIGRhdGFTaG93KSB7CiAgICAgICAgICAgIGhpZGRlbiA9IGRhdGFTaG93LmhpZGRlbjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGF0YVNob3cgPSBkYXRhUHJpdi5hY2Nlc3MoZWxlbSwgImZ4c2hvdyIsIHsKICAgICAgICAgICAgZGlzcGxheTogcmVzdG9yZURpc3BsYXkKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gU3RvcmUgaGlkZGVuL3Zpc2libGUgZm9yIHRvZ2dsZSBzbyBgLnN0b3AoKS50b2dnbGUoKWAgInJldmVyc2VzIgogICAgICAgIGlmICh0b2dnbGUpIHsKICAgICAgICAgIGRhdGFTaG93LmhpZGRlbiA9ICFoaWRkZW47CiAgICAgICAgfQoKICAgICAgICAvLyBTaG93IGVsZW1lbnRzIGJlZm9yZSBhbmltYXRpbmcgdGhlbQogICAgICAgIGlmIChoaWRkZW4pIHsKICAgICAgICAgIHNob3dIaWRlKFtlbGVtXSwgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1sb29wLWZ1bmMgKi8KCiAgICAgICAgYW5pbS5kb25lKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8qIGVzbGludC1lbmFibGUgbm8tbG9vcC1mdW5jICovCgogICAgICAgICAgLy8gVGhlIGZpbmFsIHN0ZXAgb2YgYSAiaGlkZSIgYW5pbWF0aW9uIGlzIGFjdHVhbGx5IGhpZGluZyB0aGUgZWxlbWVudAogICAgICAgICAgaWYgKCFoaWRkZW4pIHsKICAgICAgICAgICAgc2hvd0hpZGUoW2VsZW1dKTsKICAgICAgICAgIH0KICAgICAgICAgIGRhdGFQcml2LnJlbW92ZShlbGVtLCAiZnhzaG93Iik7CiAgICAgICAgICBmb3IgKHByb3AgaW4gb3JpZykgewogICAgICAgICAgICBqUXVlcnkuc3R5bGUoZWxlbSwgcHJvcCwgb3JpZ1twcm9wXSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIC8vIFBlci1wcm9wZXJ0eSBzZXR1cAogICAgICBwcm9wVHdlZW4gPSBjcmVhdGVUd2VlbihoaWRkZW4gPyBkYXRhU2hvd1twcm9wXSA6IDAsIHByb3AsIGFuaW0pOwogICAgICBpZiAoIShwcm9wIGluIGRhdGFTaG93KSkgewogICAgICAgIGRhdGFTaG93W3Byb3BdID0gcHJvcFR3ZWVuLnN0YXJ0OwogICAgICAgIGlmIChoaWRkZW4pIHsKICAgICAgICAgIHByb3BUd2Vlbi5lbmQgPSBwcm9wVHdlZW4uc3RhcnQ7CiAgICAgICAgICBwcm9wVHdlZW4uc3RhcnQgPSAwOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBwcm9wRmlsdGVyKHByb3BzLCBzcGVjaWFsRWFzaW5nKSB7CiAgICB2YXIgaW5kZXgsIG5hbWUsIGVhc2luZywgdmFsdWUsIGhvb2tzOwoKICAgIC8vIGNhbWVsQ2FzZSwgc3BlY2lhbEVhc2luZyBhbmQgZXhwYW5kIGNzc0hvb2sgcGFzcwogICAgZm9yIChpbmRleCBpbiBwcm9wcykgewogICAgICBuYW1lID0gY2FtZWxDYXNlKGluZGV4KTsKICAgICAgZWFzaW5nID0gc3BlY2lhbEVhc2luZ1tuYW1lXTsKICAgICAgdmFsdWUgPSBwcm9wc1tpbmRleF07CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIGVhc2luZyA9IHZhbHVlWzFdOwogICAgICAgIHZhbHVlID0gcHJvcHNbaW5kZXhdID0gdmFsdWVbMF07CiAgICAgIH0KICAgICAgaWYgKGluZGV4ICE9PSBuYW1lKSB7CiAgICAgICAgcHJvcHNbbmFtZV0gPSB2YWx1ZTsKICAgICAgICBkZWxldGUgcHJvcHNbaW5kZXhdOwogICAgICB9CiAgICAgIGhvb2tzID0galF1ZXJ5LmNzc0hvb2tzW25hbWVdOwogICAgICBpZiAoaG9va3MgJiYgImV4cGFuZCIgaW4gaG9va3MpIHsKICAgICAgICB2YWx1ZSA9IGhvb2tzLmV4cGFuZCh2YWx1ZSk7CiAgICAgICAgZGVsZXRlIHByb3BzW25hbWVdOwoKICAgICAgICAvLyBOb3QgcXVpdGUgJC5leHRlbmQsIHRoaXMgd29uJ3Qgb3ZlcndyaXRlIGV4aXN0aW5nIGtleXMuCiAgICAgICAgLy8gUmV1c2luZyAnaW5kZXgnIGJlY2F1c2Ugd2UgaGF2ZSB0aGUgY29ycmVjdCAibmFtZSIKICAgICAgICBmb3IgKGluZGV4IGluIHZhbHVlKSB7CiAgICAgICAgICBpZiAoIShpbmRleCBpbiBwcm9wcykpIHsKICAgICAgICAgICAgcHJvcHNbaW5kZXhdID0gdmFsdWVbaW5kZXhdOwogICAgICAgICAgICBzcGVjaWFsRWFzaW5nW2luZGV4XSA9IGVhc2luZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3BlY2lhbEVhc2luZ1tuYW1lXSA9IGVhc2luZzsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBBbmltYXRpb24oZWxlbSwgcHJvcGVydGllcywgb3B0aW9ucykgewogICAgdmFyIHJlc3VsdCwKICAgICAgc3RvcHBlZCwKICAgICAgaW5kZXggPSAwLAogICAgICBsZW5ndGggPSBBbmltYXRpb24ucHJlZmlsdGVycy5sZW5ndGgsCiAgICAgIGRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCkuYWx3YXlzKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBEb24ndCBtYXRjaCBlbGVtIGluIHRoZSA6YW5pbWF0ZWQgc2VsZWN0b3IKICAgICAgICBkZWxldGUgdGljay5lbGVtOwogICAgICB9KSwKICAgICAgdGljayA9IGZ1bmN0aW9uIHRpY2soKSB7CiAgICAgICAgaWYgKHN0b3BwZWQpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwKICAgICAgICAgIHJlbWFpbmluZyA9IE1hdGgubWF4KDAsIGFuaW1hdGlvbi5zdGFydFRpbWUgKyBhbmltYXRpb24uZHVyYXRpb24gLSBjdXJyZW50VGltZSksCiAgICAgICAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDIuMyBvbmx5CiAgICAgICAgICAvLyBBcmNoYWljIGNyYXNoIGJ1ZyB3b24ndCBhbGxvdyB1cyB0byB1c2UgYDEgLSAoIDAuNSB8fCAwIClgICgjMTI0OTcpCiAgICAgICAgICB0ZW1wID0gcmVtYWluaW5nIC8gYW5pbWF0aW9uLmR1cmF0aW9uIHx8IDAsCiAgICAgICAgICBwZXJjZW50ID0gMSAtIHRlbXAsCiAgICAgICAgICBpbmRleCA9IDAsCiAgICAgICAgICBsZW5ndGggPSBhbmltYXRpb24udHdlZW5zLmxlbmd0aDsKICAgICAgICBmb3IgKDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgIGFuaW1hdGlvbi50d2VlbnNbaW5kZXhdLnJ1bihwZXJjZW50KTsKICAgICAgICB9CiAgICAgICAgZGVmZXJyZWQubm90aWZ5V2l0aChlbGVtLCBbYW5pbWF0aW9uLCBwZXJjZW50LCByZW1haW5pbmddKTsKCiAgICAgICAgLy8gSWYgdGhlcmUncyBtb3JlIHRvIGRvLCB5aWVsZAogICAgICAgIGlmIChwZXJjZW50IDwgMSAmJiBsZW5ndGgpIHsKICAgICAgICAgIHJldHVybiByZW1haW5pbmc7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB0aGlzIHdhcyBhbiBlbXB0eSBhbmltYXRpb24sIHN5bnRoZXNpemUgYSBmaW5hbCBwcm9ncmVzcyBub3RpZmljYXRpb24KICAgICAgICBpZiAoIWxlbmd0aCkgewogICAgICAgICAgZGVmZXJyZWQubm90aWZ5V2l0aChlbGVtLCBbYW5pbWF0aW9uLCAxLCAwXSk7CiAgICAgICAgfQoKICAgICAgICAvLyBSZXNvbHZlIHRoZSBhbmltYXRpb24gYW5kIHJlcG9ydCBpdHMgY29uY2x1c2lvbgogICAgICAgIGRlZmVycmVkLnJlc29sdmVXaXRoKGVsZW0sIFthbmltYXRpb25dKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0sCiAgICAgIGFuaW1hdGlvbiA9IGRlZmVycmVkLnByb21pc2UoewogICAgICAgIGVsZW06IGVsZW0sCiAgICAgICAgcHJvcHM6IGpRdWVyeS5leHRlbmQoe30sIHByb3BlcnRpZXMpLAogICAgICAgIG9wdHM6IGpRdWVyeS5leHRlbmQodHJ1ZSwgewogICAgICAgICAgc3BlY2lhbEVhc2luZzoge30sCiAgICAgICAgICBlYXNpbmc6IGpRdWVyeS5lYXNpbmcuX2RlZmF1bHQKICAgICAgICB9LCBvcHRpb25zKSwKICAgICAgICBvcmlnaW5hbFByb3BlcnRpZXM6IHByb3BlcnRpZXMsCiAgICAgICAgb3JpZ2luYWxPcHRpb25zOiBvcHRpb25zLAogICAgICAgIHN0YXJ0VGltZTogZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwKICAgICAgICBkdXJhdGlvbjogb3B0aW9ucy5kdXJhdGlvbiwKICAgICAgICB0d2VlbnM6IFtdLAogICAgICAgIGNyZWF0ZVR3ZWVuOiBmdW5jdGlvbiBjcmVhdGVUd2Vlbihwcm9wLCBlbmQpIHsKICAgICAgICAgIHZhciB0d2VlbiA9IGpRdWVyeS5Ud2VlbihlbGVtLCBhbmltYXRpb24ub3B0cywgcHJvcCwgZW5kLCBhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nW3Byb3BdIHx8IGFuaW1hdGlvbi5vcHRzLmVhc2luZyk7CiAgICAgICAgICBhbmltYXRpb24udHdlZW5zLnB1c2godHdlZW4pOwogICAgICAgICAgcmV0dXJuIHR3ZWVuOwogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gc3RvcChnb3RvRW5kKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSAwLAogICAgICAgICAgICAvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGVuZCwgd2Ugd2FudCB0byBydW4gYWxsIHRoZSB0d2VlbnMKICAgICAgICAgICAgLy8gb3RoZXJ3aXNlIHdlIHNraXAgdGhpcyBwYXJ0CiAgICAgICAgICAgIGxlbmd0aCA9IGdvdG9FbmQgPyBhbmltYXRpb24udHdlZW5zLmxlbmd0aCA6IDA7CiAgICAgICAgICBpZiAoc3RvcHBlZCkgewogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIHN0b3BwZWQgPSB0cnVlOwogICAgICAgICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgIGFuaW1hdGlvbi50d2VlbnNbaW5kZXhdLnJ1bigxKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBSZXNvbHZlIHdoZW4gd2UgcGxheWVkIHRoZSBsYXN0IGZyYW1lOyBvdGhlcndpc2UsIHJlamVjdAogICAgICAgICAgaWYgKGdvdG9FbmQpIHsKICAgICAgICAgICAgZGVmZXJyZWQubm90aWZ5V2l0aChlbGVtLCBbYW5pbWF0aW9uLCAxLCAwXSk7CiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmVXaXRoKGVsZW0sIFthbmltYXRpb24sIGdvdG9FbmRdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdFdpdGgoZWxlbSwgW2FuaW1hdGlvbiwgZ290b0VuZF0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICB9KSwKICAgICAgcHJvcHMgPSBhbmltYXRpb24ucHJvcHM7CiAgICBwcm9wRmlsdGVyKHByb3BzLCBhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nKTsKICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICByZXN1bHQgPSBBbmltYXRpb24ucHJlZmlsdGVyc1tpbmRleF0uY2FsbChhbmltYXRpb24sIGVsZW0sIHByb3BzLCBhbmltYXRpb24ub3B0cyk7CiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICBpZiAoaXNGdW5jdGlvbihyZXN1bHQuc3RvcCkpIHsKICAgICAgICAgIGpRdWVyeS5fcXVldWVIb29rcyhhbmltYXRpb24uZWxlbSwgYW5pbWF0aW9uLm9wdHMucXVldWUpLnN0b3AgPSByZXN1bHQuc3RvcC5iaW5kKHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgIH0KICAgIGpRdWVyeS5tYXAocHJvcHMsIGNyZWF0ZVR3ZWVuLCBhbmltYXRpb24pOwogICAgaWYgKGlzRnVuY3Rpb24oYW5pbWF0aW9uLm9wdHMuc3RhcnQpKSB7CiAgICAgIGFuaW1hdGlvbi5vcHRzLnN0YXJ0LmNhbGwoZWxlbSwgYW5pbWF0aW9uKTsKICAgIH0KCiAgICAvLyBBdHRhY2ggY2FsbGJhY2tzIGZyb20gb3B0aW9ucwogICAgYW5pbWF0aW9uLnByb2dyZXNzKGFuaW1hdGlvbi5vcHRzLnByb2dyZXNzKS5kb25lKGFuaW1hdGlvbi5vcHRzLmRvbmUsIGFuaW1hdGlvbi5vcHRzLmNvbXBsZXRlKS5mYWlsKGFuaW1hdGlvbi5vcHRzLmZhaWwpLmFsd2F5cyhhbmltYXRpb24ub3B0cy5hbHdheXMpOwogICAgalF1ZXJ5LmZ4LnRpbWVyKGpRdWVyeS5leHRlbmQodGljaywgewogICAgICBlbGVtOiBlbGVtLAogICAgICBhbmltOiBhbmltYXRpb24sCiAgICAgIHF1ZXVlOiBhbmltYXRpb24ub3B0cy5xdWV1ZQogICAgfSkpOwogICAgcmV0dXJuIGFuaW1hdGlvbjsKICB9CiAgalF1ZXJ5LkFuaW1hdGlvbiA9IGpRdWVyeS5leHRlbmQoQW5pbWF0aW9uLCB7CiAgICB0d2VlbmVyczogewogICAgICAiKiI6IFtmdW5jdGlvbiAocHJvcCwgdmFsdWUpIHsKICAgICAgICB2YXIgdHdlZW4gPSB0aGlzLmNyZWF0ZVR3ZWVuKHByb3AsIHZhbHVlKTsKICAgICAgICBhZGp1c3RDU1ModHdlZW4uZWxlbSwgcHJvcCwgcmNzc051bS5leGVjKHZhbHVlKSwgdHdlZW4pOwogICAgICAgIHJldHVybiB0d2VlbjsKICAgICAgfV0KICAgIH0sCiAgICB0d2VlbmVyOiBmdW5jdGlvbiB0d2VlbmVyKHByb3BzLCBjYWxsYmFjaykgewogICAgICBpZiAoaXNGdW5jdGlvbihwcm9wcykpIHsKICAgICAgICBjYWxsYmFjayA9IHByb3BzOwogICAgICAgIHByb3BzID0gWyIqIl07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcHJvcHMgPSBwcm9wcy5tYXRjaChybm90aHRtbHdoaXRlKTsKICAgICAgfQogICAgICB2YXIgcHJvcCwKICAgICAgICBpbmRleCA9IDAsCiAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwogICAgICBmb3IgKDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICBwcm9wID0gcHJvcHNbaW5kZXhdOwogICAgICAgIEFuaW1hdGlvbi50d2VlbmVyc1twcm9wXSA9IEFuaW1hdGlvbi50d2VlbmVyc1twcm9wXSB8fCBbXTsKICAgICAgICBBbmltYXRpb24udHdlZW5lcnNbcHJvcF0udW5zaGlmdChjYWxsYmFjayk7CiAgICAgIH0KICAgIH0sCiAgICBwcmVmaWx0ZXJzOiBbZGVmYXVsdFByZWZpbHRlcl0sCiAgICBwcmVmaWx0ZXI6IGZ1bmN0aW9uIHByZWZpbHRlcihjYWxsYmFjaywgcHJlcGVuZCkgewogICAgICBpZiAocHJlcGVuZCkgewogICAgICAgIEFuaW1hdGlvbi5wcmVmaWx0ZXJzLnVuc2hpZnQoY2FsbGJhY2spOwogICAgICB9IGVsc2UgewogICAgICAgIEFuaW1hdGlvbi5wcmVmaWx0ZXJzLnB1c2goY2FsbGJhY2spOwogICAgICB9CiAgICB9CiAgfSk7CiAgalF1ZXJ5LnNwZWVkID0gZnVuY3Rpb24gKHNwZWVkLCBlYXNpbmcsIGZuKSB7CiAgICB2YXIgb3B0ID0gc3BlZWQgJiYgX3R5cGVvZihzcGVlZCkgPT09ICJvYmplY3QiID8galF1ZXJ5LmV4dGVuZCh7fSwgc3BlZWQpIDogewogICAgICBjb21wbGV0ZTogZm4gfHwgIWZuICYmIGVhc2luZyB8fCBpc0Z1bmN0aW9uKHNwZWVkKSAmJiBzcGVlZCwKICAgICAgZHVyYXRpb246IHNwZWVkLAogICAgICBlYXNpbmc6IGZuICYmIGVhc2luZyB8fCBlYXNpbmcgJiYgIWlzRnVuY3Rpb24oZWFzaW5nKSAmJiBlYXNpbmcKICAgIH07CgogICAgLy8gR28gdG8gdGhlIGVuZCBzdGF0ZSBpZiBmeCBhcmUgb2ZmCiAgICBpZiAoalF1ZXJ5LmZ4Lm9mZikgewogICAgICBvcHQuZHVyYXRpb24gPSAwOwogICAgfSBlbHNlIHsKICAgICAgaWYgKHR5cGVvZiBvcHQuZHVyYXRpb24gIT09ICJudW1iZXIiKSB7CiAgICAgICAgaWYgKG9wdC5kdXJhdGlvbiBpbiBqUXVlcnkuZnguc3BlZWRzKSB7CiAgICAgICAgICBvcHQuZHVyYXRpb24gPSBqUXVlcnkuZnguc3BlZWRzW29wdC5kdXJhdGlvbl07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9wdC5kdXJhdGlvbiA9IGpRdWVyeS5meC5zcGVlZHMuX2RlZmF1bHQ7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gTm9ybWFsaXplIG9wdC5xdWV1ZSAtIHRydWUvdW5kZWZpbmVkL251bGwgLT4gImZ4IgogICAgaWYgKG9wdC5xdWV1ZSA9PSBudWxsIHx8IG9wdC5xdWV1ZSA9PT0gdHJ1ZSkgewogICAgICBvcHQucXVldWUgPSAiZngiOwogICAgfQoKICAgIC8vIFF1ZXVlaW5nCiAgICBvcHQub2xkID0gb3B0LmNvbXBsZXRlOwogICAgb3B0LmNvbXBsZXRlID0gZnVuY3Rpb24gKCkgewogICAgICBpZiAoaXNGdW5jdGlvbihvcHQub2xkKSkgewogICAgICAgIG9wdC5vbGQuY2FsbCh0aGlzKTsKICAgICAgfQogICAgICBpZiAob3B0LnF1ZXVlKSB7CiAgICAgICAgalF1ZXJ5LmRlcXVldWUodGhpcywgb3B0LnF1ZXVlKTsKICAgICAgfQogICAgfTsKICAgIHJldHVybiBvcHQ7CiAgfTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGZhZGVUbzogZnVuY3Rpb24gZmFkZVRvKHNwZWVkLCB0bywgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICAvLyBTaG93IGFueSBoaWRkZW4gZWxlbWVudHMgYWZ0ZXIgc2V0dGluZyBvcGFjaXR5IHRvIDAKICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKGlzSGlkZGVuV2l0aGluVHJlZSkuY3NzKCJvcGFjaXR5IiwgMCkuc2hvdygpCgogICAgICAvLyBBbmltYXRlIHRvIHRoZSB2YWx1ZSBzcGVjaWZpZWQKICAgICAgLmVuZCgpLmFuaW1hdGUoewogICAgICAgIG9wYWNpdHk6IHRvCiAgICAgIH0sIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKTsKICAgIH0sCiAgICBhbmltYXRlOiBmdW5jdGlvbiBhbmltYXRlKHByb3AsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBlbXB0eSA9IGpRdWVyeS5pc0VtcHR5T2JqZWN0KHByb3ApLAogICAgICAgIG9wdGFsbCA9IGpRdWVyeS5zcGVlZChzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayksCiAgICAgICAgZG9BbmltYXRpb24gPSBmdW5jdGlvbiBkb0FuaW1hdGlvbigpIHsKICAgICAgICAgIC8vIE9wZXJhdGUgb24gYSBjb3B5IG9mIHByb3Agc28gcGVyLXByb3BlcnR5IGVhc2luZyB3b24ndCBiZSBsb3N0CiAgICAgICAgICB2YXIgYW5pbSA9IEFuaW1hdGlvbih0aGlzLCBqUXVlcnkuZXh0ZW5kKHt9LCBwcm9wKSwgb3B0YWxsKTsKCiAgICAgICAgICAvLyBFbXB0eSBhbmltYXRpb25zLCBvciBmaW5pc2hpbmcgcmVzb2x2ZXMgaW1tZWRpYXRlbHkKICAgICAgICAgIGlmIChlbXB0eSB8fCBkYXRhUHJpdi5nZXQodGhpcywgImZpbmlzaCIpKSB7CiAgICAgICAgICAgIGFuaW0uc3RvcCh0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICBkb0FuaW1hdGlvbi5maW5pc2ggPSBkb0FuaW1hdGlvbjsKICAgICAgcmV0dXJuIGVtcHR5IHx8IG9wdGFsbC5xdWV1ZSA9PT0gZmFsc2UgPyB0aGlzLmVhY2goZG9BbmltYXRpb24pIDogdGhpcy5xdWV1ZShvcHRhbGwucXVldWUsIGRvQW5pbWF0aW9uKTsKICAgIH0sCiAgICBzdG9wOiBmdW5jdGlvbiBzdG9wKHR5cGUsIGNsZWFyUXVldWUsIGdvdG9FbmQpIHsKICAgICAgdmFyIHN0b3BRdWV1ZSA9IGZ1bmN0aW9uIHN0b3BRdWV1ZShob29rcykgewogICAgICAgIHZhciBzdG9wID0gaG9va3Muc3RvcDsKICAgICAgICBkZWxldGUgaG9va3Muc3RvcDsKICAgICAgICBzdG9wKGdvdG9FbmQpOwogICAgICB9OwogICAgICBpZiAodHlwZW9mIHR5cGUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgZ290b0VuZCA9IGNsZWFyUXVldWU7CiAgICAgICAgY2xlYXJRdWV1ZSA9IHR5cGU7CiAgICAgICAgdHlwZSA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICBpZiAoY2xlYXJRdWV1ZSkgewogICAgICAgIHRoaXMucXVldWUodHlwZSB8fCAiZngiLCBbXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGRlcXVldWUgPSB0cnVlLAogICAgICAgICAgaW5kZXggPSB0eXBlICE9IG51bGwgJiYgdHlwZSArICJxdWV1ZUhvb2tzIiwKICAgICAgICAgIHRpbWVycyA9IGpRdWVyeS50aW1lcnMsCiAgICAgICAgICBkYXRhID0gZGF0YVByaXYuZ2V0KHRoaXMpOwogICAgICAgIGlmIChpbmRleCkgewogICAgICAgICAgaWYgKGRhdGFbaW5kZXhdICYmIGRhdGFbaW5kZXhdLnN0b3ApIHsKICAgICAgICAgICAgc3RvcFF1ZXVlKGRhdGFbaW5kZXhdKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChpbmRleCBpbiBkYXRhKSB7CiAgICAgICAgICAgIGlmIChkYXRhW2luZGV4XSAmJiBkYXRhW2luZGV4XS5zdG9wICYmIHJydW4udGVzdChpbmRleCkpIHsKICAgICAgICAgICAgICBzdG9wUXVldWUoZGF0YVtpbmRleF0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAoaW5kZXggPSB0aW1lcnMubGVuZ3RoOyBpbmRleC0tOykgewogICAgICAgICAgaWYgKHRpbWVyc1tpbmRleF0uZWxlbSA9PT0gdGhpcyAmJiAodHlwZSA9PSBudWxsIHx8IHRpbWVyc1tpbmRleF0ucXVldWUgPT09IHR5cGUpKSB7CiAgICAgICAgICAgIHRpbWVyc1tpbmRleF0uYW5pbS5zdG9wKGdvdG9FbmQpOwogICAgICAgICAgICBkZXF1ZXVlID0gZmFsc2U7CiAgICAgICAgICAgIHRpbWVycy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gU3RhcnQgdGhlIG5leHQgaW4gdGhlIHF1ZXVlIGlmIHRoZSBsYXN0IHN0ZXAgd2Fzbid0IGZvcmNlZC4KICAgICAgICAvLyBUaW1lcnMgY3VycmVudGx5IHdpbGwgY2FsbCB0aGVpciBjb21wbGV0ZSBjYWxsYmFja3MsIHdoaWNoCiAgICAgICAgLy8gd2lsbCBkZXF1ZXVlIGJ1dCBvbmx5IGlmIHRoZXkgd2VyZSBnb3RvRW5kLgogICAgICAgIGlmIChkZXF1ZXVlIHx8ICFnb3RvRW5kKSB7CiAgICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCB0eXBlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGZpbmlzaDogZnVuY3Rpb24gZmluaXNoKHR5cGUpIHsKICAgICAgaWYgKHR5cGUgIT09IGZhbHNlKSB7CiAgICAgICAgdHlwZSA9IHR5cGUgfHwgImZ4IjsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgaW5kZXgsCiAgICAgICAgICBkYXRhID0gZGF0YVByaXYuZ2V0KHRoaXMpLAogICAgICAgICAgcXVldWUgPSBkYXRhW3R5cGUgKyAicXVldWUiXSwKICAgICAgICAgIGhvb2tzID0gZGF0YVt0eXBlICsgInF1ZXVlSG9va3MiXSwKICAgICAgICAgIHRpbWVycyA9IGpRdWVyeS50aW1lcnMsCiAgICAgICAgICBsZW5ndGggPSBxdWV1ZSA/IHF1ZXVlLmxlbmd0aCA6IDA7CgogICAgICAgIC8vIEVuYWJsZSBmaW5pc2hpbmcgZmxhZyBvbiBwcml2YXRlIGRhdGEKICAgICAgICBkYXRhLmZpbmlzaCA9IHRydWU7CgogICAgICAgIC8vIEVtcHR5IHRoZSBxdWV1ZSBmaXJzdAogICAgICAgIGpRdWVyeS5xdWV1ZSh0aGlzLCB0eXBlLCBbXSk7CiAgICAgICAgaWYgKGhvb2tzICYmIGhvb2tzLnN0b3ApIHsKICAgICAgICAgIGhvb2tzLnN0b3AuY2FsbCh0aGlzLCB0cnVlKTsKICAgICAgICB9CgogICAgICAgIC8vIExvb2sgZm9yIGFueSBhY3RpdmUgYW5pbWF0aW9ucywgYW5kIGZpbmlzaCB0aGVtCiAgICAgICAgZm9yIChpbmRleCA9IHRpbWVycy5sZW5ndGg7IGluZGV4LS07KSB7CiAgICAgICAgICBpZiAodGltZXJzW2luZGV4XS5lbGVtID09PSB0aGlzICYmIHRpbWVyc1tpbmRleF0ucXVldWUgPT09IHR5cGUpIHsKICAgICAgICAgICAgdGltZXJzW2luZGV4XS5hbmltLnN0b3AodHJ1ZSk7CiAgICAgICAgICAgIHRpbWVycy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gTG9vayBmb3IgYW55IGFuaW1hdGlvbnMgaW4gdGhlIG9sZCBxdWV1ZSBhbmQgZmluaXNoIHRoZW0KICAgICAgICBmb3IgKGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgIGlmIChxdWV1ZVtpbmRleF0gJiYgcXVldWVbaW5kZXhdLmZpbmlzaCkgewogICAgICAgICAgICBxdWV1ZVtpbmRleF0uZmluaXNoLmNhbGwodGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBUdXJuIG9mZiBmaW5pc2hpbmcgZmxhZwogICAgICAgIGRlbGV0ZSBkYXRhLmZpbmlzaDsKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmVhY2goWyJ0b2dnbGUiLCAic2hvdyIsICJoaWRlIl0sIGZ1bmN0aW9uIChfaSwgbmFtZSkgewogICAgdmFyIGNzc0ZuID0galF1ZXJ5LmZuW25hbWVdOwogICAgalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24gKHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBzcGVlZCA9PSBudWxsIHx8IHR5cGVvZiBzcGVlZCA9PT0gImJvb2xlYW4iID8gY3NzRm4uYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IHRoaXMuYW5pbWF0ZShnZW5GeChuYW1lLCB0cnVlKSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2spOwogICAgfTsKICB9KTsKCiAgLy8gR2VuZXJhdGUgc2hvcnRjdXRzIGZvciBjdXN0b20gYW5pbWF0aW9ucwogIGpRdWVyeS5lYWNoKHsKICAgIHNsaWRlRG93bjogZ2VuRngoInNob3ciKSwKICAgIHNsaWRlVXA6IGdlbkZ4KCJoaWRlIiksCiAgICBzbGlkZVRvZ2dsZTogZ2VuRngoInRvZ2dsZSIpLAogICAgZmFkZUluOiB7CiAgICAgIG9wYWNpdHk6ICJzaG93IgogICAgfSwKICAgIGZhZGVPdXQ6IHsKICAgICAgb3BhY2l0eTogImhpZGUiCiAgICB9LAogICAgZmFkZVRvZ2dsZTogewogICAgICBvcGFjaXR5OiAidG9nZ2xlIgogICAgfQogIH0sIGZ1bmN0aW9uIChuYW1lLCBwcm9wcykgewogICAgalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24gKHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLmFuaW1hdGUocHJvcHMsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKTsKICAgIH07CiAgfSk7CiAgalF1ZXJ5LnRpbWVycyA9IFtdOwogIGpRdWVyeS5meC50aWNrID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHRpbWVyLAogICAgICBpID0gMCwKICAgICAgdGltZXJzID0galF1ZXJ5LnRpbWVyczsKICAgIGZ4Tm93ID0gRGF0ZS5ub3coKTsKICAgIGZvciAoOyBpIDwgdGltZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHRpbWVyID0gdGltZXJzW2ldOwoKICAgICAgLy8gUnVuIHRoZSB0aW1lciBhbmQgc2FmZWx5IHJlbW92ZSBpdCB3aGVuIGRvbmUgKGFsbG93aW5nIGZvciBleHRlcm5hbCByZW1vdmFsKQogICAgICBpZiAoIXRpbWVyKCkgJiYgdGltZXJzW2ldID09PSB0aW1lcikgewogICAgICAgIHRpbWVycy5zcGxpY2UoaS0tLCAxKTsKICAgICAgfQogICAgfQogICAgaWYgKCF0aW1lcnMubGVuZ3RoKSB7CiAgICAgIGpRdWVyeS5meC5zdG9wKCk7CiAgICB9CiAgICBmeE5vdyA9IHVuZGVmaW5lZDsKICB9OwogIGpRdWVyeS5meC50aW1lciA9IGZ1bmN0aW9uICh0aW1lcikgewogICAgalF1ZXJ5LnRpbWVycy5wdXNoKHRpbWVyKTsKICAgIGpRdWVyeS5meC5zdGFydCgpOwogIH07CiAgalF1ZXJ5LmZ4LmludGVydmFsID0gMTM7CiAgalF1ZXJ5LmZ4LnN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKGluUHJvZ3Jlc3MpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaW5Qcm9ncmVzcyA9IHRydWU7CiAgICBzY2hlZHVsZSgpOwogIH07CiAgalF1ZXJ5LmZ4LnN0b3AgPSBmdW5jdGlvbiAoKSB7CiAgICBpblByb2dyZXNzID0gbnVsbDsKICB9OwogIGpRdWVyeS5meC5zcGVlZHMgPSB7CiAgICBzbG93OiA2MDAsCiAgICBmYXN0OiAyMDAsCiAgICAvLyBEZWZhdWx0IHNwZWVkCiAgICBfZGVmYXVsdDogNDAwCiAgfTsKCiAgLy8gQmFzZWQgb2ZmIG9mIHRoZSBwbHVnaW4gYnkgQ2xpbnQgSGVsZmVycywgd2l0aCBwZXJtaXNzaW9uLgogIC8vIGh0dHBzOi8vd2ViLmFyY2hpdmUub3JnL3dlYi8yMDEwMDMyNDAxNDc0Ny9odHRwOi8vYmxpbmRzaWduYWxzLmNvbS9pbmRleC5waHAvMjAwOS8wNy9qcXVlcnktZGVsYXkvCiAgalF1ZXJ5LmZuLmRlbGF5ID0gZnVuY3Rpb24gKHRpbWUsIHR5cGUpIHsKICAgIHRpbWUgPSBqUXVlcnkuZnggPyBqUXVlcnkuZnguc3BlZWRzW3RpbWVdIHx8IHRpbWUgOiB0aW1lOwogICAgdHlwZSA9IHR5cGUgfHwgImZ4IjsKICAgIHJldHVybiB0aGlzLnF1ZXVlKHR5cGUsIGZ1bmN0aW9uIChuZXh0LCBob29rcykgewogICAgICB2YXIgdGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KG5leHQsIHRpbWUpOwogICAgICBob29rcy5zdG9wID0gZnVuY3Rpb24gKCkgewogICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgIH07CiAgICB9KTsKICB9OwogIChmdW5jdGlvbiAoKSB7CiAgICB2YXIgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpLAogICAgICBzZWxlY3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzZWxlY3QiKSwKICAgICAgb3B0ID0gc2VsZWN0LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpKTsKICAgIGlucHV0LnR5cGUgPSAiY2hlY2tib3giOwoKICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjMgb25seQogICAgLy8gRGVmYXVsdCB2YWx1ZSBmb3IgYSBjaGVja2JveCBzaG91bGQgYmUgIm9uIgogICAgc3VwcG9ydC5jaGVja09uID0gaW5wdXQudmFsdWUgIT09ICIiOwoKICAgIC8vIFN1cHBvcnQ6IElFIDw9MTEgb25seQogICAgLy8gTXVzdCBhY2Nlc3Mgc2VsZWN0ZWRJbmRleCB0byBtYWtlIGRlZmF1bHQgb3B0aW9ucyBzZWxlY3QKICAgIHN1cHBvcnQub3B0U2VsZWN0ZWQgPSBvcHQuc2VsZWN0ZWQ7CgogICAgLy8gU3VwcG9ydDogSUUgPD0xMSBvbmx5CiAgICAvLyBBbiBpbnB1dCBsb3NlcyBpdHMgdmFsdWUgYWZ0ZXIgYmVjb21pbmcgYSByYWRpbwogICAgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgaW5wdXQudmFsdWUgPSAidCI7CiAgICBpbnB1dC50eXBlID0gInJhZGlvIjsKICAgIHN1cHBvcnQucmFkaW9WYWx1ZSA9IGlucHV0LnZhbHVlID09PSAidCI7CiAgfSkoKTsKICB2YXIgYm9vbEhvb2ssCiAgICBhdHRySGFuZGxlID0galF1ZXJ5LmV4cHIuYXR0ckhhbmRsZTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGF0dHI6IGZ1bmN0aW9uIGF0dHIobmFtZSwgdmFsdWUpIHsKICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBqUXVlcnkuYXR0ciwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxKTsKICAgIH0sCiAgICByZW1vdmVBdHRyOiBmdW5jdGlvbiByZW1vdmVBdHRyKG5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LnJlbW92ZUF0dHIodGhpcywgbmFtZSk7CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5leHRlbmQoewogICAgYXR0cjogZnVuY3Rpb24gYXR0cihlbGVtLCBuYW1lLCB2YWx1ZSkgewogICAgICB2YXIgcmV0LAogICAgICAgIGhvb2tzLAogICAgICAgIG5UeXBlID0gZWxlbS5ub2RlVHlwZTsKCiAgICAgIC8vIERvbid0IGdldC9zZXQgYXR0cmlidXRlcyBvbiB0ZXh0LCBjb21tZW50IGFuZCBhdHRyaWJ1dGUgbm9kZXMKICAgICAgaWYgKG5UeXBlID09PSAzIHx8IG5UeXBlID09PSA4IHx8IG5UeXBlID09PSAyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBGYWxsYmFjayB0byBwcm9wIHdoZW4gYXR0cmlidXRlcyBhcmUgbm90IHN1cHBvcnRlZAogICAgICBpZiAodHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlID09PSAidW5kZWZpbmVkIikgewogICAgICAgIHJldHVybiBqUXVlcnkucHJvcChlbGVtLCBuYW1lLCB2YWx1ZSk7CiAgICAgIH0KCiAgICAgIC8vIEF0dHJpYnV0ZSBob29rcyBhcmUgZGV0ZXJtaW5lZCBieSB0aGUgbG93ZXJjYXNlIHZlcnNpb24KICAgICAgLy8gR3JhYiBuZWNlc3NhcnkgaG9vayBpZiBvbmUgaXMgZGVmaW5lZAogICAgICBpZiAoblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyhlbGVtKSkgewogICAgICAgIGhvb2tzID0galF1ZXJ5LmF0dHJIb29rc1tuYW1lLnRvTG93ZXJDYXNlKCldIHx8IChqUXVlcnkuZXhwci5tYXRjaC5ib29sLnRlc3QobmFtZSkgPyBib29sSG9vayA6IHVuZGVmaW5lZCk7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgIGpRdWVyeS5yZW1vdmVBdHRyKGVsZW0sIG5hbWUpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaG9va3MgJiYgInNldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLnNldChlbGVtLCB2YWx1ZSwgbmFtZSkpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfQogICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlICsgIiIpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICBpZiAoaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldChlbGVtLCBuYW1lKSkgIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gcmV0OwogICAgICB9CiAgICAgIHJldCA9IGpRdWVyeS5maW5kLmF0dHIoZWxlbSwgbmFtZSk7CgogICAgICAvLyBOb24tZXhpc3RlbnQgYXR0cmlidXRlcyByZXR1cm4gbnVsbCwgd2Ugbm9ybWFsaXplIHRvIHVuZGVmaW5lZAogICAgICByZXR1cm4gcmV0ID09IG51bGwgPyB1bmRlZmluZWQgOiByZXQ7CiAgICB9LAogICAgYXR0ckhvb2tzOiB7CiAgICAgIHR5cGU6IHsKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChlbGVtLCB2YWx1ZSkgewogICAgICAgICAgaWYgKCFzdXBwb3J0LnJhZGlvVmFsdWUgJiYgdmFsdWUgPT09ICJyYWRpbyIgJiYgbm9kZU5hbWUoZWxlbSwgImlucHV0IikpIHsKICAgICAgICAgICAgdmFyIHZhbCA9IGVsZW0udmFsdWU7CiAgICAgICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKCJ0eXBlIiwgdmFsdWUpOwogICAgICAgICAgICBpZiAodmFsKSB7CiAgICAgICAgICAgICAgZWxlbS52YWx1ZSA9IHZhbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24gcmVtb3ZlQXR0cihlbGVtLCB2YWx1ZSkgewogICAgICB2YXIgbmFtZSwKICAgICAgICBpID0gMCwKICAgICAgICAvLyBBdHRyaWJ1dGUgbmFtZXMgY2FuIGNvbnRhaW4gbm9uLUhUTUwgd2hpdGVzcGFjZSBjaGFyYWN0ZXJzCiAgICAgICAgLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2Uvc3ludGF4Lmh0bWwjYXR0cmlidXRlcy0yCiAgICAgICAgYXR0ck5hbWVzID0gdmFsdWUgJiYgdmFsdWUubWF0Y2gocm5vdGh0bWx3aGl0ZSk7CiAgICAgIGlmIChhdHRyTmFtZXMgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgIHdoaWxlIChuYW1lID0gYXR0ck5hbWVzW2krK10pIHsKICAgICAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwoKICAvLyBIb29rcyBmb3IgYm9vbGVhbiBhdHRyaWJ1dGVzCiAgYm9vbEhvb2sgPSB7CiAgICBzZXQ6IGZ1bmN0aW9uIHNldChlbGVtLCB2YWx1ZSwgbmFtZSkgewogICAgICBpZiAodmFsdWUgPT09IGZhbHNlKSB7CiAgICAgICAgLy8gUmVtb3ZlIGJvb2xlYW4gYXR0cmlidXRlcyB3aGVuIHNldCB0byBmYWxzZQogICAgICAgIGpRdWVyeS5yZW1vdmVBdHRyKGVsZW0sIG5hbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKG5hbWUsIG5hbWUpOwogICAgICB9CiAgICAgIHJldHVybiBuYW1lOwogICAgfQogIH07CiAgalF1ZXJ5LmVhY2goalF1ZXJ5LmV4cHIubWF0Y2guYm9vbC5zb3VyY2UubWF0Y2goL1x3Ky9nKSwgZnVuY3Rpb24gKF9pLCBuYW1lKSB7CiAgICB2YXIgZ2V0dGVyID0gYXR0ckhhbmRsZVtuYW1lXSB8fCBqUXVlcnkuZmluZC5hdHRyOwogICAgYXR0ckhhbmRsZVtuYW1lXSA9IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBpc1hNTCkgewogICAgICB2YXIgcmV0LAogICAgICAgIGhhbmRsZSwKICAgICAgICBsb3dlcmNhc2VOYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICBpZiAoIWlzWE1MKSB7CiAgICAgICAgLy8gQXZvaWQgYW4gaW5maW5pdGUgbG9vcCBieSB0ZW1wb3JhcmlseSByZW1vdmluZyB0aGlzIGZ1bmN0aW9uIGZyb20gdGhlIGdldHRlcgogICAgICAgIGhhbmRsZSA9IGF0dHJIYW5kbGVbbG93ZXJjYXNlTmFtZV07CiAgICAgICAgYXR0ckhhbmRsZVtsb3dlcmNhc2VOYW1lXSA9IHJldDsKICAgICAgICByZXQgPSBnZXR0ZXIoZWxlbSwgbmFtZSwgaXNYTUwpICE9IG51bGwgPyBsb3dlcmNhc2VOYW1lIDogbnVsbDsKICAgICAgICBhdHRySGFuZGxlW2xvd2VyY2FzZU5hbWVdID0gaGFuZGxlOwogICAgICB9CiAgICAgIHJldHVybiByZXQ7CiAgICB9OwogIH0pOwogIHZhciByZm9jdXNhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaSwKICAgIHJjbGlja2FibGUgPSAvXig/OmF8YXJlYSkkL2k7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBwcm9wOiBmdW5jdGlvbiBwcm9wKG5hbWUsIHZhbHVlKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgalF1ZXJ5LnByb3AsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSk7CiAgICB9LAogICAgcmVtb3ZlUHJvcDogZnVuY3Rpb24gcmVtb3ZlUHJvcChuYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGRlbGV0ZSB0aGlzW2pRdWVyeS5wcm9wRml4W25hbWVdIHx8IG5hbWVdOwogICAgICB9KTsKICAgIH0KICB9KTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIHByb3A6IGZ1bmN0aW9uIHByb3AoZWxlbSwgbmFtZSwgdmFsdWUpIHsKICAgICAgdmFyIHJldCwKICAgICAgICBob29rcywKICAgICAgICBuVHlwZSA9IGVsZW0ubm9kZVR5cGU7CgogICAgICAvLyBEb24ndCBnZXQvc2V0IHByb3BlcnRpZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCiAgICAgIGlmIChuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyhlbGVtKSkgewogICAgICAgIC8vIEZpeCBuYW1lIGFuZCBhdHRhY2ggaG9va3MKICAgICAgICBuYW1lID0galF1ZXJ5LnByb3BGaXhbbmFtZV0gfHwgbmFtZTsKICAgICAgICBob29rcyA9IGpRdWVyeS5wcm9wSG9va3NbbmFtZV07CiAgICAgIH0KICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoaG9va3MgJiYgInNldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLnNldChlbGVtLCB2YWx1ZSwgbmFtZSkpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBlbGVtW25hbWVdID0gdmFsdWU7CiAgICAgIH0KICAgICAgaWYgKGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgbmFtZSkpICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHJldDsKICAgICAgfQogICAgICByZXR1cm4gZWxlbVtuYW1lXTsKICAgIH0sCiAgICBwcm9wSG9va3M6IHsKICAgICAgdGFiSW5kZXg6IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldChlbGVtKSB7CiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSBvbmx5CiAgICAgICAgICAvLyBlbGVtLnRhYkluZGV4IGRvZXNuJ3QgYWx3YXlzIHJldHVybiB0aGUKICAgICAgICAgIC8vIGNvcnJlY3QgdmFsdWUgd2hlbiBpdCBoYXNuJ3QgYmVlbiBleHBsaWNpdGx5IHNldAogICAgICAgICAgLy8gaHR0cHM6Ly93ZWIuYXJjaGl2ZS5vcmcvd2ViLzIwMTQxMTE2MjMzMzQ3L2h0dHA6Ly9mbHVpZHByb2plY3Qub3JnL2Jsb2cvMjAwOC8wMS8wOS9nZXR0aW5nLXNldHRpbmctYW5kLXJlbW92aW5nLXRhYmluZGV4LXZhbHVlcy13aXRoLWphdmFzY3JpcHQvCiAgICAgICAgICAvLyBVc2UgcHJvcGVyIGF0dHJpYnV0ZSByZXRyaWV2YWwoIzEyMDcyKQogICAgICAgICAgdmFyIHRhYmluZGV4ID0galF1ZXJ5LmZpbmQuYXR0cihlbGVtLCAidGFiaW5kZXgiKTsKICAgICAgICAgIGlmICh0YWJpbmRleCkgewogICAgICAgICAgICByZXR1cm4gcGFyc2VJbnQodGFiaW5kZXgsIDEwKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZm9jdXNhYmxlLnRlc3QoZWxlbS5ub2RlTmFtZSkgfHwgcmNsaWNrYWJsZS50ZXN0KGVsZW0ubm9kZU5hbWUpICYmIGVsZW0uaHJlZikgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBwcm9wRml4OiB7CiAgICAgICJmb3IiOiAiaHRtbEZvciIsCiAgICAgICJjbGFzcyI6ICJjbGFzc05hbWUiCiAgICB9CiAgfSk7CgogIC8vIFN1cHBvcnQ6IElFIDw9MTEgb25seQogIC8vIEFjY2Vzc2luZyB0aGUgc2VsZWN0ZWRJbmRleCBwcm9wZXJ0eQogIC8vIGZvcmNlcyB0aGUgYnJvd3NlciB0byByZXNwZWN0IHNldHRpbmcgc2VsZWN0ZWQKICAvLyBvbiB0aGUgb3B0aW9uCiAgLy8gVGhlIGdldHRlciBlbnN1cmVzIGEgZGVmYXVsdCBvcHRpb24gaXMgc2VsZWN0ZWQKICAvLyB3aGVuIGluIGFuIG9wdGdyb3VwCiAgLy8gZXNsaW50IHJ1bGUgIm5vLXVudXNlZC1leHByZXNzaW9ucyIgaXMgZGlzYWJsZWQgZm9yIHRoaXMgY29kZQogIC8vIHNpbmNlIGl0IGNvbnNpZGVycyBzdWNoIGFjY2Vzc2lvbnMgbm9vcAogIGlmICghc3VwcG9ydC5vcHRTZWxlY3RlZCkgewogICAgalF1ZXJ5LnByb3BIb29rcy5zZWxlY3RlZCA9IHsKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoZWxlbSkgewogICAgICAgIC8qIGVzbGludCBuby11bnVzZWQtZXhwcmVzc2lvbnM6ICJvZmYiICovCgogICAgICAgIHZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CiAgICAgICAgaWYgKHBhcmVudCAmJiBwYXJlbnQucGFyZW50Tm9kZSkgewogICAgICAgICAgcGFyZW50LnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KGVsZW0pIHsKICAgICAgICAvKiBlc2xpbnQgbm8tdW51c2VkLWV4cHJlc3Npb25zOiAib2ZmIiAqLwoKICAgICAgICB2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwogICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgIHBhcmVudC5zZWxlY3RlZEluZGV4OwogICAgICAgICAgaWYgKHBhcmVudC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgIHBhcmVudC5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH0KICBqUXVlcnkuZWFjaChbInRhYkluZGV4IiwgInJlYWRPbmx5IiwgIm1heExlbmd0aCIsICJjZWxsU3BhY2luZyIsICJjZWxsUGFkZGluZyIsICJyb3dTcGFuIiwgImNvbFNwYW4iLCAidXNlTWFwIiwgImZyYW1lQm9yZGVyIiwgImNvbnRlbnRFZGl0YWJsZSJdLCBmdW5jdGlvbiAoKSB7CiAgICBqUXVlcnkucHJvcEZpeFt0aGlzLnRvTG93ZXJDYXNlKCldID0gdGhpczsKICB9KTsKCiAgLy8gU3RyaXAgYW5kIGNvbGxhcHNlIHdoaXRlc3BhY2UgYWNjb3JkaW5nIHRvIEhUTUwgc3BlYwogIC8vIGh0dHBzOi8vaW5mcmEuc3BlYy53aGF0d2cub3JnLyNzdHJpcC1hbmQtY29sbGFwc2UtYXNjaWktd2hpdGVzcGFjZQogIGZ1bmN0aW9uIHN0cmlwQW5kQ29sbGFwc2UodmFsdWUpIHsKICAgIHZhciB0b2tlbnMgPSB2YWx1ZS5tYXRjaChybm90aHRtbHdoaXRlKSB8fCBbXTsKICAgIHJldHVybiB0b2tlbnMuam9pbigiICIpOwogIH0KICBmdW5jdGlvbiBnZXRDbGFzcyhlbGVtKSB7CiAgICByZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzIikgfHwgIiI7CiAgfQogIGZ1bmN0aW9uIGNsYXNzZXNUb0FycmF5KHZhbHVlKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHsKICAgICAgcmV0dXJuIHZhbHVlLm1hdGNoKHJub3RodG1sd2hpdGUpIHx8IFtdOwogICAgfQogICAgcmV0dXJuIFtdOwogIH0KICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGFkZENsYXNzOiBmdW5jdGlvbiBhZGRDbGFzcyh2YWx1ZSkgewogICAgICB2YXIgY2xhc3NlcywKICAgICAgICBlbGVtLAogICAgICAgIGN1ciwKICAgICAgICBjdXJWYWx1ZSwKICAgICAgICBjbGF6eiwKICAgICAgICBqLAogICAgICAgIGZpbmFsVmFsdWUsCiAgICAgICAgaSA9IDA7CiAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGopIHsKICAgICAgICAgIGpRdWVyeSh0aGlzKS5hZGRDbGFzcyh2YWx1ZS5jYWxsKHRoaXMsIGosIGdldENsYXNzKHRoaXMpKSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgY2xhc3NlcyA9IGNsYXNzZXNUb0FycmF5KHZhbHVlKTsKICAgICAgaWYgKGNsYXNzZXMubGVuZ3RoKSB7CiAgICAgICAgd2hpbGUgKGVsZW0gPSB0aGlzW2krK10pIHsKICAgICAgICAgIGN1clZhbHVlID0gZ2V0Q2xhc3MoZWxlbSk7CiAgICAgICAgICBjdXIgPSBlbGVtLm5vZGVUeXBlID09PSAxICYmICIgIiArIHN0cmlwQW5kQ29sbGFwc2UoY3VyVmFsdWUpICsgIiAiOwogICAgICAgICAgaWYgKGN1cikgewogICAgICAgICAgICBqID0gMDsKICAgICAgICAgICAgd2hpbGUgKGNsYXp6ID0gY2xhc3Nlc1tqKytdKSB7CiAgICAgICAgICAgICAgaWYgKGN1ci5pbmRleE9mKCIgIiArIGNsYXp6ICsgIiAiKSA8IDApIHsKICAgICAgICAgICAgICAgIGN1ciArPSBjbGF6eiArICIgIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9ubHkgYXNzaWduIGlmIGRpZmZlcmVudCB0byBhdm9pZCB1bm5lZWRlZCByZW5kZXJpbmcuCiAgICAgICAgICAgIGZpbmFsVmFsdWUgPSBzdHJpcEFuZENvbGxhcHNlKGN1cik7CiAgICAgICAgICAgIGlmIChjdXJWYWx1ZSAhPT0gZmluYWxWYWx1ZSkgewogICAgICAgICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKCJjbGFzcyIsIGZpbmFsVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbiByZW1vdmVDbGFzcyh2YWx1ZSkgewogICAgICB2YXIgY2xhc3NlcywKICAgICAgICBlbGVtLAogICAgICAgIGN1ciwKICAgICAgICBjdXJWYWx1ZSwKICAgICAgICBjbGF6eiwKICAgICAgICBqLAogICAgICAgIGZpbmFsVmFsdWUsCiAgICAgICAgaSA9IDA7CiAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGopIHsKICAgICAgICAgIGpRdWVyeSh0aGlzKS5yZW1vdmVDbGFzcyh2YWx1ZS5jYWxsKHRoaXMsIGosIGdldENsYXNzKHRoaXMpKSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYXR0cigiY2xhc3MiLCAiIik7CiAgICAgIH0KICAgICAgY2xhc3NlcyA9IGNsYXNzZXNUb0FycmF5KHZhbHVlKTsKICAgICAgaWYgKGNsYXNzZXMubGVuZ3RoKSB7CiAgICAgICAgd2hpbGUgKGVsZW0gPSB0aGlzW2krK10pIHsKICAgICAgICAgIGN1clZhbHVlID0gZ2V0Q2xhc3MoZWxlbSk7CgogICAgICAgICAgLy8gVGhpcyBleHByZXNzaW9uIGlzIGhlcmUgZm9yIGJldHRlciBjb21wcmVzc2liaWxpdHkgKHNlZSBhZGRDbGFzcykKICAgICAgICAgIGN1ciA9IGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgIiAiICsgc3RyaXBBbmRDb2xsYXBzZShjdXJWYWx1ZSkgKyAiICI7CiAgICAgICAgICBpZiAoY3VyKSB7CiAgICAgICAgICAgIGogPSAwOwogICAgICAgICAgICB3aGlsZSAoY2xhenogPSBjbGFzc2VzW2orK10pIHsKICAgICAgICAgICAgICAvLyBSZW1vdmUgKmFsbCogaW5zdGFuY2VzCiAgICAgICAgICAgICAgd2hpbGUgKGN1ci5pbmRleE9mKCIgIiArIGNsYXp6ICsgIiAiKSA+IC0xKSB7CiAgICAgICAgICAgICAgICBjdXIgPSBjdXIucmVwbGFjZSgiICIgKyBjbGF6eiArICIgIiwgIiAiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9ubHkgYXNzaWduIGlmIGRpZmZlcmVudCB0byBhdm9pZCB1bm5lZWRlZCByZW5kZXJpbmcuCiAgICAgICAgICAgIGZpbmFsVmFsdWUgPSBzdHJpcEFuZENvbGxhcHNlKGN1cik7CiAgICAgICAgICAgIGlmIChjdXJWYWx1ZSAhPT0gZmluYWxWYWx1ZSkgewogICAgICAgICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKCJjbGFzcyIsIGZpbmFsVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiB0b2dnbGVDbGFzcyh2YWx1ZSwgc3RhdGVWYWwpIHsKICAgICAgdmFyIHR5cGUgPSBfdHlwZW9mKHZhbHVlKSwKICAgICAgICBpc1ZhbGlkVmFsdWUgPSB0eXBlID09PSAic3RyaW5nIiB8fCBBcnJheS5pc0FycmF5KHZhbHVlKTsKICAgICAgaWYgKHR5cGVvZiBzdGF0ZVZhbCA9PT0gImJvb2xlYW4iICYmIGlzVmFsaWRWYWx1ZSkgewogICAgICAgIHJldHVybiBzdGF0ZVZhbCA/IHRoaXMuYWRkQ2xhc3ModmFsdWUpIDogdGhpcy5yZW1vdmVDbGFzcyh2YWx1ZSk7CiAgICAgIH0KICAgICAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLnRvZ2dsZUNsYXNzKHZhbHVlLmNhbGwodGhpcywgaSwgZ2V0Q2xhc3ModGhpcyksIHN0YXRlVmFsKSwgc3RhdGVWYWwpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjbGFzc05hbWUsIGksIHNlbGYsIGNsYXNzTmFtZXM7CiAgICAgICAgaWYgKGlzVmFsaWRWYWx1ZSkgewogICAgICAgICAgLy8gVG9nZ2xlIGluZGl2aWR1YWwgY2xhc3MgbmFtZXMKICAgICAgICAgIGkgPSAwOwogICAgICAgICAgc2VsZiA9IGpRdWVyeSh0aGlzKTsKICAgICAgICAgIGNsYXNzTmFtZXMgPSBjbGFzc2VzVG9BcnJheSh2YWx1ZSk7CiAgICAgICAgICB3aGlsZSAoY2xhc3NOYW1lID0gY2xhc3NOYW1lc1tpKytdKSB7CiAgICAgICAgICAgIC8vIENoZWNrIGVhY2ggY2xhc3NOYW1lIGdpdmVuLCBzcGFjZSBzZXBhcmF0ZWQgbGlzdAogICAgICAgICAgICBpZiAoc2VsZi5oYXNDbGFzcyhjbGFzc05hbWUpKSB7CiAgICAgICAgICAgICAgc2VsZi5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNlbGYuYWRkQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIFRvZ2dsZSB3aG9sZSBjbGFzcyBuYW1lCiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHR5cGUgPT09ICJib29sZWFuIikgewogICAgICAgICAgY2xhc3NOYW1lID0gZ2V0Q2xhc3ModGhpcyk7CiAgICAgICAgICBpZiAoY2xhc3NOYW1lKSB7CiAgICAgICAgICAgIC8vIFN0b3JlIGNsYXNzTmFtZSBpZiBzZXQKICAgICAgICAgICAgZGF0YVByaXYuc2V0KHRoaXMsICJfX2NsYXNzTmFtZV9fIiwgY2xhc3NOYW1lKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBJZiB0aGUgZWxlbWVudCBoYXMgYSBjbGFzcyBuYW1lIG9yIGlmIHdlJ3JlIHBhc3NlZCBgZmFsc2VgLAogICAgICAgICAgLy8gdGhlbiByZW1vdmUgdGhlIHdob2xlIGNsYXNzbmFtZSAoaWYgdGhlcmUgd2FzIG9uZSwgdGhlIGFib3ZlIHNhdmVkIGl0KS4KICAgICAgICAgIC8vIE90aGVyd2lzZSBicmluZyBiYWNrIHdoYXRldmVyIHdhcyBwcmV2aW91c2x5IHNhdmVkIChpZiBhbnl0aGluZyksCiAgICAgICAgICAvLyBmYWxsaW5nIGJhY2sgdG8gdGhlIGVtcHR5IHN0cmluZyBpZiBub3RoaW5nIHdhcyBzdG9yZWQuCiAgICAgICAgICBpZiAodGhpcy5zZXRBdHRyaWJ1dGUpIHsKICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgY2xhc3NOYW1lIHx8IHZhbHVlID09PSBmYWxzZSA/ICIiIDogZGF0YVByaXYuZ2V0KHRoaXMsICJfX2NsYXNzTmFtZV9fIikgfHwgIiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgaGFzQ2xhc3M6IGZ1bmN0aW9uIGhhc0NsYXNzKHNlbGVjdG9yKSB7CiAgICAgIHZhciBjbGFzc05hbWUsCiAgICAgICAgZWxlbSwKICAgICAgICBpID0gMDsKICAgICAgY2xhc3NOYW1lID0gIiAiICsgc2VsZWN0b3IgKyAiICI7CiAgICAgIHdoaWxlIChlbGVtID0gdGhpc1tpKytdKSB7CiAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCIgIiArIHN0cmlwQW5kQ29sbGFwc2UoZ2V0Q2xhc3MoZWxlbSkpICsgIiAiKS5pbmRleE9mKGNsYXNzTmFtZSkgPiAtMSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9KTsKICB2YXIgcnJldHVybiA9IC9cci9nOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgdmFsOiBmdW5jdGlvbiB2YWwodmFsdWUpIHsKICAgICAgdmFyIGhvb2tzLAogICAgICAgIHJldCwKICAgICAgICB2YWx1ZUlzRnVuY3Rpb24sCiAgICAgICAgZWxlbSA9IHRoaXNbMF07CiAgICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICBob29rcyA9IGpRdWVyeS52YWxIb29rc1tlbGVtLnR5cGVdIHx8IGpRdWVyeS52YWxIb29rc1tlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCldOwogICAgICAgICAgaWYgKGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgInZhbHVlIikpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgIH0KICAgICAgICAgIHJldCA9IGVsZW0udmFsdWU7CgogICAgICAgICAgLy8gSGFuZGxlIG1vc3QgY29tbW9uIHN0cmluZyBjYXNlcwogICAgICAgICAgaWYgKHR5cGVvZiByZXQgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiByZXQucmVwbGFjZShycmV0dXJuLCAiIik7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gSGFuZGxlIGNhc2VzIHdoZXJlIHZhbHVlIGlzIG51bGwvdW5kZWYgb3IgbnVtYmVyCiAgICAgICAgICByZXR1cm4gcmV0ID09IG51bGwgPyAiIiA6IHJldDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhbHVlSXNGdW5jdGlvbiA9IGlzRnVuY3Rpb24odmFsdWUpOwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgdmFyIHZhbDsKICAgICAgICBpZiAodGhpcy5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodmFsdWVJc0Z1bmN0aW9uKSB7CiAgICAgICAgICB2YWwgPSB2YWx1ZS5jYWxsKHRoaXMsIGksIGpRdWVyeSh0aGlzKS52YWwoKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhbCA9IHZhbHVlOwogICAgICAgIH0KCiAgICAgICAgLy8gVHJlYXQgbnVsbC91bmRlZmluZWQgYXMgIiI7IGNvbnZlcnQgbnVtYmVycyB0byBzdHJpbmcKICAgICAgICBpZiAodmFsID09IG51bGwpIHsKICAgICAgICAgIHZhbCA9ICIiOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgIHZhbCArPSAiIjsKICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkgewogICAgICAgICAgdmFsID0galF1ZXJ5Lm1hcCh2YWwsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWUgKyAiIjsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBob29rcyA9IGpRdWVyeS52YWxIb29rc1t0aGlzLnR5cGVdIHx8IGpRdWVyeS52YWxIb29rc1t0aGlzLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCldOwoKICAgICAgICAvLyBJZiBzZXQgcmV0dXJucyB1bmRlZmluZWQsIGZhbGwgYmFjayB0byBub3JtYWwgc2V0dGluZwogICAgICAgIGlmICghaG9va3MgfHwgISgic2V0IiBpbiBob29rcykgfHwgaG9va3Muc2V0KHRoaXMsIHZhbCwgInZhbHVlIikgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5leHRlbmQoewogICAgdmFsSG9va3M6IHsKICAgICAgb3B0aW9uOiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoZWxlbSkgewogICAgICAgICAgdmFyIHZhbCA9IGpRdWVyeS5maW5kLmF0dHIoZWxlbSwgInZhbHVlIik7CiAgICAgICAgICByZXR1cm4gdmFsICE9IG51bGwgPyB2YWwgOgogICAgICAgICAgLy8gU3VwcG9ydDogSUUgPD0xMCAtIDExIG9ubHkKICAgICAgICAgIC8vIG9wdGlvbi50ZXh0IHRocm93cyBleGNlcHRpb25zICgjMTQ2ODYsICMxNDg1OCkKICAgICAgICAgIC8vIFN0cmlwIGFuZCBjb2xsYXBzZSB3aGl0ZXNwYWNlCiAgICAgICAgICAvLyBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnLyNzdHJpcC1hbmQtY29sbGFwc2Utd2hpdGVzcGFjZQogICAgICAgICAgc3RyaXBBbmRDb2xsYXBzZShqUXVlcnkudGV4dChlbGVtKSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZWxlY3Q6IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldChlbGVtKSB7CiAgICAgICAgICB2YXIgdmFsdWUsCiAgICAgICAgICAgIG9wdGlvbiwKICAgICAgICAgICAgaSwKICAgICAgICAgICAgb3B0aW9ucyA9IGVsZW0ub3B0aW9ucywKICAgICAgICAgICAgaW5kZXggPSBlbGVtLnNlbGVjdGVkSW5kZXgsCiAgICAgICAgICAgIG9uZSA9IGVsZW0udHlwZSA9PT0gInNlbGVjdC1vbmUiLAogICAgICAgICAgICB2YWx1ZXMgPSBvbmUgPyBudWxsIDogW10sCiAgICAgICAgICAgIG1heCA9IG9uZSA/IGluZGV4ICsgMSA6IG9wdGlvbnMubGVuZ3RoOwogICAgICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgICBpID0gbWF4OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaSA9IG9uZSA/IGluZGV4IDogMDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIHRoZSBzZWxlY3RlZCBvcHRpb25zCiAgICAgICAgICBmb3IgKDsgaSA8IG1heDsgaSsrKSB7CiAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbnNbaV07CgogICAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTkgb25seQogICAgICAgICAgICAvLyBJRTgtOSBkb2Vzbid0IHVwZGF0ZSBzZWxlY3RlZCBhZnRlciBmb3JtIHJlc2V0ICgjMjU1MSkKICAgICAgICAgICAgaWYgKChvcHRpb24uc2VsZWN0ZWQgfHwgaSA9PT0gaW5kZXgpICYmCiAgICAgICAgICAgIC8vIERvbid0IHJldHVybiBvcHRpb25zIHRoYXQgYXJlIGRpc2FibGVkIG9yIGluIGEgZGlzYWJsZWQgb3B0Z3JvdXAKICAgICAgICAgICAgIW9wdGlvbi5kaXNhYmxlZCAmJiAoIW9wdGlvbi5wYXJlbnROb2RlLmRpc2FibGVkIHx8ICFub2RlTmFtZShvcHRpb24ucGFyZW50Tm9kZSwgIm9wdGdyb3VwIikpKSB7CiAgICAgICAgICAgICAgLy8gR2V0IHRoZSBzcGVjaWZpYyB2YWx1ZSBmb3IgdGhlIG9wdGlvbgogICAgICAgICAgICAgIHZhbHVlID0galF1ZXJ5KG9wdGlvbikudmFsKCk7CgogICAgICAgICAgICAgIC8vIFdlIGRvbid0IG5lZWQgYW4gYXJyYXkgZm9yIG9uZSBzZWxlY3RzCiAgICAgICAgICAgICAgaWYgKG9uZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gTXVsdGktU2VsZWN0cyByZXR1cm4gYW4gYXJyYXkKICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChlbGVtLCB2YWx1ZSkgewogICAgICAgICAgdmFyIG9wdGlvblNldCwKICAgICAgICAgICAgb3B0aW9uLAogICAgICAgICAgICBvcHRpb25zID0gZWxlbS5vcHRpb25zLAogICAgICAgICAgICB2YWx1ZXMgPSBqUXVlcnkubWFrZUFycmF5KHZhbHVlKSwKICAgICAgICAgICAgaSA9IG9wdGlvbnMubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICBvcHRpb24gPSBvcHRpb25zW2ldOwoKICAgICAgICAgICAgLyogZXNsaW50LWRpc2FibGUgbm8tY29uZC1hc3NpZ24gKi8KCiAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQgPSBqUXVlcnkuaW5BcnJheShqUXVlcnkudmFsSG9va3Mub3B0aW9uLmdldChvcHRpb24pLCB2YWx1ZXMpID4gLTEpIHsKICAgICAgICAgICAgICBvcHRpb25TZXQgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLWNvbmQtYXNzaWduICovCiAgICAgICAgICB9CgogICAgICAgICAgLy8gRm9yY2UgYnJvd3NlcnMgdG8gYmVoYXZlIGNvbnNpc3RlbnRseSB3aGVuIG5vbi1tYXRjaGluZyB2YWx1ZSBpcyBzZXQKICAgICAgICAgIGlmICghb3B0aW9uU2V0KSB7CiAgICAgICAgICAgIGVsZW0uc2VsZWN0ZWRJbmRleCA9IC0xOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKCiAgLy8gUmFkaW9zIGFuZCBjaGVja2JveGVzIGdldHRlci9zZXR0ZXIKICBqUXVlcnkuZWFjaChbInJhZGlvIiwgImNoZWNrYm94Il0sIGZ1bmN0aW9uICgpIHsKICAgIGpRdWVyeS52YWxIb29rc1t0aGlzXSA9IHsKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoZWxlbSwgdmFsdWUpIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybiBlbGVtLmNoZWNrZWQgPSBqUXVlcnkuaW5BcnJheShqUXVlcnkoZWxlbSkudmFsKCksIHZhbHVlKSA+IC0xOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIGlmICghc3VwcG9ydC5jaGVja09uKSB7CiAgICAgIGpRdWVyeS52YWxIb29rc1t0aGlzXS5nZXQgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIHJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgidmFsdWUiKSA9PT0gbnVsbCA/ICJvbiIgOiBlbGVtLnZhbHVlOwogICAgICB9OwogICAgfQogIH0pOwoKICAvLyBSZXR1cm4galF1ZXJ5IGZvciBhdHRyaWJ1dGVzLW9ubHkgaW5jbHVzaW9uCgogIHN1cHBvcnQuZm9jdXNpbiA9ICJvbmZvY3VzaW4iIGluIHdpbmRvdzsKICB2YXIgcmZvY3VzTW9ycGggPSAvXig/OmZvY3VzaW5mb2N1c3xmb2N1c291dGJsdXIpJC8sCiAgICBzdG9wUHJvcGFnYXRpb25DYWxsYmFjayA9IGZ1bmN0aW9uIHN0b3BQcm9wYWdhdGlvbkNhbGxiYWNrKGUpIHsKICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgIH07CiAgalF1ZXJ5LmV4dGVuZChqUXVlcnkuZXZlbnQsIHsKICAgIHRyaWdnZXI6IGZ1bmN0aW9uIHRyaWdnZXIoZXZlbnQsIGRhdGEsIGVsZW0sIG9ubHlIYW5kbGVycykgewogICAgICB2YXIgaSwKICAgICAgICBjdXIsCiAgICAgICAgdG1wLAogICAgICAgIGJ1YmJsZVR5cGUsCiAgICAgICAgb250eXBlLAogICAgICAgIGhhbmRsZSwKICAgICAgICBzcGVjaWFsLAogICAgICAgIGxhc3RFbGVtZW50LAogICAgICAgIGV2ZW50UGF0aCA9IFtlbGVtIHx8IGRvY3VtZW50XSwKICAgICAgICB0eXBlID0gaGFzT3duLmNhbGwoZXZlbnQsICJ0eXBlIikgPyBldmVudC50eXBlIDogZXZlbnQsCiAgICAgICAgbmFtZXNwYWNlcyA9IGhhc093bi5jYWxsKGV2ZW50LCAibmFtZXNwYWNlIikgPyBldmVudC5uYW1lc3BhY2Uuc3BsaXQoIi4iKSA6IFtdOwogICAgICBjdXIgPSBsYXN0RWxlbWVudCA9IHRtcCA9IGVsZW0gPSBlbGVtIHx8IGRvY3VtZW50OwoKICAgICAgLy8gRG9uJ3QgZG8gZXZlbnRzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gZm9jdXMvYmx1ciBtb3JwaHMgdG8gZm9jdXNpbi9vdXQ7IGVuc3VyZSB3ZSdyZSBub3QgZmlyaW5nIHRoZW0gcmlnaHQgbm93CiAgICAgIGlmIChyZm9jdXNNb3JwaC50ZXN0KHR5cGUgKyBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAodHlwZS5pbmRleE9mKCIuIikgPiAtMSkgewogICAgICAgIC8vIE5hbWVzcGFjZWQgdHJpZ2dlcjsgY3JlYXRlIGEgcmVnZXhwIHRvIG1hdGNoIGV2ZW50IHR5cGUgaW4gaGFuZGxlKCkKICAgICAgICBuYW1lc3BhY2VzID0gdHlwZS5zcGxpdCgiLiIpOwogICAgICAgIHR5cGUgPSBuYW1lc3BhY2VzLnNoaWZ0KCk7CiAgICAgICAgbmFtZXNwYWNlcy5zb3J0KCk7CiAgICAgIH0KICAgICAgb250eXBlID0gdHlwZS5pbmRleE9mKCI6IikgPCAwICYmICJvbiIgKyB0eXBlOwoKICAgICAgLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGEgalF1ZXJ5LkV2ZW50IG9iamVjdCwgT2JqZWN0LCBvciBqdXN0IGFuIGV2ZW50IHR5cGUgc3RyaW5nCiAgICAgIGV2ZW50ID0gZXZlbnRbalF1ZXJ5LmV4cGFuZG9dID8gZXZlbnQgOiBuZXcgalF1ZXJ5LkV2ZW50KHR5cGUsIF90eXBlb2YoZXZlbnQpID09PSAib2JqZWN0IiAmJiBldmVudCk7CgogICAgICAvLyBUcmlnZ2VyIGJpdG1hc2s6ICYgMSBmb3IgbmF0aXZlIGhhbmRsZXJzOyAmIDIgZm9yIGpRdWVyeSAoYWx3YXlzIHRydWUpCiAgICAgIGV2ZW50LmlzVHJpZ2dlciA9IG9ubHlIYW5kbGVycyA/IDIgOiAzOwogICAgICBldmVudC5uYW1lc3BhY2UgPSBuYW1lc3BhY2VzLmpvaW4oIi4iKTsKICAgICAgZXZlbnQucm5hbWVzcGFjZSA9IGV2ZW50Lm5hbWVzcGFjZSA/IG5ldyBSZWdFeHAoIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCJcXC4oPzouKlxcLnwpIikgKyAiKFxcLnwkKSIpIDogbnVsbDsKCiAgICAgIC8vIENsZWFuIHVwIHRoZSBldmVudCBpbiBjYXNlIGl0IGlzIGJlaW5nIHJldXNlZAogICAgICBldmVudC5yZXN1bHQgPSB1bmRlZmluZWQ7CiAgICAgIGlmICghZXZlbnQudGFyZ2V0KSB7CiAgICAgICAgZXZlbnQudGFyZ2V0ID0gZWxlbTsKICAgICAgfQoKICAgICAgLy8gQ2xvbmUgYW55IGluY29taW5nIGRhdGEgYW5kIHByZXBlbmQgdGhlIGV2ZW50LCBjcmVhdGluZyB0aGUgaGFuZGxlciBhcmcgbGlzdAogICAgICBkYXRhID0gZGF0YSA9PSBudWxsID8gW2V2ZW50XSA6IGpRdWVyeS5tYWtlQXJyYXkoZGF0YSwgW2V2ZW50XSk7CgogICAgICAvLyBBbGxvdyBzcGVjaWFsIGV2ZW50cyB0byBkcmF3IG91dHNpZGUgdGhlIGxpbmVzCiAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCB7fTsKICAgICAgaWYgKCFvbmx5SGFuZGxlcnMgJiYgc3BlY2lhbC50cmlnZ2VyICYmIHNwZWNpYWwudHJpZ2dlci5hcHBseShlbGVtLCBkYXRhKSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIERldGVybWluZSBldmVudCBwcm9wYWdhdGlvbiBwYXRoIGluIGFkdmFuY2UsIHBlciBXM0MgZXZlbnRzIHNwZWMgKCM5OTUxKQogICAgICAvLyBCdWJibGUgdXAgdG8gZG9jdW1lbnQsIHRoZW4gdG8gd2luZG93OyB3YXRjaCBmb3IgYSBnbG9iYWwgb3duZXJEb2N1bWVudCB2YXIgKCM5NzI0KQogICAgICBpZiAoIW9ubHlIYW5kbGVycyAmJiAhc3BlY2lhbC5ub0J1YmJsZSAmJiAhaXNXaW5kb3coZWxlbSkpIHsKICAgICAgICBidWJibGVUeXBlID0gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgfHwgdHlwZTsKICAgICAgICBpZiAoIXJmb2N1c01vcnBoLnRlc3QoYnViYmxlVHlwZSArIHR5cGUpKSB7CiAgICAgICAgICBjdXIgPSBjdXIucGFyZW50Tm9kZTsKICAgICAgICB9CiAgICAgICAgZm9yICg7IGN1cjsgY3VyID0gY3VyLnBhcmVudE5vZGUpIHsKICAgICAgICAgIGV2ZW50UGF0aC5wdXNoKGN1cik7CiAgICAgICAgICB0bXAgPSBjdXI7CiAgICAgICAgfQoKICAgICAgICAvLyBPbmx5IGFkZCB3aW5kb3cgaWYgd2UgZ290IHRvIGRvY3VtZW50IChlLmcuLCBub3QgcGxhaW4gb2JqIG9yIGRldGFjaGVkIERPTSkKICAgICAgICBpZiAodG1wID09PSAoZWxlbS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50KSkgewogICAgICAgICAgZXZlbnRQYXRoLnB1c2godG1wLmRlZmF1bHRWaWV3IHx8IHRtcC5wYXJlbnRXaW5kb3cgfHwgd2luZG93KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIEZpcmUgaGFuZGxlcnMgb24gdGhlIGV2ZW50IHBhdGgKICAgICAgaSA9IDA7CiAgICAgIHdoaWxlICgoY3VyID0gZXZlbnRQYXRoW2krK10pICYmICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgbGFzdEVsZW1lbnQgPSBjdXI7CiAgICAgICAgZXZlbnQudHlwZSA9IGkgPiAxID8gYnViYmxlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgfHwgdHlwZTsKCiAgICAgICAgLy8galF1ZXJ5IGhhbmRsZXIKICAgICAgICBoYW5kbGUgPSAoZGF0YVByaXYuZ2V0KGN1ciwgImV2ZW50cyIpIHx8IE9iamVjdC5jcmVhdGUobnVsbCkpW2V2ZW50LnR5cGVdICYmIGRhdGFQcml2LmdldChjdXIsICJoYW5kbGUiKTsKICAgICAgICBpZiAoaGFuZGxlKSB7CiAgICAgICAgICBoYW5kbGUuYXBwbHkoY3VyLCBkYXRhKTsKICAgICAgICB9CgogICAgICAgIC8vIE5hdGl2ZSBoYW5kbGVyCiAgICAgICAgaGFuZGxlID0gb250eXBlICYmIGN1cltvbnR5cGVdOwogICAgICAgIGlmIChoYW5kbGUgJiYgaGFuZGxlLmFwcGx5ICYmIGFjY2VwdERhdGEoY3VyKSkgewogICAgICAgICAgZXZlbnQucmVzdWx0ID0gaGFuZGxlLmFwcGx5KGN1ciwgZGF0YSk7CiAgICAgICAgICBpZiAoZXZlbnQucmVzdWx0ID09PSBmYWxzZSkgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBldmVudC50eXBlID0gdHlwZTsKCiAgICAgIC8vIElmIG5vYm9keSBwcmV2ZW50ZWQgdGhlIGRlZmF1bHQgYWN0aW9uLCBkbyBpdCBub3cKICAgICAgaWYgKCFvbmx5SGFuZGxlcnMgJiYgIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpKSB7CiAgICAgICAgaWYgKCghc3BlY2lhbC5fZGVmYXVsdCB8fCBzcGVjaWFsLl9kZWZhdWx0LmFwcGx5KGV2ZW50UGF0aC5wb3AoKSwgZGF0YSkgPT09IGZhbHNlKSAmJiBhY2NlcHREYXRhKGVsZW0pKSB7CiAgICAgICAgICAvLyBDYWxsIGEgbmF0aXZlIERPTSBtZXRob2Qgb24gdGhlIHRhcmdldCB3aXRoIHRoZSBzYW1lIG5hbWUgYXMgdGhlIGV2ZW50LgogICAgICAgICAgLy8gRG9uJ3QgZG8gZGVmYXVsdCBhY3Rpb25zIG9uIHdpbmRvdywgdGhhdCdzIHdoZXJlIGdsb2JhbCB2YXJpYWJsZXMgYmUgKCM2MTcwKQogICAgICAgICAgaWYgKG9udHlwZSAmJiBpc0Z1bmN0aW9uKGVsZW1bdHlwZV0pICYmICFpc1dpbmRvdyhlbGVtKSkgewogICAgICAgICAgICAvLyBEb24ndCByZS10cmlnZ2VyIGFuIG9uRk9PIGV2ZW50IHdoZW4gd2UgY2FsbCBpdHMgRk9PKCkgbWV0aG9kCiAgICAgICAgICAgIHRtcCA9IGVsZW1bb250eXBlXTsKICAgICAgICAgICAgaWYgKHRtcCkgewogICAgICAgICAgICAgIGVsZW1bb250eXBlXSA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFByZXZlbnQgcmUtdHJpZ2dlcmluZyBvZiB0aGUgc2FtZSBldmVudCwgc2luY2Ugd2UgYWxyZWFkeSBidWJibGVkIGl0IGFib3ZlCiAgICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB0eXBlOwogICAgICAgICAgICBpZiAoZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgICAgIGxhc3RFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgc3RvcFByb3BhZ2F0aW9uQ2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1bdHlwZV0oKTsKICAgICAgICAgICAgaWYgKGV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICAgICAgICBsYXN0RWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIHN0b3BQcm9wYWdhdGlvbkNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkID0gdW5kZWZpbmVkOwogICAgICAgICAgICBpZiAodG1wKSB7CiAgICAgICAgICAgICAgZWxlbVtvbnR5cGVdID0gdG1wOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBldmVudC5yZXN1bHQ7CiAgICB9LAogICAgLy8gUGlnZ3liYWNrIG9uIGEgZG9ub3IgZXZlbnQgdG8gc2ltdWxhdGUgYSBkaWZmZXJlbnQgb25lCiAgICAvLyBVc2VkIG9ubHkgZm9yIGBmb2N1cyhpbiB8IG91dClgIGV2ZW50cwogICAgc2ltdWxhdGU6IGZ1bmN0aW9uIHNpbXVsYXRlKHR5cGUsIGVsZW0sIGV2ZW50KSB7CiAgICAgIHZhciBlID0galF1ZXJ5LmV4dGVuZChuZXcgalF1ZXJ5LkV2ZW50KCksIGV2ZW50LCB7CiAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICBpc1NpbXVsYXRlZDogdHJ1ZQogICAgICB9KTsKICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoZSwgbnVsbCwgZWxlbSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICB0cmlnZ2VyOiBmdW5jdGlvbiB0cmlnZ2VyKHR5cGUsIGRhdGEpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIodHlwZSwgZGF0YSwgdGhpcyk7CiAgICAgIH0pOwogICAgfSwKICAgIHRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiB0cmlnZ2VySGFuZGxlcih0eXBlLCBkYXRhKSB7CiAgICAgIHZhciBlbGVtID0gdGhpc1swXTsKICAgICAgaWYgKGVsZW0pIHsKICAgICAgICByZXR1cm4galF1ZXJ5LmV2ZW50LnRyaWdnZXIodHlwZSwgZGF0YSwgZWxlbSwgdHJ1ZSk7CiAgICAgIH0KICAgIH0KICB9KTsKCiAgLy8gU3VwcG9ydDogRmlyZWZveCA8PTQ0CiAgLy8gRmlyZWZveCBkb2Vzbid0IGhhdmUgZm9jdXMoaW4gfCBvdXQpIGV2ZW50cwogIC8vIFJlbGF0ZWQgdGlja2V0IC0gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9Njg3Nzg3CiAgLy8KICAvLyBTdXBwb3J0OiBDaHJvbWUgPD00OCAtIDQ5LCBTYWZhcmkgPD05LjAgLSA5LjEKICAvLyBmb2N1cyhpbiB8IG91dCkgZXZlbnRzIGZpcmUgYWZ0ZXIgZm9jdXMgJiBibHVyIGV2ZW50cywKICAvLyB3aGljaCBpcyBzcGVjIHZpb2xhdGlvbiAtIGh0dHA6Ly93d3cudzMub3JnL1RSL0RPTS1MZXZlbC0zLUV2ZW50cy8jZXZlbnRzLWZvY3VzZXZlbnQtZXZlbnQtb3JkZXIKICAvLyBSZWxhdGVkIHRpY2tldCAtIGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTQ0OTg1NwogIGlmICghc3VwcG9ydC5mb2N1c2luKSB7CiAgICBqUXVlcnkuZWFjaCh7CiAgICAgIGZvY3VzOiAiZm9jdXNpbiIsCiAgICAgIGJsdXI6ICJmb2N1c291dCIKICAgIH0sIGZ1bmN0aW9uIChvcmlnLCBmaXgpIHsKICAgICAgLy8gQXR0YWNoIGEgc2luZ2xlIGNhcHR1cmluZyBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudCB3aGlsZSBzb21lb25lIHdhbnRzIGZvY3VzaW4vZm9jdXNvdXQKICAgICAgdmFyIGhhbmRsZXIgPSBmdW5jdGlvbiBoYW5kbGVyKGV2ZW50KSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKGZpeCwgZXZlbnQudGFyZ2V0LCBqUXVlcnkuZXZlbnQuZml4KGV2ZW50KSk7CiAgICAgIH07CiAgICAgIGpRdWVyeS5ldmVudC5zcGVjaWFsW2ZpeF0gPSB7CiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uIHNldHVwKCkgewogICAgICAgICAgLy8gSGFuZGxlOiByZWd1bGFyIG5vZGVzICh2aWEgYHRoaXMub3duZXJEb2N1bWVudGApLCB3aW5kb3cKICAgICAgICAgIC8vICh2aWEgYHRoaXMuZG9jdW1lbnRgKSAmIGRvY3VtZW50ICh2aWEgYHRoaXNgKS4KICAgICAgICAgIHZhciBkb2MgPSB0aGlzLm93bmVyRG9jdW1lbnQgfHwgdGhpcy5kb2N1bWVudCB8fCB0aGlzLAogICAgICAgICAgICBhdHRhY2hlcyA9IGRhdGFQcml2LmFjY2Vzcyhkb2MsIGZpeCk7CiAgICAgICAgICBpZiAoIWF0dGFjaGVzKSB7CiAgICAgICAgICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKG9yaWcsIGhhbmRsZXIsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZGF0YVByaXYuYWNjZXNzKGRvYywgZml4LCAoYXR0YWNoZXMgfHwgMCkgKyAxKTsKICAgICAgICB9LAogICAgICAgIHRlYXJkb3duOiBmdW5jdGlvbiB0ZWFyZG93bigpIHsKICAgICAgICAgIHZhciBkb2MgPSB0aGlzLm93bmVyRG9jdW1lbnQgfHwgdGhpcy5kb2N1bWVudCB8fCB0aGlzLAogICAgICAgICAgICBhdHRhY2hlcyA9IGRhdGFQcml2LmFjY2Vzcyhkb2MsIGZpeCkgLSAxOwogICAgICAgICAgaWYgKCFhdHRhY2hlcykgewogICAgICAgICAgICBkb2MucmVtb3ZlRXZlbnRMaXN0ZW5lcihvcmlnLCBoYW5kbGVyLCB0cnVlKTsKICAgICAgICAgICAgZGF0YVByaXYucmVtb3ZlKGRvYywgZml4KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRhdGFQcml2LmFjY2Vzcyhkb2MsIGZpeCwgYXR0YWNoZXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwogIH0KICB2YXIgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgdmFyIG5vbmNlID0gewogICAgZ3VpZDogRGF0ZS5ub3coKQogIH07CiAgdmFyIHJxdWVyeSA9IC9cPy87CgogIC8vIENyb3NzLWJyb3dzZXIgeG1sIHBhcnNpbmcKICBqUXVlcnkucGFyc2VYTUwgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgdmFyIHhtbDsKICAgIGlmICghZGF0YSB8fCB0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLy8gU3VwcG9ydDogSUUgOSAtIDExIG9ubHkKICAgIC8vIElFIHRocm93cyBvbiBwYXJzZUZyb21TdHJpbmcgd2l0aCBpbnZhbGlkIGlucHV0LgogICAgdHJ5IHsKICAgICAgeG1sID0gbmV3IHdpbmRvdy5ET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcoZGF0YSwgInRleHQveG1sIik7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHhtbCA9IHVuZGVmaW5lZDsKICAgIH0KICAgIGlmICgheG1sIHx8IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgicGFyc2VyZXJyb3IiKS5sZW5ndGgpIHsKICAgICAgalF1ZXJ5LmVycm9yKCJJbnZhbGlkIFhNTDogIiArIGRhdGEpOwogICAgfQogICAgcmV0dXJuIHhtbDsKICB9OwogIHZhciByYnJhY2tldCA9IC9cW1xdJC8sCiAgICByQ1JMRiA9IC9ccj9cbi9nLAogICAgcnN1Ym1pdHRlclR5cGVzID0gL14oPzpzdWJtaXR8YnV0dG9ufGltYWdlfHJlc2V0fGZpbGUpJC9pLAogICAgcnN1Ym1pdHRhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8a2V5Z2VuKS9pOwogIGZ1bmN0aW9uIGJ1aWxkUGFyYW1zKHByZWZpeCwgb2JqLCB0cmFkaXRpb25hbCwgYWRkKSB7CiAgICB2YXIgbmFtZTsKICAgIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKICAgICAgLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCiAgICAgIGpRdWVyeS5lYWNoKG9iaiwgZnVuY3Rpb24gKGksIHYpIHsKICAgICAgICBpZiAodHJhZGl0aW9uYWwgfHwgcmJyYWNrZXQudGVzdChwcmVmaXgpKSB7CiAgICAgICAgICAvLyBUcmVhdCBlYWNoIGFycmF5IGl0ZW0gYXMgYSBzY2FsYXIuCiAgICAgICAgICBhZGQocHJlZml4LCB2KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gSXRlbSBpcyBub24tc2NhbGFyIChhcnJheSBvciBvYmplY3QpLCBlbmNvZGUgaXRzIG51bWVyaWMgaW5kZXguCiAgICAgICAgICBidWlsZFBhcmFtcyhwcmVmaXggKyAiWyIgKyAoX3R5cGVvZih2KSA9PT0gIm9iamVjdCIgJiYgdiAhPSBudWxsID8gaSA6ICIiKSArICJdIiwgdiwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoIXRyYWRpdGlvbmFsICYmIHRvVHlwZShvYmopID09PSAib2JqZWN0IikgewogICAgICAvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCiAgICAgIGZvciAobmFtZSBpbiBvYmopIHsKICAgICAgICBidWlsZFBhcmFtcyhwcmVmaXggKyAiWyIgKyBuYW1lICsgIl0iLCBvYmpbbmFtZV0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCiAgICAgIGFkZChwcmVmaXgsIG9iaik7CiAgICB9CiAgfQoKICAvLyBTZXJpYWxpemUgYW4gYXJyYXkgb2YgZm9ybSBlbGVtZW50cyBvciBhIHNldCBvZgogIC8vIGtleS92YWx1ZXMgaW50byBhIHF1ZXJ5IHN0cmluZwogIGpRdWVyeS5wYXJhbSA9IGZ1bmN0aW9uIChhLCB0cmFkaXRpb25hbCkgewogICAgdmFyIHByZWZpeCwKICAgICAgcyA9IFtdLAogICAgICBhZGQgPSBmdW5jdGlvbiBhZGQoa2V5LCB2YWx1ZU9yRnVuY3Rpb24pIHsKICAgICAgICAvLyBJZiB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCBpbnZva2UgaXQgYW5kIHVzZSBpdHMgcmV0dXJuIHZhbHVlCiAgICAgICAgdmFyIHZhbHVlID0gaXNGdW5jdGlvbih2YWx1ZU9yRnVuY3Rpb24pID8gdmFsdWVPckZ1bmN0aW9uKCkgOiB2YWx1ZU9yRnVuY3Rpb247CiAgICAgICAgc1tzLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSk7CiAgICAgIH07CiAgICBpZiAoYSA9PSBudWxsKSB7CiAgICAgIHJldHVybiAiIjsKICAgIH0KCiAgICAvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgogICAgaWYgKEFycmF5LmlzQXJyYXkoYSkgfHwgYS5qcXVlcnkgJiYgIWpRdWVyeS5pc1BsYWluT2JqZWN0KGEpKSB7CiAgICAgIC8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cwogICAgICBqUXVlcnkuZWFjaChhLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgYWRkKHRoaXMubmFtZSwgdGhpcy52YWx1ZSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgLy8gSWYgdHJhZGl0aW9uYWwsIGVuY29kZSB0aGUgIm9sZCIgd2F5ICh0aGUgd2F5IDEuMy4yIG9yIG9sZGVyCiAgICAgIC8vIGRpZCBpdCksIG90aGVyd2lzZSBlbmNvZGUgcGFyYW1zIHJlY3Vyc2l2ZWx5LgogICAgICBmb3IgKHByZWZpeCBpbiBhKSB7CiAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4LCBhW3ByZWZpeF0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICB9CiAgICB9CgogICAgLy8gUmV0dXJuIHRoZSByZXN1bHRpbmcgc2VyaWFsaXphdGlvbgogICAgcmV0dXJuIHMuam9pbigiJiIpOwogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBzZXJpYWxpemU6IGZ1bmN0aW9uIHNlcmlhbGl6ZSgpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5wYXJhbSh0aGlzLnNlcmlhbGl6ZUFycmF5KCkpOwogICAgfSwKICAgIHNlcmlhbGl6ZUFycmF5OiBmdW5jdGlvbiBzZXJpYWxpemVBcnJheSgpIHsKICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBDYW4gYWRkIHByb3BIb29rIGZvciAiZWxlbWVudHMiIHRvIGZpbHRlciBvciBhZGQgZm9ybSBlbGVtZW50cwogICAgICAgIHZhciBlbGVtZW50cyA9IGpRdWVyeS5wcm9wKHRoaXMsICJlbGVtZW50cyIpOwogICAgICAgIHJldHVybiBlbGVtZW50cyA/IGpRdWVyeS5tYWtlQXJyYXkoZWxlbWVudHMpIDogdGhpczsKICAgICAgfSkuZmlsdGVyKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdHlwZSA9IHRoaXMudHlwZTsKCiAgICAgICAgLy8gVXNlIC5pcyggIjpkaXNhYmxlZCIgKSBzbyB0aGF0IGZpZWxkc2V0W2Rpc2FibGVkXSB3b3JrcwogICAgICAgIHJldHVybiB0aGlzLm5hbWUgJiYgIWpRdWVyeSh0aGlzKS5pcygiOmRpc2FibGVkIikgJiYgcnN1Ym1pdHRhYmxlLnRlc3QodGhpcy5ub2RlTmFtZSkgJiYgIXJzdWJtaXR0ZXJUeXBlcy50ZXN0KHR5cGUpICYmICh0aGlzLmNoZWNrZWQgfHwgIXJjaGVja2FibGVUeXBlLnRlc3QodHlwZSkpOwogICAgICB9KS5tYXAoZnVuY3Rpb24gKF9pLCBlbGVtKSB7CiAgICAgICAgdmFyIHZhbCA9IGpRdWVyeSh0aGlzKS52YWwoKTsKICAgICAgICBpZiAodmFsID09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7CiAgICAgICAgICByZXR1cm4galF1ZXJ5Lm1hcCh2YWwsIGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBuYW1lOiBlbGVtLm5hbWUsCiAgICAgICAgICAgICAgdmFsdWU6IHZhbC5yZXBsYWNlKHJDUkxGLCAiXHJcbiIpCiAgICAgICAgICAgIH07CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIG5hbWU6IGVsZW0ubmFtZSwKICAgICAgICAgIHZhbHVlOiB2YWwucmVwbGFjZShyQ1JMRiwgIlxyXG4iKQogICAgICAgIH07CiAgICAgIH0pLmdldCgpOwogICAgfQogIH0pOwogIHZhciByMjAgPSAvJTIwL2csCiAgICByaGFzaCA9IC8jLiokLywKICAgIHJhbnRpQ2FjaGUgPSAvKFs/Jl0pXz1bXiZdKi8sCiAgICByaGVhZGVycyA9IC9eKC4qPyk6WyBcdF0qKFteXHJcbl0qKSQvbWcsCiAgICAvLyAjNzY1MywgIzgxMjUsICM4MTUyOiBsb2NhbCBwcm90b2NvbCBkZXRlY3Rpb24KICAgIHJsb2NhbFByb3RvY29sID0gL14oPzphYm91dHxhcHB8YXBwLXN0b3JhZ2V8ListZXh0ZW5zaW9ufGZpbGV8cmVzfHdpZGdldCk6JC8sCiAgICBybm9Db250ZW50ID0gL14oPzpHRVR8SEVBRCkkLywKICAgIHJwcm90b2NvbCA9IC9eXC9cLy8sCiAgICAvKiBQcmVmaWx0ZXJzCiAgICAqIDEpIFRoZXkgYXJlIHVzZWZ1bCB0byBpbnRyb2R1Y2UgY3VzdG9tIGRhdGFUeXBlcyAoc2VlIGFqYXgvanNvbnAuanMgZm9yIGFuIGV4YW1wbGUpCiAgICAqIDIpIFRoZXNlIGFyZSBjYWxsZWQ6CiAgICAqICAgIC0gQkVGT1JFIGFza2luZyBmb3IgYSB0cmFuc3BvcnQKICAgICogICAgLSBBRlRFUiBwYXJhbSBzZXJpYWxpemF0aW9uIChzLmRhdGEgaXMgYSBzdHJpbmcgaWYgcy5wcm9jZXNzRGF0YSBpcyB0cnVlKQogICAgKiAzKSBrZXkgaXMgdGhlIGRhdGFUeXBlCiAgICAqIDQpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCiAgICAqIDUpIGV4ZWN1dGlvbiB3aWxsIHN0YXJ0IHdpdGggdHJhbnNwb3J0IGRhdGFUeXBlIGFuZCBUSEVOIGNvbnRpbnVlIGRvd24gdG8gIioiIGlmIG5lZWRlZAogICAgKi8KICAgIHByZWZpbHRlcnMgPSB7fSwKICAgIC8qIFRyYW5zcG9ydHMgYmluZGluZ3MKICAgICogMSkga2V5IGlzIHRoZSBkYXRhVHlwZQogICAgKiAyKSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAogICAgKiAzKSBzZWxlY3Rpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBnbyB0byAiKiIgaWYgbmVlZGVkCiAgICAqLwogICAgdHJhbnNwb3J0cyA9IHt9LAogICAgLy8gQXZvaWQgY29tbWVudC1wcm9sb2cgY2hhciBzZXF1ZW5jZSAoIzEwMDk4KTsgbXVzdCBhcHBlYXNlIGxpbnQgYW5kIGV2YWRlIGNvbXByZXNzaW9uCiAgICBhbGxUeXBlcyA9ICIqLyIuY29uY2F0KCIqIiksCiAgICAvLyBBbmNob3IgdGFnIGZvciBwYXJzaW5nIHRoZSBkb2N1bWVudCBvcmlnaW4KICAgIG9yaWdpbkFuY2hvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICBvcmlnaW5BbmNob3IuaHJlZiA9IGxvY2F0aW9uLmhyZWY7CgogIC8vIEJhc2UgImNvbnN0cnVjdG9yIiBmb3IgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIgYW5kIGpRdWVyeS5hamF4VHJhbnNwb3J0CiAgZnVuY3Rpb24gYWRkVG9QcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHN0cnVjdHVyZSkgewogICAgLy8gZGF0YVR5cGVFeHByZXNzaW9uIGlzIG9wdGlvbmFsIGFuZCBkZWZhdWx0cyB0byAiKiIKICAgIHJldHVybiBmdW5jdGlvbiAoZGF0YVR5cGVFeHByZXNzaW9uLCBmdW5jKSB7CiAgICAgIGlmICh0eXBlb2YgZGF0YVR5cGVFeHByZXNzaW9uICE9PSAic3RyaW5nIikgewogICAgICAgIGZ1bmMgPSBkYXRhVHlwZUV4cHJlc3Npb247CiAgICAgICAgZGF0YVR5cGVFeHByZXNzaW9uID0gIioiOwogICAgICB9CiAgICAgIHZhciBkYXRhVHlwZSwKICAgICAgICBpID0gMCwKICAgICAgICBkYXRhVHlwZXMgPSBkYXRhVHlwZUV4cHJlc3Npb24udG9Mb3dlckNhc2UoKS5tYXRjaChybm90aHRtbHdoaXRlKSB8fCBbXTsKICAgICAgaWYgKGlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICAvLyBGb3IgZWFjaCBkYXRhVHlwZSBpbiB0aGUgZGF0YVR5cGVFeHByZXNzaW9uCiAgICAgICAgd2hpbGUgKGRhdGFUeXBlID0gZGF0YVR5cGVzW2krK10pIHsKICAgICAgICAgIC8vIFByZXBlbmQgaWYgcmVxdWVzdGVkCiAgICAgICAgICBpZiAoZGF0YVR5cGVbMF0gPT09ICIrIikgewogICAgICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlLnNsaWNlKDEpIHx8ICIqIjsKICAgICAgICAgICAgKHN0cnVjdHVyZVtkYXRhVHlwZV0gPSBzdHJ1Y3R1cmVbZGF0YVR5cGVdIHx8IFtdKS51bnNoaWZ0KGZ1bmMpOwoKICAgICAgICAgICAgLy8gT3RoZXJ3aXNlIGFwcGVuZAogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgKHN0cnVjdHVyZVtkYXRhVHlwZV0gPSBzdHJ1Y3R1cmVbZGF0YVR5cGVdIHx8IFtdKS5wdXNoKGZ1bmMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9CgogIC8vIEJhc2UgaW5zcGVjdGlvbiBmdW5jdGlvbiBmb3IgcHJlZmlsdGVycyBhbmQgdHJhbnNwb3J0cwogIGZ1bmN0aW9uIGluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUikgewogICAgdmFyIGluc3BlY3RlZCA9IHt9LAogICAgICBzZWVraW5nVHJhbnNwb3J0ID0gc3RydWN0dXJlID09PSB0cmFuc3BvcnRzOwogICAgZnVuY3Rpb24gaW5zcGVjdChkYXRhVHlwZSkgewogICAgICB2YXIgc2VsZWN0ZWQ7CiAgICAgIGluc3BlY3RlZFtkYXRhVHlwZV0gPSB0cnVlOwogICAgICBqUXVlcnkuZWFjaChzdHJ1Y3R1cmVbZGF0YVR5cGVdIHx8IFtdLCBmdW5jdGlvbiAoXywgcHJlZmlsdGVyT3JGYWN0b3J5KSB7CiAgICAgICAgdmFyIGRhdGFUeXBlT3JUcmFuc3BvcnQgPSBwcmVmaWx0ZXJPckZhY3Rvcnkob3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUik7CiAgICAgICAgaWYgKHR5cGVvZiBkYXRhVHlwZU9yVHJhbnNwb3J0ID09PSAic3RyaW5nIiAmJiAhc2Vla2luZ1RyYW5zcG9ydCAmJiAhaW5zcGVjdGVkW2RhdGFUeXBlT3JUcmFuc3BvcnRdKSB7CiAgICAgICAgICBvcHRpb25zLmRhdGFUeXBlcy51bnNoaWZ0KGRhdGFUeXBlT3JUcmFuc3BvcnQpOwogICAgICAgICAgaW5zcGVjdChkYXRhVHlwZU9yVHJhbnNwb3J0KTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGVsc2UgaWYgKHNlZWtpbmdUcmFuc3BvcnQpIHsKICAgICAgICAgIHJldHVybiAhKHNlbGVjdGVkID0gZGF0YVR5cGVPclRyYW5zcG9ydCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHNlbGVjdGVkOwogICAgfQogICAgcmV0dXJuIGluc3BlY3Qob3B0aW9ucy5kYXRhVHlwZXNbMF0pIHx8ICFpbnNwZWN0ZWRbIioiXSAmJiBpbnNwZWN0KCIqIik7CiAgfQoKICAvLyBBIHNwZWNpYWwgZXh0ZW5kIGZvciBhamF4IG9wdGlvbnMKICAvLyB0aGF0IHRha2VzICJmbGF0IiBvcHRpb25zIChub3QgdG8gYmUgZGVlcCBleHRlbmRlZCkKICAvLyBGaXhlcyAjOTg4NwogIGZ1bmN0aW9uIGFqYXhFeHRlbmQodGFyZ2V0LCBzcmMpIHsKICAgIHZhciBrZXksCiAgICAgIGRlZXAsCiAgICAgIGZsYXRPcHRpb25zID0galF1ZXJ5LmFqYXhTZXR0aW5ncy5mbGF0T3B0aW9ucyB8fCB7fTsKICAgIGZvciAoa2V5IGluIHNyYykgewogICAgICBpZiAoc3JjW2tleV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgIChmbGF0T3B0aW9uc1trZXldID8gdGFyZ2V0IDogZGVlcCB8fCAoZGVlcCA9IHt9KSlba2V5XSA9IHNyY1trZXldOwogICAgICB9CiAgICB9CiAgICBpZiAoZGVlcCkgewogICAgICBqUXVlcnkuZXh0ZW5kKHRydWUsIHRhcmdldCwgZGVlcCk7CiAgICB9CiAgICByZXR1cm4gdGFyZ2V0OwogIH0KCiAgLyogSGFuZGxlcyByZXNwb25zZXMgdG8gYW4gYWpheCByZXF1ZXN0OgogICogLSBmaW5kcyB0aGUgcmlnaHQgZGF0YVR5cGUgKG1lZGlhdGVzIGJldHdlZW4gY29udGVudC10eXBlIGFuZCBleHBlY3RlZCBkYXRhVHlwZSkKICAqIC0gcmV0dXJucyB0aGUgY29ycmVzcG9uZGluZyByZXNwb25zZQogICovCiAgZnVuY3Rpb24gYWpheEhhbmRsZVJlc3BvbnNlcyhzLCBqcVhIUiwgcmVzcG9uc2VzKSB7CiAgICB2YXIgY3QsCiAgICAgIHR5cGUsCiAgICAgIGZpbmFsRGF0YVR5cGUsCiAgICAgIGZpcnN0RGF0YVR5cGUsCiAgICAgIGNvbnRlbnRzID0gcy5jb250ZW50cywKICAgICAgZGF0YVR5cGVzID0gcy5kYXRhVHlwZXM7CgogICAgLy8gUmVtb3ZlIGF1dG8gZGF0YVR5cGUgYW5kIGdldCBjb250ZW50LXR5cGUgaW4gdGhlIHByb2Nlc3MKICAgIHdoaWxlIChkYXRhVHlwZXNbMF0gPT09ICIqIikgewogICAgICBkYXRhVHlwZXMuc2hpZnQoKTsKICAgICAgaWYgKGN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBjdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtVHlwZSIpOwogICAgICB9CiAgICB9CgogICAgLy8gQ2hlY2sgaWYgd2UncmUgZGVhbGluZyB3aXRoIGEga25vd24gY29udGVudC10eXBlCiAgICBpZiAoY3QpIHsKICAgICAgZm9yICh0eXBlIGluIGNvbnRlbnRzKSB7CiAgICAgICAgaWYgKGNvbnRlbnRzW3R5cGVdICYmIGNvbnRlbnRzW3R5cGVdLnRlc3QoY3QpKSB7CiAgICAgICAgICBkYXRhVHlwZXMudW5zaGlmdCh0eXBlKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGEgcmVzcG9uc2UgZm9yIHRoZSBleHBlY3RlZCBkYXRhVHlwZQogICAgaWYgKGRhdGFUeXBlc1swXSBpbiByZXNwb25zZXMpIHsKICAgICAgZmluYWxEYXRhVHlwZSA9IGRhdGFUeXBlc1swXTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIFRyeSBjb252ZXJ0aWJsZSBkYXRhVHlwZXMKICAgICAgZm9yICh0eXBlIGluIHJlc3BvbnNlcykgewogICAgICAgIGlmICghZGF0YVR5cGVzWzBdIHx8IHMuY29udmVydGVyc1t0eXBlICsgIiAiICsgZGF0YVR5cGVzWzBdXSkgewogICAgICAgICAgZmluYWxEYXRhVHlwZSA9IHR5cGU7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKCFmaXJzdERhdGFUeXBlKSB7CiAgICAgICAgICBmaXJzdERhdGFUeXBlID0gdHlwZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIE9yIGp1c3QgdXNlIGZpcnN0IG9uZQogICAgICBmaW5hbERhdGFUeXBlID0gZmluYWxEYXRhVHlwZSB8fCBmaXJzdERhdGFUeXBlOwogICAgfQoKICAgIC8vIElmIHdlIGZvdW5kIGEgZGF0YVR5cGUKICAgIC8vIFdlIGFkZCB0aGUgZGF0YVR5cGUgdG8gdGhlIGxpc3QgaWYgbmVlZGVkCiAgICAvLyBhbmQgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIHJlc3BvbnNlCiAgICBpZiAoZmluYWxEYXRhVHlwZSkgewogICAgICBpZiAoZmluYWxEYXRhVHlwZSAhPT0gZGF0YVR5cGVzWzBdKSB7CiAgICAgICAgZGF0YVR5cGVzLnVuc2hpZnQoZmluYWxEYXRhVHlwZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3BvbnNlc1tmaW5hbERhdGFUeXBlXTsKICAgIH0KICB9CgogIC8qIENoYWluIGNvbnZlcnNpb25zIGdpdmVuIHRoZSByZXF1ZXN0IGFuZCB0aGUgb3JpZ2luYWwgcmVzcG9uc2UKICAqIEFsc28gc2V0cyB0aGUgcmVzcG9uc2VYWFggZmllbGRzIG9uIHRoZSBqcVhIUiBpbnN0YW5jZQogICovCiAgZnVuY3Rpb24gYWpheENvbnZlcnQocywgcmVzcG9uc2UsIGpxWEhSLCBpc1N1Y2Nlc3MpIHsKICAgIHZhciBjb252MiwKICAgICAgY3VycmVudCwKICAgICAgY29udiwKICAgICAgdG1wLAogICAgICBwcmV2LAogICAgICBjb252ZXJ0ZXJzID0ge30sCiAgICAgIC8vIFdvcmsgd2l0aCBhIGNvcHkgb2YgZGF0YVR5cGVzIGluIGNhc2Ugd2UgbmVlZCB0byBtb2RpZnkgaXQgZm9yIGNvbnZlcnNpb24KICAgICAgZGF0YVR5cGVzID0gcy5kYXRhVHlwZXMuc2xpY2UoKTsKCiAgICAvLyBDcmVhdGUgY29udmVydGVycyBtYXAgd2l0aCBsb3dlcmNhc2VkIGtleXMKICAgIGlmIChkYXRhVHlwZXNbMV0pIHsKICAgICAgZm9yIChjb252IGluIHMuY29udmVydGVycykgewogICAgICAgIGNvbnZlcnRlcnNbY29udi50b0xvd2VyQ2FzZSgpXSA9IHMuY29udmVydGVyc1tjb252XTsKICAgICAgfQogICAgfQogICAgY3VycmVudCA9IGRhdGFUeXBlcy5zaGlmdCgpOwoKICAgIC8vIENvbnZlcnQgdG8gZWFjaCBzZXF1ZW50aWFsIGRhdGFUeXBlCiAgICB3aGlsZSAoY3VycmVudCkgewogICAgICBpZiAocy5yZXNwb25zZUZpZWxkc1tjdXJyZW50XSkgewogICAgICAgIGpxWEhSW3MucmVzcG9uc2VGaWVsZHNbY3VycmVudF1dID0gcmVzcG9uc2U7CiAgICAgIH0KCiAgICAgIC8vIEFwcGx5IHRoZSBkYXRhRmlsdGVyIGlmIHByb3ZpZGVkCiAgICAgIGlmICghcHJldiAmJiBpc1N1Y2Nlc3MgJiYgcy5kYXRhRmlsdGVyKSB7CiAgICAgICAgcmVzcG9uc2UgPSBzLmRhdGFGaWx0ZXIocmVzcG9uc2UsIHMuZGF0YVR5cGUpOwogICAgICB9CiAgICAgIHByZXYgPSBjdXJyZW50OwogICAgICBjdXJyZW50ID0gZGF0YVR5cGVzLnNoaWZ0KCk7CiAgICAgIGlmIChjdXJyZW50KSB7CiAgICAgICAgLy8gVGhlcmUncyBvbmx5IHdvcmsgdG8gZG8gaWYgY3VycmVudCBkYXRhVHlwZSBpcyBub24tYXV0bwogICAgICAgIGlmIChjdXJyZW50ID09PSAiKiIpIHsKICAgICAgICAgIGN1cnJlbnQgPSBwcmV2OwoKICAgICAgICAgIC8vIENvbnZlcnQgcmVzcG9uc2UgaWYgcHJldiBkYXRhVHlwZSBpcyBub24tYXV0byBhbmQgZGlmZmVycyBmcm9tIGN1cnJlbnQKICAgICAgICB9IGVsc2UgaWYgKHByZXYgIT09ICIqIiAmJiBwcmV2ICE9PSBjdXJyZW50KSB7CiAgICAgICAgICAvLyBTZWVrIGEgZGlyZWN0IGNvbnZlcnRlcgogICAgICAgICAgY29udiA9IGNvbnZlcnRlcnNbcHJldiArICIgIiArIGN1cnJlbnRdIHx8IGNvbnZlcnRlcnNbIiogIiArIGN1cnJlbnRdOwoKICAgICAgICAgIC8vIElmIG5vbmUgZm91bmQsIHNlZWsgYSBwYWlyCiAgICAgICAgICBpZiAoIWNvbnYpIHsKICAgICAgICAgICAgZm9yIChjb252MiBpbiBjb252ZXJ0ZXJzKSB7CiAgICAgICAgICAgICAgLy8gSWYgY29udjIgb3V0cHV0cyBjdXJyZW50CiAgICAgICAgICAgICAgdG1wID0gY29udjIuc3BsaXQoIiAiKTsKICAgICAgICAgICAgICBpZiAodG1wWzFdID09PSBjdXJyZW50KSB7CiAgICAgICAgICAgICAgICAvLyBJZiBwcmV2IGNhbiBiZSBjb252ZXJ0ZWQgdG8gYWNjZXB0ZWQgaW5wdXQKICAgICAgICAgICAgICAgIGNvbnYgPSBjb252ZXJ0ZXJzW3ByZXYgKyAiICIgKyB0bXBbMF1dIHx8IGNvbnZlcnRlcnNbIiogIiArIHRtcFswXV07CiAgICAgICAgICAgICAgICBpZiAoY29udikgewogICAgICAgICAgICAgICAgICAvLyBDb25kZW5zZSBlcXVpdmFsZW5jZSBjb252ZXJ0ZXJzCiAgICAgICAgICAgICAgICAgIGlmIChjb252ID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgY29udiA9IGNvbnZlcnRlcnNbY29udjJdOwoKICAgICAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2UsIGluc2VydCB0aGUgaW50ZXJtZWRpYXRlIGRhdGFUeXBlCiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udmVydGVyc1tjb252Ml0gIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdG1wWzBdOwogICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlcy51bnNoaWZ0KHRtcFsxXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQXBwbHkgY29udmVydGVyIChpZiBub3QgYW4gZXF1aXZhbGVuY2UpCiAgICAgICAgICBpZiAoY29udiAhPT0gdHJ1ZSkgewogICAgICAgICAgICAvLyBVbmxlc3MgZXJyb3JzIGFyZSBhbGxvd2VkIHRvIGJ1YmJsZSwgY2F0Y2ggYW5kIHJldHVybiB0aGVtCiAgICAgICAgICAgIGlmIChjb252ICYmIHMudGhyb3dzKSB7CiAgICAgICAgICAgICAgcmVzcG9uc2UgPSBjb252KHJlc3BvbnNlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBjb252KHJlc3BvbnNlKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICBzdGF0ZTogInBhcnNlcmVycm9yIiwKICAgICAgICAgICAgICAgICAgZXJyb3I6IGNvbnYgPyBlIDogIk5vIGNvbnZlcnNpb24gZnJvbSAiICsgcHJldiArICIgdG8gIiArIGN1cnJlbnQKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICBzdGF0ZTogInN1Y2Nlc3MiLAogICAgICBkYXRhOiByZXNwb25zZQogICAgfTsKICB9CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICAvLyBDb3VudGVyIGZvciBob2xkaW5nIHRoZSBudW1iZXIgb2YgYWN0aXZlIHF1ZXJpZXMKICAgIGFjdGl2ZTogMCwKICAgIC8vIExhc3QtTW9kaWZpZWQgaGVhZGVyIGNhY2hlIGZvciBuZXh0IHJlcXVlc3QKICAgIGxhc3RNb2RpZmllZDoge30sCiAgICBldGFnOiB7fSwKICAgIGFqYXhTZXR0aW5nczogewogICAgICB1cmw6IGxvY2F0aW9uLmhyZWYsCiAgICAgIHR5cGU6ICJHRVQiLAogICAgICBpc0xvY2FsOiBybG9jYWxQcm90b2NvbC50ZXN0KGxvY2F0aW9uLnByb3RvY29sKSwKICAgICAgZ2xvYmFsOiB0cnVlLAogICAgICBwcm9jZXNzRGF0YTogdHJ1ZSwKICAgICAgYXN5bmM6IHRydWUsCiAgICAgIGNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PVVURi04IiwKICAgICAgLyoKICAgICAgdGltZW91dDogMCwKICAgICAgZGF0YTogbnVsbCwKICAgICAgZGF0YVR5cGU6IG51bGwsCiAgICAgIHVzZXJuYW1lOiBudWxsLAogICAgICBwYXNzd29yZDogbnVsbCwKICAgICAgY2FjaGU6IG51bGwsCiAgICAgIHRocm93czogZmFsc2UsCiAgICAgIHRyYWRpdGlvbmFsOiBmYWxzZSwKICAgICAgaGVhZGVyczoge30sCiAgICAgICovCgogICAgICBhY2NlcHRzOiB7CiAgICAgICAgIioiOiBhbGxUeXBlcywKICAgICAgICB0ZXh0OiAidGV4dC9wbGFpbiIsCiAgICAgICAgaHRtbDogInRleHQvaHRtbCIsCiAgICAgICAgeG1sOiAiYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCIsCiAgICAgICAganNvbjogImFwcGxpY2F0aW9uL2pzb24sIHRleHQvamF2YXNjcmlwdCIKICAgICAgfSwKICAgICAgY29udGVudHM6IHsKICAgICAgICB4bWw6IC9cYnhtbFxiLywKICAgICAgICBodG1sOiAvXGJodG1sLywKICAgICAgICBqc29uOiAvXGJqc29uXGIvCiAgICAgIH0sCiAgICAgIHJlc3BvbnNlRmllbGRzOiB7CiAgICAgICAgeG1sOiAicmVzcG9uc2VYTUwiLAogICAgICAgIHRleHQ6ICJyZXNwb25zZVRleHQiLAogICAgICAgIGpzb246ICJyZXNwb25zZUpTT04iCiAgICAgIH0sCiAgICAgIC8vIERhdGEgY29udmVydGVycwogICAgICAvLyBLZXlzIHNlcGFyYXRlIHNvdXJjZSAob3IgY2F0Y2hhbGwgIioiKSBhbmQgZGVzdGluYXRpb24gdHlwZXMgd2l0aCBhIHNpbmdsZSBzcGFjZQogICAgICBjb252ZXJ0ZXJzOiB7CiAgICAgICAgLy8gQ29udmVydCBhbnl0aGluZyB0byB0ZXh0CiAgICAgICAgIiogdGV4dCI6IFN0cmluZywKICAgICAgICAvLyBUZXh0IHRvIGh0bWwgKHRydWUgPSBubyB0cmFuc2Zvcm1hdGlvbikKICAgICAgICAidGV4dCBodG1sIjogdHJ1ZSwKICAgICAgICAvLyBFdmFsdWF0ZSB0ZXh0IGFzIGEganNvbiBleHByZXNzaW9uCiAgICAgICAgInRleHQganNvbiI6IEpTT04ucGFyc2UsCiAgICAgICAgLy8gUGFyc2UgdGV4dCBhcyB4bWwKICAgICAgICAidGV4dCB4bWwiOiBqUXVlcnkucGFyc2VYTUwKICAgICAgfSwKICAgICAgLy8gRm9yIG9wdGlvbnMgdGhhdCBzaG91bGRuJ3QgYmUgZGVlcCBleHRlbmRlZDoKICAgICAgLy8geW91IGNhbiBhZGQgeW91ciBvd24gY3VzdG9tIG9wdGlvbnMgaGVyZSBpZgogICAgICAvLyBhbmQgd2hlbiB5b3UgY3JlYXRlIG9uZSB0aGF0IHNob3VsZG4ndCBiZQogICAgICAvLyBkZWVwIGV4dGVuZGVkIChzZWUgYWpheEV4dGVuZCkKICAgICAgZmxhdE9wdGlvbnM6IHsKICAgICAgICB1cmw6IHRydWUsCiAgICAgICAgY29udGV4dDogdHJ1ZQogICAgICB9CiAgICB9LAogICAgLy8gQ3JlYXRlcyBhIGZ1bGwgZmxlZGdlZCBzZXR0aW5ncyBvYmplY3QgaW50byB0YXJnZXQKICAgIC8vIHdpdGggYm90aCBhamF4U2V0dGluZ3MgYW5kIHNldHRpbmdzIGZpZWxkcy4KICAgIC8vIElmIHRhcmdldCBpcyBvbWl0dGVkLCB3cml0ZXMgaW50byBhamF4U2V0dGluZ3MuCiAgICBhamF4U2V0dXA6IGZ1bmN0aW9uIGFqYXhTZXR1cCh0YXJnZXQsIHNldHRpbmdzKSB7CiAgICAgIHJldHVybiBzZXR0aW5ncyA/CiAgICAgIC8vIEJ1aWxkaW5nIGEgc2V0dGluZ3Mgb2JqZWN0CiAgICAgIGFqYXhFeHRlbmQoYWpheEV4dGVuZCh0YXJnZXQsIGpRdWVyeS5hamF4U2V0dGluZ3MpLCBzZXR0aW5ncykgOgogICAgICAvLyBFeHRlbmRpbmcgYWpheFNldHRpbmdzCiAgICAgIGFqYXhFeHRlbmQoalF1ZXJ5LmFqYXhTZXR0aW5ncywgdGFyZ2V0KTsKICAgIH0sCiAgICBhamF4UHJlZmlsdGVyOiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMocHJlZmlsdGVycyksCiAgICBhamF4VHJhbnNwb3J0OiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHModHJhbnNwb3J0cyksCiAgICAvLyBNYWluIG1ldGhvZAogICAgYWpheDogZnVuY3Rpb24gYWpheCh1cmwsIG9wdGlvbnMpIHsKICAgICAgLy8gSWYgdXJsIGlzIGFuIG9iamVjdCwgc2ltdWxhdGUgcHJlLTEuNSBzaWduYXR1cmUKICAgICAgaWYgKF90eXBlb2YodXJsKSA9PT0gIm9iamVjdCIpIHsKICAgICAgICBvcHRpb25zID0gdXJsOwogICAgICAgIHVybCA9IHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgLy8gRm9yY2Ugb3B0aW9ucyB0byBiZSBhbiBvYmplY3QKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHZhciB0cmFuc3BvcnQsCiAgICAgICAgLy8gVVJMIHdpdGhvdXQgYW50aS1jYWNoZSBwYXJhbQogICAgICAgIGNhY2hlVVJMLAogICAgICAgIC8vIFJlc3BvbnNlIGhlYWRlcnMKICAgICAgICByZXNwb25zZUhlYWRlcnNTdHJpbmcsCiAgICAgICAgcmVzcG9uc2VIZWFkZXJzLAogICAgICAgIC8vIHRpbWVvdXQgaGFuZGxlCiAgICAgICAgdGltZW91dFRpbWVyLAogICAgICAgIC8vIFVybCBjbGVhbnVwIHZhcgogICAgICAgIHVybEFuY2hvciwKICAgICAgICAvLyBSZXF1ZXN0IHN0YXRlIChiZWNvbWVzIGZhbHNlIHVwb24gc2VuZCBhbmQgdHJ1ZSB1cG9uIGNvbXBsZXRpb24pCiAgICAgICAgY29tcGxldGVkLAogICAgICAgIC8vIFRvIGtub3cgaWYgZ2xvYmFsIGV2ZW50cyBhcmUgdG8gYmUgZGlzcGF0Y2hlZAogICAgICAgIGZpcmVHbG9iYWxzLAogICAgICAgIC8vIExvb3AgdmFyaWFibGUKICAgICAgICBpLAogICAgICAgIC8vIHVuY2FjaGVkIHBhcnQgb2YgdGhlIHVybAogICAgICAgIHVuY2FjaGVkLAogICAgICAgIC8vIENyZWF0ZSB0aGUgZmluYWwgb3B0aW9ucyBvYmplY3QKICAgICAgICBzID0galF1ZXJ5LmFqYXhTZXR1cCh7fSwgb3B0aW9ucyksCiAgICAgICAgLy8gQ2FsbGJhY2tzIGNvbnRleHQKICAgICAgICBjYWxsYmFja0NvbnRleHQgPSBzLmNvbnRleHQgfHwgcywKICAgICAgICAvLyBDb250ZXh0IGZvciBnbG9iYWwgZXZlbnRzIGlzIGNhbGxiYWNrQ29udGV4dCBpZiBpdCBpcyBhIERPTSBub2RlIG9yIGpRdWVyeSBjb2xsZWN0aW9uCiAgICAgICAgZ2xvYmFsRXZlbnRDb250ZXh0ID0gcy5jb250ZXh0ICYmIChjYWxsYmFja0NvbnRleHQubm9kZVR5cGUgfHwgY2FsbGJhY2tDb250ZXh0LmpxdWVyeSkgPyBqUXVlcnkoY2FsbGJhY2tDb250ZXh0KSA6IGpRdWVyeS5ldmVudCwKICAgICAgICAvLyBEZWZlcnJlZHMKICAgICAgICBkZWZlcnJlZCA9IGpRdWVyeS5EZWZlcnJlZCgpLAogICAgICAgIGNvbXBsZXRlRGVmZXJyZWQgPSBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLAogICAgICAgIC8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCiAgICAgICAgX3N0YXR1c0NvZGUgPSBzLnN0YXR1c0NvZGUgfHwge30sCiAgICAgICAgLy8gSGVhZGVycyAodGhleSBhcmUgc2VudCBhbGwgYXQgb25jZSkKICAgICAgICByZXF1ZXN0SGVhZGVycyA9IHt9LAogICAgICAgIHJlcXVlc3RIZWFkZXJzTmFtZXMgPSB7fSwKICAgICAgICAvLyBEZWZhdWx0IGFib3J0IG1lc3NhZ2UKICAgICAgICBzdHJBYm9ydCA9ICJjYW5jZWxlZCIsCiAgICAgICAgLy8gRmFrZSB4aHIKICAgICAgICBqcVhIUiA9IHsKICAgICAgICAgIHJlYWR5U3RhdGU6IDAsCiAgICAgICAgICAvLyBCdWlsZHMgaGVhZGVycyBoYXNodGFibGUgaWYgbmVlZGVkCiAgICAgICAgICBnZXRSZXNwb25zZUhlYWRlcjogZnVuY3Rpb24gZ2V0UmVzcG9uc2VIZWFkZXIoa2V5KSB7CiAgICAgICAgICAgIHZhciBtYXRjaDsKICAgICAgICAgICAgaWYgKGNvbXBsZXRlZCkgewogICAgICAgICAgICAgIGlmICghcmVzcG9uc2VIZWFkZXJzKSB7CiAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnMgPSB7fTsKICAgICAgICAgICAgICAgIHdoaWxlIChtYXRjaCA9IHJoZWFkZXJzLmV4ZWMocmVzcG9uc2VIZWFkZXJzU3RyaW5nKSkgewogICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnNbbWF0Y2hbMV0udG9Mb3dlckNhc2UoKSArICIgIl0gPSAocmVzcG9uc2VIZWFkZXJzW21hdGNoWzFdLnRvTG93ZXJDYXNlKCkgKyAiICJdIHx8IFtdKS5jb25jYXQobWF0Y2hbMl0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBtYXRjaCA9IHJlc3BvbnNlSGVhZGVyc1trZXkudG9Mb3dlckNhc2UoKSArICIgIl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1hdGNoID09IG51bGwgPyBudWxsIDogbWF0Y2guam9pbigiLCAiKTsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBSYXcgc3RyaW5nCiAgICAgICAgICBnZXRBbGxSZXNwb25zZUhlYWRlcnM6IGZ1bmN0aW9uIGdldEFsbFJlc3BvbnNlSGVhZGVycygpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBsZXRlZCA/IHJlc3BvbnNlSGVhZGVyc1N0cmluZyA6IG51bGw7CiAgICAgICAgICB9LAogICAgICAgICAgLy8gQ2FjaGVzIHRoZSBoZWFkZXIKICAgICAgICAgIHNldFJlcXVlc3RIZWFkZXI6IGZ1bmN0aW9uIHNldFJlcXVlc3RIZWFkZXIobmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGNvbXBsZXRlZCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmFtZSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbbmFtZS50b0xvd2VyQ2FzZSgpXSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbbmFtZS50b0xvd2VyQ2FzZSgpXSB8fCBuYW1lOwogICAgICAgICAgICAgIHJlcXVlc3RIZWFkZXJzW25hbWVdID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9LAogICAgICAgICAgLy8gT3ZlcnJpZGVzIHJlc3BvbnNlIGNvbnRlbnQtdHlwZSBoZWFkZXIKICAgICAgICAgIG92ZXJyaWRlTWltZVR5cGU6IGZ1bmN0aW9uIG92ZXJyaWRlTWltZVR5cGUodHlwZSkgewogICAgICAgICAgICBpZiAoY29tcGxldGVkID09IG51bGwpIHsKICAgICAgICAgICAgICBzLm1pbWVUeXBlID0gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwogICAgICAgICAgc3RhdHVzQ29kZTogZnVuY3Rpb24gc3RhdHVzQ29kZShtYXApIHsKICAgICAgICAgICAgdmFyIGNvZGU7CiAgICAgICAgICAgIGlmIChtYXApIHsKICAgICAgICAgICAgICBpZiAoY29tcGxldGVkKSB7CiAgICAgICAgICAgICAgICAvLyBFeGVjdXRlIHRoZSBhcHByb3ByaWF0ZSBjYWxsYmFja3MKICAgICAgICAgICAgICAgIGpxWEhSLmFsd2F5cyhtYXBbanFYSFIuc3RhdHVzXSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIExhenktYWRkIHRoZSBuZXcgY2FsbGJhY2tzIGluIGEgd2F5IHRoYXQgcHJlc2VydmVzIG9sZCBvbmVzCiAgICAgICAgICAgICAgICBmb3IgKGNvZGUgaW4gbWFwKSB7CiAgICAgICAgICAgICAgICAgIF9zdGF0dXNDb2RlW2NvZGVdID0gW19zdGF0dXNDb2RlW2NvZGVdLCBtYXBbY29kZV1dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBDYW5jZWwgdGhlIHJlcXVlc3QKICAgICAgICAgIGFib3J0OiBmdW5jdGlvbiBhYm9ydChzdGF0dXNUZXh0KSB7CiAgICAgICAgICAgIHZhciBmaW5hbFRleHQgPSBzdGF0dXNUZXh0IHx8IHN0ckFib3J0OwogICAgICAgICAgICBpZiAodHJhbnNwb3J0KSB7CiAgICAgICAgICAgICAgdHJhbnNwb3J0LmFib3J0KGZpbmFsVGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9uZSgwLCBmaW5hbFRleHQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgLy8gQXR0YWNoIGRlZmVycmVkcwogICAgICBkZWZlcnJlZC5wcm9taXNlKGpxWEhSKTsKCiAgICAgIC8vIEFkZCBwcm90b2NvbCBpZiBub3QgcHJvdmlkZWQgKHByZWZpbHRlcnMgbWlnaHQgZXhwZWN0IGl0KQogICAgICAvLyBIYW5kbGUgZmFsc3kgdXJsIGluIHRoZSBzZXR0aW5ncyBvYmplY3QgKCMxMDA5MzogY29uc2lzdGVuY3kgd2l0aCBvbGQgc2lnbmF0dXJlKQogICAgICAvLyBXZSBhbHNvIHVzZSB0aGUgdXJsIHBhcmFtZXRlciBpZiBhdmFpbGFibGUKICAgICAgcy51cmwgPSAoKHVybCB8fCBzLnVybCB8fCBsb2NhdGlvbi5ocmVmKSArICIiKS5yZXBsYWNlKHJwcm90b2NvbCwgbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iKTsKCiAgICAgIC8vIEFsaWFzIG1ldGhvZCBvcHRpb24gdG8gdHlwZSBhcyBwZXIgdGlja2V0ICMxMjAwNAogICAgICBzLnR5cGUgPSBvcHRpb25zLm1ldGhvZCB8fCBvcHRpb25zLnR5cGUgfHwgcy5tZXRob2QgfHwgcy50eXBlOwoKICAgICAgLy8gRXh0cmFjdCBkYXRhVHlwZXMgbGlzdAogICAgICBzLmRhdGFUeXBlcyA9IChzLmRhdGFUeXBlIHx8ICIqIikudG9Mb3dlckNhc2UoKS5tYXRjaChybm90aHRtbHdoaXRlKSB8fCBbIiJdOwoKICAgICAgLy8gQSBjcm9zcy1kb21haW4gcmVxdWVzdCBpcyBpbiBvcmRlciB3aGVuIHRoZSBvcmlnaW4gZG9lc24ndCBtYXRjaCB0aGUgY3VycmVudCBvcmlnaW4uCiAgICAgIGlmIChzLmNyb3NzRG9tYWluID09IG51bGwpIHsKICAgICAgICB1cmxBbmNob3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CgogICAgICAgIC8vIFN1cHBvcnQ6IElFIDw9OCAtIDExLCBFZGdlIDEyIC0gMTUKICAgICAgICAvLyBJRSB0aHJvd3MgZXhjZXB0aW9uIG9uIGFjY2Vzc2luZyB0aGUgaHJlZiBwcm9wZXJ0eSBpZiB1cmwgaXMgbWFsZm9ybWVkLAogICAgICAgIC8vIGUuZy4gaHR0cDovL2V4YW1wbGUuY29tOjgweC8KICAgICAgICB0cnkgewogICAgICAgICAgdXJsQW5jaG9yLmhyZWYgPSBzLnVybDsKCiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTggLSAxMSBvbmx5CiAgICAgICAgICAvLyBBbmNob3IncyBob3N0IHByb3BlcnR5IGlzbid0IGNvcnJlY3RseSBzZXQgd2hlbiBzLnVybCBpcyByZWxhdGl2ZQogICAgICAgICAgdXJsQW5jaG9yLmhyZWYgPSB1cmxBbmNob3IuaHJlZjsKICAgICAgICAgIHMuY3Jvc3NEb21haW4gPSBvcmlnaW5BbmNob3IucHJvdG9jb2wgKyAiLy8iICsgb3JpZ2luQW5jaG9yLmhvc3QgIT09IHVybEFuY2hvci5wcm90b2NvbCArICIvLyIgKyB1cmxBbmNob3IuaG9zdDsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAvLyBJZiB0aGVyZSBpcyBhbiBlcnJvciBwYXJzaW5nIHRoZSBVUkwsIGFzc3VtZSBpdCBpcyBjcm9zc0RvbWFpbiwKICAgICAgICAgIC8vIGl0IGNhbiBiZSByZWplY3RlZCBieSB0aGUgdHJhbnNwb3J0IGlmIGl0IGlzIGludmFsaWQKICAgICAgICAgIHMuY3Jvc3NEb21haW4gPSB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQ29udmVydCBkYXRhIGlmIG5vdCBhbHJlYWR5IGEgc3RyaW5nCiAgICAgIGlmIChzLmRhdGEgJiYgcy5wcm9jZXNzRGF0YSAmJiB0eXBlb2Ygcy5kYXRhICE9PSAic3RyaW5nIikgewogICAgICAgIHMuZGF0YSA9IGpRdWVyeS5wYXJhbShzLmRhdGEsIHMudHJhZGl0aW9uYWwpOwogICAgICB9CgogICAgICAvLyBBcHBseSBwcmVmaWx0ZXJzCiAgICAgIGluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHByZWZpbHRlcnMsIHMsIG9wdGlvbnMsIGpxWEhSKTsKCiAgICAgIC8vIElmIHJlcXVlc3Qgd2FzIGFib3J0ZWQgaW5zaWRlIGEgcHJlZmlsdGVyLCBzdG9wIHRoZXJlCiAgICAgIGlmIChjb21wbGV0ZWQpIHsKICAgICAgICByZXR1cm4ganFYSFI7CiAgICAgIH0KCiAgICAgIC8vIFdlIGNhbiBmaXJlIGdsb2JhbCBldmVudHMgYXMgb2Ygbm93IGlmIGFza2VkIHRvCiAgICAgIC8vIERvbid0IGZpcmUgZXZlbnRzIGlmIGpRdWVyeS5ldmVudCBpcyB1bmRlZmluZWQgaW4gYW4gQU1ELXVzYWdlIHNjZW5hcmlvICgjMTUxMTgpCiAgICAgIGZpcmVHbG9iYWxzID0galF1ZXJ5LmV2ZW50ICYmIHMuZ2xvYmFsOwoKICAgICAgLy8gV2F0Y2ggZm9yIGEgbmV3IHNldCBvZiByZXF1ZXN0cwogICAgICBpZiAoZmlyZUdsb2JhbHMgJiYgalF1ZXJ5LmFjdGl2ZSsrID09PSAwKSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoImFqYXhTdGFydCIpOwogICAgICB9CgogICAgICAvLyBVcHBlcmNhc2UgdGhlIHR5cGUKICAgICAgcy50eXBlID0gcy50eXBlLnRvVXBwZXJDYXNlKCk7CgogICAgICAvLyBEZXRlcm1pbmUgaWYgcmVxdWVzdCBoYXMgY29udGVudAogICAgICBzLmhhc0NvbnRlbnQgPSAhcm5vQ29udGVudC50ZXN0KHMudHlwZSk7CgogICAgICAvLyBTYXZlIHRoZSBVUkwgaW4gY2FzZSB3ZSdyZSB0b3lpbmcgd2l0aCB0aGUgSWYtTW9kaWZpZWQtU2luY2UKICAgICAgLy8gYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyIGxhdGVyIG9uCiAgICAgIC8vIFJlbW92ZSBoYXNoIHRvIHNpbXBsaWZ5IHVybCBtYW5pcHVsYXRpb24KICAgICAgY2FjaGVVUkwgPSBzLnVybC5yZXBsYWNlKHJoYXNoLCAiIik7CgogICAgICAvLyBNb3JlIG9wdGlvbnMgaGFuZGxpbmcgZm9yIHJlcXVlc3RzIHdpdGggbm8gY29udGVudAogICAgICBpZiAoIXMuaGFzQ29udGVudCkgewogICAgICAgIC8vIFJlbWVtYmVyIHRoZSBoYXNoIHNvIHdlIGNhbiBwdXQgaXQgYmFjawogICAgICAgIHVuY2FjaGVkID0gcy51cmwuc2xpY2UoY2FjaGVVUkwubGVuZ3RoKTsKCiAgICAgICAgLy8gSWYgZGF0YSBpcyBhdmFpbGFibGUgYW5kIHNob3VsZCBiZSBwcm9jZXNzZWQsIGFwcGVuZCBkYXRhIHRvIHVybAogICAgICAgIGlmIChzLmRhdGEgJiYgKHMucHJvY2Vzc0RhdGEgfHwgdHlwZW9mIHMuZGF0YSA9PT0gInN0cmluZyIpKSB7CiAgICAgICAgICBjYWNoZVVSTCArPSAocnF1ZXJ5LnRlc3QoY2FjaGVVUkwpID8gIiYiIDogIj8iKSArIHMuZGF0YTsKCiAgICAgICAgICAvLyAjOTY4MjogcmVtb3ZlIGRhdGEgc28gdGhhdCBpdCdzIG5vdCB1c2VkIGluIGFuIGV2ZW50dWFsIHJldHJ5CiAgICAgICAgICBkZWxldGUgcy5kYXRhOwogICAgICAgIH0KCiAgICAgICAgLy8gQWRkIG9yIHVwZGF0ZSBhbnRpLWNhY2hlIHBhcmFtIGlmIG5lZWRlZAogICAgICAgIGlmIChzLmNhY2hlID09PSBmYWxzZSkgewogICAgICAgICAgY2FjaGVVUkwgPSBjYWNoZVVSTC5yZXBsYWNlKHJhbnRpQ2FjaGUsICIkMSIpOwogICAgICAgICAgdW5jYWNoZWQgPSAocnF1ZXJ5LnRlc3QoY2FjaGVVUkwpID8gIiYiIDogIj8iKSArICJfPSIgKyBub25jZS5ndWlkKysgKyB1bmNhY2hlZDsKICAgICAgICB9CgogICAgICAgIC8vIFB1dCBoYXNoIGFuZCBhbnRpLWNhY2hlIG9uIHRoZSBVUkwgdGhhdCB3aWxsIGJlIHJlcXVlc3RlZCAoZ2gtMTczMikKICAgICAgICBzLnVybCA9IGNhY2hlVVJMICsgdW5jYWNoZWQ7CgogICAgICAgIC8vIENoYW5nZSAnJTIwJyB0byAnKycgaWYgdGhpcyBpcyBlbmNvZGVkIGZvcm0gYm9keSBjb250ZW50IChnaC0yNjU4KQogICAgICB9IGVsc2UgaWYgKHMuZGF0YSAmJiBzLnByb2Nlc3NEYXRhICYmIChzLmNvbnRlbnRUeXBlIHx8ICIiKS5pbmRleE9mKCJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQiKSA9PT0gMCkgewogICAgICAgIHMuZGF0YSA9IHMuZGF0YS5yZXBsYWNlKHIyMCwgIisiKTsKICAgICAgfQoKICAgICAgLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KICAgICAgaWYgKHMuaWZNb2RpZmllZCkgewogICAgICAgIGlmIChqUXVlcnkubGFzdE1vZGlmaWVkW2NhY2hlVVJMXSkgewogICAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcigiSWYtTW9kaWZpZWQtU2luY2UiLCBqUXVlcnkubGFzdE1vZGlmaWVkW2NhY2hlVVJMXSk7CiAgICAgICAgfQogICAgICAgIGlmIChqUXVlcnkuZXRhZ1tjYWNoZVVSTF0pIHsKICAgICAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoIklmLU5vbmUtTWF0Y2giLCBqUXVlcnkuZXRhZ1tjYWNoZVVSTF0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gU2V0IHRoZSBjb3JyZWN0IGhlYWRlciwgaWYgZGF0YSBpcyBiZWluZyBzZW50CiAgICAgIGlmIChzLmRhdGEgJiYgcy5oYXNDb250ZW50ICYmIHMuY29udGVudFR5cGUgIT09IGZhbHNlIHx8IG9wdGlvbnMuY29udGVudFR5cGUpIHsKICAgICAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCJDb250ZW50LVR5cGUiLCBzLmNvbnRlbnRUeXBlKTsKICAgICAgfQoKICAgICAgLy8gU2V0IHRoZSBBY2NlcHRzIGhlYWRlciBmb3IgdGhlIHNlcnZlciwgZGVwZW5kaW5nIG9uIHRoZSBkYXRhVHlwZQogICAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCJBY2NlcHQiLCBzLmRhdGFUeXBlc1swXSAmJiBzLmFjY2VwdHNbcy5kYXRhVHlwZXNbMF1dID8gcy5hY2NlcHRzW3MuZGF0YVR5cGVzWzBdXSArIChzLmRhdGFUeXBlc1swXSAhPT0gIioiID8gIiwgIiArIGFsbFR5cGVzICsgIjsgcT0wLjAxIiA6ICIiKSA6IHMuYWNjZXB0c1siKiJdKTsKCiAgICAgIC8vIENoZWNrIGZvciBoZWFkZXJzIG9wdGlvbgogICAgICBmb3IgKGkgaW4gcy5oZWFkZXJzKSB7CiAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcihpLCBzLmhlYWRlcnNbaV0pOwogICAgICB9CgogICAgICAvLyBBbGxvdyBjdXN0b20gaGVhZGVycy9taW1ldHlwZXMgYW5kIGVhcmx5IGFib3J0CiAgICAgIGlmIChzLmJlZm9yZVNlbmQgJiYgKHMuYmVmb3JlU2VuZC5jYWxsKGNhbGxiYWNrQ29udGV4dCwganFYSFIsIHMpID09PSBmYWxzZSB8fCBjb21wbGV0ZWQpKSB7CiAgICAgICAgLy8gQWJvcnQgaWYgbm90IGRvbmUgYWxyZWFkeSBhbmQgcmV0dXJuCiAgICAgICAgcmV0dXJuIGpxWEhSLmFib3J0KCk7CiAgICAgIH0KCiAgICAgIC8vIEFib3J0aW5nIGlzIG5vIGxvbmdlciBhIGNhbmNlbGxhdGlvbgogICAgICBzdHJBYm9ydCA9ICJhYm9ydCI7CgogICAgICAvLyBJbnN0YWxsIGNhbGxiYWNrcyBvbiBkZWZlcnJlZHMKICAgICAgY29tcGxldGVEZWZlcnJlZC5hZGQocy5jb21wbGV0ZSk7CiAgICAgIGpxWEhSLmRvbmUocy5zdWNjZXNzKTsKICAgICAganFYSFIuZmFpbChzLmVycm9yKTsKCiAgICAgIC8vIEdldCB0cmFuc3BvcnQKICAgICAgdHJhbnNwb3J0ID0gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHModHJhbnNwb3J0cywgcywgb3B0aW9ucywganFYSFIpOwoKICAgICAgLy8gSWYgbm8gdHJhbnNwb3J0LCB3ZSBhdXRvLWFib3J0CiAgICAgIGlmICghdHJhbnNwb3J0KSB7CiAgICAgICAgZG9uZSgtMSwgIk5vIFRyYW5zcG9ydCIpOwogICAgICB9IGVsc2UgewogICAgICAgIGpxWEhSLnJlYWR5U3RhdGUgPSAxOwoKICAgICAgICAvLyBTZW5kIGdsb2JhbCBldmVudAogICAgICAgIGlmIChmaXJlR2xvYmFscykgewogICAgICAgICAgZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoImFqYXhTZW5kIiwgW2pxWEhSLCBzXSk7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiByZXF1ZXN0IHdhcyBhYm9ydGVkIGluc2lkZSBhamF4U2VuZCwgc3RvcCB0aGVyZQogICAgICAgIGlmIChjb21wbGV0ZWQpIHsKICAgICAgICAgIHJldHVybiBqcVhIUjsKICAgICAgICB9CgogICAgICAgIC8vIFRpbWVvdXQKICAgICAgICBpZiAocy5hc3luYyAmJiBzLnRpbWVvdXQgPiAwKSB7CiAgICAgICAgICB0aW1lb3V0VGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGpxWEhSLmFib3J0KCJ0aW1lb3V0Iik7CiAgICAgICAgICB9LCBzLnRpbWVvdXQpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgY29tcGxldGVkID0gZmFsc2U7CiAgICAgICAgICB0cmFuc3BvcnQuc2VuZChyZXF1ZXN0SGVhZGVycywgZG9uZSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgLy8gUmV0aHJvdyBwb3N0LWNvbXBsZXRpb24gZXhjZXB0aW9ucwogICAgICAgICAgaWYgKGNvbXBsZXRlZCkgewogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFByb3BhZ2F0ZSBvdGhlcnMgYXMgcmVzdWx0cwogICAgICAgICAgZG9uZSgtMSwgZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBDYWxsYmFjayBmb3Igd2hlbiBldmVyeXRoaW5nIGlzIGRvbmUKICAgICAgZnVuY3Rpb24gZG9uZShzdGF0dXMsIG5hdGl2ZVN0YXR1c1RleHQsIHJlc3BvbnNlcywgaGVhZGVycykgewogICAgICAgIHZhciBpc1N1Y2Nlc3MsCiAgICAgICAgICBzdWNjZXNzLAogICAgICAgICAgZXJyb3IsCiAgICAgICAgICByZXNwb25zZSwKICAgICAgICAgIG1vZGlmaWVkLAogICAgICAgICAgc3RhdHVzVGV4dCA9IG5hdGl2ZVN0YXR1c1RleHQ7CgogICAgICAgIC8vIElnbm9yZSByZXBlYXQgaW52b2NhdGlvbnMKICAgICAgICBpZiAoY29tcGxldGVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbXBsZXRlZCA9IHRydWU7CgogICAgICAgIC8vIENsZWFyIHRpbWVvdXQgaWYgaXQgZXhpc3RzCiAgICAgICAgaWYgKHRpbWVvdXRUaW1lcikgewogICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aW1lb3V0VGltZXIpOwogICAgICAgIH0KCiAgICAgICAgLy8gRGVyZWZlcmVuY2UgdHJhbnNwb3J0IGZvciBlYXJseSBnYXJiYWdlIGNvbGxlY3Rpb24KICAgICAgICAvLyAobm8gbWF0dGVyIGhvdyBsb25nIHRoZSBqcVhIUiBvYmplY3Qgd2lsbCBiZSB1c2VkKQogICAgICAgIHRyYW5zcG9ydCA9IHVuZGVmaW5lZDsKCiAgICAgICAgLy8gQ2FjaGUgcmVzcG9uc2UgaGVhZGVycwogICAgICAgIHJlc3BvbnNlSGVhZGVyc1N0cmluZyA9IGhlYWRlcnMgfHwgIiI7CgogICAgICAgIC8vIFNldCByZWFkeVN0YXRlCiAgICAgICAganFYSFIucmVhZHlTdGF0ZSA9IHN0YXR1cyA+IDAgPyA0IDogMDsKCiAgICAgICAgLy8gRGV0ZXJtaW5lIGlmIHN1Y2Nlc3NmdWwKICAgICAgICBpc1N1Y2Nlc3MgPSBzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCB8fCBzdGF0dXMgPT09IDMwNDsKCiAgICAgICAgLy8gR2V0IHJlc3BvbnNlIGRhdGEKICAgICAgICBpZiAocmVzcG9uc2VzKSB7CiAgICAgICAgICByZXNwb25zZSA9IGFqYXhIYW5kbGVSZXNwb25zZXMocywganFYSFIsIHJlc3BvbnNlcyk7CiAgICAgICAgfQoKICAgICAgICAvLyBVc2UgYSBub29wIGNvbnZlcnRlciBmb3IgbWlzc2luZyBzY3JpcHQKICAgICAgICBpZiAoIWlzU3VjY2VzcyAmJiBqUXVlcnkuaW5BcnJheSgic2NyaXB0Iiwgcy5kYXRhVHlwZXMpID4gLTEpIHsKICAgICAgICAgIHMuY29udmVydGVyc1sidGV4dCBzY3JpcHQiXSA9IGZ1bmN0aW9uICgpIHt9OwogICAgICAgIH0KCiAgICAgICAgLy8gQ29udmVydCBubyBtYXR0ZXIgd2hhdCAodGhhdCB3YXkgcmVzcG9uc2VYWFggZmllbGRzIGFyZSBhbHdheXMgc2V0KQogICAgICAgIHJlc3BvbnNlID0gYWpheENvbnZlcnQocywgcmVzcG9uc2UsIGpxWEhSLCBpc1N1Y2Nlc3MpOwoKICAgICAgICAvLyBJZiBzdWNjZXNzZnVsLCBoYW5kbGUgdHlwZSBjaGFpbmluZwogICAgICAgIGlmIChpc1N1Y2Nlc3MpIHsKICAgICAgICAgIC8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuCiAgICAgICAgICBpZiAocy5pZk1vZGlmaWVkKSB7CiAgICAgICAgICAgIG1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkxhc3QtTW9kaWZpZWQiKTsKICAgICAgICAgICAgaWYgKG1vZGlmaWVkKSB7CiAgICAgICAgICAgICAgalF1ZXJ5Lmxhc3RNb2RpZmllZFtjYWNoZVVSTF0gPSBtb2RpZmllZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBtb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCJldGFnIik7CiAgICAgICAgICAgIGlmIChtb2RpZmllZCkgewogICAgICAgICAgICAgIGpRdWVyeS5ldGFnW2NhY2hlVVJMXSA9IG1vZGlmaWVkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gaWYgbm8gY29udGVudAogICAgICAgICAgaWYgKHN0YXR1cyA9PT0gMjA0IHx8IHMudHlwZSA9PT0gIkhFQUQiKSB7CiAgICAgICAgICAgIHN0YXR1c1RleHQgPSAibm9jb250ZW50IjsKCiAgICAgICAgICAgIC8vIGlmIG5vdCBtb2RpZmllZAogICAgICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IDMwNCkgewogICAgICAgICAgICBzdGF0dXNUZXh0ID0gIm5vdG1vZGlmaWVkIjsKCiAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgZGF0YSwgbGV0J3MgY29udmVydCBpdAogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdHVzVGV4dCA9IHJlc3BvbnNlLnN0YXRlOwogICAgICAgICAgICBzdWNjZXNzID0gcmVzcG9uc2UuZGF0YTsKICAgICAgICAgICAgZXJyb3IgPSByZXNwb25zZS5lcnJvcjsKICAgICAgICAgICAgaXNTdWNjZXNzID0gIWVycm9yOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBFeHRyYWN0IGVycm9yIGZyb20gc3RhdHVzVGV4dCBhbmQgbm9ybWFsaXplIGZvciBub24tYWJvcnRzCiAgICAgICAgICBlcnJvciA9IHN0YXR1c1RleHQ7CiAgICAgICAgICBpZiAoc3RhdHVzIHx8ICFzdGF0dXNUZXh0KSB7CiAgICAgICAgICAgIHN0YXR1c1RleHQgPSAiZXJyb3IiOwogICAgICAgICAgICBpZiAoc3RhdHVzIDwgMCkgewogICAgICAgICAgICAgIHN0YXR1cyA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFNldCBkYXRhIGZvciB0aGUgZmFrZSB4aHIgb2JqZWN0CiAgICAgICAganFYSFIuc3RhdHVzID0gc3RhdHVzOwogICAgICAgIGpxWEhSLnN0YXR1c1RleHQgPSAobmF0aXZlU3RhdHVzVGV4dCB8fCBzdGF0dXNUZXh0KSArICIiOwoKICAgICAgICAvLyBTdWNjZXNzL0Vycm9yCiAgICAgICAgaWYgKGlzU3VjY2VzcykgewogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoY2FsbGJhY2tDb250ZXh0LCBbc3VjY2Vzcywgc3RhdHVzVGV4dCwganFYSFJdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVmZXJyZWQucmVqZWN0V2l0aChjYWxsYmFja0NvbnRleHQsIFtqcVhIUiwgc3RhdHVzVGV4dCwgZXJyb3JdKTsKICAgICAgICB9CgogICAgICAgIC8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCiAgICAgICAganFYSFIuc3RhdHVzQ29kZShfc3RhdHVzQ29kZSk7CiAgICAgICAgX3N0YXR1c0NvZGUgPSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKGZpcmVHbG9iYWxzKSB7CiAgICAgICAgICBnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlcihpc1N1Y2Nlc3MgPyAiYWpheFN1Y2Nlc3MiIDogImFqYXhFcnJvciIsIFtqcVhIUiwgcywgaXNTdWNjZXNzID8gc3VjY2VzcyA6IGVycm9yXSk7CiAgICAgICAgfQoKICAgICAgICAvLyBDb21wbGV0ZQogICAgICAgIGNvbXBsZXRlRGVmZXJyZWQuZmlyZVdpdGgoY2FsbGJhY2tDb250ZXh0LCBbanFYSFIsIHN0YXR1c1RleHRdKTsKICAgICAgICBpZiAoZmlyZUdsb2JhbHMpIHsKICAgICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCJhamF4Q29tcGxldGUiLCBbanFYSFIsIHNdKTsKCiAgICAgICAgICAvLyBIYW5kbGUgdGhlIGdsb2JhbCBBSkFYIGNvdW50ZXIKICAgICAgICAgIGlmICghIC0talF1ZXJ5LmFjdGl2ZSkgewogICAgICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcigiYWpheFN0b3AiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGpxWEhSOwogICAgfSwKICAgIGdldEpTT046IGZ1bmN0aW9uIGdldEpTT04odXJsLCBkYXRhLCBjYWxsYmFjaykgewogICAgICByZXR1cm4galF1ZXJ5LmdldCh1cmwsIGRhdGEsIGNhbGxiYWNrLCAianNvbiIpOwogICAgfSwKICAgIGdldFNjcmlwdDogZnVuY3Rpb24gZ2V0U2NyaXB0KHVybCwgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIGpRdWVyeS5nZXQodXJsLCB1bmRlZmluZWQsIGNhbGxiYWNrLCAic2NyaXB0Iik7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmVhY2goWyJnZXQiLCAicG9zdCJdLCBmdW5jdGlvbiAoX2ksIG1ldGhvZCkgewogICAgalF1ZXJ5W21ldGhvZF0gPSBmdW5jdGlvbiAodXJsLCBkYXRhLCBjYWxsYmFjaywgdHlwZSkgewogICAgICAvLyBTaGlmdCBhcmd1bWVudHMgaWYgZGF0YSBhcmd1bWVudCB3YXMgb21pdHRlZAogICAgICBpZiAoaXNGdW5jdGlvbihkYXRhKSkgewogICAgICAgIHR5cGUgPSB0eXBlIHx8IGNhbGxiYWNrOwogICAgICAgIGNhbGxiYWNrID0gZGF0YTsKICAgICAgICBkYXRhID0gdW5kZWZpbmVkOwogICAgICB9CgogICAgICAvLyBUaGUgdXJsIGNhbiBiZSBhbiBvcHRpb25zIG9iamVjdCAod2hpY2ggdGhlbiBtdXN0IGhhdmUgLnVybCkKICAgICAgcmV0dXJuIGpRdWVyeS5hamF4KGpRdWVyeS5leHRlbmQoewogICAgICAgIHVybDogdXJsLAogICAgICAgIHR5cGU6IG1ldGhvZCwKICAgICAgICBkYXRhVHlwZTogdHlwZSwKICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgIHN1Y2Nlc3M6IGNhbGxiYWNrCiAgICAgIH0sIGpRdWVyeS5pc1BsYWluT2JqZWN0KHVybCkgJiYgdXJsKSk7CiAgICB9OwogIH0pOwogIGpRdWVyeS5hamF4UHJlZmlsdGVyKGZ1bmN0aW9uIChzKSB7CiAgICB2YXIgaTsKICAgIGZvciAoaSBpbiBzLmhlYWRlcnMpIHsKICAgICAgaWYgKGkudG9Mb3dlckNhc2UoKSA9PT0gImNvbnRlbnQtdHlwZSIpIHsKICAgICAgICBzLmNvbnRlbnRUeXBlID0gcy5oZWFkZXJzW2ldIHx8ICIiOwogICAgICB9CiAgICB9CiAgfSk7CiAgalF1ZXJ5Ll9ldmFsVXJsID0gZnVuY3Rpb24gKHVybCwgb3B0aW9ucywgZG9jKSB7CiAgICByZXR1cm4galF1ZXJ5LmFqYXgoewogICAgICB1cmw6IHVybCwKICAgICAgLy8gTWFrZSB0aGlzIGV4cGxpY2l0LCBzaW5jZSB1c2VyIGNhbiBvdmVycmlkZSB0aGlzIHRocm91Z2ggYWpheFNldHVwICgjMTEyNjQpCiAgICAgIHR5cGU6ICJHRVQiLAogICAgICBkYXRhVHlwZTogInNjcmlwdCIsCiAgICAgIGNhY2hlOiB0cnVlLAogICAgICBhc3luYzogZmFsc2UsCiAgICAgIGdsb2JhbDogZmFsc2UsCiAgICAgIC8vIE9ubHkgZXZhbHVhdGUgdGhlIHJlc3BvbnNlIGlmIGl0IGlzIHN1Y2Nlc3NmdWwgKGdoLTQxMjYpCiAgICAgIC8vIGRhdGFGaWx0ZXIgaXMgbm90IGludm9rZWQgZm9yIGZhaWx1cmUgcmVzcG9uc2VzLCBzbyB1c2luZyBpdCBpbnN0ZWFkCiAgICAgIC8vIG9mIHRoZSBkZWZhdWx0IGNvbnZlcnRlciBpcyBrbHVkZ3kgYnV0IGl0IHdvcmtzLgogICAgICBjb252ZXJ0ZXJzOiB7CiAgICAgICAgInRleHQgc2NyaXB0IjogZnVuY3Rpb24gdGV4dFNjcmlwdCgpIHt9CiAgICAgIH0sCiAgICAgIGRhdGFGaWx0ZXI6IGZ1bmN0aW9uIGRhdGFGaWx0ZXIocmVzcG9uc2UpIHsKICAgICAgICBqUXVlcnkuZ2xvYmFsRXZhbChyZXNwb25zZSwgb3B0aW9ucywgZG9jKTsKICAgICAgfQogICAgfSk7CiAgfTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIHdyYXBBbGw6IGZ1bmN0aW9uIHdyYXBBbGwoaHRtbCkgewogICAgICB2YXIgd3JhcDsKICAgICAgaWYgKHRoaXNbMF0pIHsKICAgICAgICBpZiAoaXNGdW5jdGlvbihodG1sKSkgewogICAgICAgICAgaHRtbCA9IGh0bWwuY2FsbCh0aGlzWzBdKTsKICAgICAgICB9CgogICAgICAgIC8vIFRoZSBlbGVtZW50cyB0byB3cmFwIHRoZSB0YXJnZXQgYXJvdW5kCiAgICAgICAgd3JhcCA9IGpRdWVyeShodG1sLCB0aGlzWzBdLm93bmVyRG9jdW1lbnQpLmVxKDApLmNsb25lKHRydWUpOwogICAgICAgIGlmICh0aGlzWzBdLnBhcmVudE5vZGUpIHsKICAgICAgICAgIHdyYXAuaW5zZXJ0QmVmb3JlKHRoaXNbMF0pOwogICAgICAgIH0KICAgICAgICB3cmFwLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgZWxlbSA9IHRoaXM7CiAgICAgICAgICB3aGlsZSAoZWxlbS5maXJzdEVsZW1lbnRDaGlsZCkgewogICAgICAgICAgICBlbGVtID0gZWxlbS5maXJzdEVsZW1lbnRDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtOwogICAgICAgIH0pLmFwcGVuZCh0aGlzKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICB3cmFwSW5uZXI6IGZ1bmN0aW9uIHdyYXBJbm5lcihodG1sKSB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKGh0bWwpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLndyYXBJbm5lcihodG1sLmNhbGwodGhpcywgaSkpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBzZWxmID0galF1ZXJ5KHRoaXMpLAogICAgICAgICAgY29udGVudHMgPSBzZWxmLmNvbnRlbnRzKCk7CiAgICAgICAgaWYgKGNvbnRlbnRzLmxlbmd0aCkgewogICAgICAgICAgY29udGVudHMud3JhcEFsbChodG1sKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5hcHBlbmQoaHRtbCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICB3cmFwOiBmdW5jdGlvbiB3cmFwKGh0bWwpIHsKICAgICAgdmFyIGh0bWxJc0Z1bmN0aW9uID0gaXNGdW5jdGlvbihodG1sKTsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgIGpRdWVyeSh0aGlzKS53cmFwQWxsKGh0bWxJc0Z1bmN0aW9uID8gaHRtbC5jYWxsKHRoaXMsIGkpIDogaHRtbCk7CiAgICAgIH0pOwogICAgfSwKICAgIHVud3JhcDogZnVuY3Rpb24gdW53cmFwKHNlbGVjdG9yKSB7CiAgICAgIHRoaXMucGFyZW50KHNlbGVjdG9yKS5ub3QoImJvZHkiKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBqUXVlcnkodGhpcykucmVwbGFjZVdpdGgodGhpcy5jaGlsZE5vZGVzKTsKICAgICAgfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH0pOwogIGpRdWVyeS5leHByLnBzZXVkb3MuaGlkZGVuID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgIHJldHVybiAhalF1ZXJ5LmV4cHIucHNldWRvcy52aXNpYmxlKGVsZW0pOwogIH07CiAgalF1ZXJ5LmV4cHIucHNldWRvcy52aXNpYmxlID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgIHJldHVybiAhIShlbGVtLm9mZnNldFdpZHRoIHx8IGVsZW0ub2Zmc2V0SGVpZ2h0IHx8IGVsZW0uZ2V0Q2xpZW50UmVjdHMoKS5sZW5ndGgpOwogIH07CiAgalF1ZXJ5LmFqYXhTZXR0aW5ncy54aHIgPSBmdW5jdGlvbiAoKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gbmV3IHdpbmRvdy5YTUxIdHRwUmVxdWVzdCgpOwogICAgfSBjYXRjaCAoZSkge30KICB9OwogIHZhciB4aHJTdWNjZXNzU3RhdHVzID0gewogICAgICAvLyBGaWxlIHByb3RvY29sIGFsd2F5cyB5aWVsZHMgc3RhdHVzIGNvZGUgMCwgYXNzdW1lIDIwMAogICAgICAwOiAyMDAsCiAgICAgIC8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5CiAgICAgIC8vICMxNDUwOiBzb21ldGltZXMgSUUgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNAogICAgICAxMjIzOiAyMDQKICAgIH0sCiAgICB4aHJTdXBwb3J0ZWQgPSBqUXVlcnkuYWpheFNldHRpbmdzLnhocigpOwogIHN1cHBvcnQuY29ycyA9ICEheGhyU3VwcG9ydGVkICYmICJ3aXRoQ3JlZGVudGlhbHMiIGluIHhoclN1cHBvcnRlZDsKICBzdXBwb3J0LmFqYXggPSB4aHJTdXBwb3J0ZWQgPSAhIXhoclN1cHBvcnRlZDsKICBqUXVlcnkuYWpheFRyYW5zcG9ydChmdW5jdGlvbiAob3B0aW9ucykgewogICAgdmFyIF9jYWxsYmFjaywgZXJyb3JDYWxsYmFjazsKCiAgICAvLyBDcm9zcyBkb21haW4gb25seSBhbGxvd2VkIGlmIHN1cHBvcnRlZCB0aHJvdWdoIFhNTEh0dHBSZXF1ZXN0CiAgICBpZiAoc3VwcG9ydC5jb3JzIHx8IHhoclN1cHBvcnRlZCAmJiAhb3B0aW9ucy5jcm9zc0RvbWFpbikgewogICAgICByZXR1cm4gewogICAgICAgIHNlbmQ6IGZ1bmN0aW9uIHNlbmQoaGVhZGVycywgY29tcGxldGUpIHsKICAgICAgICAgIHZhciBpLAogICAgICAgICAgICB4aHIgPSBvcHRpb25zLnhocigpOwogICAgICAgICAgeGhyLm9wZW4ob3B0aW9ucy50eXBlLCBvcHRpb25zLnVybCwgb3B0aW9ucy5hc3luYywgb3B0aW9ucy51c2VybmFtZSwgb3B0aW9ucy5wYXNzd29yZCk7CgogICAgICAgICAgLy8gQXBwbHkgY3VzdG9tIGZpZWxkcyBpZiBwcm92aWRlZAogICAgICAgICAgaWYgKG9wdGlvbnMueGhyRmllbGRzKSB7CiAgICAgICAgICAgIGZvciAoaSBpbiBvcHRpb25zLnhockZpZWxkcykgewogICAgICAgICAgICAgIHhocltpXSA9IG9wdGlvbnMueGhyRmllbGRzW2ldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gT3ZlcnJpZGUgbWltZSB0eXBlIGlmIG5lZWRlZAogICAgICAgICAgaWYgKG9wdGlvbnMubWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUpIHsKICAgICAgICAgICAgeGhyLm92ZXJyaWRlTWltZVR5cGUob3B0aW9ucy5taW1lVHlwZSk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gWC1SZXF1ZXN0ZWQtV2l0aCBoZWFkZXIKICAgICAgICAgIC8vIEZvciBjcm9zcy1kb21haW4gcmVxdWVzdHMsIHNlZWluZyBhcyBjb25kaXRpb25zIGZvciBhIHByZWZsaWdodCBhcmUKICAgICAgICAgIC8vIGFraW4gdG8gYSBqaWdzYXcgcHV6emxlLCB3ZSBzaW1wbHkgbmV2ZXIgc2V0IGl0IHRvIGJlIHN1cmUuCiAgICAgICAgICAvLyAoaXQgY2FuIGFsd2F5cyBiZSBzZXQgb24gYSBwZXItcmVxdWVzdCBiYXNpcyBvciBldmVuIHVzaW5nIGFqYXhTZXR1cCkKICAgICAgICAgIC8vIEZvciBzYW1lLWRvbWFpbiByZXF1ZXN0cywgd29uJ3QgY2hhbmdlIGhlYWRlciBpZiBhbHJlYWR5IHByb3ZpZGVkLgogICAgICAgICAgaWYgKCFvcHRpb25zLmNyb3NzRG9tYWluICYmICFoZWFkZXJzWyJYLVJlcXVlc3RlZC1XaXRoIl0pIHsKICAgICAgICAgICAgaGVhZGVyc1siWC1SZXF1ZXN0ZWQtV2l0aCJdID0gIlhNTEh0dHBSZXF1ZXN0IjsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBTZXQgaGVhZGVycwogICAgICAgICAgZm9yIChpIGluIGhlYWRlcnMpIHsKICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoaSwgaGVhZGVyc1tpXSk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQ2FsbGJhY2sKICAgICAgICAgIF9jYWxsYmFjayA9IGZ1bmN0aW9uIGNhbGxiYWNrKHR5cGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBpZiAoX2NhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBfY2FsbGJhY2sgPSBlcnJvckNhbGxiYWNrID0geGhyLm9ubG9hZCA9IHhoci5vbmVycm9yID0geGhyLm9uYWJvcnQgPSB4aHIub250aW1lb3V0ID0geGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gImFib3J0IikgewogICAgICAgICAgICAgICAgICB4aHIuYWJvcnQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gImVycm9yIikgewogICAgICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTkgb25seQogICAgICAgICAgICAgICAgICAvLyBPbiBhIG1hbnVhbCBuYXRpdmUgYWJvcnQsIElFOSB0aHJvd3MKICAgICAgICAgICAgICAgICAgLy8gZXJyb3JzIG9uIGFueSBwcm9wZXJ0eSBhY2Nlc3MgdGhhdCBpcyBub3QgcmVhZHlTdGF0ZQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHhoci5zdGF0dXMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgY29tcGxldGUoMCwgImVycm9yIik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29tcGxldGUoCiAgICAgICAgICAgICAgICAgICAgLy8gRmlsZTogcHJvdG9jb2wgYWx3YXlzIHlpZWxkcyBzdGF0dXMgMDsgc2VlICM4NjA1LCAjMTQyMDcKICAgICAgICAgICAgICAgICAgICB4aHIuc3RhdHVzLCB4aHIuc3RhdHVzVGV4dCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbXBsZXRlKHhoclN1Y2Nlc3NTdGF0dXNbeGhyLnN0YXR1c10gfHwgeGhyLnN0YXR1cywgeGhyLnN0YXR1c1RleHQsCiAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5CiAgICAgICAgICAgICAgICAgIC8vIElFOSBoYXMgbm8gWEhSMiBidXQgdGhyb3dzIG9uIGJpbmFyeSAodHJhYy0xMTQyNikKICAgICAgICAgICAgICAgICAgLy8gRm9yIFhIUjIgbm9uLXRleHQsIGxldCB0aGUgY2FsbGVyIGhhbmRsZSBpdCAoZ2gtMjQ5OCkKICAgICAgICAgICAgICAgICAgKHhoci5yZXNwb25zZVR5cGUgfHwgInRleHQiKSAhPT0gInRleHQiIHx8IHR5cGVvZiB4aHIucmVzcG9uc2VUZXh0ICE9PSAic3RyaW5nIiA/IHsKICAgICAgICAgICAgICAgICAgICBiaW5hcnk6IHhoci5yZXNwb25zZQogICAgICAgICAgICAgICAgICB9IDogewogICAgICAgICAgICAgICAgICAgIHRleHQ6IHhoci5yZXNwb25zZVRleHQKICAgICAgICAgICAgICAgICAgfSwgeGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9OwoKICAgICAgICAgIC8vIExpc3RlbiB0byBldmVudHMKICAgICAgICAgIHhoci5vbmxvYWQgPSBfY2FsbGJhY2soKTsKICAgICAgICAgIGVycm9yQ2FsbGJhY2sgPSB4aHIub25lcnJvciA9IHhoci5vbnRpbWVvdXQgPSBfY2FsbGJhY2soImVycm9yIik7CgogICAgICAgICAgLy8gU3VwcG9ydDogSUUgOSBvbmx5CiAgICAgICAgICAvLyBVc2Ugb25yZWFkeXN0YXRlY2hhbmdlIHRvIHJlcGxhY2Ugb25hYm9ydAogICAgICAgICAgLy8gdG8gaGFuZGxlIHVuY2F1Z2h0IGFib3J0cwogICAgICAgICAgaWYgKHhoci5vbmFib3J0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgeGhyLm9uYWJvcnQgPSBlcnJvckNhbGxiYWNrOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAvLyBDaGVjayByZWFkeVN0YXRlIGJlZm9yZSB0aW1lb3V0IGFzIGl0IGNoYW5nZXMKICAgICAgICAgICAgICBpZiAoeGhyLnJlYWR5U3RhdGUgPT09IDQpIHsKICAgICAgICAgICAgICAgIC8vIEFsbG93IG9uZXJyb3IgdG8gYmUgY2FsbGVkIGZpcnN0LAogICAgICAgICAgICAgICAgLy8gYnV0IHRoYXQgd2lsbCBub3QgaGFuZGxlIGEgbmF0aXZlIGFib3J0CiAgICAgICAgICAgICAgICAvLyBBbHNvLCBzYXZlIGVycm9yQ2FsbGJhY2sgdG8gYSB2YXJpYWJsZQogICAgICAgICAgICAgICAgLy8gYXMgeGhyLm9uZXJyb3IgY2Fubm90IGJlIGFjY2Vzc2VkCiAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICBlcnJvckNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBDcmVhdGUgdGhlIGFib3J0IGNhbGxiYWNrCiAgICAgICAgICBfY2FsbGJhY2sgPSBfY2FsbGJhY2soImFib3J0Iik7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICAvLyBEbyBzZW5kIHRoZSByZXF1ZXN0ICh0aGlzIG1heSByYWlzZSBhbiBleGNlcHRpb24pCiAgICAgICAgICAgIHhoci5zZW5kKG9wdGlvbnMuaGFzQ29udGVudCAmJiBvcHRpb25zLmRhdGEgfHwgbnVsbCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIC8vICMxNDY4MzogT25seSByZXRocm93IGlmIHRoaXMgaGFzbid0IGJlZW4gbm90aWZpZWQgYXMgYW4gZXJyb3IgeWV0CiAgICAgICAgICAgIGlmIChfY2FsbGJhY2spIHsKICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhYm9ydDogZnVuY3Rpb24gYWJvcnQoKSB7CiAgICAgICAgICBpZiAoX2NhbGxiYWNrKSB7CiAgICAgICAgICAgIF9jYWxsYmFjaygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gUHJldmVudCBhdXRvLWV4ZWN1dGlvbiBvZiBzY3JpcHRzIHdoZW4gbm8gZXhwbGljaXQgZGF0YVR5cGUgd2FzIHByb3ZpZGVkIChTZWUgZ2gtMjQzMikKICBqUXVlcnkuYWpheFByZWZpbHRlcihmdW5jdGlvbiAocykgewogICAgaWYgKHMuY3Jvc3NEb21haW4pIHsKICAgICAgcy5jb250ZW50cy5zY3JpcHQgPSBmYWxzZTsKICAgIH0KICB9KTsKCiAgLy8gSW5zdGFsbCBzY3JpcHQgZGF0YVR5cGUKICBqUXVlcnkuYWpheFNldHVwKHsKICAgIGFjY2VwdHM6IHsKICAgICAgc2NyaXB0OiAidGV4dC9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0LCAiICsgImFwcGxpY2F0aW9uL2VjbWFzY3JpcHQsIGFwcGxpY2F0aW9uL3gtZWNtYXNjcmlwdCIKICAgIH0sCiAgICBjb250ZW50czogewogICAgICBzY3JpcHQ6IC9cYig/OmphdmF8ZWNtYSlzY3JpcHRcYi8KICAgIH0sCiAgICBjb252ZXJ0ZXJzOiB7CiAgICAgICJ0ZXh0IHNjcmlwdCI6IGZ1bmN0aW9uIHRleHRTY3JpcHQodGV4dCkgewogICAgICAgIGpRdWVyeS5nbG9iYWxFdmFsKHRleHQpOwogICAgICAgIHJldHVybiB0ZXh0OwogICAgICB9CiAgICB9CiAgfSk7CgogIC8vIEhhbmRsZSBjYWNoZSdzIHNwZWNpYWwgY2FzZSBhbmQgY3Jvc3NEb21haW4KICBqUXVlcnkuYWpheFByZWZpbHRlcigic2NyaXB0IiwgZnVuY3Rpb24gKHMpIHsKICAgIGlmIChzLmNhY2hlID09PSB1bmRlZmluZWQpIHsKICAgICAgcy5jYWNoZSA9IGZhbHNlOwogICAgfQogICAgaWYgKHMuY3Jvc3NEb21haW4pIHsKICAgICAgcy50eXBlID0gIkdFVCI7CiAgICB9CiAgfSk7CgogIC8vIEJpbmQgc2NyaXB0IHRhZyBoYWNrIHRyYW5zcG9ydAogIGpRdWVyeS5hamF4VHJhbnNwb3J0KCJzY3JpcHQiLCBmdW5jdGlvbiAocykgewogICAgLy8gVGhpcyB0cmFuc3BvcnQgb25seSBkZWFscyB3aXRoIGNyb3NzIGRvbWFpbiBvciBmb3JjZWQtYnktYXR0cnMgcmVxdWVzdHMKICAgIGlmIChzLmNyb3NzRG9tYWluIHx8IHMuc2NyaXB0QXR0cnMpIHsKICAgICAgdmFyIHNjcmlwdCwgX2NhbGxiYWNrMjsKICAgICAgcmV0dXJuIHsKICAgICAgICBzZW5kOiBmdW5jdGlvbiBzZW5kKF8sIGNvbXBsZXRlKSB7CiAgICAgICAgICBzY3JpcHQgPSBqUXVlcnkoIjxzY3JpcHQ+IikuYXR0cihzLnNjcmlwdEF0dHJzIHx8IHt9KS5wcm9wKHsKICAgICAgICAgICAgY2hhcnNldDogcy5zY3JpcHRDaGFyc2V0LAogICAgICAgICAgICBzcmM6IHMudXJsCiAgICAgICAgICB9KS5vbigibG9hZCBlcnJvciIsIF9jYWxsYmFjazIgPSBmdW5jdGlvbiBjYWxsYmFjayhldnQpIHsKICAgICAgICAgICAgc2NyaXB0LnJlbW92ZSgpOwogICAgICAgICAgICBfY2FsbGJhY2syID0gbnVsbDsKICAgICAgICAgICAgaWYgKGV2dCkgewogICAgICAgICAgICAgIGNvbXBsZXRlKGV2dC50eXBlID09PSAiZXJyb3IiID8gNDA0IDogMjAwLCBldnQudHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIFVzZSBuYXRpdmUgRE9NIG1hbmlwdWxhdGlvbiB0byBhdm9pZCBvdXIgZG9tTWFuaXAgQUpBWCB0cmlja2VyeQogICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHRbMF0pOwogICAgICAgIH0sCiAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uIGFib3J0KCkgewogICAgICAgICAgaWYgKF9jYWxsYmFjazIpIHsKICAgICAgICAgICAgX2NhbGxiYWNrMigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9KTsKICB2YXIgb2xkQ2FsbGJhY2tzID0gW10sCiAgICByanNvbnAgPSAvKD0pXD8oPz0mfCQpfFw/XD8vOwoKICAvLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCiAgalF1ZXJ5LmFqYXhTZXR1cCh7CiAgICBqc29ucDogImNhbGxiYWNrIiwKICAgIGpzb25wQ2FsbGJhY2s6IGZ1bmN0aW9uIGpzb25wQ2FsbGJhY2soKSB7CiAgICAgIHZhciBjYWxsYmFjayA9IG9sZENhbGxiYWNrcy5wb3AoKSB8fCBqUXVlcnkuZXhwYW5kbyArICJfIiArIG5vbmNlLmd1aWQrKzsKICAgICAgdGhpc1tjYWxsYmFja10gPSB0cnVlOwogICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICB9CiAgfSk7CgogIC8vIERldGVjdCwgbm9ybWFsaXplIG9wdGlvbnMgYW5kIGluc3RhbGwgY2FsbGJhY2tzIGZvciBqc29ucCByZXF1ZXN0cwogIGpRdWVyeS5hamF4UHJlZmlsdGVyKCJqc29uIGpzb25wIiwgZnVuY3Rpb24gKHMsIG9yaWdpbmFsU2V0dGluZ3MsIGpxWEhSKSB7CiAgICB2YXIgY2FsbGJhY2tOYW1lLAogICAgICBvdmVyd3JpdHRlbiwKICAgICAgcmVzcG9uc2VDb250YWluZXIsCiAgICAgIGpzb25Qcm9wID0gcy5qc29ucCAhPT0gZmFsc2UgJiYgKHJqc29ucC50ZXN0KHMudXJsKSA/ICJ1cmwiIDogdHlwZW9mIHMuZGF0YSA9PT0gInN0cmluZyIgJiYgKHMuY29udGVudFR5cGUgfHwgIiIpLmluZGV4T2YoImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIpID09PSAwICYmIHJqc29ucC50ZXN0KHMuZGF0YSkgJiYgImRhdGEiKTsKCiAgICAvLyBIYW5kbGUgaWZmIHRoZSBleHBlY3RlZCBkYXRhIHR5cGUgaXMgImpzb25wIiBvciB3ZSBoYXZlIGEgcGFyYW1ldGVyIHRvIHNldAogICAgaWYgKGpzb25Qcm9wIHx8IHMuZGF0YVR5cGVzWzBdID09PSAianNvbnAiKSB7CiAgICAgIC8vIEdldCBjYWxsYmFjayBuYW1lLCByZW1lbWJlcmluZyBwcmVleGlzdGluZyB2YWx1ZSBhc3NvY2lhdGVkIHdpdGggaXQKICAgICAgY2FsbGJhY2tOYW1lID0gcy5qc29ucENhbGxiYWNrID0gaXNGdW5jdGlvbihzLmpzb25wQ2FsbGJhY2spID8gcy5qc29ucENhbGxiYWNrKCkgOiBzLmpzb25wQ2FsbGJhY2s7CgogICAgICAvLyBJbnNlcnQgY2FsbGJhY2sgaW50byB1cmwgb3IgZm9ybSBkYXRhCiAgICAgIGlmIChqc29uUHJvcCkgewogICAgICAgIHNbanNvblByb3BdID0gc1tqc29uUHJvcF0ucmVwbGFjZShyanNvbnAsICIkMSIgKyBjYWxsYmFja05hbWUpOwogICAgICB9IGVsc2UgaWYgKHMuanNvbnAgIT09IGZhbHNlKSB7CiAgICAgICAgcy51cmwgKz0gKHJxdWVyeS50ZXN0KHMudXJsKSA/ICImIiA6ICI/IikgKyBzLmpzb25wICsgIj0iICsgY2FsbGJhY2tOYW1lOwogICAgICB9CgogICAgICAvLyBVc2UgZGF0YSBjb252ZXJ0ZXIgdG8gcmV0cmlldmUganNvbiBhZnRlciBzY3JpcHQgZXhlY3V0aW9uCiAgICAgIHMuY29udmVydGVyc1sic2NyaXB0IGpzb24iXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoIXJlc3BvbnNlQ29udGFpbmVyKSB7CiAgICAgICAgICBqUXVlcnkuZXJyb3IoY2FsbGJhY2tOYW1lICsgIiB3YXMgbm90IGNhbGxlZCIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzcG9uc2VDb250YWluZXJbMF07CiAgICAgIH07CgogICAgICAvLyBGb3JjZSBqc29uIGRhdGFUeXBlCiAgICAgIHMuZGF0YVR5cGVzWzBdID0gImpzb24iOwoKICAgICAgLy8gSW5zdGFsbCBjYWxsYmFjawogICAgICBvdmVyd3JpdHRlbiA9IHdpbmRvd1tjYWxsYmFja05hbWVdOwogICAgICB3aW5kb3dbY2FsbGJhY2tOYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXNwb25zZUNvbnRhaW5lciA9IGFyZ3VtZW50czsKICAgICAgfTsKCiAgICAgIC8vIENsZWFuLXVwIGZ1bmN0aW9uIChmaXJlcyBhZnRlciBjb252ZXJ0ZXJzKQogICAgICBqcVhIUi5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgIC8vIElmIHByZXZpb3VzIHZhbHVlIGRpZG4ndCBleGlzdCAtIHJlbW92ZSBpdAogICAgICAgIGlmIChvdmVyd3JpdHRlbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBqUXVlcnkod2luZG93KS5yZW1vdmVQcm9wKGNhbGxiYWNrTmFtZSk7CgogICAgICAgICAgLy8gT3RoZXJ3aXNlIHJlc3RvcmUgcHJlZXhpc3RpbmcgdmFsdWUKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBvdmVyd3JpdHRlbjsKICAgICAgICB9CgogICAgICAgIC8vIFNhdmUgYmFjayBhcyBmcmVlCiAgICAgICAgaWYgKHNbY2FsbGJhY2tOYW1lXSkgewogICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgcmUtdXNpbmcgdGhlIG9wdGlvbnMgZG9lc24ndCBzY3JldyB0aGluZ3MgYXJvdW5kCiAgICAgICAgICBzLmpzb25wQ2FsbGJhY2sgPSBvcmlnaW5hbFNldHRpbmdzLmpzb25wQ2FsbGJhY2s7CgogICAgICAgICAgLy8gU2F2ZSB0aGUgY2FsbGJhY2sgbmFtZSBmb3IgZnV0dXJlIHVzZQogICAgICAgICAgb2xkQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2tOYW1lKTsKICAgICAgICB9CgogICAgICAgIC8vIENhbGwgaWYgaXQgd2FzIGEgZnVuY3Rpb24gYW5kIHdlIGhhdmUgYSByZXNwb25zZQogICAgICAgIGlmIChyZXNwb25zZUNvbnRhaW5lciAmJiBpc0Z1bmN0aW9uKG92ZXJ3cml0dGVuKSkgewogICAgICAgICAgb3ZlcndyaXR0ZW4ocmVzcG9uc2VDb250YWluZXJbMF0pOwogICAgICAgIH0KICAgICAgICByZXNwb25zZUNvbnRhaW5lciA9IG92ZXJ3cml0dGVuID0gdW5kZWZpbmVkOwogICAgICB9KTsKCiAgICAgIC8vIERlbGVnYXRlIHRvIHNjcmlwdAogICAgICByZXR1cm4gInNjcmlwdCI7CiAgICB9CiAgfSk7CgogIC8vIFN1cHBvcnQ6IFNhZmFyaSA4IG9ubHkKICAvLyBJbiBTYWZhcmkgOCBkb2N1bWVudHMgY3JlYXRlZCB2aWEgZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50CiAgLy8gY29sbGFwc2Ugc2libGluZyBmb3JtczogdGhlIHNlY29uZCBvbmUgYmVjb21lcyBhIGNoaWxkIG9mIHRoZSBmaXJzdCBvbmUuCiAgLy8gQmVjYXVzZSBvZiB0aGF0LCB0aGlzIHNlY3VyaXR5IG1lYXN1cmUgaGFzIHRvIGJlIGRpc2FibGVkIGluIFNhZmFyaSA4LgogIC8vIGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD0xMzczMzcKICBzdXBwb3J0LmNyZWF0ZUhUTUxEb2N1bWVudCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBib2R5ID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KCIiKS5ib2R5OwogICAgYm9keS5pbm5lckhUTUwgPSAiPGZvcm0+PC9mb3JtPjxmb3JtPjwvZm9ybT4iOwogICAgcmV0dXJuIGJvZHkuY2hpbGROb2Rlcy5sZW5ndGggPT09IDI7CiAgfSgpOwoKICAvLyBBcmd1bWVudCAiZGF0YSIgc2hvdWxkIGJlIHN0cmluZyBvZiBodG1sCiAgLy8gY29udGV4dCAob3B0aW9uYWwpOiBJZiBzcGVjaWZpZWQsIHRoZSBmcmFnbWVudCB3aWxsIGJlIGNyZWF0ZWQgaW4gdGhpcyBjb250ZXh0LAogIC8vIGRlZmF1bHRzIHRvIGRvY3VtZW50CiAgLy8ga2VlcFNjcmlwdHMgKG9wdGlvbmFsKTogSWYgdHJ1ZSwgd2lsbCBpbmNsdWRlIHNjcmlwdHMgcGFzc2VkIGluIHRoZSBodG1sIHN0cmluZwogIGpRdWVyeS5wYXJzZUhUTUwgPSBmdW5jdGlvbiAoZGF0YSwgY29udGV4dCwga2VlcFNjcmlwdHMpIHsKICAgIGlmICh0eXBlb2YgZGF0YSAhPT0gInN0cmluZyIpIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQogICAgaWYgKHR5cGVvZiBjb250ZXh0ID09PSAiYm9vbGVhbiIpIHsKICAgICAga2VlcFNjcmlwdHMgPSBjb250ZXh0OwogICAgICBjb250ZXh0ID0gZmFsc2U7CiAgICB9CiAgICB2YXIgYmFzZSwgcGFyc2VkLCBzY3JpcHRzOwogICAgaWYgKCFjb250ZXh0KSB7CiAgICAgIC8vIFN0b3Agc2NyaXB0cyBvciBpbmxpbmUgZXZlbnQgaGFuZGxlcnMgZnJvbSBiZWluZyBleGVjdXRlZCBpbW1lZGlhdGVseQogICAgICAvLyBieSB1c2luZyBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbgogICAgICBpZiAoc3VwcG9ydC5jcmVhdGVIVE1MRG9jdW1lbnQpIHsKICAgICAgICBjb250ZXh0ID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KCIiKTsKCiAgICAgICAgLy8gU2V0IHRoZSBiYXNlIGhyZWYgZm9yIHRoZSBjcmVhdGVkIGRvY3VtZW50CiAgICAgICAgLy8gc28gYW55IHBhcnNlZCBlbGVtZW50cyB3aXRoIFVSTHMKICAgICAgICAvLyBhcmUgYmFzZWQgb24gdGhlIGRvY3VtZW50J3MgVVJMIChnaC0yOTY1KQogICAgICAgIGJhc2UgPSBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImJhc2UiKTsKICAgICAgICBiYXNlLmhyZWYgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwogICAgICAgIGNvbnRleHQuaGVhZC5hcHBlbmRDaGlsZChiYXNlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb250ZXh0ID0gZG9jdW1lbnQ7CiAgICAgIH0KICAgIH0KICAgIHBhcnNlZCA9IHJzaW5nbGVUYWcuZXhlYyhkYXRhKTsKICAgIHNjcmlwdHMgPSAha2VlcFNjcmlwdHMgJiYgW107CgogICAgLy8gU2luZ2xlIHRhZwogICAgaWYgKHBhcnNlZCkgewogICAgICByZXR1cm4gW2NvbnRleHQuY3JlYXRlRWxlbWVudChwYXJzZWRbMV0pXTsKICAgIH0KICAgIHBhcnNlZCA9IGJ1aWxkRnJhZ21lbnQoW2RhdGFdLCBjb250ZXh0LCBzY3JpcHRzKTsKICAgIGlmIChzY3JpcHRzICYmIHNjcmlwdHMubGVuZ3RoKSB7CiAgICAgIGpRdWVyeShzY3JpcHRzKS5yZW1vdmUoKTsKICAgIH0KICAgIHJldHVybiBqUXVlcnkubWVyZ2UoW10sIHBhcnNlZC5jaGlsZE5vZGVzKTsKICB9OwoKICAvKioKICAgKiBMb2FkIGEgdXJsIGludG8gYSBwYWdlCiAgICovCiAgalF1ZXJ5LmZuLmxvYWQgPSBmdW5jdGlvbiAodXJsLCBwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZWN0b3IsCiAgICAgIHR5cGUsCiAgICAgIHJlc3BvbnNlLAogICAgICBzZWxmID0gdGhpcywKICAgICAgb2ZmID0gdXJsLmluZGV4T2YoIiAiKTsKICAgIGlmIChvZmYgPiAtMSkgewogICAgICBzZWxlY3RvciA9IHN0cmlwQW5kQ29sbGFwc2UodXJsLnNsaWNlKG9mZikpOwogICAgICB1cmwgPSB1cmwuc2xpY2UoMCwgb2ZmKTsKICAgIH0KCiAgICAvLyBJZiBpdCdzIGEgZnVuY3Rpb24KICAgIGlmIChpc0Z1bmN0aW9uKHBhcmFtcykpIHsKICAgICAgLy8gV2UgYXNzdW1lIHRoYXQgaXQncyB0aGUgY2FsbGJhY2sKICAgICAgY2FsbGJhY2sgPSBwYXJhbXM7CiAgICAgIHBhcmFtcyA9IHVuZGVmaW5lZDsKCiAgICAgIC8vIE90aGVyd2lzZSwgYnVpbGQgYSBwYXJhbSBzdHJpbmcKICAgIH0gZWxzZSBpZiAocGFyYW1zICYmIF90eXBlb2YocGFyYW1zKSA9PT0gIm9iamVjdCIpIHsKICAgICAgdHlwZSA9ICJQT1NUIjsKICAgIH0KCiAgICAvLyBJZiB3ZSBoYXZlIGVsZW1lbnRzIHRvIG1vZGlmeSwgbWFrZSB0aGUgcmVxdWVzdAogICAgaWYgKHNlbGYubGVuZ3RoID4gMCkgewogICAgICBqUXVlcnkuYWpheCh7CiAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgLy8gSWYgInR5cGUiIHZhcmlhYmxlIGlzIHVuZGVmaW5lZCwgdGhlbiAiR0VUIiBtZXRob2Qgd2lsbCBiZSB1c2VkLgogICAgICAgIC8vIE1ha2UgdmFsdWUgb2YgdGhpcyBmaWVsZCBleHBsaWNpdCBzaW5jZQogICAgICAgIC8vIHVzZXIgY2FuIG92ZXJyaWRlIGl0IHRocm91Z2ggYWpheFNldHVwIG1ldGhvZAogICAgICAgIHR5cGU6IHR5cGUgfHwgIkdFVCIsCiAgICAgICAgZGF0YVR5cGU6ICJodG1sIiwKICAgICAgICBkYXRhOiBwYXJhbXMKICAgICAgfSkuZG9uZShmdW5jdGlvbiAocmVzcG9uc2VUZXh0KSB7CiAgICAgICAgLy8gU2F2ZSByZXNwb25zZSBmb3IgdXNlIGluIGNvbXBsZXRlIGNhbGxiYWNrCiAgICAgICAgcmVzcG9uc2UgPSBhcmd1bWVudHM7CiAgICAgICAgc2VsZi5odG1sKHNlbGVjdG9yID8KICAgICAgICAvLyBJZiBhIHNlbGVjdG9yIHdhcyBzcGVjaWZpZWQsIGxvY2F0ZSB0aGUgcmlnaHQgZWxlbWVudHMgaW4gYSBkdW1teSBkaXYKICAgICAgICAvLyBFeGNsdWRlIHNjcmlwdHMgdG8gYXZvaWQgSUUgJ1Blcm1pc3Npb24gRGVuaWVkJyBlcnJvcnMKICAgICAgICBqUXVlcnkoIjxkaXY+IikuYXBwZW5kKGpRdWVyeS5wYXJzZUhUTUwocmVzcG9uc2VUZXh0KSkuZmluZChzZWxlY3RvcikgOgogICAgICAgIC8vIE90aGVyd2lzZSB1c2UgdGhlIGZ1bGwgcmVzdWx0CiAgICAgICAgcmVzcG9uc2VUZXh0KTsKCiAgICAgICAgLy8gSWYgdGhlIHJlcXVlc3Qgc3VjY2VlZHMsIHRoaXMgZnVuY3Rpb24gZ2V0cyAiZGF0YSIsICJzdGF0dXMiLCAianFYSFIiCiAgICAgICAgLy8gYnV0IHRoZXkgYXJlIGlnbm9yZWQgYmVjYXVzZSByZXNwb25zZSB3YXMgc2V0IGFib3ZlLgogICAgICAgIC8vIElmIGl0IGZhaWxzLCB0aGlzIGZ1bmN0aW9uIGdldHMgImpxWEhSIiwgInN0YXR1cyIsICJlcnJvciIKICAgICAgfSkuYWx3YXlzKGNhbGxiYWNrICYmIGZ1bmN0aW9uIChqcVhIUiwgc3RhdHVzKSB7CiAgICAgICAgc2VsZi5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIHJlc3BvbnNlIHx8IFtqcVhIUi5yZXNwb25zZVRleHQsIHN0YXR1cywganFYSFJdKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwogIGpRdWVyeS5leHByLnBzZXVkb3MuYW5pbWF0ZWQgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuIGpRdWVyeS5ncmVwKGpRdWVyeS50aW1lcnMsIGZ1bmN0aW9uIChmbikgewogICAgICByZXR1cm4gZWxlbSA9PT0gZm4uZWxlbTsKICAgIH0pLmxlbmd0aDsKICB9OwogIGpRdWVyeS5vZmZzZXQgPSB7CiAgICBzZXRPZmZzZXQ6IGZ1bmN0aW9uIHNldE9mZnNldChlbGVtLCBvcHRpb25zLCBpKSB7CiAgICAgIHZhciBjdXJQb3NpdGlvbiwKICAgICAgICBjdXJMZWZ0LAogICAgICAgIGN1ckNTU1RvcCwKICAgICAgICBjdXJUb3AsCiAgICAgICAgY3VyT2Zmc2V0LAogICAgICAgIGN1ckNTU0xlZnQsCiAgICAgICAgY2FsY3VsYXRlUG9zaXRpb24sCiAgICAgICAgcG9zaXRpb24gPSBqUXVlcnkuY3NzKGVsZW0sICJwb3NpdGlvbiIpLAogICAgICAgIGN1ckVsZW0gPSBqUXVlcnkoZWxlbSksCiAgICAgICAgcHJvcHMgPSB7fTsKCiAgICAgIC8vIFNldCBwb3NpdGlvbiBmaXJzdCwgaW4tY2FzZSB0b3AvbGVmdCBhcmUgc2V0IGV2ZW4gb24gc3RhdGljIGVsZW0KICAgICAgaWYgKHBvc2l0aW9uID09PSAic3RhdGljIikgewogICAgICAgIGVsZW0uc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogICAgICB9CiAgICAgIGN1ck9mZnNldCA9IGN1ckVsZW0ub2Zmc2V0KCk7CiAgICAgIGN1ckNTU1RvcCA9IGpRdWVyeS5jc3MoZWxlbSwgInRvcCIpOwogICAgICBjdXJDU1NMZWZ0ID0galF1ZXJ5LmNzcyhlbGVtLCAibGVmdCIpOwogICAgICBjYWxjdWxhdGVQb3NpdGlvbiA9IChwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIikgJiYgKGN1ckNTU1RvcCArIGN1ckNTU0xlZnQpLmluZGV4T2YoImF1dG8iKSA+IC0xOwoKICAgICAgLy8gTmVlZCB0byBiZSBhYmxlIHRvIGNhbGN1bGF0ZSBwb3NpdGlvbiBpZiBlaXRoZXIKICAgICAgLy8gdG9wIG9yIGxlZnQgaXMgYXV0byBhbmQgcG9zaXRpb24gaXMgZWl0aGVyIGFic29sdXRlIG9yIGZpeGVkCiAgICAgIGlmIChjYWxjdWxhdGVQb3NpdGlvbikgewogICAgICAgIGN1clBvc2l0aW9uID0gY3VyRWxlbS5wb3NpdGlvbigpOwogICAgICAgIGN1clRvcCA9IGN1clBvc2l0aW9uLnRvcDsKICAgICAgICBjdXJMZWZ0ID0gY3VyUG9zaXRpb24ubGVmdDsKICAgICAgfSBlbHNlIHsKICAgICAgICBjdXJUb3AgPSBwYXJzZUZsb2F0KGN1ckNTU1RvcCkgfHwgMDsKICAgICAgICBjdXJMZWZ0ID0gcGFyc2VGbG9hdChjdXJDU1NMZWZ0KSB8fCAwOwogICAgICB9CiAgICAgIGlmIChpc0Z1bmN0aW9uKG9wdGlvbnMpKSB7CiAgICAgICAgLy8gVXNlIGpRdWVyeS5leHRlbmQgaGVyZSB0byBhbGxvdyBtb2RpZmljYXRpb24gb2YgY29vcmRpbmF0ZXMgYXJndW1lbnQgKGdoLTE4NDgpCiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMuY2FsbChlbGVtLCBpLCBqUXVlcnkuZXh0ZW5kKHt9LCBjdXJPZmZzZXQpKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy50b3AgIT0gbnVsbCkgewogICAgICAgIHByb3BzLnRvcCA9IG9wdGlvbnMudG9wIC0gY3VyT2Zmc2V0LnRvcCArIGN1clRvcDsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy5sZWZ0ICE9IG51bGwpIHsKICAgICAgICBwcm9wcy5sZWZ0ID0gb3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQgKyBjdXJMZWZ0OwogICAgICB9CiAgICAgIGlmICgidXNpbmciIGluIG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zLnVzaW5nLmNhbGwoZWxlbSwgcHJvcHMpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0eXBlb2YgcHJvcHMudG9wID09PSAibnVtYmVyIikgewogICAgICAgICAgcHJvcHMudG9wICs9ICJweCI7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgcHJvcHMubGVmdCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgIHByb3BzLmxlZnQgKz0gInB4IjsKICAgICAgICB9CiAgICAgICAgY3VyRWxlbS5jc3MocHJvcHMpOwogICAgICB9CiAgICB9CiAgfTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIC8vIG9mZnNldCgpIHJlbGF0ZXMgYW4gZWxlbWVudCdzIGJvcmRlciBib3ggdG8gdGhlIGRvY3VtZW50IG9yaWdpbgogICAgb2Zmc2V0OiBmdW5jdGlvbiBvZmZzZXQob3B0aW9ucykgewogICAgICAvLyBQcmVzZXJ2ZSBjaGFpbmluZyBmb3Igc2V0dGVyCiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIG9wdGlvbnMgPT09IHVuZGVmaW5lZCA/IHRoaXMgOiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICAgIGpRdWVyeS5vZmZzZXQuc2V0T2Zmc2V0KHRoaXMsIG9wdGlvbnMsIGkpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHZhciByZWN0LAogICAgICAgIHdpbiwKICAgICAgICBlbGVtID0gdGhpc1swXTsKICAgICAgaWYgKCFlbGVtKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBSZXR1cm4gemVyb3MgZm9yIGRpc2Nvbm5lY3RlZCBhbmQgaGlkZGVuIChkaXNwbGF5OiBub25lKSBlbGVtZW50cyAoZ2gtMjMxMCkKICAgICAgLy8gU3VwcG9ydDogSUUgPD0xMSBvbmx5CiAgICAgIC8vIFJ1bm5pbmcgZ2V0Qm91bmRpbmdDbGllbnRSZWN0IG9uIGEKICAgICAgLy8gZGlzY29ubmVjdGVkIG5vZGUgaW4gSUUgdGhyb3dzIGFuIGVycm9yCiAgICAgIGlmICghZWxlbS5nZXRDbGllbnRSZWN0cygpLmxlbmd0aCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0b3A6IDAsCiAgICAgICAgICBsZWZ0OiAwCiAgICAgICAgfTsKICAgICAgfQoKICAgICAgLy8gR2V0IGRvY3VtZW50LXJlbGF0aXZlIHBvc2l0aW9uIGJ5IGFkZGluZyB2aWV3cG9ydCBzY3JvbGwgdG8gdmlld3BvcnQtcmVsYXRpdmUgZ0JDUgogICAgICByZWN0ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgd2luID0gZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3OwogICAgICByZXR1cm4gewogICAgICAgIHRvcDogcmVjdC50b3AgKyB3aW4ucGFnZVlPZmZzZXQsCiAgICAgICAgbGVmdDogcmVjdC5sZWZ0ICsgd2luLnBhZ2VYT2Zmc2V0CiAgICAgIH07CiAgICB9LAogICAgLy8gcG9zaXRpb24oKSByZWxhdGVzIGFuIGVsZW1lbnQncyBtYXJnaW4gYm94IHRvIGl0cyBvZmZzZXQgcGFyZW50J3MgcGFkZGluZyBib3gKICAgIC8vIFRoaXMgY29ycmVzcG9uZHMgdG8gdGhlIGJlaGF2aW9yIG9mIENTUyBhYnNvbHV0ZSBwb3NpdGlvbmluZwogICAgcG9zaXRpb246IGZ1bmN0aW9uIHBvc2l0aW9uKCkgewogICAgICBpZiAoIXRoaXNbMF0pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIG9mZnNldFBhcmVudCwKICAgICAgICBvZmZzZXQsCiAgICAgICAgZG9jLAogICAgICAgIGVsZW0gPSB0aGlzWzBdLAogICAgICAgIHBhcmVudE9mZnNldCA9IHsKICAgICAgICAgIHRvcDogMCwKICAgICAgICAgIGxlZnQ6IDAKICAgICAgICB9OwoKICAgICAgLy8gcG9zaXRpb246Zml4ZWQgZWxlbWVudHMgYXJlIG9mZnNldCBmcm9tIHRoZSB2aWV3cG9ydCwgd2hpY2ggaXRzZWxmIGFsd2F5cyBoYXMgemVybyBvZmZzZXQKICAgICAgaWYgKGpRdWVyeS5jc3MoZWxlbSwgInBvc2l0aW9uIikgPT09ICJmaXhlZCIpIHsKICAgICAgICAvLyBBc3N1bWUgcG9zaXRpb246Zml4ZWQgaW1wbGllcyBhdmFpbGFiaWxpdHkgb2YgZ2V0Qm91bmRpbmdDbGllbnRSZWN0CiAgICAgICAgb2Zmc2V0ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvZmZzZXQgPSB0aGlzLm9mZnNldCgpOwoKICAgICAgICAvLyBBY2NvdW50IGZvciB0aGUgKnJlYWwqIG9mZnNldCBwYXJlbnQsIHdoaWNoIGNhbiBiZSB0aGUgZG9jdW1lbnQgb3IgaXRzIHJvb3QgZWxlbWVudAogICAgICAgIC8vIHdoZW4gYSBzdGF0aWNhbGx5IHBvc2l0aW9uZWQgZWxlbWVudCBpcyBpZGVudGlmaWVkCiAgICAgICAgZG9jID0gZWxlbS5vd25lckRvY3VtZW50OwogICAgICAgIG9mZnNldFBhcmVudCA9IGVsZW0ub2Zmc2V0UGFyZW50IHx8IGRvYy5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgd2hpbGUgKG9mZnNldFBhcmVudCAmJiAob2Zmc2V0UGFyZW50ID09PSBkb2MuYm9keSB8fCBvZmZzZXRQYXJlbnQgPT09IGRvYy5kb2N1bWVudEVsZW1lbnQpICYmIGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50LCAicG9zaXRpb24iKSA9PT0gInN0YXRpYyIpIHsKICAgICAgICAgIG9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5wYXJlbnROb2RlOwogICAgICAgIH0KICAgICAgICBpZiAob2Zmc2V0UGFyZW50ICYmIG9mZnNldFBhcmVudCAhPT0gZWxlbSAmJiBvZmZzZXRQYXJlbnQubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgIC8vIEluY29ycG9yYXRlIGJvcmRlcnMgaW50byBpdHMgb2Zmc2V0LCBzaW5jZSB0aGV5IGFyZSBvdXRzaWRlIGl0cyBjb250ZW50IG9yaWdpbgogICAgICAgICAgcGFyZW50T2Zmc2V0ID0galF1ZXJ5KG9mZnNldFBhcmVudCkub2Zmc2V0KCk7CiAgICAgICAgICBwYXJlbnRPZmZzZXQudG9wICs9IGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50LCAiYm9yZGVyVG9wV2lkdGgiLCB0cnVlKTsKICAgICAgICAgIHBhcmVudE9mZnNldC5sZWZ0ICs9IGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50LCAiYm9yZGVyTGVmdFdpZHRoIiwgdHJ1ZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBTdWJ0cmFjdCBwYXJlbnQgb2Zmc2V0cyBhbmQgZWxlbWVudCBtYXJnaW5zCiAgICAgIHJldHVybiB7CiAgICAgICAgdG9wOiBvZmZzZXQudG9wIC0gcGFyZW50T2Zmc2V0LnRvcCAtIGpRdWVyeS5jc3MoZWxlbSwgIm1hcmdpblRvcCIsIHRydWUpLAogICAgICAgIGxlZnQ6IG9mZnNldC5sZWZ0IC0gcGFyZW50T2Zmc2V0LmxlZnQgLSBqUXVlcnkuY3NzKGVsZW0sICJtYXJnaW5MZWZ0IiwgdHJ1ZSkKICAgICAgfTsKICAgIH0sCiAgICAvLyBUaGlzIG1ldGhvZCB3aWxsIHJldHVybiBkb2N1bWVudEVsZW1lbnQgaW4gdGhlIGZvbGxvd2luZyBjYXNlczoKICAgIC8vIDEpIEZvciB0aGUgZWxlbWVudCBpbnNpZGUgdGhlIGlmcmFtZSB3aXRob3V0IG9mZnNldFBhcmVudCwgdGhpcyBtZXRob2Qgd2lsbCByZXR1cm4KICAgIC8vICAgIGRvY3VtZW50RWxlbWVudCBvZiB0aGUgcGFyZW50IHdpbmRvdwogICAgLy8gMikgRm9yIHRoZSBoaWRkZW4gb3IgZGV0YWNoZWQgZWxlbWVudAogICAgLy8gMykgRm9yIGJvZHkgb3IgaHRtbCBlbGVtZW50LCBpLmUuIGluIGNhc2Ugb2YgdGhlIGh0bWwgbm9kZSAtIGl0IHdpbGwgcmV0dXJuIGl0c2VsZgogICAgLy8KICAgIC8vIGJ1dCB0aG9zZSBleGNlcHRpb25zIHdlcmUgbmV2ZXIgcHJlc2VudGVkIGFzIGEgcmVhbCBsaWZlIHVzZS1jYXNlcwogICAgLy8gYW5kIG1pZ2h0IGJlIGNvbnNpZGVyZWQgYXMgbW9yZSBwcmVmZXJhYmxlIHJlc3VsdHMuCiAgICAvLwogICAgLy8gVGhpcyBsb2dpYywgaG93ZXZlciwgaXMgbm90IGd1YXJhbnRlZWQgYW5kIGNhbiBjaGFuZ2UgYXQgYW55IHBvaW50IGluIHRoZSBmdXR1cmUKICAgIG9mZnNldFBhcmVudDogZnVuY3Rpb24gb2Zmc2V0UGFyZW50KCkgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudDsKICAgICAgICB3aGlsZSAob2Zmc2V0UGFyZW50ICYmIGpRdWVyeS5jc3Mob2Zmc2V0UGFyZW50LCAicG9zaXRpb24iKSA9PT0gInN0YXRpYyIpIHsKICAgICAgICAgIG9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5vZmZzZXRQYXJlbnQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvZmZzZXRQYXJlbnQgfHwgZG9jdW1lbnRFbGVtZW50OwogICAgICB9KTsKICAgIH0KICB9KTsKCiAgLy8gQ3JlYXRlIHNjcm9sbExlZnQgYW5kIHNjcm9sbFRvcCBtZXRob2RzCiAgalF1ZXJ5LmVhY2goewogICAgc2Nyb2xsTGVmdDogInBhZ2VYT2Zmc2V0IiwKICAgIHNjcm9sbFRvcDogInBhZ2VZT2Zmc2V0IgogIH0sIGZ1bmN0aW9uIChtZXRob2QsIHByb3ApIHsKICAgIHZhciB0b3AgPSAicGFnZVlPZmZzZXQiID09PSBwcm9wOwogICAgalF1ZXJ5LmZuW21ldGhvZF0gPSBmdW5jdGlvbiAodmFsKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgZnVuY3Rpb24gKGVsZW0sIG1ldGhvZCwgdmFsKSB7CiAgICAgICAgLy8gQ29hbGVzY2UgZG9jdW1lbnRzIGFuZCB3aW5kb3dzCiAgICAgICAgdmFyIHdpbjsKICAgICAgICBpZiAoaXNXaW5kb3coZWxlbSkpIHsKICAgICAgICAgIHdpbiA9IGVsZW07CiAgICAgICAgfSBlbHNlIGlmIChlbGVtLm5vZGVUeXBlID09PSA5KSB7CiAgICAgICAgICB3aW4gPSBlbGVtLmRlZmF1bHRWaWV3OwogICAgICAgIH0KICAgICAgICBpZiAodmFsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJldHVybiB3aW4gPyB3aW5bcHJvcF0gOiBlbGVtW21ldGhvZF07CiAgICAgICAgfQogICAgICAgIGlmICh3aW4pIHsKICAgICAgICAgIHdpbi5zY3JvbGxUbyghdG9wID8gdmFsIDogd2luLnBhZ2VYT2Zmc2V0LCB0b3AgPyB2YWwgOiB3aW4ucGFnZVlPZmZzZXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlbGVtW21ldGhvZF0gPSB2YWw7CiAgICAgICAgfQogICAgICB9LCBtZXRob2QsIHZhbCwgYXJndW1lbnRzLmxlbmd0aCk7CiAgICB9OwogIH0pOwoKICAvLyBTdXBwb3J0OiBTYWZhcmkgPD03IC0gOS4xLCBDaHJvbWUgPD0zNyAtIDQ5CiAgLy8gQWRkIHRoZSB0b3AvbGVmdCBjc3NIb29rcyB1c2luZyBqUXVlcnkuZm4ucG9zaXRpb24KICAvLyBXZWJraXQgYnVnOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MjkwODQKICAvLyBCbGluayBidWc6IGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTU4OTM0NwogIC8vIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyBwZXJjZW50IHdoZW4gc3BlY2lmaWVkIGZvciB0b3AvbGVmdC9ib3R0b20vcmlnaHQ7CiAgLy8gcmF0aGVyIHRoYW4gbWFrZSB0aGUgY3NzIG1vZHVsZSBkZXBlbmQgb24gdGhlIG9mZnNldCBtb2R1bGUsIGp1c3QgY2hlY2sgZm9yIGl0IGhlcmUKICBqUXVlcnkuZWFjaChbInRvcCIsICJsZWZ0Il0sIGZ1bmN0aW9uIChfaSwgcHJvcCkgewogICAgalF1ZXJ5LmNzc0hvb2tzW3Byb3BdID0gYWRkR2V0SG9va0lmKHN1cHBvcnQucGl4ZWxQb3NpdGlvbiwgZnVuY3Rpb24gKGVsZW0sIGNvbXB1dGVkKSB7CiAgICAgIGlmIChjb21wdXRlZCkgewogICAgICAgIGNvbXB1dGVkID0gY3VyQ1NTKGVsZW0sIHByb3ApOwoKICAgICAgICAvLyBJZiBjdXJDU1MgcmV0dXJucyBwZXJjZW50YWdlLCBmYWxsYmFjayB0byBvZmZzZXQKICAgICAgICByZXR1cm4gcm51bW5vbnB4LnRlc3QoY29tcHV0ZWQpID8galF1ZXJ5KGVsZW0pLnBvc2l0aW9uKClbcHJvcF0gKyAicHgiIDogY29tcHV0ZWQ7CiAgICAgIH0KICAgIH0pOwogIH0pOwoKICAvLyBDcmVhdGUgaW5uZXJIZWlnaHQsIGlubmVyV2lkdGgsIGhlaWdodCwgd2lkdGgsIG91dGVySGVpZ2h0IGFuZCBvdXRlcldpZHRoIG1ldGhvZHMKICBqUXVlcnkuZWFjaCh7CiAgICBIZWlnaHQ6ICJoZWlnaHQiLAogICAgV2lkdGg6ICJ3aWR0aCIKICB9LCBmdW5jdGlvbiAobmFtZSwgdHlwZSkgewogICAgalF1ZXJ5LmVhY2goewogICAgICBwYWRkaW5nOiAiaW5uZXIiICsgbmFtZSwKICAgICAgY29udGVudDogdHlwZSwKICAgICAgIiI6ICJvdXRlciIgKyBuYW1lCiAgICB9LCBmdW5jdGlvbiAoZGVmYXVsdEV4dHJhLCBmdW5jTmFtZSkgewogICAgICAvLyBNYXJnaW4gaXMgb25seSBmb3Igb3V0ZXJIZWlnaHQsIG91dGVyV2lkdGgKICAgICAgalF1ZXJ5LmZuW2Z1bmNOYW1lXSA9IGZ1bmN0aW9uIChtYXJnaW4sIHZhbHVlKSB7CiAgICAgICAgdmFyIGNoYWluYWJsZSA9IGFyZ3VtZW50cy5sZW5ndGggJiYgKGRlZmF1bHRFeHRyYSB8fCB0eXBlb2YgbWFyZ2luICE9PSAiYm9vbGVhbiIpLAogICAgICAgICAgZXh0cmEgPSBkZWZhdWx0RXh0cmEgfHwgKG1hcmdpbiA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gdHJ1ZSA/ICJtYXJnaW4iIDogImJvcmRlciIpOwogICAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgZnVuY3Rpb24gKGVsZW0sIHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICB2YXIgZG9jOwogICAgICAgICAgaWYgKGlzV2luZG93KGVsZW0pKSB7CiAgICAgICAgICAgIC8vICQoIHdpbmRvdyApLm91dGVyV2lkdGgvSGVpZ2h0IHJldHVybiB3L2ggaW5jbHVkaW5nIHNjcm9sbGJhcnMgKGdoLTE3MjkpCiAgICAgICAgICAgIHJldHVybiBmdW5jTmFtZS5pbmRleE9mKCJvdXRlciIpID09PSAwID8gZWxlbVsiaW5uZXIiICsgbmFtZV0gOiBlbGVtLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsiY2xpZW50IiArIG5hbWVdOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIEdldCBkb2N1bWVudCB3aWR0aCBvciBoZWlnaHQKICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSA5KSB7CiAgICAgICAgICAgIGRvYyA9IGVsZW0uZG9jdW1lbnRFbGVtZW50OwoKICAgICAgICAgICAgLy8gRWl0aGVyIHNjcm9sbFtXaWR0aC9IZWlnaHRdIG9yIG9mZnNldFtXaWR0aC9IZWlnaHRdIG9yIGNsaWVudFtXaWR0aC9IZWlnaHRdLAogICAgICAgICAgICAvLyB3aGljaGV2ZXIgaXMgZ3JlYXRlc3QKICAgICAgICAgICAgcmV0dXJuIE1hdGgubWF4KGVsZW0uYm9keVsic2Nyb2xsIiArIG5hbWVdLCBkb2NbInNjcm9sbCIgKyBuYW1lXSwgZWxlbS5ib2R5WyJvZmZzZXQiICsgbmFtZV0sIGRvY1sib2Zmc2V0IiArIG5hbWVdLCBkb2NbImNsaWVudCIgKyBuYW1lXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IHVuZGVmaW5lZCA/CiAgICAgICAgICAvLyBHZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50LCByZXF1ZXN0aW5nIGJ1dCBub3QgZm9yY2luZyBwYXJzZUZsb2F0CiAgICAgICAgICBqUXVlcnkuY3NzKGVsZW0sIHR5cGUsIGV4dHJhKSA6CiAgICAgICAgICAvLyBTZXQgd2lkdGggb3IgaGVpZ2h0IG9uIHRoZSBlbGVtZW50CiAgICAgICAgICBqUXVlcnkuc3R5bGUoZWxlbSwgdHlwZSwgdmFsdWUsIGV4dHJhKTsKICAgICAgICB9LCB0eXBlLCBjaGFpbmFibGUgPyBtYXJnaW4gOiB1bmRlZmluZWQsIGNoYWluYWJsZSk7CiAgICAgIH07CiAgICB9KTsKICB9KTsKICBqUXVlcnkuZWFjaChbImFqYXhTdGFydCIsICJhamF4U3RvcCIsICJhamF4Q29tcGxldGUiLCAiYWpheEVycm9yIiwgImFqYXhTdWNjZXNzIiwgImFqYXhTZW5kIl0sIGZ1bmN0aW9uIChfaSwgdHlwZSkgewogICAgalF1ZXJ5LmZuW3R5cGVdID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgIHJldHVybiB0aGlzLm9uKHR5cGUsIGZuKTsKICAgIH07CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBiaW5kOiBmdW5jdGlvbiBiaW5kKHR5cGVzLCBkYXRhLCBmbikgewogICAgICByZXR1cm4gdGhpcy5vbih0eXBlcywgbnVsbCwgZGF0YSwgZm4pOwogICAgfSwKICAgIHVuYmluZDogZnVuY3Rpb24gdW5iaW5kKHR5cGVzLCBmbikgewogICAgICByZXR1cm4gdGhpcy5vZmYodHlwZXMsIG51bGwsIGZuKTsKICAgIH0sCiAgICBkZWxlZ2F0ZTogZnVuY3Rpb24gZGVsZWdhdGUoc2VsZWN0b3IsIHR5cGVzLCBkYXRhLCBmbikgewogICAgICByZXR1cm4gdGhpcy5vbih0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuKTsKICAgIH0sCiAgICB1bmRlbGVnYXRlOiBmdW5jdGlvbiB1bmRlbGVnYXRlKHNlbGVjdG9yLCB0eXBlcywgZm4pIHsKICAgICAgLy8gKCBuYW1lc3BhY2UgKSBvciAoIHNlbGVjdG9yLCB0eXBlcyBbLCBmbl0gKQogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IHRoaXMub2ZmKHNlbGVjdG9yLCAiKioiKSA6IHRoaXMub2ZmKHR5cGVzLCBzZWxlY3RvciB8fCAiKioiLCBmbik7CiAgICB9LAogICAgaG92ZXI6IGZ1bmN0aW9uIGhvdmVyKGZuT3ZlciwgZm5PdXQpIHsKICAgICAgcmV0dXJuIHRoaXMubW91c2VlbnRlcihmbk92ZXIpLm1vdXNlbGVhdmUoZm5PdXQgfHwgZm5PdmVyKTsKICAgIH0KICB9KTsKICBqUXVlcnkuZWFjaCgoImJsdXIgZm9jdXMgZm9jdXNpbiBmb2N1c291dCByZXNpemUgc2Nyb2xsIGNsaWNrIGRibGNsaWNrICIgKyAibW91c2Vkb3duIG1vdXNldXAgbW91c2Vtb3ZlIG1vdXNlb3ZlciBtb3VzZW91dCBtb3VzZWVudGVyIG1vdXNlbGVhdmUgIiArICJjaGFuZ2Ugc2VsZWN0IHN1Ym1pdCBrZXlkb3duIGtleXByZXNzIGtleXVwIGNvbnRleHRtZW51Iikuc3BsaXQoIiAiKSwgZnVuY3Rpb24gKF9pLCBuYW1lKSB7CiAgICAvLyBIYW5kbGUgZXZlbnQgYmluZGluZwogICAgalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24gKGRhdGEsIGZuKSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMCA/IHRoaXMub24obmFtZSwgbnVsbCwgZGF0YSwgZm4pIDogdGhpcy50cmlnZ2VyKG5hbWUpOwogICAgfTsKICB9KTsKCiAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMCBvbmx5CiAgLy8gTWFrZSBzdXJlIHdlIHRyaW0gQk9NIGFuZCBOQlNQCiAgdmFyIHJ0cmltID0gL15bXHNcdUZFRkZceEEwXSt8W1xzXHVGRUZGXHhBMF0rJC9nOwoKICAvLyBCaW5kIGEgZnVuY3Rpb24gdG8gYSBjb250ZXh0LCBvcHRpb25hbGx5IHBhcnRpYWxseSBhcHBseWluZyBhbnkKICAvLyBhcmd1bWVudHMuCiAgLy8galF1ZXJ5LnByb3h5IGlzIGRlcHJlY2F0ZWQgdG8gcHJvbW90ZSBzdGFuZGFyZHMgKHNwZWNpZmljYWxseSBGdW5jdGlvbiNiaW5kKQogIC8vIEhvd2V2ZXIsIGl0IGlzIG5vdCBzbGF0ZWQgZm9yIHJlbW92YWwgYW55IHRpbWUgc29vbgogIGpRdWVyeS5wcm94eSA9IGZ1bmN0aW9uIChmbiwgY29udGV4dCkgewogICAgdmFyIHRtcCwgYXJncywgcHJveHk7CiAgICBpZiAodHlwZW9mIGNvbnRleHQgPT09ICJzdHJpbmciKSB7CiAgICAgIHRtcCA9IGZuW2NvbnRleHRdOwogICAgICBjb250ZXh0ID0gZm47CiAgICAgIGZuID0gdG1wOwogICAgfQoKICAgIC8vIFF1aWNrIGNoZWNrIHRvIGRldGVybWluZSBpZiB0YXJnZXQgaXMgY2FsbGFibGUsIGluIHRoZSBzcGVjCiAgICAvLyB0aGlzIHRocm93cyBhIFR5cGVFcnJvciwgYnV0IHdlIHdpbGwganVzdCByZXR1cm4gdW5kZWZpbmVkLgogICAgaWYgKCFpc0Z1bmN0aW9uKGZuKSkgewogICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQoKICAgIC8vIFNpbXVsYXRlZCBiaW5kCiAgICBhcmdzID0gX3NsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHByb3h5ID0gZnVuY3Rpb24gcHJveHkoKSB7CiAgICAgIHJldHVybiBmbi5hcHBseShjb250ZXh0IHx8IHRoaXMsIGFyZ3MuY29uY2F0KF9zbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgIH07CgogICAgLy8gU2V0IHRoZSBndWlkIG9mIHVuaXF1ZSBoYW5kbGVyIHRvIHRoZSBzYW1lIG9mIG9yaWdpbmFsIGhhbmRsZXIsIHNvIGl0IGNhbiBiZSByZW1vdmVkCiAgICBwcm94eS5ndWlkID0gZm4uZ3VpZCA9IGZuLmd1aWQgfHwgalF1ZXJ5Lmd1aWQrKzsKICAgIHJldHVybiBwcm94eTsKICB9OwogIGpRdWVyeS5ob2xkUmVhZHkgPSBmdW5jdGlvbiAoaG9sZCkgewogICAgaWYgKGhvbGQpIHsKICAgICAgalF1ZXJ5LnJlYWR5V2FpdCsrOwogICAgfSBlbHNlIHsKICAgICAgalF1ZXJ5LnJlYWR5KHRydWUpOwogICAgfQogIH07CiAgalF1ZXJ5LmlzQXJyYXkgPSBBcnJheS5pc0FycmF5OwogIGpRdWVyeS5wYXJzZUpTT04gPSBKU09OLnBhcnNlOwogIGpRdWVyeS5ub2RlTmFtZSA9IG5vZGVOYW1lOwogIGpRdWVyeS5pc0Z1bmN0aW9uID0gaXNGdW5jdGlvbjsKICBqUXVlcnkuaXNXaW5kb3cgPSBpc1dpbmRvdzsKICBqUXVlcnkuY2FtZWxDYXNlID0gY2FtZWxDYXNlOwogIGpRdWVyeS50eXBlID0gdG9UeXBlOwogIGpRdWVyeS5ub3cgPSBEYXRlLm5vdzsKICBqUXVlcnkuaXNOdW1lcmljID0gZnVuY3Rpb24gKG9iaikgewogICAgLy8gQXMgb2YgalF1ZXJ5IDMuMCwgaXNOdW1lcmljIGlzIGxpbWl0ZWQgdG8KICAgIC8vIHN0cmluZ3MgYW5kIG51bWJlcnMgKHByaW1pdGl2ZXMgb3Igb2JqZWN0cykKICAgIC8vIHRoYXQgY2FuIGJlIGNvZXJjZWQgdG8gZmluaXRlIG51bWJlcnMgKGdoLTI2NjIpCiAgICB2YXIgdHlwZSA9IGpRdWVyeS50eXBlKG9iaik7CiAgICByZXR1cm4gKHR5cGUgPT09ICJudW1iZXIiIHx8IHR5cGUgPT09ICJzdHJpbmciKSAmJgogICAgLy8gcGFyc2VGbG9hdCBOYU5zIG51bWVyaWMtY2FzdCBmYWxzZSBwb3NpdGl2ZXMgKCIiKQogICAgLy8gLi4uYnV0IG1pc2ludGVycHJldHMgbGVhZGluZy1udW1iZXIgc3RyaW5ncywgcGFydGljdWxhcmx5IGhleCBsaXRlcmFscyAoIjB4Li4uIikKICAgIC8vIHN1YnRyYWN0aW9uIGZvcmNlcyBpbmZpbml0aWVzIHRvIE5hTgogICAgIWlzTmFOKG9iaiAtIHBhcnNlRmxvYXQob2JqKSk7CiAgfTsKICBqUXVlcnkudHJpbSA9IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICByZXR1cm4gdGV4dCA9PSBudWxsID8gIiIgOiAodGV4dCArICIiKS5yZXBsYWNlKHJ0cmltLCAiIik7CiAgfTsKCiAgLy8gUmVnaXN0ZXIgYXMgYSBuYW1lZCBBTUQgbW9kdWxlLCBzaW5jZSBqUXVlcnkgY2FuIGJlIGNvbmNhdGVuYXRlZCB3aXRoIG90aGVyCiAgLy8gZmlsZXMgdGhhdCBtYXkgdXNlIGRlZmluZSwgYnV0IG5vdCB2aWEgYSBwcm9wZXIgY29uY2F0ZW5hdGlvbiBzY3JpcHQgdGhhdAogIC8vIHVuZGVyc3RhbmRzIGFub255bW91cyBBTUQgbW9kdWxlcy4gQSBuYW1lZCBBTUQgaXMgc2FmZXN0IGFuZCBtb3N0IHJvYnVzdAogIC8vIHdheSB0byByZWdpc3Rlci4gTG93ZXJjYXNlIGpxdWVyeSBpcyB1c2VkIGJlY2F1c2UgQU1EIG1vZHVsZSBuYW1lcyBhcmUKICAvLyBkZXJpdmVkIGZyb20gZmlsZSBuYW1lcywgYW5kIGpRdWVyeSBpcyBub3JtYWxseSBkZWxpdmVyZWQgaW4gYSBsb3dlcmNhc2UKICAvLyBmaWxlIG5hbWUuIERvIHRoaXMgYWZ0ZXIgY3JlYXRpbmcgdGhlIGdsb2JhbCBzbyB0aGF0IGlmIGFuIEFNRCBtb2R1bGUgd2FudHMKICAvLyB0byBjYWxsIG5vQ29uZmxpY3QgdG8gaGlkZSB0aGlzIHZlcnNpb24gb2YgalF1ZXJ5LCBpdCB3aWxsIHdvcmsuCgogIC8vIE5vdGUgdGhhdCBmb3IgbWF4aW11bSBwb3J0YWJpbGl0eSwgbGlicmFyaWVzIHRoYXQgYXJlIG5vdCBqUXVlcnkgc2hvdWxkCiAgLy8gZGVjbGFyZSB0aGVtc2VsdmVzIGFzIGFub255bW91cyBtb2R1bGVzLCBhbmQgYXZvaWQgc2V0dGluZyBhIGdsb2JhbCBpZiBhbgogIC8vIEFNRCBsb2FkZXIgaXMgcHJlc2VudC4galF1ZXJ5IGlzIGEgc3BlY2lhbCBjYXNlLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgc2VlCiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2pyYnVya2UvcmVxdWlyZWpzL3dpa2kvVXBkYXRpbmctZXhpc3RpbmctbGlicmFyaWVzI3dpa2ktYW5vbgoKICBpZiAodHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSB7CiAgICBkZWZpbmUoImpxdWVyeSIsIFtdLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBqUXVlcnk7CiAgICB9KTsKICB9CiAgdmFyCiAgICAvLyBNYXAgb3ZlciBqUXVlcnkgaW4gY2FzZSBvZiBvdmVyd3JpdGUKICAgIF9qUXVlcnkgPSB3aW5kb3cualF1ZXJ5LAogICAgLy8gTWFwIG92ZXIgdGhlICQgaW4gY2FzZSBvZiBvdmVyd3JpdGUKICAgIF8kID0gd2luZG93LiQ7CiAgalF1ZXJ5Lm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoZGVlcCkgewogICAgaWYgKHdpbmRvdy4kID09PSBqUXVlcnkpIHsKICAgICAgd2luZG93LiQgPSBfJDsKICAgIH0KICAgIGlmIChkZWVwICYmIHdpbmRvdy5qUXVlcnkgPT09IGpRdWVyeSkgewogICAgICB3aW5kb3cualF1ZXJ5ID0gX2pRdWVyeTsKICAgIH0KICAgIHJldHVybiBqUXVlcnk7CiAgfTsKCiAgLy8gRXhwb3NlIGpRdWVyeSBhbmQgJCBpZGVudGlmaWVycywgZXZlbiBpbiBBTUQKICAvLyAoIzcxMDIjY29tbWVudDoxMCwgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnkvcHVsbC81NTcpCiAgLy8gYW5kIENvbW1vbkpTIGZvciBicm93c2VyIGVtdWxhdG9ycyAoIzEzNTY2KQogIGlmICh0eXBlb2Ygbm9HbG9iYWwgPT09ICJ1bmRlZmluZWQiKSB7CiAgICB3aW5kb3cualF1ZXJ5ID0gd2luZG93LiQgPSBqUXVlcnk7CiAgfQogIHJldHVybiBqUXVlcnk7Cn0pOw=="},null]}